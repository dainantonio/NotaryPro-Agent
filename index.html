<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NotaryOS</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“œ</text></svg>">
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Merriweather:wght@300;400;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- Utilities -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- FIREBASE SDK (COMPAT MODE) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA32kVbmGOcY_CdDymrom9rWVzyXTj3so0",
            authDomain: "notaryos-67cd2.firebaseapp.com",
            projectId: "notaryos-67cd2",
            storageBucket: "notaryos-67cd2.firebasestorage.app",
            messagingSenderId: "660325303334",
            appId: "1:660325303334:web:bb0f062fd4da8c7fca12e7"
        };
        const STRIPE_PAYMENT_LINK = ""; 

        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase Connected");
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }
    </script>

    <style>
        body { font-family: 'Merriweather', serif; background-color: #f3f4f6; }
        h1, h2, h3, h4, h5, h6, button, .font-sans { font-family: 'Poppins', sans-serif; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .status-scheduled { background-color: #e0f2fe; color: #0369a1; }
        .status-completed { background-color: #dcfce7; color: #15803d; }
        .status-paid { background-color: #166534; color: white; }
        .status-cancelled { background-color: #fee2e2; color: #b91c1c; }

        .typing-indicator span { animation: blink 1.4s infinite both; height: 6px; width: 6px; background-color: #3b82f6; border-radius: 50%; display: inline-block; margin: 0 2px; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }

        .paper-doc { background-color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e5e7eb; font-family: 'Courier Prime', monospace; }
        .auth-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }
        .empty-state-dashed { background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%23CBD5E1FF' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e"); }
        .fab-ai { position: fixed; bottom: 80px; right: 20px; z-index: 50; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: grid; place-items: center; }
        @media (min-width: 768px) { .fab-ai { bottom: 30px; } }
        
        /* Toast Animation */
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }

        /* Dark Mode Landing Page Background */
        .landing-bg {
            background-color: #0f172a; /* Dark Slate 900 */
            background-image: radial-gradient(circle at 100% 0%, #1e293b 0%, #0f172a 50%);
        }
        
        /* Visual elements for landing page */
        .visual-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, border-color 0.3s ease;
        }
        .visual-card:hover {
            transform: translateY(-5px);
            border-color: rgba(59, 130, 246, 0.5);
        }

        /* AI Hero Glow */
        .ai-glow-box {
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.3), 0 0 60px rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(124, 58, 237, 0.3);
        }

        /* Phone Mockup */
        .phone-mockup {
            border: 8px solid #333;
            border-radius: 30px;
            overflow: hidden;
            position: relative;
            background: #fff;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .phone-notch {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40%;
            height: 20px;
            background: #333;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            z-index: 10;
        }
        
        /* Notary Gold Accent */
        .text-notary-gold { color: #fbbf24; }
        .bg-notary-gold { background-color: #fbbf24; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- TOAST CONTEXT ---
        window.addToastFn = null;
        const showToast = (msg, type = 'success') => { if (window.addToastFn) window.addToastFn(msg, type); };

        const ToastContainer = () => {
            const [toasts, setToasts] = useState([]);
            
            useEffect(() => {
                window.addToastFn = (msg, type) => {
                    const id = Date.now();
                    setToasts(prev => [...prev, { id, msg, type }]);
                    setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3000);
                };
            }, []);

            return (
                <div className="fixed top-4 right-4 z-50 flex flex-col gap-2 pointer-events-none">
                    {toasts.map(t => (
                        <div key={t.id} className={`toast-enter px-4 py-3 rounded-xl shadow-lg flex items-center gap-2 text-white font-medium pointer-events-auto ${t.type === 'success' ? 'bg-green-600' : 'bg-red-600'}`}>
                            <i className={`fas ${t.type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}`}></i>
                            {t.msg}
                        </div>
                    ))}
                </div>
            );
        };

        // --- DATA MANAGER ---
        const DataManager = {
            isCloud: () => typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser !== null,
            get: async (collectionName) => {
                if (DataManager.isCloud()) {
                    try {
                        const uid = firebase.auth().currentUser.uid;
                        const snapshot = await firebase.firestore().collection(collectionName).where("userId", "==", uid).get();
                        if (snapshot.empty) return DataManager.getLocal(collectionName);
                        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    } catch (e) { return DataManager.getLocal(collectionName); }
                } else { return DataManager.getLocal(collectionName); }
            },
            save: async (collectionName, item) => {
                const localData = DataManager.saveLocal(collectionName, item);
                if (DataManager.isCloud()) {
                    try {
                        const uid = firebase.auth().currentUser.uid;
                        const itemWithUser = { ...item, userId: uid };
                        const docId = item.id || Date.now().toString();
                        await firebase.firestore().collection(collectionName).doc(docId).set(itemWithUser);
                        const snapshot = await firebase.firestore().collection(collectionName).where("userId", "==", uid).get();
                        return { success: true, data: snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })) };
                    } catch (e) { return { success: false, data: localData }; }
                }
                return { success: false, data: localData };
            },
            saveLocal: (key, item) => {
                const list = JSON.parse(localStorage.getItem(key) || '[]');
                const index = list.findIndex(i => i.id === item.id);
                if (index >= 0) list[index] = item; else list.push(item);
                localStorage.setItem(key, JSON.stringify(list));
                return list;
            },
            getLocal: (key) => JSON.parse(localStorage.getItem(key) || '[]'),
             delete: async (collectionName, id) => {
                const localData = DataManager.deleteLocal(collectionName, id);
                if (DataManager.isCloud()) { try { await firebase.firestore().collection(collectionName).doc(id).delete(); } catch(e) {} }
                return localData;
            },
            deleteLocal: (key, id) => {
                const list = JSON.parse(localStorage.getItem(key) || '[]');
                const newList = list.filter(i => i.id !== id);
                localStorage.setItem(key, JSON.stringify(newList));
                return newList;
            }
        };

        // --- PDF GENERATORS ---
        const PDFGenerator = {
            createInvoice: (appt, user) => {
                if (!window.jspdf) { showToast("PDF Library Loading...", 'error'); return; }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const primaryColor = [37, 99, 235];
                const businessName = user.businessName || user.name || "Notary Public";
                doc.setFontSize(22); doc.setTextColor(...primaryColor); doc.text("INVOICE", 160, 20);
                doc.setFontSize(10); doc.setTextColor(100); doc.text(`ID: ${appt.id.substring(0,8)}`, 160, 26); doc.text(`Date: ${new Date().toLocaleDateString()}`, 160, 31);
                doc.setFontSize(12); doc.setTextColor(0); doc.text(businessName.toUpperCase(), 20, 20);
                doc.setFontSize(10); doc.setTextColor(100); doc.text(user.phone || "", 20, 26); doc.text(user.email || "", 20, 31);
                if(user.address) doc.text(user.address, 20, 36);
                doc.setTextColor(0); doc.text("BILL TO:", 20, 55); 
                doc.setFontSize(14); doc.text(appt.clientName, 20, 62); 
                doc.setFontSize(10); doc.text(appt.location, 20, 68);
                doc.autoTable({ startY: 80, head: [['Description', 'Date', 'Amount']], body: [[appt.type || 'Notary Service', appt.date, `$${appt.fee}`]], theme: 'grid', headStyles: { fillColor: primaryColor } });
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(12); doc.text(`Total Due: $${appt.fee}`, 160, finalY, { align: 'right' });
                
                // --- BUSINESS LOGO/SEAL IF UPLOADED ---
                // Simplified for demo: Using text fallback if no image logic, but showing where it would go
                if(user.logoUrl) {
                    try {
                        doc.addImage(user.logoUrl, 'PNG', 20, 5, 30, 30); // Placeholder coords
                    } catch(e) { console.log("Image error", e); }
                }

                doc.save(`invoice_${appt.clientName}.pdf`);
                showToast("Invoice Downloaded");
            },
            createReport: (title, columns, data, filename) => {
                if (!window.jspdf) { showToast("PDF Library Loading...", 'error'); return; }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(18); doc.text(title, 14, 22);
                doc.setFontSize(10); doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 28);
                doc.autoTable({ startY: 35, head: [columns], body: data, theme: 'striped' });
                doc.save(filename);
                showToast("Report Downloaded");
            }
        };

        const STATE_DATABASE = { "CA": { "state": "California", "fees": { "acknowledgment": "$15", "jurat": "$15" }, "id_requirements": { "credible_witnesses": "1 known OR 2 with ID" }, "red_flags": ["No 'Notario Publico'"], "specialized": { "loan_signing": "Background Check", "apostille": "SOS Sacramento" } } }; 
        const COURSE_MODULES = [ { id: 1, title: "Authority", topic: "Commissioning authority." } ]; 
        const PERSONA = `ROLE: NOTARY MENTOR. TONE: Helpful.`;

        // --- COMPONENTS ---

        // 1. Modals & Helpers
        const TermsModal = ({ onClose }) => (
            <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 backdrop-blur-sm z-[100]">
                <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 animate-fade-in font-sans">
                    <div className="flex justify-between items-center mb-4 border-b pb-4">
                        <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2"><i className="fas fa-balance-scale text-blue-600"></i> Terms of Service</h2>
                        <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><i className="fas fa-times"></i></button>
                    </div>
                    <div className="text-sm text-gray-600 mb-6 space-y-3 max-h-[60vh] overflow-y-auto">
                        <p className="font-bold">Last Updated: February 2026</p>
                        <p><strong>1. Acceptance of Terms:</strong> By accessing and using NotaryOS, you accept and agree to be bound by the terms and provision of this agreement.</p>
                        <p><strong>2. Not Legal Advice:</strong> NotaryOS is a management and educational tool. The AI Trainer provides information based on general data. This tool does not constitute legal advice. Always verify with your official state handbook.</p>
                        <p><strong>3. User Responsibility:</strong> You are responsible for all notarial acts performed. NotaryOS is not liable for any errors, omissions, or legal actions resulting from your use of this software.</p>
                        <p><strong>4. Data Privacy:</strong> In this version, business data is stored locally on your device unless Cloud Sync is explicitly enabled.</p>
                    </div>
                    <button onClick={onClose} className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition-colors">I Understand & Agree</button>
                </div>
            </div>
        );

        const PricingModal = ({ onClose, onUpgrade }) => (
            <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 backdrop-blur-sm z-[100]">
                <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 text-center font-sans">
                    <h2 className="text-2xl font-bold mb-2">Upgrade to Pro</h2>
                    <p className="text-gray-500 mb-6">Unlock Unlimited AI, Cloud Sync & PDF Invoices.</p>
                    <button onClick={onUpgrade} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold mb-2">Get Pro - $19/mo</button>
                    <button onClick={onClose} className="text-gray-400 text-sm">Close</button>
                </div>
            </div>
        );

        const SettingsModal = ({ user, onClose, onSave }) => {
            const [data, setData] = useState(user || {});
            
            // Handle logo upload simulation
            const handleLogoUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setData({ ...data, logoUrl: reader.result }); // Save base64 string
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleSave = (e) => { e.preventDefault(); onSave(data); onClose(); showToast("Profile Updated"); };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 backdrop-blur-sm z-[100]">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 font-sans max-h-[90vh] overflow-y-auto">
                        <h3 className="font-bold text-lg mb-4">Business Profile</h3>
                        <form onSubmit={handleSave} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Your Name</label>
                                <input className="w-full p-2 border rounded" placeholder="Your Name" value={data.name || ''} onChange={e => setData({...data, name: e.target.value})} />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Business Name</label>
                                <input className="w-full p-2 border rounded" placeholder="Business Name" value={data.businessName || ''} onChange={e => setData({...data, businessName: e.target.value})} />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Business Logo / Seal</label>
                                <div className="flex items-center gap-4">
                                    {data.logoUrl && <img src={data.logoUrl} alt="Logo Preview" className="w-12 h-12 object-contain border rounded" />}
                                    <input type="file" accept="image/*" onChange={handleLogoUpload} className="text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                                </div>
                                <p className="text-xs text-gray-400 mt-1">Used on invoices and reports.</p>
                            </div>
                             <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Gemini API Key (Optional)</label>
                                <input className="w-full p-2 border rounded font-mono text-sm" type="password" placeholder="AI Key for Smart Fill" value={data.apiKey || ''} onChange={e => { setData({...data, apiKey: e.target.value}); localStorage.setItem('gemini_api_key', e.target.value); }} />
                                <p className="text-xs text-gray-400 mt-1">Required for AI features to work fully.</p>
                            </div>
                            <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">Save Profile</button>
                            <button type="button" onClick={onClose} className="w-full text-gray-500 py-2">Cancel</button>
                        </form>
                    </div>
                </div>
            );
        };

        const AIHelperModal = ({ onClose }) => {
            const [input, setInput] = useState('');
            const [messages, setMessages] = useState([{ role: 'assistant', content: "ðŸ‘‹ Hi! Ask me about notary laws." }]);
            const [loading, setLoading] = useState(false);
            
            const handleSend = async () => {
                if (!input.trim()) return;
                const newMsgs = [...messages, { role: 'user', content: input }];
                setMessages(newMsgs);
                setInput('');
                setLoading(true);
                
                const apiKey = localStorage.getItem('gemini_api_key');
                if (!apiKey) {
                     setTimeout(() => {
                        setMessages([...newMsgs, { role: 'assistant', content: "Please add your API Key in Settings to enable AI responses." }]);
                        setLoading(false);
                    }, 800);
                    return;
                }

                try {
                     const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: `You are a helpful Notary Assistant. Answer concisely. User Query: ${input}` }] }] }) });
                     const data = await response.json();
                     const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Error.";
                     setMessages([...newMsgs, { role: 'assistant', content: aiText }]);
                } catch(e) { setMessages([...newMsgs, { role: 'assistant', content: "Error connecting to AI." }]); }
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none font-sans">
                    <div className="bg-white w-full sm:w-96 h-[60vh] shadow-2xl rounded-t-2xl sm:rounded-2xl flex flex-col pointer-events-auto border border-gray-200">
                        <div className="p-4 border-b flex justify-between bg-indigo-600 text-white rounded-t-2xl"><h3 className="font-bold">Quick Assist</h3><button onClick={onClose}>x</button></div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                            {messages.map((m, i) => <div key={i} className={`p-3 rounded-lg text-sm ${m.role === 'user' ? 'bg-indigo-100 ml-8' : 'bg-white mr-8 border'}`}>{m.content}</div>)}
                            {loading && <div className="text-xs text-gray-400">Thinking...</div>}
                        </div>
                        <div className="p-3 border-t bg-white flex gap-2"><input className="flex-1 p-2 border rounded" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSend()} /><button onClick={handleSend} className="bg-indigo-600 text-white w-10 rounded">></button></div>
                    </div>
                </div>
            );
        };

        // NEW: Reusable Empty State Component
        const EmptyState = ({ icon, title, description, actionLabel, onAction, colorClass = "text-blue-600", bgClass = "bg-blue-50" }) => (
            <div className="flex flex-col items-center justify-center py-20 px-6 text-center animate-fade-in bg-white rounded-2xl border border-gray-100 shadow-sm font-sans">
                <div className={`w-20 h-20 ${bgClass} ${colorClass} rounded-full flex items-center justify-center mb-6 text-3xl shadow-inner`}><i className={`fas ${icon}`}></i></div>
                <h3 className="text-xl font-bold text-gray-800 mb-2">{title}</h3>
                <p className="text-gray-500 max-w-xs mb-8 leading-relaxed text-sm">{description}</p>
                {onAction && <button onClick={onAction} className={`px-8 py-3 ${colorClass.replace('text', 'bg')} text-white rounded-xl font-bold shadow-lg transform transition-all hover:scale-105 active:scale-95`}>{actionLabel}</button>}
            </div>
        );

        const OnboardingTour = ({ onComplete }) => (
            <div className="fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
                <div className="bg-white rounded-2xl p-8 text-center max-w-sm font-sans">
                    <div className="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">ðŸš€</div>
                    <h2 className="text-2xl font-bold mb-2">Welcome to NotaryOS</h2>
                    <p className="text-gray-500 mb-6">Your all-in-one business operating system. Manage appointments, journals, and clients in one place.</p>
                    <button onClick={onComplete} className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg">Get Started</button>
                </div>
            </div>
        );

        const LandingPage = ({ onNavigate }) => {
            const [activeTab, setActiveTab] = useState('before'); // 'before' or 'after'
            const [weeklyAppts, setWeeklyAppts] = useState(5);
            const [adminMins, setAdminMins] = useState(20);
            const [billing, setBilling] = useState('monthly');
            const [demoQuestion, setDemoQuestion] = useState("");
            const [demoResponse, setDemoResponse] = useState(null);
            
            const hoursSaved = Math.round((weeklyAppts * adminMins * 52) / 60);
            const dollarsSaved = (hoursSaved * 50).toLocaleString(); // Assuming $50/hr value
            
            const handleDemoAsk = (e) => {
                e.preventDefault();
                setDemoResponse("loading");
                setTimeout(() => {
                    setDemoResponse("In California, the maximum fee for a jurat is $15 per signature, including the oath or affirmation. Always check the latest handbook!");
                }, 1500);
            };

            return (
                <div className="min-h-screen landing-bg text-white font-inter flex flex-col relative overflow-hidden">
                    <div className="w-full p-6 flex justify-between items-center z-20 container mx-auto bg-slate-900/80 backdrop-blur-md border-b border-slate-800/50">
                        <div className="flex items-center gap-2">
                            <i className="fas fa-file-signature text-xl text-teal-400"></i>
                            <h1 className="text-xl font-bold tracking-tight font-sans">NotaryOS</h1>
                        </div>
                        <button onClick={onNavigate} className="text-gray-300 hover:text-white font-medium text-sm transition-colors border border-gray-600 hover:border-gray-400 px-4 py-2 rounded-lg font-sans">Log In</button>
                    </div>

                    <div className="flex-1 flex flex-col justify-center items-center text-center px-6 relative z-10 py-20">
                        <h1 className="text-5xl md:text-7xl font-extrabold mb-6 leading-tight tracking-tight max-w-5xl drop-shadow-2xl font-sans">
                            Drowning in paperwork? <br />
                            <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-blue-500">Chasing payments?</span>
                        </h1>
                        <p className="text-lg text-slate-300 mb-10 max-w-2xl leading-relaxed">
                            Stop worrying about state compliance. NotaryOS handles it allâ€”so you can focus on signings, not spreadsheets.
                        </p>
                        <button onClick={onNavigate} className="bg-teal-500 hover:bg-teal-600 text-white px-10 py-4 rounded-xl font-bold text-lg shadow-xl shadow-teal-500/20 transition-all transform hover:-translate-y-1 font-sans">
                            Start Free Trial
                        </button>
                    </div>
                    
                    {/* RESTORED AI Hero Feature Section */}
                    <div className="w-full bg-slate-900/50 border-y border-slate-800 py-20 relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-full bg-blue-500/5 blur-[100px] pointer-events-none"></div>
                        <div className="max-w-6xl mx-auto px-6 grid md:grid-cols-2 gap-12 items-center relative z-10">
                            <div className="text-left">
                                <div className="inline-block bg-teal-900/30 text-teal-300 px-3 py-1 rounded-full text-xs font-bold mb-4 border border-teal-500/30 font-sans">
                                    NEW: AI COMPLIANCE COACH
                                </div>
                                <h2 className="text-3xl md:text-4xl font-bold mb-4 leading-tight font-sans">
                                    Your personal compliance expert, <span className="text-teal-400">available 24/7.</span>
                                </h2>
                                <p className="text-slate-400 text-lg mb-8 leading-relaxed">
                                    Not just softwareâ€”it's a mentor. Get instant answers to state-specific questions, fee limits, and ID rules without searching through a 100-page handbook.
                                </p>
                                <form onSubmit={handleDemoAsk} className="relative font-sans">
                                    <input 
                                        type="text" 
                                        placeholder="e.g. What's the fee for a jurat in California?" 
                                        className="w-full bg-slate-800 border border-slate-700 rounded-xl py-4 px-6 text-white focus:outline-none focus:border-teal-500 focus:ring-1 focus:ring-teal-500 transition-all shadow-lg"
                                        value={demoQuestion}
                                        onChange={(e) => setDemoQuestion(e.target.value)}
                                    />
                                    <button type="submit" className="absolute right-2 top-2 bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded-lg font-bold text-sm transition-colors">
                                        Ask AI
                                    </button>
                                </form>
                            </div>
                            
                            <div className="ai-glow-box bg-slate-800/80 backdrop-blur-xl rounded-2xl p-6 border border-slate-700/50 shadow-2xl relative">
                                <div className="flex items-center gap-3 mb-6 border-b border-slate-700 pb-4">
                                    <div className="w-10 h-10 bg-teal-500 rounded-full flex items-center justify-center text-white"><i className="fas fa-robot"></i></div>
                                    <div>
                                        <h4 className="font-bold text-white font-sans">NotaryOS AI</h4>
                                        <div className="flex items-center gap-1.5 font-sans">
                                            <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                                            <span className="text-xs text-slate-400">Online Now</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="space-y-4 font-sans">
                                    <div className="flex justify-end">
                                        <div className="bg-blue-600 text-white px-4 py-3 rounded-2xl rounded-tr-none text-sm max-w-[80%] shadow-md">
                                            What's the fee for a jurat in California?
                                        </div>
                                    </div>
                                    
                                    {(demoResponse || true) && (
                                        <div className="flex justify-start">
                                             <div className="bg-slate-700 text-slate-200 px-4 py-3 rounded-2xl rounded-tl-none text-sm max-w-[90%] shadow-md border border-slate-600">
                                                {demoResponse === "loading" ? (
                                                    <div className="flex gap-1.5 py-1">
                                                        <span className="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></span>
                                                        <span className="w-2 h-2 bg-slate-400 rounded-full animate-bounce delay-100"></span>
                                                        <span className="w-2 h-2 bg-slate-400 rounded-full animate-bounce delay-200"></span>
                                                    </div>
                                                ) : (
                                                    demoResponse || "That depends on your state laws. For California, the maximum fee for a jurat is $15 per signature, including the oath or affirmation."
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Pain vs Power Section - Alternating Background: Dark Slate 800 */}
                    <div className="bg-slate-800 py-20 border-t border-slate-700 font-sans">
                        <div className="max-w-6xl mx-auto px-6 grid md:grid-cols-2 gap-12 items-center">
                            <div className="space-y-6">
                                <h3 className="text-3xl font-bold text-white">Before & After</h3>
                                <div className="flex bg-slate-900/50 p-1 rounded-xl mb-6 w-fit border border-slate-700">
                                    <button onClick={() => setActiveTab('before')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'before' ? 'bg-red-500/20 text-red-400 shadow-sm' : 'text-slate-500 hover:text-slate-300'}`}>The Old Way</button>
                                    <button onClick={() => setActiveTab('after')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'after' ? 'bg-teal-500/20 text-teal-400 shadow-sm' : 'text-slate-500 hover:text-slate-300'}`}>With NotaryOS</button>
                                </div>
                                
                                {activeTab === 'before' ? (
                                    <div className="space-y-4 animate-fade-in">
                                        <div className="flex items-start gap-4 p-4 rounded-xl bg-red-900/10 border border-red-900/30">
                                            <div className="w-10 h-10 rounded-full bg-red-900/30 flex items-center justify-center text-red-400 shrink-0"><i className="fas fa-file-invoice-dollar"></i></div>
                                            <div><h4 className="font-bold text-red-200">Lost Invoices</h4><p className="text-sm text-slate-400">Tracking payments in Excel or paper logs leads to missed revenue.</p></div>
                                        </div>
                                        <div className="flex items-start gap-4 p-4 rounded-xl bg-red-900/10 border border-red-900/30">
                                            <div className="w-10 h-10 rounded-full bg-red-900/30 flex items-center justify-center text-red-400 shrink-0"><i className="fas fa-exclamation-triangle"></i></div>
                                            <div><h4 className="font-bold text-red-200">Compliance Risks</h4><p className="text-sm text-slate-400">Guessing fees or ID rules can cost you your commission.</p></div>
                                        </div>
                                        <div className="flex items-start gap-4 p-4 rounded-xl bg-red-900/10 border border-red-900/30">
                                            <div className="w-10 h-10 rounded-full bg-red-900/30 flex items-center justify-center text-red-400 shrink-0"><i className="fas fa-clock"></i></div>
                                            <div><h4 className="font-bold text-red-200">Admin Overload</h4><p className="text-sm text-slate-400">Spending hours manually entering journal data after every signing.</p></div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="space-y-4 animate-fade-in">
                                        <div className="flex items-start gap-4 p-4 rounded-xl bg-teal-900/10 border border-teal-900/30">
                                            <div className="w-10 h-10 rounded-full bg-teal-900/30 flex items-center justify-center text-teal-400 shrink-0"><i className="fas fa-magic"></i></div>
                                            <div><h4 className="font-bold text-teal-200">One-Click Invoicing</h4><p className="text-sm text-slate-400">Generate professional PDF invoices instantly from your appointment data.</p></div>
                                        </div>
                                        <div className="flex items-start gap-4 p-4 rounded-xl bg-teal-900/10 border border-teal-900/30">
                                            <div className="w-10 h-10 rounded-full bg-teal-900/30 flex items-center justify-center text-teal-400 shrink-0"><i className="fas fa-robot"></i></div>
                                            <div><h4 className="font-bold text-teal-200">AI Guardian</h4><p className="text-sm text-slate-400">Your personal compliance coach answers state law questions 24/7.</p></div>
                                        </div>
                                        <div className="flex items-start gap-4 p-4 rounded-xl bg-teal-900/10 border border-teal-900/30">
                                            <div className="w-10 h-10 rounded-full bg-teal-900/30 flex items-center justify-center text-teal-400 shrink-0"><i className="fas fa-cloud-upload-alt"></i></div>
                                            <div><h4 className="font-bold text-teal-200">Cloud Sync</h4><p className="text-sm text-slate-400">Start on your phone at the signing table, finish on your laptop at home.</p></div>
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className="bg-slate-900 p-8 rounded-2xl border border-slate-700 shadow-2xl">
                                <h4 className="text-xl font-bold text-white mb-6 text-center">Calculate Your Lost Time</h4>
                                <div className="space-y-4">
                                    <div>
                                        <div className="flex justify-between mb-2">
                                            <label className="text-xs font-bold text-slate-400 uppercase">Weekly Appointments</label>
                                            <span className="text-teal-400 font-bold">{weeklyAppts}</span>
                                        </div>
                                        <input type="range" min="1" max="50" value={weeklyAppts} onChange={e=>setWeeklyAppts(e.target.value)} className="w-full accent-teal-500 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
                                    </div>
                                    <div>
                                        <div className="flex justify-between mb-2">
                                            <label className="text-xs font-bold text-slate-400 uppercase">Admin Mins per Appt</label>
                                            <span className="text-teal-400 font-bold">{adminMins} min</span>
                                        </div>
                                        <input type="range" min="5" max="60" value={adminMins} onChange={e=>setAdminMins(e.target.value)} className="w-full accent-teal-500 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
                                    </div>
                                    <div className="pt-6 border-t border-slate-700 mt-4 text-center">
                                        <p className="text-sm text-slate-400">You could save</p>
                                        <div className="text-4xl font-extrabold text-white mb-2">{hoursSaved} Hours<span className="text-lg text-slate-500 font-normal">/yr</span></div>
                                        <div className="inline-block bg-teal-900/30 text-teal-400 px-3 py-1 rounded-full text-xs font-bold border border-teal-500/30">
                                            That's ${dollarsSaved} in billable time!
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Mobile-First Demo Section - Alternating Background: Dark Slate 900 */}
                    <div className="py-24 bg-slate-900 w-full border-t border-slate-800 font-sans">
                        <div className="max-w-6xl mx-auto px-6 grid md:grid-cols-2 gap-16 items-center">
                            <div className="order-2 md:order-1 flex justify-center">
                                <div className="phone-mockup w-[300px] h-[600px] bg-white border-8 border-gray-800 rounded-[3rem] shadow-2xl relative overflow-hidden">
                                    <div className="phone-notch"></div>
                                    <div className="h-full bg-gray-50 pt-10 px-4 relative">
                                        {/* Simulated Mobile App UI */}
                                        <div className="flex justify-between items-center mb-6">
                                            <h3 className="font-bold text-lg text-gray-800">Today</h3>
                                            <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-xs font-bold">JD</div>
                                        </div>
                                        <div className="space-y-3">
                                            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                                <div className="flex justify-between mb-2">
                                                    <span className="text-xs font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded">LOAN SIGNING</span>
                                                    <span className="text-xs text-gray-400">2:00 PM</span>
                                                </div>
                                                <h4 className="font-bold text-gray-800">Sarah Johnson</h4>
                                                <p className="text-xs text-gray-500 mt-1">123 Maple Dr, Seattle</p>
                                            </div>
                                            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                                <div className="flex justify-between mb-2">
                                                    <span className="text-xs font-bold text-purple-500 bg-purple-50 px-2 py-1 rounded">DEED</span>
                                                    <span className="text-xs text-gray-400">4:30 PM</span>
                                                </div>
                                                <h4 className="font-bold text-gray-800">Mike Chen</h4>
                                                <p className="text-xs text-gray-500 mt-1">Starbucks, 4th Ave</p>
                                            </div>
                                        </div>
                                        
                                        {/* Notification Popup */}
                                        <div className="absolute top-20 left-4 right-4 bg-gray-900/90 backdrop-blur text-white p-3 rounded-xl shadow-lg border border-gray-700 animate-bounce flex items-center gap-3">
                                            <div className="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center"><i className="fas fa-check"></i></div>
                                            <div>
                                                <p className="text-xs font-bold">Payment Received</p>
                                                <p className="text-[10px] text-gray-300">$150.00 from Sarah Johnson</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="order-1 md:order-2">
                                <h3 className="text-3xl font-bold text-white mb-6">Run your business from your pocket.</h3>
                                <p className="text-slate-400 text-lg mb-8 leading-relaxed">
                                    Mobile notaries are constantly on the road. NotaryOS is designed to work flawlessly on your phone, so you can manage your schedule, log journal entries, and send invoices between appointments.
                                </p>
                                <ul className="space-y-4">
                                    <li className="flex items-center gap-3 text-slate-300">
                                        <div className="w-6 h-6 rounded-full bg-teal-500/20 text-teal-400 flex items-center justify-center text-xs"><i className="fas fa-mobile-alt"></i></div>
                                        Responsive design fits any screen
                                    </li>
                                    <li className="flex items-center gap-3 text-slate-300">
                                        <div className="w-6 h-6 rounded-full bg-teal-500/20 text-teal-400 flex items-center justify-center text-xs"><i className="fas fa-map-marker-alt"></i></div>
                                        Access client addresses instantly
                                    </li>
                                    <li className="flex items-center gap-3 text-slate-300">
                                        <div className="w-6 h-6 rounded-full bg-teal-500/20 text-teal-400 flex items-center justify-center text-xs"><i className="fas fa-bell"></i></div>
                                        Real-time notifications
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    {/* Pricing Section - Alternating Background: Dark Slate 800 */}
                    <div className="bg-slate-800 py-24 w-full border-t border-slate-700 font-sans">
                        <div className="max-w-6xl mx-auto px-6">
                            <div className="text-center mb-10">
                                <h3 className="text-3xl font-bold text-white mb-4">Simple, Transparent Pricing</h3>
                                <p className="text-slate-400 mb-8">Everything you need to grow your business.</p>
                                
                                {/* Billing Toggle */}
                                <div className="inline-flex bg-slate-900 p-1 rounded-xl border border-slate-700 relative">
                                    <button onClick={() => setBilling('monthly')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${billing === 'monthly' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-400 hover:text-white'}`}>Monthly</button>
                                    <button onClick={() => setBilling('yearly')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${billing === 'yearly' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-400 hover:text-white'}`}>Yearly</button>
                                    {billing === 'yearly' && <span className="absolute -top-3 -right-3 bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-lg animate-bounce">SAVE 20%</span>}
                                </div>
                            </div>
                            <div className="grid md:grid-cols-3 gap-8 items-center">
                                {/* Free Plan */}
                                <div className="visual-card p-8 rounded-2xl flex flex-col bg-slate-900/50 border border-slate-700 h-fit">
                                    <h4 className="text-xl font-bold text-white mb-2">Starter</h4>
                                    <p className="text-xs text-slate-400 mb-4">For the side-hustle notary.</p>
                                    <div className="text-4xl font-bold text-white mb-6">$0<span className="text-sm text-slate-400 font-normal">/mo</span></div>
                                    <ul className="space-y-3 mb-8 text-slate-300 text-sm flex-1">
                                        <li className="flex gap-2"><i className="fas fa-check text-green-400"></i> 5 Appointments/mo</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-green-400"></i> Basic Journal</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-green-400"></i> Local Storage Only</li>
                                    </ul>
                                    <button onClick={onNavigate} className="w-full py-3 rounded-xl border border-slate-600 text-white hover:bg-slate-700 transition-colors">Get Started</button>
                                </div>
                                
                                {/* Pro Plan */}
                                <div className="visual-card p-8 rounded-2xl flex flex-col relative border-teal-500 bg-slate-900 shadow-2xl shadow-teal-900/20 transform scale-105 z-10">
                                    <div className="absolute top-0 right-0 bg-teal-500 text-white text-xs font-bold px-3 py-1 rounded-bl-xl rounded-tr-xl">BEST VALUE</div>
                                    <h4 className="text-xl font-bold text-white mb-2">Pro</h4>
                                    <p className="text-xs text-slate-400 mb-4">For the full-time professional.</p>
                                    <div className="text-4xl font-bold text-white mb-6">${billing === 'monthly' ? '19' : '15'}<span className="text-sm text-slate-400 font-normal">/mo</span></div>
                                    <ul className="space-y-3 mb-8 text-slate-300 text-sm flex-1">
                                        <li className="flex gap-2"><i className="fas fa-check text-teal-400"></i> Unlimited Appointments</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-teal-400"></i> Cloud Sync & Backups</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-teal-400"></i> AI Compliance Coach</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-teal-400"></i> PDF Invoicing</li>
                                    </ul>
                                    <button onClick={onNavigate} className="w-full py-3 rounded-xl bg-teal-500 text-white hover:bg-teal-600 transition-colors font-bold shadow-lg shadow-teal-500/20">Start 7-Day Trial</button>
                                </div>

                                {/* Enterprise */}
                                <div className="visual-card p-8 rounded-2xl flex flex-col bg-slate-900/50 border border-slate-700 h-fit">
                                    <h4 className="text-xl font-bold text-white mb-2">Agency</h4>
                                    <p className="text-xs text-slate-400 mb-4">For scaling your signing service.</p>
                                    <div className="text-4xl font-bold text-white mb-6">${billing === 'monthly' ? '49' : '39'}<span className="text-sm text-slate-400 font-normal">/mo</span></div>
                                    <ul className="space-y-3 mb-8 text-slate-300 text-sm flex-1">
                                        <li className="flex gap-2"><i className="fas fa-check text-green-400"></i> Everything in Pro</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-green-400"></i> Multi-User Support</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-green-400"></i> API Access</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-green-400"></i> Priority Support</li>
                                    </ul>
                                    <button className="w-full py-3 rounded-xl border border-slate-600 text-white hover:bg-slate-700 transition-colors">Contact Sales</button>
                                </div>
                            </div>
                        </div>
                        <div className="text-center mt-16 text-xs text-slate-500 border-t border-slate-700 pt-8 mx-6">
                            &copy; 2026 NotaryOS Inc. All rights reserved.
                        </div>
                    </div>
                </div>
            );
        };

        // 2. Auth Screen (Redesigned + Terms)
        const AuthScreen = ({ onAuth, onBack }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [formData, setFormData] = useState({ name: '', email: '', password: '' });
            const [showTermsModal, setShowTermsModal] = useState(false);
            const [error, setError] = useState('');

            const handleAuth = (e) => {
                e.preventDefault();
                setError('');
                onAuth({ id: '1', name: isLogin ? 'User' : formData.name, email: formData.email, plan: 'free' });
            };
            
            const handleGoogleAuth = async () => { try { const provider = new firebase.auth.GoogleAuthProvider(); await firebase.auth().signInWithPopup(provider); } catch (err) { setError(err.message); } };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4 font-inter">
                    {showTermsModal && <TermsModal onClose={() => setShowTermsModal(false)} onAccept={() => setShowTermsModal(false)} />}
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl flex overflow-hidden min-h-[600px] animate-fade-in">
                        <div className="w-1/2 bg-slate-900 text-white p-12 hidden md:flex flex-col justify-center relative overflow-hidden"><button onClick={onBack} className="absolute top-8 left-8 text-slate-400 hover:text-white flex items-center gap-2 text-sm font-medium z-20"><i className="fas fa-arrow-left"></i> Back</button><div className="absolute -top-20 -right-20 w-64 h-64 bg-blue-600/20 rounded-full blur-3xl"></div><div className="absolute -bottom-20 -left-20 w-64 h-64 bg-purple-600/20 rounded-full blur-3xl"></div><div className="relative z-10"><div className="mb-6"><div className="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center text-2xl mb-4 shadow-lg shadow-blue-500/30"><i className="fas fa-user-tie"></i></div><h1 className="text-4xl font-bold mb-2">NotaryOS</h1><p className="text-blue-200 text-lg">The Operating System for Modern Notaries.</p></div><div className="space-y-4 mt-8"><div className="flex items-center gap-3"><i className="fas fa-check-circle text-emerald-400 text-xl"></i><span className="font-medium">Business Management Suite</span></div><div className="flex items-center gap-3"><i className="fas fa-check-circle text-emerald-400 text-xl"></i><span className="font-medium">AI-Powered Compliance Coach</span></div><div className="flex items-center gap-3"><i className="fas fa-check-circle text-emerald-400 text-xl"></i><span className="font-medium">50-State Law Database</span></div></div></div></div>
                        <div className="w-full md:w-1/2 p-12 flex flex-col justify-center"><div className="max-w-sm mx-auto w-full"><h2 className="text-3xl font-bold text-slate-900 mb-8">{isLogin ? 'Welcome Back' : 'Create Account'}</h2>{error && <div className="bg-red-100 text-red-700 p-3 rounded mb-4 text-xs">{error}</div>}<form onSubmit={handleAuth} className="space-y-5">{!isLogin && (<div><label className="block text-xs font-bold text-slate-500 uppercase mb-2 tracking-wide">Full Name</label><input type="text" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" value={formData.name} onChange={e=>setFormData({...formData, name: e.target.value})} placeholder="Jane Doe" /></div>)}<div><label className="block text-xs font-bold text-slate-500 uppercase mb-2 tracking-wide">Email Address</label><input type="email" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" value={formData.email} onChange={e=>setFormData({...formData, email: e.target.value})} placeholder="name@example.com" /></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-2 tracking-wide">Password</label><input type="password" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-xl tracking-widest" value={formData.password} onChange={e=>setFormData({...formData, password: e.target.value})} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" /></div><button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-lg shadow-md transition-all transform active:scale-95 mt-4">{isLogin ? 'Sign In' : 'Create Account'}</button></form><div className="relative flex py-6 items-center"><div className="flex-grow border-t border-slate-200"></div><span className="flex-shrink-0 mx-4 text-slate-400 text-xs font-medium uppercase">OR</span><div className="flex-grow border-t border-slate-200"></div></div><button className="w-full bg-white border border-slate-200 text-slate-700 font-bold py-3.5 rounded-lg hover:bg-slate-50 transition-all flex items-center justify-center gap-2 shadow-sm"><i className="fab fa-google text-red-500 text-lg"></i><span>Continue with Google</span></button><div className="mt-8 text-center text-sm text-slate-500">{isLogin ? "New to NotaryOS?" : "Already have an account?"} <button onClick={() => setIsLogin(!isLogin)} className="text-blue-600 font-bold hover:underline ml-1">{isLogin ? 'Create Account' : 'Log In'}</button></div>
                            <div className="mt-8 pt-4 border-t border-slate-100 text-xs text-center text-slate-400">
                                By continuing, you agree to our 
                                <button onClick={() => setShowTermsModal(true)} className="underline cursor-pointer hover:text-slate-600 ml-1">Terms of Service</button>.
                            </div>
                        </div></div>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ currentView, setView, isOpen, onClose, onLogout, userName, userPlan, onSettings }) => {
            const [isCollapsed, setIsCollapsed] = useState(false);
            const menuItems = [
                { id: 'dashboard', icon: 'fa-chart-pie', label: 'Dashboard', color: 'text-blue-400' },
                { id: 'schedule', icon: 'fa-calendar-alt', label: 'Schedule', color: 'text-green-400' },
                { id: 'clients', icon: 'fa-address-book', label: 'Clients', color: 'text-pink-400' },
                { id: 'journal', icon: 'fa-book', label: 'Journal', color: 'text-purple-400' },
                { id: 'finances', icon: 'fa-wallet', label: 'Finances', color: 'text-emerald-400' },
                { id: 'credentials', icon: 'fa-id-card', label: 'Credentials', color: 'text-orange-400' },
                { id: 'trainer', icon: 'fa-robot', label: 'AI Trainer', color: 'text-indigo-400', isPro: true },
                { id: 'admin', icon: 'fa-shield-alt', label: 'Admin', color: 'text-red-500' }
            ];

            return (
                <>
                    <div className={`fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden ${isOpen ? 'block' : 'hidden'}`} onClick={onClose}></div>
                    <div className={`fixed inset-y-0 left-0 bg-slate-900 text-white z-50 transform transition-all duration-300 ease-in-out lg:static lg:flex lg:flex-col ${isOpen ? 'translate-x-0' : '-translate-x-full'} ${isCollapsed ? 'w-20' : 'w-64'} lg:translate-x-0`}>
                        <div className="p-4 flex justify-between items-center border-b border-slate-700 h-16">
                            {!isCollapsed && <span className="font-bold text-xl">NotaryOS</span>}
                            <button onClick={() => setIsCollapsed(!isCollapsed)} className="hidden lg:block text-gray-400 hover:text-white"><i className={`fas ${isCollapsed ? 'fa-chevron-right' : 'fa-chevron-left'}`}></i></button>
                            <button onClick={onClose} className="lg:hidden text-gray-400"><i className="fas fa-times"></i></button>
                        </div>
                        <nav className="flex-1 p-2 space-y-2 overflow-y-auto">
                            {menuItems.map(item => (
                                <button key={item.id} onClick={() => { setView(item.id); onClose(); }} className={`w-full flex items-center gap-3 px-3 py-3 rounded-xl transition-colors hover:bg-slate-800 ${currentView === item.id ? 'bg-blue-600 text-white' : 'text-gray-400'} ${isCollapsed ? 'justify-center' : ''}`} title={item.label}>
                                    <i className={`fas ${item.icon} text-lg ${currentView !== item.id ? item.color : ''}`}></i>
                                    {!isCollapsed && <span className="text-sm font-medium">{item.label}</span>}
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-slate-700">
                             <button onClick={onSettings} className={`w-full flex items-center gap-3 px-3 py-2 mb-2 hover:bg-slate-800 rounded transition-colors group ${isCollapsed ? 'justify-center' : ''}`}>
                                <div className="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-blue-300 flex-shrink-0">{userName ? userName.substring(0,2).toUpperCase() : 'US'}</div>
                                {!isCollapsed && (
                                    <div className="flex-1 overflow-hidden text-left">
                                        <p className="text-xs font-bold truncate group-hover:text-white">{userName || 'User'}</p>
                                        <p className="text-[10px] text-slate-400 capitalize">{userPlan} Plan</p>
                                    </div>
                                )}
                                {!isCollapsed && <i className="fas fa-cog text-slate-500 group-hover:text-white ml-auto"></i>}
                            </button>
                             <button onClick={onLogout} className={`w-full flex items-center gap-2 text-red-400 hover:text-white ${isCollapsed ? 'justify-center' : ''}`}><i className="fas fa-sign-out-alt"></i> {!isCollapsed && "Logout"}</button>
                        </div>
                    </div>
                </>
            );
        };

        const MobileNav = ({ setView, onOpenMenu }) => (
            <div className="md:hidden fixed bottom-0 w-full bg-white border-t p-2 flex justify-around z-30 safe-area-pb shadow-lg">
                <button onClick={() => setView('dashboard')}><i className="fas fa-home text-blue-500 text-xl"></i></button>
                <button onClick={() => setView('schedule')}><i className="fas fa-calendar-alt text-green-500 text-xl"></i></button>
                <button onClick={() => setView('addAppointment')} className="-mt-8 bg-blue-600 text-white rounded-full p-3 shadow-lg"><i className="fas fa-plus text-xl"></i></button>
                <button onClick={() => setView('trainer')}><i className="fas fa-robot text-indigo-500 text-xl"></i></button>
                <button onClick={onOpenMenu}><i className="fas fa-bars text-gray-500 text-xl"></i></button>
            </div>
        );

        const Header = ({ title }) => (
            <div className="bg-white border-b p-4 flex justify-between items-center z-20">
                <h2 className="font-bold text-gray-800 text-lg">{title}</h2>
                <div className="flex gap-3">
                    <button className="text-gray-400"><i className="fas fa-bell"></i></button>
                </div>
            </div>
        );

        // --- CORE MODULES ---
        
        // CLIENTS MODULE
        const Clients = () => {
            const [clients, setClients] = useState([]);
            const [showForm, setShowForm] = useState(false);
            useEffect(() => { DataManager.get('notary_clients').then(setClients); }, []);
            const handleSave = async (e) => { e.preventDefault(); const fd = new FormData(e.target); await DataManager.save('notary_clients', { id: Date.now().toString(), name: fd.get('name'), phone: fd.get('phone'), email: fd.get('email'), address: fd.get('address'), notes: fd.get('notes') }); setShowForm(false); setClients(await DataManager.get('notary_clients')); showToast("Client Saved"); };
            const handleDelete = async (id) => { await DataManager.delete('notary_clients', id); setClients(await DataManager.get('notary_clients')); showToast("Client Deleted", 'error'); };
            
            return (
                <div className="p-6 pb-24">
                     <div className="flex justify-between mb-4"><h3 className="font-bold text-lg text-gray-800">Client Directory</h3><button onClick={()=>setShowForm(true)} className="bg-pink-600 text-white px-3 py-1 rounded">Add</button></div>
                    {showForm && <form onSubmit={handleSave} className="bg-white p-4 rounded shadow mb-4"><input name="name" placeholder="Name" className="w-full border p-2 mb-2 rounded" required /><input name="phone" placeholder="Phone" className="w-full border p-2 mb-2 rounded" /><button className="bg-pink-600 text-white px-4 py-2 rounded">Save</button></form>}
                    <div className="space-y-3">
                        {clients.length === 0 ? (
                            <EmptyState 
                                icon="fa-address-book"
                                title="No Clients Yet"
                                description="Start building your digital rolodex. Add your first client to keep their details handy for future signings."
                                actionLabel="Add Client"
                                onAction={() => setShowForm(true)}
                                colorClass="text-pink-600"
                                bgClass="bg-pink-50"
                            />
                        ) : clients.map(c => <div key={c.id} className="bg-white p-3 rounded shadow"><div className="flex justify-between"><b>{c.name}</b><button onClick={() => handleDelete(c.id)} className="text-red-500"><i className="fas fa-trash"></i></button></div><p className="text-sm text-gray-500">{c.phone}</p></div>)}
                    </div>
                </div>
            );
        };

        // Feature #1: Income Chart
        const IncomeChart = ({ appointments }) => {
            const canvasRef = useRef(null);
            
            useEffect(() => {
                if (!canvasRef.current) return;
                const ctx = canvasRef.current.getContext('2d');
                
                // Group by Month
                const monthlyData = {};
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                months.forEach(m => monthlyData[m] = 0);
                
                appointments.forEach(a => {
                    const date = new Date(a.date);
                    const m = date.toLocaleString('default', { month: 'short' });
                    if(monthlyData[m] !== undefined) monthlyData[m] += parseFloat(a.fee || 0);
                });

                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Income',
                            data: Object.values(monthlyData),
                            borderColor: '#4F46E5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } }
                    }
                });
                
                return () => chart.destroy();
            }, [appointments]);

            return <div className="h-24 w-full"><canvas ref={canvasRef}></canvas></div>;
        };

        const Dashboard = ({ appointments, credentials, setView, isCloud }) => {
            const today = new Date().toISOString().split('T')[0];
            const safeAppointments = Array.isArray(appointments) ? appointments : [];
            const todaysJobs = safeAppointments.filter(a => a.date === today);
            
            const safeCredentials = Array.isArray(credentials) ? credentials : [];
            const expiringCreds = safeCredentials.filter(c => { 
                const exp = new Date(c.expiry); 
                return Math.ceil((exp - new Date()) / (1000 * 60 * 60 * 24)) <= 60; 
            });
            const monthlyIncome = safeAppointments.filter(a => a.status === 'Paid').reduce((sum, a) => sum + parseFloat(a.fee || 0), 0);

            return (
                <div className="p-6 space-y-6 pb-24">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden"><div className="absolute right-0 top-0 w-24 h-24 bg-green-50 rounded-bl-full -mr-4 -mt-4"></div><div className="relative"><div className="text-gray-500 text-xs font-bold uppercase mb-1">Monthly Income</div><div className="text-2xl font-bold text-gray-800">${monthlyIncome.toFixed(2)}</div>
                            <IncomeChart appointments={safeAppointments} />
                        </div></div>
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden"><div className="absolute right-0 top-0 w-24 h-24 bg-blue-50 rounded-bl-full -mr-4 -mt-4"></div><div className="relative"><div className="text-gray-500 text-xs font-bold uppercase mb-1">Today's Jobs</div><div className="text-2xl font-bold text-gray-800">{todaysJobs.length}</div></div></div>
                        <div onClick={() => setView('credentials')} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 cursor-pointer hover:bg-gray-50 relative overflow-hidden"><div className={`absolute right-0 top-0 w-24 h-24 rounded-bl-full -mr-4 -mt-4 ${expiringCreds.length > 0 ? 'bg-red-50' : 'bg-gray-50'}`}></div><div className="relative"><div className="text-gray-500 text-xs font-bold uppercase mb-1">Compliance Alerts</div><div className={`text-2xl font-bold ${expiringCreds.length > 0 ? 'text-red-600' : 'text-green-600'}`}>{expiringCreds.length}</div></div></div>
                    </div>
                    <div>
                        <h3 className="text-lg font-bold text-gray-800 mb-4">Today's Agenda</h3>
                        {todaysJobs.length === 0 ? <EmptyState icon="fa-calendar-day" title="No jobs today" description="Schedule clear. Good day for marketing or training!" actionLabel="Add Job" onAction={() => setView('addAppointment')} colorClass="text-blue-600" bgClass="bg-blue-50" /> : <div className="space-y-3">{todaysJobs.map(j => <div key={j.id} className="bg-white p-4 rounded shadow">{j.clientName}</div>)}</div>}
                    </div>
                </div>
            );
        };

        const AppointmentForm = ({ onSave, onCancel }) => {
            const [formData, setFormData] = useState({ clientName: '', date: '', time: '', fee: '', status: 'Scheduled' });
            const [magicInput, setMagicInput] = useState('');
            const handleSmartFill = () => { if(magicInput.includes('John')) { setFormData({...formData, clientName: 'John Doe', date: '2023-12-01', time: '14:00', fee: '150'}); showToast("Form Filled by AI"); } else alert("API Key Needed"); };
            const handleSubmit = (e) => { e.preventDefault(); onSave({...formData, id: Date.now().toString()}); showToast("Appointment Scheduled"); };

            return (
                <div className="p-6 pb-24 max-w-2xl mx-auto">
                    <div className="bg-white rounded-2xl shadow p-6">
                        <h3 className="font-bold text-lg mb-4">New Appointment</h3>
                        <div className="mb-6 p-4 bg-blue-50 rounded-xl border border-blue-100">
                            <label className="text-xs font-bold text-blue-600 uppercase block mb-2"><i className="fas fa-magic"></i> Smart Fill</label>
                            <div className="flex gap-2"><input value={magicInput} onChange={e=>setMagicInput(e.target.value)} className="flex-1 p-2 border rounded text-sm" placeholder="e.g. Loan signing with John tomorrow..." /><button onClick={handleSmartFill} className="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold">Fill</button></div>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input className="w-full p-3 border rounded-xl" placeholder="Client Name" value={formData.clientName} onChange={e=>setFormData({...formData, clientName: e.target.value})} required />
                            <div className="grid grid-cols-2 gap-4"><input type="date" className="w-full p-3 border rounded-xl" value={formData.date} onChange={e=>setFormData({...formData, date: e.target.value})} /><input type="time" className="w-full p-3 border rounded-xl" value={formData.time} onChange={e=>setFormData({...formData, time: e.target.value})} /></div>
                            <input className="w-full p-3 border rounded-xl" type="number" placeholder="Fee ($)" value={formData.fee} onChange={e=>setFormData({...formData, fee: e.target.value})} />
                            <div className="flex gap-3"><button type="button" onClick={onCancel} className="flex-1 py-3 bg-gray-100 rounded-xl">Cancel</button><button type="submit" className="flex-1 py-3 bg-blue-600 text-white rounded-xl">Save</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        const Schedule = ({ appointments, setView }) => {
            const [viewMode, setViewMode] = useState('list');
            const safeAppointments = Array.isArray(appointments) ? appointments : [];
            const CalendarView = () => <div className="bg-white p-8 rounded-2xl shadow text-center text-gray-400">Calendar View</div>;
            return (
                <div className="p-6 pb-24">
                    <div className="flex justify-between items-center mb-6"><h3 className="font-bold text-lg">Schedule</h3><div className="bg-gray-200 p-1 rounded-lg flex"><button onClick={()=>setViewMode('list')} className={`px-3 py-1 text-xs font-bold rounded-md ${viewMode==='list'?'bg-white shadow':''}`}>List</button><button onClick={()=>setViewMode('calendar')} className={`px-3 py-1 text-xs font-bold rounded-md ${viewMode==='calendar'?'bg-white shadow':''}`}>Calendar</button></div></div>
                    {viewMode === 'calendar' ? <CalendarView /> : (
                        <div className="space-y-3">
                            {safeAppointments.length === 0 ? <EmptyState icon="fa-calendar-alt" title="Schedule Empty" description="Add your first signing." actionLabel="Add" onAction={() => setView('addAppointment')} colorClass="text-green-600" bgClass="bg-green-50" /> : safeAppointments.sort((a,b) => new Date(a.date) - new Date(b.date)).map(job => (
                                <div key={job.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm"><div onClick={() => {}} className="cursor-pointer"><div className="flex justify-between items-start mb-2"><div><span className="text-xs font-bold text-gray-400 uppercase">{job.type}</span><h4 className="font-bold text-gray-800 text-lg">{job.clientName}</h4></div><span className={`text-[10px] px-2 py-1 rounded-full font-bold uppercase status-${job.status.toLowerCase()}`}>{job.status}</span></div><div className="grid grid-cols-2 gap-4 text-sm text-gray-600 mt-3 pt-3 border-t border-gray-50"><div className="flex items-center gap-2"><i className="far fa-calendar-alt text-blue-400"></i> {job.date} {job.time}</div><div className="text-right font-bold text-gray-800">${job.fee}</div></div></div></div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const Journal = ({ user, onUpgrade }) => {
            const [entries, setEntries] = useState([]);
            const [showForm, setShowForm] = useState(false);
            useEffect(() => { DataManager.get('notary_journal').then(setEntries); }, []);
            const handleSave = async (e) => { e.preventDefault(); const fd = new FormData(e.target); await DataManager.save('notary_journal', { id: Date.now().toString(), date: fd.get('date'), signer: fd.get('signer'), docType: fd.get('docType'), fee: fd.get('fee') }); setShowForm(false); setEntries(await DataManager.get('notary_journal')); showToast("Entry Logged"); };
            const handleExport = () => { if (user.plan !== 'pro') { onUpgrade(); return; } if (window.jspdf) PDFGenerator.createReport("Notary Journal", ["Date", "Signer", "Doc", "Fee"], entries.map(e => [e.date, e.signer, e.docType, `$${e.fee}`]), "journal.pdf"); };
            return (<div className="p-6 pb-24"><div className="flex justify-between items-center mb-6"><div className="flex gap-2"><h3 className="text-lg font-bold text-gray-800">Journal</h3><button onClick={handleExport} className="text-gray-400 hover:text-blue-600"><i className="fas fa-file-export"></i></button></div><button onClick={() => setShowForm(true)} className="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold"><i className="fas fa-plus mr-2"></i>Log</button></div>{showForm && <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-6"><form onSubmit={handleSave} className="space-y-4"><input required name="date" type="date" className="w-full p-3 bg-gray-50 border rounded-xl" /><input required name="signer" type="text" placeholder="Signer" className="w-full p-3 bg-gray-50 border rounded-xl" /><div className="flex gap-2"><button type="button" onClick={() => setShowForm(false)} className="flex-1 bg-gray-100 rounded-lg">Cancel</button><button type="submit" className="flex-1 bg-purple-600 text-white rounded-lg">Save</button></div></form></div>}<div className="space-y-3">{entries.length === 0 ? <EmptyState icon="fa-book" title="Journal Empty" description="Log your notarial acts." actionLabel="Log" onAction={()=>setShowForm(true)} colorClass="text-purple-600" bgClass="bg-purple-50" /> : entries.map(e => <div key={e.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm"><h4>{e.signer}</h4><p className="text-xs text-gray-500">{e.docType}</p></div>)}</div></div>);
        };

        const Finances = () => {
            const [activeTab, setActiveTab] = useState('expenses');
            const [expenses, setExpenses] = useState([]);
            const [mileage, setMileage] = useState([]);
            const [showForm, setShowForm] = useState(false);
             useEffect(() => { const load = async () => { setExpenses(await DataManager.get('notary_expenses')); setMileage(await DataManager.get('notary_mileage')); }; load(); }, []);
            const handleSave = async (e) => { e.preventDefault(); const formData = new FormData(e.target); if (activeTab === 'expenses') { await DataManager.save('notary_expenses', { id: Date.now().toString(), date: formData.get('date'), category: formData.get('category'), desc: formData.get('desc'), amount: formData.get('amount') }); setExpenses(await DataManager.get('notary_expenses')); } else { await DataManager.save('notary_mileage', { id: Date.now().toString(), date: formData.get('date'), start: formData.get('start'), end: formData.get('end'), miles: formData.get('miles') }); setMileage(await DataManager.get('notary_mileage')); } setShowForm(false); showToast("Record Saved"); };
            const handleExport = () => { if (activeTab === 'expenses') PDFGenerator.createReport("Expense Report", ["Date", "Category", "Description", "Amount"], expenses.map(e => [e.date, e.category, e.desc, `-$${e.amount}`]), "expenses.pdf"); else PDFGenerator.createReport("Mileage Log", ["Date", "Start", "End", "Miles"], mileage.map(m => [m.date, m.start, m.end, `${m.miles} mi`]), "mileage.pdf"); };
            return (
                <div className="p-6 pb-24">
                    <div className="bg-white p-1 rounded-xl flex mb-6 border border-gray-200 shadow-sm"><button onClick={() => setActiveTab('expenses')} className={`flex-1 py-2 text-sm font-bold rounded-lg ${activeTab === 'expenses' ? 'bg-emerald-50 text-emerald-700' : 'text-gray-500'}`}>Expenses</button><button onClick={() => setActiveTab('mileage')} className={`flex-1 py-2 text-sm font-bold rounded-lg ${activeTab === 'mileage' ? 'bg-blue-50 text-blue-700' : 'text-gray-500'}`}>Mileage</button></div>
                    <div className="flex justify-between items-center mb-6"><div><p className="text-xs text-gray-500 uppercase font-bold">Total</p><p className="text-2xl font-bold text-gray-800">{activeTab === 'expenses' ? `$${expenses.reduce((s, i) => s + parseFloat(i.amount||0), 0).toFixed(2)}` : `${mileage.reduce((s, i) => s + parseFloat(i.miles||0), 0)} mi`}</p></div><div className="flex gap-2"><button onClick={handleExport} className="bg-white text-gray-500 border w-10 h-10 rounded-full flex items-center justify-center"><i className="fas fa-file-export"></i></button><button onClick={() => setShowForm(true)} className="bg-gray-900 text-white w-10 h-10 rounded-full flex items-center justify-center"><i className="fas fa-plus"></i></button></div></div>
                    {showForm && <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-6"><form onSubmit={handleSave} className="space-y-4"><input required name="date" type="date" className="w-full p-3 bg-gray-50 border rounded-xl" />{activeTab === 'expenses' ? <><input name="category" placeholder="Category" className="w-full p-3 border rounded-xl" /><input name="desc" placeholder="Description" className="w-full p-3 border rounded-xl" /><input name="amount" placeholder="Amount" className="w-full p-3 border rounded-xl" /></> : <><input name="start" placeholder="Start" className="w-full p-3 border rounded-xl" /><input name="end" placeholder="End" className="w-full p-3 border rounded-xl" /><input name="miles" placeholder="Miles" className="w-full p-3 border rounded-xl" /></>}<button className="w-full bg-gray-900 text-white py-3 rounded-lg">Save</button></form></div>}
                    
                    <div className="space-y-3">
                        {activeTab === 'expenses' && expenses.length === 0 ? (
                            <EmptyState 
                                icon="fa-receipt"
                                title="No Expenses Logged"
                                description="Track your business spending for tax time. Add your first expense."
                                actionLabel="Log Expense"
                                onAction={() => setShowForm(true)}
                                colorClass="text-emerald-600"
                                bgClass="bg-emerald-50"
                            />
                        ) : activeTab === 'mileage' && mileage.length === 0 ? (
                            <EmptyState 
                                icon="fa-road"
                                title="No Mileage Logged"
                                description="Don't miss out on tax deductions. Track the miles you drive for work."
                                actionLabel="Log Mileage"
                                onAction={() => setShowForm(true)}
                                colorClass="text-blue-600"
                                bgClass="bg-blue-50"
                            />
                        ) : (
                            activeTab === 'expenses' ? expenses.map(e => <div key={e.id} className="bg-white p-3 rounded shadow"><span>{e.desc}</span></div>) : mileage.map(m => <div key={m.id} className="bg-white p-3 rounded shadow"><span>{m.start} to {m.end}</span></div>)
                        )}
                    </div>
                </div>
            );
        };
        
        const Credentials = ({ onUpdate }) => {
            const [creds, setCreds] = useState([]);
            const [showForm, setShowForm] = useState(false);
            useEffect(() => { DataManager.get('notary_credentials').then(setCreds); }, []);
            const handleSave = async (e) => { e.preventDefault(); const fd = new FormData(e.target); await DataManager.save('notary_credentials', { id: Date.now().toString(), name: fd.get('name'), expiry: fd.get('expiry') }); setShowForm(false); setCreds(await DataManager.get('notary_credentials')); showToast("Credential Saved"); };
            const handleDelete = async (id) => { await DataManager.delete('notary_credentials', id); setCreds(await DataManager.get('notary_credentials')); showToast("Credential Deleted", 'error'); };
            
            return (
                <div className="p-6 pb-24">
                    <div className="flex justify-between mb-4"><h3 className="font-bold">Credentials</h3><button onClick={()=>setShowForm(true)} className="bg-indigo-600 text-white px-3 py-1 rounded">Add</button></div>
                    {showForm && <form onSubmit={handleSave} className="bg-white p-4 rounded shadow mb-4"><input name="name" placeholder="Name" className="w-full border p-2 mb-2 rounded" /><input name="expiry" type="date" className="w-full border p-2 mb-2 rounded" /><button className="bg-indigo-600 text-white px-4 py-2 rounded">Save</button></form>}
                    <div className="space-y-3">
                        {creds.length === 0 ? (
                            <EmptyState 
                                icon="fa-id-card"
                                title="No Credentials"
                                description="Keep track of your commission, bond, and insurance. We'll alert you before they expire."
                                actionLabel="Add Credential"
                                onAction={() => setShowForm(true)}
                                colorClass="text-orange-600"
                                bgClass="bg-orange-50"
                            />
                        ) : creds.map(c => <div key={c.id} className="bg-white p-3 rounded shadow flex justify-between"><div><b>{c.name}</b><br/><span className="text-sm text-gray-500">{c.expiry}</span></div><button onClick={()=>handleDelete(c.id)} className="text-red-500">Delete</button></div>)}
                    </div>
                </div>
            );
        };
        
        const TrainerModule = ({ stateDB, courseMods, user, onUpgrade }) => { const [selectedStateKey, setSelectedStateKey] = useState('CA'); const [mode, setMode] = useState('study'); const [messages, setMessages] = useState([{ role: 'assistant', content: "Hello! I am your AI Mentor. Ask me anything about notary laws." }]); const [input, setInput] = useState(''); const [loading, setLoading] = useState(false); const scrollRef = useRef(null); useEffect(() => { scrollRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]); const sendMessage = async () => { if (!input.trim()) return; const newMsgs = [...messages, { role: 'user', content: input }]; setMessages(newMsgs); setInput(''); setLoading(true); setTimeout(() => { setMessages([...newMsgs, { role: 'assistant', content: "This is a simulated AI response. Please configure your API Key." }]); setLoading(false); }, 800); }; return (<div className="flex flex-col h-full bg-white relative pb-20 md:pb-0"><div className="border-b px-4 py-3 flex justify-between items-center bg-gray-50"><select value={selectedStateKey} onChange={e => setSelectedStateKey(e.target.value)} className="bg-white border rounded p-1">{Object.keys(stateDB).map(k => <option key={k} value={k}>{stateDB[k].state}</option>)}</select><div className="flex gap-2"><button onClick={() => setMode('study')} className={`px-2 py-1 text-xs rounded ${mode==='study' ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}>Study</button><button onClick={() => setMode('course')} className={`px-2 py-1 text-xs rounded ${mode==='course' ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}>Course</button><button onClick={() => setMode('sim')} className={`px-2 py-1 text-xs rounded ${mode==='sim' ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}>Sim</button></div></div><div className="flex-1 overflow-y-auto p-4 space-y-4 pb-4">{messages.map((m, i) => <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}><div className={`max-w-[85%] p-3 rounded-lg text-sm ${m.role === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}>{m.content}</div></div>)}{loading && <div className="text-xs text-gray-400 ml-4">Thinking...</div>}<div ref={scrollRef} /></div><div className="p-4 border-t bg-white flex gap-2 pb-24 md:pb-4 safe-area-pb"><input value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && sendMessage()} placeholder="Ask AI..." className="flex-1 p-2 border rounded" /><button onClick={sendMessage} className="bg-blue-600 text-white px-4 rounded">Send</button></div></div>); };
        
        const AdminPanel = ({ stateDB }) => { 
            const [activeTab, setActiveTab] = useState('states'); 
            const [selectedState, setSelectedState] = useState('CA'); 
            
            return (
                <div className="p-6 pb-24">
                    <div className="bg-red-50 border border-red-200 rounded p-4 mb-4"><h3 className="font-bold text-red-800">Admin Panel</h3></div>
                    <div className="flex gap-2 mb-4">
                        <button onClick={()=>setActiveTab('states')} className={`px-3 py-1 rounded ${activeTab==='states'?'bg-indigo-100 text-indigo-800':''}`}>States</button>
                        <button onClick={()=>setActiveTab('curriculum')} className={`px-3 py-1 rounded ${activeTab==='curriculum'?'bg-indigo-100 text-indigo-800':''}`}>Curriculum</button>
                    </div>
                    {activeTab === 'states' ? (
                        <div className="bg-white p-4 rounded shadow border">
                            <select className="w-full border p-2 mb-4" value={selectedState} onChange={e=>setSelectedState(e.target.value)}>
                                {Object.keys(stateDB).map(k=><option key={k} value={k}>{stateDB[k].state}</option>)}
                            </select>
                            <div className="space-y-2">
                                <label className="text-xs font-bold text-gray-500">Fees (Ack)</label>
                                <input className="w-full border p-2 rounded" defaultValue={stateDB[selectedState].fees.acknowledgment} />
                                <button className="bg-indigo-600 text-white px-4 py-2 rounded w-full">Save Changes</button>
                            </div>
                        </div>
                    ) : (
                        <div className="bg-white p-4 rounded shadow border"><p>Curriculum Editor Placeholder</p></div>
                    )}
                </div>
            ); 
        };

        const App = () => {
            // Fix #3: Initialize currentView based on user existence to prevent loop
            const [user, setUser] = useState(() => JSON.parse(localStorage.getItem('notary_user_profile')));
            const [currentView, setCurrentView] = useState(user ? 'dashboard' : 'landing');
            
            const [appointments, setAppointments] = useState([]);
            const [credentials, setCredentials] = useState([]);
            const [showMobileMenu, setShowMobileMenu] = useState(false);
            const [isCloudConnected, setIsCloudConnected] = useState(false);
            const [showPricing, setShowPricing] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [showOnboarding, setShowOnboarding] = useState(false);
            const [showAIModal, setShowAIModal] = useState(false); 

            useEffect(() => {
                DataManager.get('notary_appointments').then(setAppointments);
                DataManager.get('notary_credentials').then(setCredentials);
                if (user && !localStorage.getItem('notary_onboarded')) setShowOnboarding(true);
            }, [user]);
            
            const handleUpdateProfile = (updatedData) => {
                const newUser = { ...user, ...updatedData };
                setUser(newUser);
                localStorage.setItem('notary_user_profile', JSON.stringify(newUser));
                showToast("Profile Saved");
            };

            const handleLogin = (profile) => {
                localStorage.setItem('notary_user_profile', JSON.stringify(profile));
                setUser(profile);
                setCurrentView('dashboard');
                if (!localStorage.getItem('notary_onboarded')) setShowOnboarding(true);
                showToast("Welcome Back!");
            };

            const handleLogout = () => {
                localStorage.removeItem('notary_user_profile');
                setUser(null);
                setCurrentView('landing');
            };

            const handleUpgrade = () => { const upgraded = { ...user, plan: 'pro' }; setUser(upgraded); localStorage.setItem('notary_user_profile', JSON.stringify(upgraded)); setShowPricing(false); showToast("Upgrade Successful!"); };

            const handleSaveAppt = async (appt) => {
                await DataManager.save('notary_appointments', appt);
                setAppointments(await DataManager.get('notary_appointments'));
                setCurrentView('schedule');
                showToast("Appointment Saved");
            };
            
            const handleRefresh = async () => {
                 setAppointments(await DataManager.get('notary_appointments'));
                 setCredentials(await DataManager.get('notary_credentials')); 
            };

            const renderView = () => {
                switch(currentView) {
                    case 'landing': return <LandingPage onNavigate={() => setCurrentView('auth')} />;
                    case 'auth': return <AuthScreen onAuth={handleLogin} onBack={() => setCurrentView('landing')} />;
                    case 'dashboard': return <Dashboard appointments={appointments} credentials={credentials} setView={setCurrentView} isCloud={isCloudConnected} />;
                    case 'schedule': return <Schedule appointments={appointments} setView={setCurrentView} />;
                    case 'addAppointment': return <AppointmentForm onSave={handleSaveAppt} onCancel={() => setCurrentView('schedule')} />;
                    case 'clients': return <Clients />;
                    case 'journal': return <Journal user={user} onUpgrade={()=>{}} />;
                    case 'finances': return <Finances />;
                    case 'credentials': return <Credentials onUpdate={handleRefresh} />;
                    case 'trainer': return <TrainerModule stateDB={STATE_DATABASE} courseMods={COURSE_MODULES} user={user} onUpgrade={()=>{}} />;
                    case 'admin': return <AdminPanel stateDB={STATE_DATABASE} onUpdateStateDB={()=>{}} />;
                    default: return <div>Not found</div>;
                }
            };

            if (!user && currentView !== 'landing' && currentView !== 'auth') { setCurrentView('landing'); return null; }
            if (currentView === 'landing' || currentView === 'auth') return renderView();

            return (
                <div className="flex h-screen overflow-hidden font-sans">
                    <ToastContainer />
                    <button onClick={() => setShowAIModal(true)} className="fab-ai bg-indigo-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-2xl hover:bg-indigo-700 transition-transform transform hover:scale-110"><i className="fas fa-robot text-2xl"></i></button>
                    {showAIModal && <AIHelperModal onClose={() => setShowAIModal(false)} />}
                    {showPricing && <PricingModal onClose={() => setShowPricing(false)} onUpgrade={handleUpgrade} />}
                    {showSettings && <SettingsModal user={user} onClose={() => setShowSettings(false)} onSave={handleUpdateProfile} />}
                    {showOnboarding && <OnboardingTour onComplete={() => { localStorage.setItem('notary_onboarded', 'true'); setShowOnboarding(false); }} />}
                    
                    <Sidebar 
                        currentView={currentView} 
                        setView={setCurrentView} 
                        isOpen={showMobileMenu} 
                        onClose={() => setShowMobileMenu(false)} 
                        onLogout={handleLogout} 
                        userName={user.name} 
                        userPlan={user.plan} 
                        onUpgrade={() => setShowPricing(true)} 
                        onSettings={() => setShowSettings(true)}
                    />
                    <main className="flex-1 flex flex-col h-screen md:ml-64 relative bg-gray-50">
                        <Header title={currentView.charAt(0).toUpperCase() + currentView.slice(1)} isCloud={isCloudConnected} />
                        <div className="flex-1 overflow-y-auto relative">{renderView()}</div>
                        <MobileNav currentView={currentView} setView={setCurrentView} onOpenMenu={() => setShowMobileMenu(true)} />
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
