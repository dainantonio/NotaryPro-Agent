<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotaryPro AI Agent</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .typing-indicator span {
            animation: blink 1.4s infinite both;
            height: 6px; width: 6px; background-color: #3b82f6; border-radius: 50%; display: inline-block; margin: 0 2px;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        function App() {
            const [apiKey, setApiKey] = React.useState('');
            const [hasKey, setHasKey] = React.useState(false);
            const [messages, setMessages] = React.useState([
                { role: 'assistant', content: "Welcome to NotaryPro Trainer. I am your Agentic Instructor. To begin, please tell me which State you are training for?" }
            ]);
            const [input, setInput] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [mode, setMode] = React.useState('study'); // study | scenario

            const SYSTEM_PROMPT = `
                You are an expert Notary Public Instructor and Roleplay Agent.
                1. FIRST: Identify the user's US State. Do not proceed without it.
                2. ADAPT: Apply the specific laws of that state (e.g., California requires a thumbprint for Deeds of Trust; Florida allows RON).
                3. MODES:
                   - If mode is "study": Answer questions Socratically. Don't just give answers, guide them.
                   - If mode is "scenario": PLAY A CHARACTER. You are a client (the signer).
                     * Set a scene (e.g., "I'm in a rush, here's my papers").
                     * Introduce a problem (e.g., expired ID, wrong name, nervous behavior).
                     * Wait for the user (the notary) to respond.
                     * If they fail a critical step, stop and correct them.
                4. GOAL: Train them to catch fraud and follow procedure.
                5. Keep responses concise (under 100 words) unless explaining a complex law.
            `;

            const handleStart = () => {
                if(apiKey.trim().length > 0) setHasKey(true);
            };

            const sendMessage = async () => {
                if (!input.trim()) return;
                
                const newMessages = [...messages, { role: 'user', content: input }];
                setMessages(newMessages);
                setInput('');
                setLoading(true);

                try {
                    // Prepare the conversation history for the API
                    // We map 'assistant' -> 'model' for Gemini API compatibility if needed, 
                    // but standard structure usually works with prompt construction.
                    // Here we construct a "chat" structure for the API payload.
                    
                    const contents = [
                        { role: "user", parts: [{ text: SYSTEM_PROMPT + `\n\nCurrent Mode: ${mode.toUpperCase()}\n\n` }] },
                        ...newMessages.map(m => ({
                            role: m.role === 'assistant' ? 'model' : 'user',
                            parts: [{ text: m.content }]
                        }))
                    ];

                    // Calls Google Gemini API
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: contents })
                    });

                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error.message);
                    }

                    const aiResponse = data.candidates[0].content.parts[0].text;
                    setMessages([...newMessages, { role: 'assistant', content: aiResponse }]);

                } catch (error) {
                    setMessages([...newMessages, { role: 'assistant', content: "Error: " + error.message + ". Please check your API Key." }]);
                } finally {
                    setLoading(false);
                }
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') sendMessage();
            };

            if (!hasKey) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                        <div className="bg-white p-8 rounded-xl shadow-lg max-w-md w-full">
                            <div className="text-center mb-6">
                                <i className="fas fa-stamp text-5xl text-blue-600 mb-4"></i>
                                <h1 className="text-2xl font-bold text-gray-800">Notary Agent Trainer</h1>
                                <p className="text-gray-500 text-sm mt-2">AI-Powered Simulation & Training</p>
                            </div>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Google Gemini API Key</label>
                                    <input 
                                        type="password" 
                                        value={apiKey}
                                        onChange={(e) => setApiKey(e.target.value)}
                                        placeholder="Paste your API key here..."
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                    />
                                    <p className="text-xs text-gray-400 mt-2">
                                        Don't have one? <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-blue-500 hover:underline">Get a free key here</a>.
                                    </p>
                                </div>
                                <button 
                                    onClick={handleStart}
                                    className="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-200"
                                >
                                    Start Training
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex flex-col h-screen bg-white">
                    {/* Header */}
                    <div className="bg-white border-b px-6 py-4 flex justify-between items-center shadow-sm z-10">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-600 p-2 rounded-lg text-white">
                                <i className="fas fa-stamp"></i>
                            </div>
                            <div>
                                <h1 className="font-bold text-lg text-gray-800">NotaryPro Agent</h1>
                                <div className="text-xs text-green-500 flex items-center gap-1">
                                    <span className="w-2 h-2 bg-green-500 rounded-full"></span> Online
                                </div>
                            </div>
                        </div>
                        <div className="flex bg-gray-100 p-1 rounded-lg">
                            <button 
                                onClick={() => setMode('study')}
                                className={`px-4 py-2 text-sm rounded-md transition-all ${mode === 'study' ? 'bg-white shadow text-blue-600 font-medium' : 'text-gray-500 hover:text-gray-700'}`}
                            >
                                Study Mode
                            </button>
                            <button 
                                onClick={() => setMode('scenario')}
                                className={`px-4 py-2 text-sm rounded-md transition-all ${mode === 'scenario' ? 'bg-white shadow text-blue-600 font-medium' : 'text-gray-500 hover:text-gray-700'}`}
                            >
                                Roleplay Sim
                            </button>
                        </div>
                    </div>

                    {/* Chat Area */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
                        {messages.map((msg, index) => (
                            <div key={index} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[80%] rounded-2xl px-5 py-3 shadow-sm ${
                                    msg.role === 'user' 
                                        ? 'bg-blue-600 text-white rounded-br-none' 
                                        : 'bg-white text-gray-800 border border-gray-100 rounded-bl-none'
                                }`}>
                                    {msg.role === 'assistant' && (
                                        <div className="text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">
                                            {mode === 'scenario' ? 'Client / Trainer' : 'Instructor'}
                                        </div>
                                    )}
                                    <div className="leading-relaxed whitespace-pre-wrap">{msg.content}</div>
                                </div>
                            </div>
                        ))}
                        {loading && (
                            <div className="flex justify-start">
                                <div className="bg-white border border-gray-100 rounded-2xl rounded-bl-none px-5 py-4 shadow-sm">
                                    <div className="typing-indicator">
                                        <span></span><span></span><span></span>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Input Area */}
                    <div className="p-4 bg-white border-t">
                        <div className="max-w-4xl mx-auto relative flex items-center gap-2">
                            <input
                                type="text"
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                onKeyDown={handleKeyDown}
                                placeholder="Type your response..."
                                className="flex-1 bg-gray-100 text-gray-800 p-4 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                            />
                            <button 
                                onClick={sendMessage}
                                disabled={loading || !input.trim()}
                                className="bg-blue-600 text-white p-4 rounded-xl hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-md"
                            >
                                <i className="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <p className="text-center text-xs text-gray-400 mt-3">
                            AI can make mistakes. Always check your official State Notary Handbook.
                        </p>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
