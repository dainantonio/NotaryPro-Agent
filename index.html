<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NotaryOS</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“œ</text></svg>">
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Utilities -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- FIREBASE SDK (COMPAT MODE - Stable) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // --- CONFIGURATION ZONE ---
        const firebaseConfig = {
            apiKey: "AIzaSyA32kVbmGOcY_CdDymrom9rWVzyXTj3so0",
            authDomain: "notaryos-67cd2.firebaseapp.com",
            projectId: "notaryos-67cd2",
            storageBucket: "notaryos-67cd2.firebasestorage.app",
            messagingSenderId: "660325303334",
            appId: "1:660325303334:web:bb0f062fd4da8c7fca12e7"
        };

        const STRIPE_PAYMENT_LINK = ""; // Leave empty for simulation mode

        // Initialize Firebase
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase Connected");
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }
    </script>

    <!-- Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Courier+Prime&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Status Badges */
        .status-scheduled { background-color: #e0f2fe; color: #0369a1; }
        .status-completed { background-color: #dcfce7; color: #15803d; }
        .status-paid { background-color: #166534; color: white; }
        .status-cancelled { background-color: #fee2e2; color: #b91c1c; }

        /* Chat Styles */
        .typing-indicator span {
            animation: blink 1.4s infinite both;
            height: 6px; width: 6px; background-color: #3b82f6; border-radius: 50%; display: inline-block; margin: 0 2px;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }

        /* Markdown Styles */
        .prose p { margin-bottom: 0.5em; margin-top: 0.5em; line-height: 1.5; }
        .prose ul { margin-top: 0.25em; margin-bottom: 0.25em; padding-left: 1.5em; list-style-type: disc;}
        .prose strong { color: inherit; font-weight: 700; }
        .user-content .prose { color: white; }
        .user-content .prose strong { color: white; }

        .paper-doc {
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
            font-family: 'Courier Prime', monospace;
        }
        
        /* Auth Animations */
        .auth-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .sidebar-transition { transition: width 0.3s ease-in-out; }
        
        /* Safe area for mobile nav */
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }

        /* Toast Animations */
        .toast-in { animation: toastIn 0.3s ease-out forwards; }
        @keyframes toastIn {
            from { transform: translate(-50%, 20px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- HYBRID DATA MANAGER ---
        const DataManager = {
            isCloud: () => typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser !== null,
            get: async (collectionName) => {
                if (DataManager.isCloud()) {
                    try {
                        const uid = firebase.auth().currentUser.uid;
                        const snapshot = await firebase.firestore().collection(collectionName).where("userId", "==", uid).get();
                        if (snapshot.empty) return DataManager.getLocal(collectionName);
                        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    } catch (e) {
                        return DataManager.getLocal(collectionName);
                    }
                } else {
                    return DataManager.getLocal(collectionName);
                }
            },
            save: async (collectionName, item) => {
                const localData = DataManager.saveLocal(collectionName, item);
                if (DataManager.isCloud()) {
                    try {
                        const uid = firebase.auth().currentUser.uid;
                        const itemWithUser = { ...item, userId: uid };
                        const docId = item.id || Date.now().toString();
                        await firebase.firestore().collection(collectionName).doc(docId).set(itemWithUser);
                        const snapshot = await firebase.firestore().collection(collectionName).where("userId", "==", uid).get();
                        return { success: true, data: snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })) };
                    } catch (e) {
                        return { success: false, data: localData };
                    }
                }
                return { success: false, data: localData };
            },
            saveLocal: (key, item) => {
                const list = JSON.parse(localStorage.getItem(key) || '[]');
                const index = list.findIndex(i => i.id === item.id);
                if (index >= 0) list[index] = item;
                else list.push(item);
                localStorage.setItem(key, JSON.stringify(list));
                return list;
            },
            getLocal: (key) => JSON.parse(localStorage.getItem(key) || '[]'),
             delete: async (collectionName, id) => {
                const localData = DataManager.deleteLocal(collectionName, id);
                if (DataManager.isCloud()) {
                     try { await firebase.firestore().collection(collectionName).doc(id).delete(); } catch(e) {}
                }
                return localData;
            },
            deleteLocal: (key, id) => {
                const list = JSON.parse(localStorage.getItem(key) || '[]');
                const newList = list.filter(i => i.id !== id);
                localStorage.setItem(key, JSON.stringify(newList));
                return newList;
            }
        };

        // --- PDF GENERATORS ---
        const PDFGenerator = {
            createInvoice: (appt, user) => {
                if (!window.jspdf) { alert("PDF Library not loaded yet."); return; }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const primaryColor = [37, 99, 235];
                
                // Config
                const businessName = user.businessName || user.name || "Notary Public";
                const businessPhone = user.phone || "";
                const businessAddress = user.address || "";

                // Header
                doc.setFontSize(22); doc.setTextColor(...primaryColor); doc.text("INVOICE", 160, 20);
                doc.setFontSize(10); doc.setTextColor(100); doc.text(`ID: ${appt.id.substring(0,8)}`, 160, 26); doc.text(`Date: ${new Date().toLocaleDateString()}`, 160, 31);
                
                // From (Business)
                doc.setFontSize(12); doc.setTextColor(0); doc.text(businessName.toUpperCase(), 20, 20);
                doc.setFontSize(10); doc.setTextColor(100);
                doc.text(businessPhone, 20, 26);
                doc.text(user.email || "", 20, 31);
                if(businessAddress) doc.text(businessAddress, 20, 36);

                // To (Client)
                doc.setTextColor(0); doc.text("BILL TO:", 20, 55); 
                doc.setFontSize(14); doc.text(appt.clientName, 20, 62); 
                doc.setFontSize(10); doc.text(appt.location, 20, 68);

                // Table
                doc.autoTable({ startY: 80, head: [['Description', 'Date', 'Amount']], body: [[appt.type || 'Notary Service', appt.date, `$${appt.fee}`]], theme: 'grid', headStyles: { fillColor: primaryColor } });
                
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(12); doc.text(`Total Due: $${appt.fee}`, 160, finalY, { align: 'right' });
                
                // Footer
                doc.setFontSize(8); doc.setTextColor(150);
                doc.text("Thank you for your business.", 105, 280, { align: 'center' });
                if(user.commissionNumber) doc.text(`Commission #${user.commissionNumber}`, 105, 285, { align: 'center' });

                doc.save(`invoice_${appt.clientName}.pdf`);
            },
            createReport: (title, columns, data, filename) => {
                if (!window.jspdf) { alert("PDF Library not loaded yet."); return; }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(18); doc.text(title, 14, 22);
                doc.setFontSize(10); doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 28);
                doc.autoTable({ startY: 35, head: [columns], body: data, theme: 'striped' });
                doc.save(filename);
            }
        };

        // --- FULL KNOWLEDGE BASE (50 States) ---
        const STATE_DATABASE = {
             "AL": { "state": "Alabama", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Not specified" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "AK": { "state": "Alaska", "fees": { "acknowledgment": "$25.00", "jurat": "$25.00", "oath": "$25.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Not specified" }, "red_flags": ["Conflict of Interest"], "specialized": { "loan_signing": "Allowed", "apostille": "Lt. Governor", "marriage": "No" }},
             "AZ": { "state": "Arizona", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "1 or 2 allowed", "expired_id_rule": "Not allowed" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "AR": { "state": "Arkansas", "fees": { "acknowledgment": "Reasonable", "jurat": "Reasonable", "oath": "Reasonable" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Not specified" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "CA": { "state": "California", "fees": { "acknowledgment": "$15.00", "jurat": "$15.00", "oath": "$15.00" }, "id_requirements": { "credible_witnesses": "1 known OR 2 with ID", "expired_id_rule": "5 years" }, "red_flags": ["Thumbprint mandatory for Deeds/POA"], "specialized": { "loan_signing": "Background Check Required", "apostille": "Secretary of State", "marriage": "No" }},
             "CO": { "state": "Colorado", "fees": { "acknowledgment": "$15.00", "jurat": "$15.00", "oath": "$15.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "1 year" }, "red_flags": ["No Seal Embosser"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "CT": { "state": "Connecticut", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["Attorney State (Restriction)"], "specialized": { "loan_signing": "ATTORNEY STATE (Witness Only)", "apostille": "Secretary of State", "marriage": "No" }},
             "DE": { "state": "Delaware", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["Attorney State"], "specialized": { "loan_signing": "ATTORNEY STATE", "apostille": "Secretary of State", "marriage": "No" }},
             "DC": { "state": "District of Columbia", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Office of Notary", "marriage": "No" }},
             "FL": { "state": "Florida", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "1 known OR 2 with ID", "expired_id_rule": "5 years" }, "red_flags": ["No Family"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "YES ($30 Fee)" }},
             "GA": { "state": "Georgia", "fees": { "acknowledgment": "$2.00", "jurat": "$2.00", "oath": "$2.00" }, "id_requirements": { "credible_witnesses": "Not specified", "expired_id_rule": "Not specified" }, "red_flags": ["Attorney State"], "specialized": { "loan_signing": "ATTORNEY STATE", "apostille": "GSCCCA", "marriage": "No" }},
             "HI": { "state": "Hawaii", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Lt. Governor", "marriage": "No" }},
             "ID": { "state": "Idaho", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "IL": { "state": "Illinois", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["Cook County Record"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "IN": { "state": "Indiana", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["Title Producer License for LSA"], "specialized": { "loan_signing": "REQUIRES TPL LICENSE", "apostille": "Secretary of State", "marriage": "No" }},
             "IA": { "state": "Iowa", "fees": { "acknowledgment": "Reasonable", "jurat": "Reasonable", "oath": "Reasonable" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "KS": { "state": "Kansas", "fees": { "acknowledgment": "Reasonable", "jurat": "Reasonable", "oath": "Reasonable" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "KY": { "state": "Kentucky", "fees": { "acknowledgment": "Not set", "jurat": "Not set", "oath": "Not set" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "LA": { "state": "Louisiana", "fees": { "acknowledgment": "Not set", "jurat": "Not set", "oath": "Not set" }, "id_requirements": { "credible_witnesses": "2 witnesses", "expired_id_rule": "Current" }, "red_flags": ["Civil Law Notary"], "specialized": { "loan_signing": "Civil Law Notary Exam Required", "apostille": "Secretary of State", "marriage": "No" }},
             "ME": { "state": "Maine", "fees": { "acknowledgment": "Reasonable", "jurat": "Reasonable", "oath": "Reasonable" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "YES" }},
             "MD": { "state": "Maryland", "fees": { "acknowledgment": "$4.00", "jurat": "$4.00", "oath": "$4.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["TIP License Required"], "specialized": { "loan_signing": "REQUIRES TIP LICENSE", "apostille": "Secretary of State", "marriage": "No" }},
             "MA": { "state": "Massachusetts", "fees": { "acknowledgment": "Not set", "jurat": "Not set", "oath": "Not set" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["Attorney State"], "specialized": { "loan_signing": "ATTORNEY STATE", "apostille": "Secretary of the Commonwealth", "marriage": "No" }},
             "MI": { "state": "Michigan", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "MN": { "state": "Minnesota", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["Closing Agent License"], "specialized": { "loan_signing": "REQUIRES CLOSING LICENSE", "apostille": "Secretary of State", "marriage": "No" }},
             "MS": { "state": "Mississippi", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "5 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "MO": { "state": "Missouri", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "MT": { "state": "Montana", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "YES" }},
             "NE": { "state": "Nebraska", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$2.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "NV": { "state": "Nevada", "fees": { "acknowledgment": "$15.00", "jurat": "$15.00", "oath": "$7.50" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Notary Discretion" }, "red_flags": ["Escrow License for LSA"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "YES (Specific Cert Required)" }},
             "NH": { "state": "New Hampshire", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Not specified" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "NJ": { "state": "New Jersey", "fees": { "acknowledgment": "$2.50", "jurat": "$2.50", "oath": "$2.50" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Treasury Division", "marriage": "No" }},
             "NM": { "state": "New Mexico", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "1 year" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "NY": { "state": "New York", "fees": { "acknowledgment": "$2.00", "jurat": "$2.00", "oath": "$2.00" }, "id_requirements": { "credible_witnesses": "Not specified", "expired_id_rule": "Not specified" }, "red_flags": ["No Initials in Name"], "specialized": { "loan_signing": "Allowed", "apostille": "Dept of State", "marriage": "No" }},
             "NC": { "state": "North Carolina", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "ND": { "state": "North Dakota", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Valid" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "OH": { "state": "Ohio", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Not specified" }, "red_flags": ["Conflict of Interest"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "OK": { "state": "Oklahoma", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "OR": { "state": "Oregon", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "PA": { "state": "Pennsylvania", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of the Commonwealth", "marriage": "No" }},
             "RI": { "state": "Rhode Island", "fees": { "acknowledgment": "$25.00", "jurat": "$25.00", "oath": "$25.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "SC": { "state": "South Carolina", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["Attorney Supervision"], "specialized": { "loan_signing": "ATTORNEY STATE", "apostille": "Secretary of State", "marriage": "YES" }},
             "SD": { "state": "South Dakota", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "TN": { "state": "Tennessee", "fees": { "acknowledgment": "$0", "jurat": "$0", "oath": "$0" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["Reasonable Fees"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "YES" }},
             "TX": { "state": "Texas", "fees": { "acknowledgment": "$6.00", "jurat": "$6.00", "oath": "$6.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "UT": { "state": "Utah", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Valid" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Lt. Governor", "marriage": "No" }},
             "VT": { "state": "Vermont", "fees": { "acknowledgment": "No limit", "jurat": "No limit", "oath": "No limit" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["Attorney Supervision"], "specialized": { "loan_signing": "ATTORNEY STATE", "apostille": "Secretary of State", "marriage": "No" }},
             "VA": { "state": "Virginia", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of the Commonwealth", "marriage": "No" }},
             "WA": { "state": "Washington", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "WV": { "state": "West Virginia", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["Attorney State"], "specialized": { "loan_signing": "ATTORNEY STATE", "apostille": "Secretary of State", "marriage": "No" }},
             "WI": { "state": "Wisconsin", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "WY": { "state": "Wyoming", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
             "certificates": { "acknowledgment_text": "State of [State]...", "jurat_text": "Subscribed and sworn..." }
        };

        const COURSE_MODULES = [
            { id: 1, title: "Authority & Qualifications", topic: "Commissioning authority, term length, and jurisdiction." },
            { id: 2, title: "The Core 5 Steps", topic: "Personal Appearance, ID, Willingness, Awareness, Certificates." },
            { id: 3, title: "Notarial Acts", topic: "Acknowledgments vs. Jurats vs. Oaths." },
            { id: 4, title: "Identification Standards", topic: "Satisfactory Evidence, Credible Witnesses." },
            { id: 5, title: "Rules, Fees, & Journals", topic: "Maximum fees, Journal requirements, Seal rules." },
            { id: 6, title: "Special Circumstances", topic: "RON, Signature by Mark/Proxy, Foreign language." },
            { id: 7, title: "Misconduct & Liability", topic: "Prohibited acts (UPL), Penalties, Liability." },
            { id: 8, title: "Loan Signing Agent (LSA)", topic: "Handling loan packages (Deed of Trust, Note, CD), borrower interactions, and avoiding UPL in real estate." },
            { id: 9, title: "Apostilles & Authentication", topic: "The apostille process, Secretary of State authentication, and chain of signature requirements for international documents." },
            { id: 10, title: "Specialized Services", topic: "Field Inspections, I-9 Verification, and Marriage/Wedding solemnization rules (State Specific)." }
        ];

        const PERSONA = `
            ROLE: SUPPORTIVE NOTARY MENTOR.
            TONE: Encouraging, professional, clear.
            APPROACH: Guide the user. Explain the "Why" behind laws.
            RULES: Teach One Topic -> Quiz -> Feedback.
        `;

        // --- COMPONENTS ---

        // 1. Landing Page
        const LandingPage = ({ onNavigate }) => {
            return (
                <div className="min-h-screen bg-white font-inter flex flex-col">
                    <div className="bg-slate-900 text-white relative overflow-hidden flex-1 flex flex-col justify-center min-h-[60vh]">
                        <div className="absolute inset-0 bg-blue-600/10 z-0"></div>
                        
                        {/* Header Nav inside Landing */}
                        <div className="absolute top-0 left-0 w-full p-6 flex justify-between items-center z-20">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 p-1.5 rounded-lg"><i className="fas fa-stamp text-xl"></i></div>
                                <h1 className="text-xl font-bold">NotaryOS</h1>
                            </div>
                            <button onClick={onNavigate} className="text-gray-300 hover:text-white font-medium">Log In</button>
                        </div>

                        <div className="max-w-6xl mx-auto px-6 py-20 relative z-10">
                            <div className="max-w-3xl">
                                <h1 className="text-5xl md:text-7xl font-extrabold mb-8 leading-tight tracking-tight">
                                    The Operating System for <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-400">Modern Notaries</span>.
                                </h1>
                                <p className="text-xl md:text-2xl text-gray-400 mb-10 leading-relaxed max-w-2xl">
                                    Manage appointments, track compliance, generate invoices, and train with an AI expert. All in one place.
                                </p>
                                <div className="flex flex-col sm:flex-row gap-4">
                                    <button onClick={onNavigate} className="bg-blue-600 hover:bg-blue-700 text-white px-10 py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-blue-500/30 transition-all transform hover:-translate-y-1">
                                        Start Free Trial
                                    </button>
                                </div>
                            </div>
                        </div>
                        {/* Background Shapes */}
                        <div className="absolute top-20 right-0 w-96 h-96 bg-purple-600/20 rounded-full blur-3xl -mr-20 animate-pulse"></div>
                        <div className="absolute bottom-0 left-0 w-64 h-64 bg-blue-600/20 rounded-full blur-3xl -ml-20"></div>
                    </div>

                    {/* Features Grid */}
                    <div className="py-24 bg-gray-50">
                        <div className="max-w-6xl mx-auto px-6">
                            <div className="text-center mb-16">
                                <h2 className="text-3xl font-bold text-gray-900 mb-4">Everything you need to run your business</h2>
                                <p className="text-gray-500 max-w-2xl mx-auto text-lg">Stop using spreadsheets and sticky notes. NotaryOS brings your entire workflow into one secure, compliant dashboard.</p>
                            </div>
                            
                            <div className="grid md:grid-cols-3 gap-8">
                                <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-all hover:-translate-y-1">
                                    <div className="w-14 h-14 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center text-2xl mb-6"><i className="fas fa-calendar-check"></i></div>
                                    <h3 className="text-xl font-bold text-gray-900 mb-3">Smart Scheduling</h3>
                                    <p className="text-gray-500 leading-relaxed">Track appointments, set reminders, and generate PDF invoices instantly. Never miss a signing.</p>
                                </div>
                                <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-all hover:-translate-y-1">
                                    <div className="w-14 h-14 bg-purple-100 text-purple-600 rounded-xl flex items-center justify-center text-2xl mb-6"><i className="fas fa-robot"></i></div>
                                    <h3 className="text-xl font-bold text-gray-900 mb-3">AI Compliance Coach</h3>
                                    <p className="text-gray-500 leading-relaxed">A strict AI mentor trained on 50-state laws. Ask questions, roleplay scenarios, and stay compliant.</p>
                                </div>
                                <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-all hover:-translate-y-1">
                                    <div className="w-14 h-14 bg-green-100 text-green-600 rounded-xl flex items-center justify-center text-2xl mb-6"><i className="fas fa-cloud"></i></div>
                                    <div className="flex items-center gap-2 mb-3">
                                        <h3 className="text-xl font-bold text-gray-900">Cloud Sync</h3>
                                        <span className="bg-green-100 text-green-700 text-[10px] font-bold px-2 py-1 rounded-full uppercase">Live</span>
                                    </div>
                                    <p className="text-gray-500 leading-relaxed">Start on your laptop, finish on your phone. Your data is encrypted and synced in real-time.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <footer className="bg-white border-t border-gray-200 py-12">
                         <div className="max-w-6xl mx-auto px-6 text-center text-gray-400 text-sm">
                            &copy; 2024 NotaryOS Inc.
                         </div>
                    </footer>
                </div>
            );
        };

        const TermsModal = ({ onAccept }) => {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden auth-fade-in">
                        <div className="p-6 border-b border-gray-100 bg-gray-50">
                            <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <i className="fas fa-balance-scale text-blue-600"></i> Terms of Service
                            </h2>
                        </div>
                        <div className="p-6 text-sm text-gray-600 space-y-4 max-h-[60vh] overflow-y-auto">
                            <p className="font-bold text-gray-800">Please review and accept to continue.</p>
                            <p><strong>1. Not Legal Advice:</strong> NotaryOS is an educational and management tool. The AI Trainer provides information based on general data and may produce inaccuracies. This tool does not constitute legal advice.</p>
                            <p><strong>2. User Responsibility:</strong> You are responsible for verifying all laws with your state's official Notary Handbook. NotaryOS is not liable for any notarial errors, fines, or legal actions resulting from the use of this software.</p>
                            <p><strong>3. Data Privacy:</strong> In this Beta version, your business data is stored locally on your device unless Cloud Sync is enabled.</p>
                            <p><strong>4. AI Limitations:</strong> The AI features utilize Google Gemini. AI responses should always be fact-checked against official statutes.</p>
                        </div>
                        <div className="p-6 border-t border-gray-100 bg-gray-50">
                            <button 
                                onClick={onAccept}
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg transform active:scale-95"
                            >
                                I Understand & Agree
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const PricingModal = ({ onClose, onUpgrade }) => (
            <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden auth-fade-in text-center p-8">
                    <div className="w-16 h-16 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-4 text-white text-3xl shadow-lg">
                        <i className="fas fa-crown"></i>
                    </div>
                    <h2 className="text-2xl font-bold text-gray-900 mb-2">Upgrade to Pro</h2>
                    <p className="text-gray-500 mb-6">Unlock the full power of NotaryOS.</p>
                    
                    <ul className="text-left space-y-3 mb-8 bg-gray-50 p-4 rounded-xl">
                        <li className="flex items-center gap-3"><i className="fas fa-check text-green-500"></i> <span>Unlimited AI Training</span></li>
                        <li className="flex items-center gap-3"><i className="fas fa-check text-green-500"></i> <span>Professional PDF Invoices</span></li>
                        <li className="flex items-center gap-3"><i className="fas fa-check text-green-500"></i> <span>Cloud Sync & Backups</span></li>
                        <li className="flex items-center gap-3"><i className="fas fa-check text-green-500"></i> <span>Advanced Reporting</span></li>
                    </ul>

                    <button onClick={onUpgrade} className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1">
                        Get Pro - $19/mo
                    </button>
                    <button onClick={onClose} className="mt-4 text-sm text-gray-400 hover:text-gray-600">Maybe Later</button>
                </div>
            </div>
        );

        // Settings Modal with Business Fields
        const SettingsModal = ({ user, onClose, onSave }) => {
            const [data, setData] = useState(user || {});
            
            const handleSave = (e) => {
                e.preventDefault();
                onSave(data);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden auth-fade-in">
                         <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                            <h3 className="font-bold text-lg text-gray-800">Business Profile</h3>
                            <button onClick={onClose} className="text-gray-500"><i className="fas fa-times"></i></button>
                        </div>
                        <div className="p-6">
                            <form onSubmit={handleSave} className="space-y-4">
                                <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Your Name</label><input className="w-full p-2 border rounded" value={data.name || ''} onChange={e => setData({...data, name: e.target.value})} /></div>
                                <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Business Name</label><input className="w-full p-2 border rounded" placeholder="e.g. Acme Notary LLC" value={data.businessName || ''} onChange={e => setData({...data, businessName: e.target.value})} /></div>
                                <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Phone</label><input className="w-full p-2 border rounded" placeholder="(555) 123-4567" value={data.phone || ''} onChange={e => setData({...data, phone: e.target.value})} /></div>
                                <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Address (For Invoices)</label><textarea className="w-full p-2 border rounded" placeholder="123 Notary St, City, State" value={data.address || ''} onChange={e => setData({...data, address: e.target.value})}></textarea></div>
                                <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Commission Number</label><input className="w-full p-2 border rounded" value={data.commissionNumber || ''} onChange={e => setData({...data, commissionNumber: e.target.value})} /></div>
                                <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Exam Target Date</label><input type="date" className="w-full p-2 border rounded" value={data.targetDate || ''} onChange={e => setData({...data, targetDate: e.target.value})} /></div>
                                <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">Save Profile</button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        const AuthScreen = ({ onAuth, onBack }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [formData, setFormData] = useState({ name: '', email: '', password: '' });
            const [showTerms, setShowTerms] = useState(false);
            const [error, setError] = useState('');

            const handleAuth = (e) => {
                e.preventDefault();
                setError('');
                setShowTerms(true); // Trigger Terms Modal
            };

            const completeAuth = async () => {
                try {
                    let user;
                    // Check if Firebase is active
                    if (firebase.auth()) {
                        if (isLogin) {
                            const cred = await firebase.auth().signInWithEmailAndPassword(formData.email, formData.password);
                            user = cred.user;
                        } else {
                            const cred = await firebase.auth().createUserWithEmailAndPassword(formData.email, formData.password);
                            user = cred.user;
                        }
                    } else {
                        // Fallback Local Auth
                         console.warn("Firebase not configured properly. Using Local Simulation.");
                    }

                    const profile = {
                        id: user ? user.uid : Date.now().toString(),
                        name: isLogin ? (formData.email.split('@')[0] || "User") : formData.name, 
                        email: formData.email,
                        joined: new Date().toLocaleDateString(),
                        plan: 'free' // Default to free plan
                    };
                    onAuth(profile);
                } catch (err) {
                    setShowTerms(false);
                    let msg = err.message;
                    if(err.code === 'auth/configuration-not-found') msg = "Email login not enabled in Firebase Console.";
                    setError(msg);
                }
            };
            
            // New: Google Sign In
            const handleGoogleAuth = async () => {
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    await firebase.auth().signInWithPopup(provider);
                    // Auth state change will handle the redirect
                } catch (err) {
                    setError(err.message);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                    {showTerms && <TermsModal onAccept={completeAuth} />}
                    
                    <div className="bg-white rounded-2xl shadow-2xl overflow-hidden max-w-4xl w-full flex flex-col md:flex-row auth-fade-in">
                        {/* Brand Side */}
                        <div className="bg-slate-900 text-white p-8 md:w-1/2 flex flex-col justify-center relative overflow-hidden">
                             <button onClick={onBack} className="absolute top-6 left-6 text-white/50 hover:text-white z-20 flex items-center gap-2"><i className="fas fa-arrow-left"></i> Back</button>
                             <div className="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 bg-blue-600 rounded-full opacity-20"></div>
                             <div className="absolute bottom-0 left-0 -ml-16 -mb-16 w-48 h-48 bg-purple-600 rounded-full opacity-20"></div>
                            <div className="mb-8 relative z-10 mt-10 md:mt-0">
                                <div className="flex items-center gap-3 mb-2">
                                    <div className="bg-blue-600 p-2 rounded-lg"><i className="fas fa-stamp text-2xl"></i></div>
                                    <h1 className="text-4xl font-bold">NotaryOS</h1>
                                </div>
                                <p className="text-blue-200 text-lg">The Operating System for Modern Notaries.</p>
                            </div>
                            <ul className="space-y-4 text-gray-300 relative z-10">
                                <li className="flex items-center gap-3"><i className="fas fa-check-circle text-green-400"></i> Business Management Suite</li>
                                <li className="flex items-center gap-3"><i className="fas fa-check-circle text-green-400"></i> AI-Powered Compliance Coach</li>
                                <li className="flex items-center gap-3"><i className="fas fa-check-circle text-green-400"></i> 50-State Law Database</li>
                            </ul>
                        </div>
                        
                        {/* Form Side */}
                        <div className="p-8 md:w-1/2 flex flex-col justify-center bg-white">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6">{isLogin ? 'Welcome Back' : 'Create Account'}</h2>
                            {error && <div className="bg-red-100 text-red-700 p-3 rounded mb-4 text-xs">{error}</div>}
                            
                            <form onSubmit={handleAuth} className="space-y-4">
                                {!isLogin && (
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Full Name</label>
                                        <input required type="text" className="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} placeholder="Jane Doe" />
                                    </div>
                                )}
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Email Address</label>
                                    <input required type="email" className="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} placeholder="notary@example.com" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Password</label>
                                    <input required type="password" className="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
                                </div>
                                <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-all shadow-md transform active:scale-95">
                                    {isLogin ? 'Sign In' : 'Start Free Trial'}
                                </button>
                                
                                <div className="relative flex py-2 items-center">
                                    <div className="flex-grow border-t border-gray-200"></div>
                                    <span className="flex-shrink-0 mx-4 text-gray-400 text-xs">OR</span>
                                    <div className="flex-grow border-t border-gray-200"></div>
                                </div>

                                <button type="button" onClick={handleGoogleAuth} className="w-full bg-white border border-gray-300 text-gray-700 font-bold py-3 rounded-lg transition-all shadow-sm hover:bg-gray-50 flex items-center justify-center gap-2">
                                    <i className="fab fa-google text-red-500"></i> Continue with Google
                                </button>
                            </form>
                            <div className="mt-6 text-center text-sm">
                                <span className="text-gray-500">{isLogin ? "New to NotaryOS?" : "Already have an account?"}</span>
                                <button onClick={() => setIsLogin(!isLogin)} className="ml-2 text-blue-600 font-bold hover:text-blue-700 transition-colors">
                                    {isLogin ? 'Create Account' : 'Log In'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ currentView, setView, isOpen, onClose, onLogout, userName, userPlan, onUpgrade, onSettings, isCollapsed, onToggleCollapse }) => {
            const menuItems = [
                { id: 'dashboard', icon: 'fa-chart-pie', label: 'Dashboard', color: 'text-blue-400' },
                { id: 'schedule', icon: 'fa-calendar-alt', label: 'Schedule', color: 'text-green-400' },
                { id: 'clients', icon: 'fa-address-book', label: 'Clients', color: 'text-pink-400' },
                { id: 'journal', icon: 'fa-book', label: 'Journal', color: 'text-purple-400' },
                { id: 'finances', icon: 'fa-wallet', label: 'Finances', color: 'text-emerald-400' },
                { id: 'credentials', icon: 'fa-id-card', label: 'Credentials', color: 'text-orange-400' },
                { id: 'trainer', icon: 'fa-robot', label: 'AI Trainer', color: 'text-indigo-400', isPro: true },
                { id: 'admin', icon: 'fa-shield-alt', label: 'Admin', color: 'text-red-500' }
            ];

            return (
                <>
                    <div className={`fixed inset-0 bg-black bg-opacity-50 z-40 transition-opacity duration-300 lg:hidden ${isOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`} onClick={onClose}></div>
                    <div className={`fixed inset-y-0 left-0 bg-slate-900 text-white z-50 transform transition-all duration-300 ease-in-out lg:translate-x-0 lg:static lg:flex lg:flex-col ${isOpen ? 'translate-x-0' : '-translate-x-full'} ${isCollapsed ? 'lg:w-20' : 'lg:w-64'}`}>
                        <div className={`p-6 border-b border-slate-700 flex items-center ${isCollapsed ? 'justify-center' : 'justify-between'}`}>
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 p-2 rounded-lg"><i className="fas fa-stamp"></i></div>
                                {!isCollapsed && <h1 className="font-bold text-xl tracking-tight">NotaryOS</h1>}
                            </div>
                            <button onClick={onClose} className="lg:hidden text-slate-400 hover:text-white">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                            {!isCollapsed && (
                                <button onClick={onToggleCollapse} className="hidden lg:block text-slate-500 hover:text-white transition-colors">
                                    <i className="fas fa-angle-double-left"></i>
                                </button>
                            )}
                        </div>
                        
                        {isCollapsed && (
                            <div className="hidden lg:flex justify-center py-4 border-b border-slate-700">
                                <button onClick={onToggleCollapse} className="text-slate-500 hover:text-white transition-colors">
                                    <i className="fas fa-angle-double-right"></i>
                                </button>
                            </div>
                        )}

                        <nav className="flex-1 p-4 space-y-2 overflow-y-auto scrollbar-hide">
                            {menuItems.map(item => (
                                <button 
                                    key={item.id}
                                    onClick={() => { setView(item.id); onClose(); }}
                                    title={isCollapsed ? item.label : ''}
                                    className={`w-full flex items-center ${isCollapsed ? 'justify-center' : 'gap-3 px-4'} py-3 rounded-xl transition-all ${currentView === item.id ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800 hover:text-white'} group relative`}
                                >
                                    <i className={`fas ${item.icon} w-5 text-center ${item.color}`}></i>
                                    {!isCollapsed && <span className="font-medium text-sm">{item.label}</span>}
                                    {item.isPro && userPlan !== 'pro' && !isCollapsed && (
                                        <i className="fas fa-lock text-xs text-gray-500 absolute right-4"></i>
                                    )}
                                </button>
                            ))}
                        </nav>
                        
                        {userPlan !== 'pro' && !isCollapsed && (
                            <div className="px-4 pb-4">
                                <div className="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl p-4 text-center shadow-lg">
                                    <div className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-2 text-white">
                                        <i className="fas fa-crown"></i>
                                    </div>
                                    <h4 className="font-bold text-sm mb-1">Upgrade to Pro</h4>
                                    <p className="text-[10px] text-indigo-100 mb-3">Unlock AI Trainer & PDF Reports</p>
                                    <button onClick={onUpgrade} className="w-full bg-white text-indigo-600 text-xs font-bold py-2 rounded-lg hover:bg-gray-50 transition-colors">
                                        Upgrade Now
                                    </button>
                                </div>
                            </div>
                        )}

                        <div className="p-4 border-t border-slate-700">
                             <button onClick={onSettings} className={`w-full flex items-center ${isCollapsed ? 'justify-center' : 'gap-3 px-4'} py-2 mb-2 hover:bg-slate-800 rounded transition-colors group`}>
                                <div className="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-blue-300 flex-shrink-0">
                                    {userName ? userName.substring(0,2).toUpperCase() : 'US'}
                                </div>
                                {!isCollapsed && (
                                    <>
                                        <div className="flex-1 overflow-hidden text-left">
                                            <p className="text-xs font-bold truncate group-hover:text-white">{userName || 'User'}</p>
                                            <p className="text-[10px] text-slate-400 capitalize">{userPlan} Plan</p>
                                        </div>
                                        <i className="fas fa-cog text-slate-500 group-hover:text-white"></i>
                                    </>
                                )}
                            </button>
                            <button onClick={onLogout} title={isCollapsed ? 'Log Out' : ''} className={`w-full text-left ${isCollapsed ? 'justify-center' : 'px-4 gap-2'} py-2 text-xs text-red-400 hover:text-red-300 hover:bg-slate-800 rounded flex items-center transition-colors`}>
                                <i className="fas fa-sign-out-alt"></i> {!isCollapsed && "Log Out"}
                            </button>
                        </div>
                    </div>
                </>
            );
        };

        const MobileNav = ({ currentView, setView, onOpenMenu }) => {
            const menuItems = [
                { id: 'dashboard', icon: 'fa-chart-pie', label: 'Home', color: 'text-blue-500' },
                { id: 'schedule', icon: 'fa-calendar-alt', label: 'Schedule', color: 'text-green-500' },
                { id: 'add', icon: 'fa-plus-circle', label: 'Add', special: true },
                { id: 'trainer', icon: 'fa-robot', label: 'Trainer', color: 'text-indigo-500' },
                { id: 'menu', icon: 'fa-bars', label: 'Menu', action: onOpenMenu },
            ];

            return (
                <div className="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 flex justify-around items-center px-2 py-2 z-30 shadow-lg safe-area-pb">
                    {menuItems.map(item => (
                        <button 
                            key={item.id}
                            onClick={() => item.special ? setView('add_appointment') : (item.action ? item.action() : setView(item.id))}
                            className={`flex flex-col items-center justify-center w-full py-1 ${item.special ? '-mt-6' : ''}`}
                        >
                            {item.special ? (
                                <div className="w-14 h-14 bg-blue-600 rounded-full flex items-center justify-center text-white shadow-lg shadow-blue-600/30">
                                    <i className={`fas ${item.icon} text-2xl`}></i>
                                </div>
                            ) : (
                                <>
                                    <i className={`fas ${item.icon} text-lg mb-1 ${currentView === item.id ? 'text-blue-600' : 'text-gray-400'} ${item.color}`}></i>
                                    <span className={`text-[10px] font-medium ${currentView === item.id ? 'text-blue-600' : 'text-gray-400'}`}>{item.label}</span>
                                </>
                            )}
                        </button>
                    ))}
                </div>
            );
        };

        const Header = ({ title, isCloud }) => (
            <div className="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center sticky top-0 z-20">
                <div className="flex items-center gap-2">
                     <i className="fas fa-stamp text-blue-600 text-xl md:hidden"></i>
                    <h2 className="text-xl font-bold text-gray-800">{title}</h2>
                </div>
                <div className="flex items-center gap-4">
                    <div title={isCloud ? "Cloud Connected" : "Offline Mode (Local Save)"} className={`flex items-center gap-1 text-xs font-bold px-2 py-1 rounded ${isCloud ? "bg-green-100 text-green-700" : "bg-gray-100 text-gray-500"}`}>
                        <i className={`fas ${isCloud ? 'fa-cloud' : 'fa-save'}`}></i>
                        <span className="hidden sm:inline">{isCloud ? "Online" : "Local"}</span>
                    </div>
                    <button className="relative text-gray-400 hover:text-blue-600 transition-colors">
                        <i className="fas fa-bell text-xl"></i>
                        <span className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
                    </button>
                </div>
            </div>
        );

        // --- MODULES ---

        // NEW: CLIENTS MODULE
        const Toast = ({ message, type = 'success', onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle'
            };

            const colors = {
                success: 'bg-emerald-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };

            return (
                <div className={`fixed bottom-24 left-1/2 -translate-x-1/2 z-[200] flex items-center gap-3 px-6 py-3 rounded-2xl text-white shadow-2xl toast-in ${colors[type]}`}>
                    <i className={`fas ${icons[type]} text-lg`}></i>
                    <span className="font-bold text-sm whitespace-nowrap">{message}</span>
                </div>
            );
        };

        const EmptyState = ({ icon, title, description, actionLabel, onAction, colorClass = "text-blue-600", bgClass = "bg-blue-50" }) => (
            <div className="flex flex-col items-center justify-center py-20 px-6 text-center animate-fade-in">
                <div className={`w-24 h-24 ${bgClass} ${colorClass} rounded-full flex items-center justify-center mb-6 text-4xl shadow-inner`}>
                    <i className={`fas ${icon}`}></i>
                </div>
                <h3 className="text-xl font-bold text-gray-800 mb-2">{title}</h3>
                <p className="text-gray-500 max-w-xs mb-8 leading-relaxed">{description}</p>
                {onAction && (
                    <button 
                        onClick={onAction} 
                        className={`px-8 py-3 ${colorClass.replace('text', 'bg')} text-white rounded-2xl font-bold shadow-lg transform transition-all hover:scale-105 active:scale-95`}
                    >
                        {actionLabel}
                    </button>
                )}
            </div>
        );

        const Clients = () => {
            const [clients, setClients] = useState([]);
            const [showForm, setShowForm] = useState(false);

            useEffect(() => { DataManager.get('notary_clients').then(setClients); }, []);

            const handleSave = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                await DataManager.save('notary_clients', {
                    id: Date.now().toString(),
                    name: formData.get('name'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    address: formData.get('address'),
                    notes: formData.get('notes')
                });
                setShowForm(false);
                setClients(await DataManager.get('notary_clients'));
                window.showToast("Client saved successfully!");
            };

            const handleDelete = async (id) => {
                await DataManager.delete('notary_clients', id);
                setClients(await DataManager.get('notary_clients'));
                window.showToast("Client deleted", "info");
            };

            return (
                <div className="p-6 pb-24">
                     <div className="flex justify-between items-center mb-6"><h3 className="text-lg font-bold text-gray-800">Client Directory</h3><button onClick={() => setShowForm(true)} className="bg-pink-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-pink-700 transition-colors shadow-md"><i className="fas fa-plus mr-2"></i>Add</button></div>
                    {showForm && <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-6 animate-fade-in"><form onSubmit={handleSave} className="space-y-4"><input required name="name" type="text" placeholder="Client Name" className="w-full p-3 bg-gray-50 border rounded-xl" /><div className="grid grid-cols-2 gap-4"><input name="email" type="email" placeholder="Email" className="w-full p-3 bg-gray-50 border rounded-xl" /><input name="phone" type="tel" placeholder="Phone" className="w-full p-3 bg-gray-50 border rounded-xl" /></div><input name="address" type="text" placeholder="Address" className="w-full p-3 bg-gray-50 border rounded-xl" /><textarea name="notes" placeholder="Notes (Gate codes, preferences...)" className="w-full p-3 bg-gray-50 border rounded-xl h-24"></textarea><div className="flex gap-2"><button type="button" onClick={() => setShowForm(false)} className="flex-1 py-2 bg-gray-100 rounded-lg">Cancel</button><button type="submit" className="flex-1 py-2 bg-pink-600 text-white rounded-lg">Save Client</button></div></form></div>}
                    <div className="space-y-3">
                        {clients.length === 0 ? (
                            <EmptyState 
                                icon="fa-address-book"
                                title="No Clients Yet"
                                description="Start building your digital rolodex. Add your first client to keep their details handy for future signings."
                                actionLabel="Add First Client"
                                onAction={() => setShowForm(true)}
                                colorClass="text-pink-600"
                                bgClass="bg-pink-50"
                            />
                        ) : clients.sort((a,b) => a.name.localeCompare(b.name)).map(c => (
                            <div key={c.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center">
                                <div>
                                    <h4 className="font-bold text-gray-800">{c.name}</h4>
                                    <p className="text-xs text-gray-500">{c.phone} &bull; {c.email}</p>
                                </div>
                                <button onClick={() => handleDelete(c.id)} className="text-gray-300 hover:text-red-500 w-8 h-8 rounded-full hover:bg-red-50 flex items-center justify-center"><i className="fas fa-trash"></i></button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const Dashboard = ({ appointments, credentials, setView, isCloud }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            const today = new Date().toISOString().split('T')[0];
            const todaysJobs = appointments.filter(a => a.date === today && a.status !== 'Cancelled');
            const monthlyIncome = appointments.filter(a => a.status === 'Paid').reduce((sum, a) => sum + parseFloat(a.fee || 0), 0);
            
            // Calc Alerts
            const expiringCreds = credentials.filter(c => {
                const exp = new Date(c.expiry);
                const now = new Date();
                const diffTime = exp - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays <= 60; 
            });

            useEffect(() => {
                if (chartRef.current) {
                    const ctx = chartRef.current.getContext('2d');
                    
                    // Prepare data for last 6 months
                    const months = [];
                    const incomeData = [];
                    for (let i = 5; i >= 0; i--) {
                        const d = new Date();
                        d.setMonth(d.getMonth() - i);
                        const monthName = d.toLocaleString('default', { month: 'short' });
                        months.push(monthName);
                        
                        const monthStart = new Date(d.getFullYear(), d.getMonth(), 1);
                        const monthEnd = new Date(d.getFullYear(), d.getMonth() + 1, 0);
                        
                        const monthIncome = appointments
                            .filter(a => a.status === 'Paid')
                            .filter(a => {
                                const apptDate = new Date(a.date);
                                return apptDate >= monthStart && apptDate <= monthEnd;
                            })
                            .reduce((sum, a) => sum + parseFloat(a.fee || 0), 0);
                        
                        incomeData.push(monthIncome);
                    }

                    if (chartInstance.current) chartInstance.current.destroy();

                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: [{
                                label: 'Income ($)',
                                data: incomeData,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true,
                                tension: 0.4,
                                borderWidth: 3,
                                pointBackgroundColor: '#3b82f6',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: '#1e293b',
                                    titleFont: { size: 12, weight: 'bold' },
                                    bodyFont: { size: 12 },
                                    padding: 12,
                                    displayColors: false,
                                    callbacks: {
                                        label: (context) => `$${context.parsed.y.toFixed(2)}`
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { color: '#f1f5f9' },
                                    ticks: {
                                        font: { size: 10 },
                                        callback: (value) => `$${value}`
                                    }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { font: { size: 10 } }
                                }
                            }
                        }
                    });
                }
                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [appointments]);

            return (
                <div className="p-6 space-y-6 pb-24">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden">
                            <div className="absolute right-0 top-0 w-24 h-24 bg-green-50 rounded-bl-full -mr-4 -mt-4"></div>
                            <div className="relative">
                                <div className="text-gray-500 text-xs font-bold uppercase mb-1">Monthly Income</div>
                                <div className="text-2xl font-bold text-gray-800">${monthlyIncome.toFixed(2)}</div>
                                <div className="text-xs text-green-500 mt-1 font-medium"><i className="fas fa-arrow-up"></i> Updated just now</div>
                            </div>
                        </div>
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden">
                            <div className="absolute right-0 top-0 w-24 h-24 bg-blue-50 rounded-bl-full -mr-4 -mt-4"></div>
                            <div className="relative">
                                <div className="text-gray-500 text-xs font-bold uppercase mb-1">Today's Jobs</div>
                                <div className="text-2xl font-bold text-gray-800">{todaysJobs.length}</div>
                                <div className="text-xs text-blue-500 mt-1 font-medium"><i className="fas fa-calendar-day"></i> Check schedule</div>
                            </div>
                        </div>
                        <div onClick={() => setView('credentials')} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 cursor-pointer hover:bg-gray-50 relative overflow-hidden">
                            <div className={`absolute right-0 top-0 w-24 h-24 rounded-bl-full -mr-4 -mt-4 ${expiringCreds.length > 0 ? 'bg-red-50' : 'bg-gray-50'}`}></div>
                            <div className="relative">
                                <div className="text-gray-500 text-xs font-bold uppercase mb-1">Compliance Alerts</div>
                                <div className={`text-2xl font-bold ${expiringCreds.length > 0 ? 'text-red-600' : 'text-green-600'}`}>
                                    {expiringCreds.length}
                                </div>
                                <div className="text-xs text-gray-400 mt-1 font-medium">
                                    {expiringCreds.length > 0 ? `${expiringCreds.length} items expiring soon` : "All credentials active"}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-lg font-bold text-gray-800">Income Visualization</h3>
                                <div className="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Last 6 Months</div>
                            </div>
                            <div className="h-64 w-full">
                                <canvas ref={chartRef}></canvas>
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-lg font-bold text-gray-800">Today's Agenda</h3>
                                <button onClick={() => setView('schedule')} className="text-blue-600 text-sm font-semibold hover:underline">View All</button>
                            </div>
                            
                            {todaysJobs.length === 0 ? (
                                <div className="text-center py-12">
                                    <div className="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-300">
                                        <i className="fas fa-coffee"></i>
                                    </div>
                                    <p className="text-gray-500 text-sm">No appointments scheduled for today.</p>
                                    <button onClick={() => setView('schedule')} className="mt-4 text-blue-600 text-sm font-semibold hover:underline">Add one now</button>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {todaysJobs.map(job => (
                                        <div key={job.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center">
                                            <div className="flex gap-4 items-center">
                                                <div className="bg-blue-50 text-blue-600 w-12 h-12 rounded-lg flex flex-col items-center justify-center text-xs font-bold leading-none">
                                                    <span>{job.time.split(':')[0]}</span>
                                                    <span className="text-[10px] opacity-70">{job.time.split(':')[1]}</span>
                                                </div>
                                                <div>
                                                    <h4 className="font-bold text-gray-800">{job.clientName}</h4>
                                                    <p className="text-xs text-gray-500"><i className="fas fa-map-marker-alt mr-1"></i>{job.location}</p>
                                                </div>
                                            </div>
                                            <span className={`text-[10px] px-2 py-1 rounded-full font-bold uppercase tracking-wide status-${job.status.toLowerCase()}`}>
                                                {job.status}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const Credentials = ({ onUpdate }) => {
            const [creds, setCreds] = useState([]);
            const [showForm, setShowForm] = useState(false);
            
            useEffect(() => {
                const load = async () => {
                    const data = await DataManager.get('notary_credentials');
                    setCreds(data);
                };
                load();
            }, []);

            const handleSave = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                await DataManager.save('notary_credentials', {
                    id: Date.now().toString(),
                    name: formData.get('name'),
                    expiry: formData.get('expiry')
                });
                const updated = await DataManager.get('notary_credentials');
                setCreds(updated);
                onUpdate();
                setShowForm(false);
                window.showToast("Credential saved successfully!");
            };

            const handleDelete = async (id) => {
                await DataManager.delete('notary_credentials', id);
                const updated = await DataManager.get('notary_credentials');
                setCreds(updated);
                onUpdate();
            };

            return (
                <div className="p-6 pb-24">
                     <div className="flex justify-between items-center mb-6">
                        <h3 className="text-lg font-bold text-gray-800">My Credentials</h3>
                        <button onClick={() => setShowForm(true)} className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-indigo-700 transition-colors shadow-md"><i className="fas fa-plus mr-2"></i>Add</button>
                    </div>

                    {showForm && (
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-6 animate-fade-in">
                            <form onSubmit={handleSave} className="space-y-4">
                                <input required name="name" type="text" placeholder="Credential Name (e.g. Commission, Bond)" className="w-full p-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" />
                                <input required name="expiry" type="date" className="w-full p-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" />
                                <div className="flex gap-2">
                                    <button type="button" onClick={() => setShowForm(false)} className="flex-1 py-2 bg-gray-100 rounded-lg font-medium">Cancel</button>
                                    <button type="submit" className="flex-1 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700">Save</button>
                                </div>
                            </form>
                        </div>
                    )}

                    <div className="space-y-3">
                        {creds.length === 0 ? (
                            <EmptyState 
                                icon="fa-id-card"
                                title="No Credentials"
                                description="Keep track of your commission, bond, and insurance. We'll alert you before they expire."
                                actionLabel="Add Credential"
                                onAction={() => setShowForm(true)}
                                colorClass="text-orange-600"
                                bgClass="bg-orange-50"
                            />
                        ) : creds.sort((a,b) => new Date(a.expiry) - new Date(b.expiry)).map(c => {
                            const daysLeft = Math.ceil((new Date(c.expiry) - new Date()) / (1000 * 60 * 60 * 24));
                            const statusColor = daysLeft < 0 ? 'bg-red-100 text-red-700' : (daysLeft < 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-700');
                            
                            return (
                                <div key={c.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center">
                                    <div>
                                        <h4 className="font-bold text-gray-800">{c.name}</h4>
                                        <p className="text-xs text-gray-500 mt-1"><i className="far fa-calendar-alt mr-1"></i> Expires: {c.expiry}</p>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <span className={`text-xs px-3 py-1 rounded-full font-bold uppercase ${statusColor}`}>
                                            {daysLeft < 0 ? 'EXPIRED' : `${daysLeft} days`}
                                        </span>
                                        <button onClick={() => handleDelete(c.id)} className="text-gray-300 hover:text-red-500 w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 transition-colors"><i className="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const AppointmentForm = ({ onSave, onCancel, initialData }) => {
            const [formData, setFormData] = useState(initialData || {
                clientName: '', date: new Date().toISOString().split('T')[0], time: '12:00',
                location: '', type: 'General Notarization', fee: '', status: 'Scheduled', notes: ''
            });
            const [smartInput, setSmartInput] = useState('');
            const [isParsing, setIsParsing] = useState(false);

            const handleSmartFill = async () => {
                const apiKey = localStorage.getItem('gemini_api_key');
                if (!apiKey) {
                    alert("Please set your Gemini API Key in the AI Trainer module first.");
                    return;
                }
                if (!smartInput.trim()) return;

                setIsParsing(true);
                const today = new Date().toISOString().split('T')[0];
                const prompt = `
                    Extract appointment details from this sentence: "${smartInput}"
                    Today's date is ${today}.
                    Return ONLY a JSON object with these keys: clientName, date (YYYY-MM-DD), time (HH:mm), location, fee (number), type, notes.
                    If a field is missing, use these defaults: date: ${today}, time: 12:00, type: General Notarization, fee: 0.
                    Example: "Signing with John Doe tomorrow at 2pm for $50 at Starbucks" -> {"clientName": "John Doe", "date": "2024-05-21", "time": "14:00", "location": "Starbucks", "fee": 50, "type": "Signing", "notes": ""}
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    const jsonMatch = aiText.match(/\{.*\}/s);
                    if (jsonMatch) {
                        const parsed = JSON.parse(jsonMatch[0]);
                        setFormData(prev => ({ ...prev, ...parsed }));
                        setSmartInput('');
                    } else {
                        alert("Could not parse the sentence. Please try again with more detail.");
                    }
                } catch (error) {
                    alert("AI Fill Error: " + error.message);
                } finally {
                    setIsParsing(false);
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({ ...formData, id: initialData?.id || Date.now().toString() });
            };

            return (
                <div className="p-6 max-w-2xl mx-auto">
                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-lg font-bold flex items-center gap-2"><i className="fas fa-calendar-plus text-blue-600"></i>{initialData ? 'Edit Appointment' : 'New Appointment'}</h3>
                            {!initialData && (
                                <div className="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded-full font-bold uppercase tracking-wider">
                                    <i className="fas fa-magic mr-1"></i> AI Powered
                                </div>
                            )}
                        </div>

                        {!initialData && (
                            <div className="mb-8 p-4 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl border border-blue-100">
                                <label className="block text-xs font-bold text-blue-600 uppercase mb-2 ml-1">Magic Smart Fill</label>
                                <div className="flex gap-2">
                                    <input 
                                        type="text" 
                                        placeholder='e.g. "Signing with John Doe tomorrow at 2pm for $50 at Starbucks"' 
                                        className="flex-1 p-3 bg-white border border-blue-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                        value={smartInput}
                                        onChange={e => setSmartInput(e.target.value)}
                                        onKeyDown={e => e.key === 'Enter' && handleSmartFill()}
                                    />
                                    <button 
                                        type="button"
                                        onClick={handleSmartFill}
                                        disabled={isParsing}
                                        className="bg-blue-600 text-white px-4 rounded-xl font-bold text-sm shadow-md hover:bg-blue-700 transition-all flex items-center gap-2 disabled:opacity-50"
                                    >
                                        {isParsing ? <i className="fas fa-spinner animate-spin"></i> : <i className="fas fa-wand-magic-sparkles"></i>}
                                        <span className="hidden sm:inline">AI Fill</span>
                                    </button>
                                </div>
                                <p className="text-[10px] text-blue-400 mt-2 ml-1 italic">Type a sentence and let AI fill the form for you.</p>
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Client Name</label>
                                <input required type="text" placeholder="Client Name" className="w-full p-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" value={formData.clientName} onChange={e => setFormData({...formData, clientName: e.target.value})} />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Date</label>
                                    <input required type="date" className="w-full p-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Time</label>
                                    <input required type="time" className="w-full p-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" value={formData.time} onChange={e => setFormData({...formData, time: e.target.value})} />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Location</label>
                                <input required type="text" placeholder="Location" className="w-full p-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" value={formData.location} onChange={e => setFormData({...formData, location: e.target.value})} />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Fee ($)</label>
                                    <input required type="number" placeholder="Fee ($)" className="w-full p-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" value={formData.fee} onChange={e => setFormData({...formData, fee: e.target.value})} />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Status</label>
                                    <select className="w-full p-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" value={formData.status} onChange={e => setFormData({...formData, status: e.target.value})}>
                                        <option>Scheduled</option><option>Completed</option><option>Paid</option><option>Cancelled</option>
                                    </select>
                                </div>
                            </div>
                            <div className="flex gap-3 pt-4">
                                <button type="button" onClick={onCancel} className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">Cancel</button>
                                <button type="submit" className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-100">Save Appointment</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const Schedule = ({ appointments, setView, onEdit, user, onUpgrade }) => {
            const [viewMode, setViewMode] = useState('list'); // 'list' or 'calendar'
            const [currentMonth, setCurrentMonth] = useState(new Date());

            const handleInvoice = (job) => {
                if (user.plan !== 'pro') {
                    onUpgrade();
                    return;
                }
                if (window.jspdf) PDFGenerator.createInvoice(job, user);
                else alert("PDF library loading. Try again in 2 seconds.");
            };

            const renderCalendar = () => {
                const year = currentMonth.getFullYear();
                const month = currentMonth.getMonth();
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                const days = [];
                for (let i = 0; i < firstDay; i++) days.push(null);
                for (let i = 1; i <= daysInMonth; i++) days.push(i);

                const monthName = currentMonth.toLocaleString('default', { month: 'long' });

                return (
                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <div className="p-4 bg-gray-50 border-b flex justify-between items-center">
                            <button onClick={() => setCurrentMonth(new Date(year, month - 1))} className="p-2 hover:bg-gray-200 rounded-full transition-colors"><i className="fas fa-chevron-left"></i></button>
                            <h4 className="font-bold text-gray-800">{monthName} {year}</h4>
                            <button onClick={() => setCurrentMonth(new Date(year, month + 1))} className="p-2 hover:bg-gray-200 rounded-full transition-colors"><i className="fas fa-chevron-right"></i></button>
                        </div>
                        <div className="grid grid-cols-7 text-center border-b">
                            {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => (
                                <div key={d} className="py-2 text-[10px] font-bold text-gray-400 uppercase">{d}</div>
                            ))}
                        </div>
                        <div className="grid grid-cols-7">
                            {days.map((day, i) => {
                                if (!day) return <div key={`empty-${i}`} className="h-24 border-b border-r border-gray-50 bg-gray-50/30"></div>;
                                
                                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                const dayJobs = appointments.filter(a => a.date === dateStr);
                                const isToday = new Date().toISOString().split('T')[0] === dateStr;

                                return (
                                    <div key={day} className={`h-24 border-b border-r border-gray-50 p-1 overflow-y-auto scrollbar-hide ${isToday ? 'bg-blue-50/30' : ''}`}>
                                        <div className="flex justify-between items-center mb-1">
                                            <span className={`text-xs font-bold ${isToday ? 'bg-blue-600 text-white w-5 h-5 flex items-center justify-center rounded-full' : 'text-gray-400'}`}>{day}</span>
                                        </div>
                                        <div className="space-y-1">
                                            {dayJobs.map(job => (
                                                <div 
                                                    key={job.id} 
                                                    onClick={() => onEdit(job)}
                                                    className="text-[9px] p-1 rounded bg-blue-100 text-blue-700 font-bold truncate cursor-pointer hover:bg-blue-200 transition-colors"
                                                    title={`${job.time} - ${job.clientName}`}
                                                >
                                                    {job.time} {job.clientName}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            return (
                <div className="p-6 pb-24">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                        <h3 className="text-lg font-bold text-gray-800">Smart Schedule</h3>
                        <div className="flex items-center gap-2 w-full sm:w-auto">
                            <div className="bg-gray-100 p-1 rounded-xl flex flex-1 sm:flex-none">
                                <button 
                                    onClick={() => setViewMode('list')} 
                                    className={`flex-1 sm:px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${viewMode === 'list' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
                                >
                                    <i className="fas fa-list-ul mr-1"></i> List
                                </button>
                                <button 
                                    onClick={() => setViewMode('calendar')} 
                                    className={`flex-1 sm:px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${viewMode === 'calendar' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
                                >
                                    <i className="fas fa-calendar-alt mr-1"></i> Calendar
                                </button>
                            </div>
                            <button onClick={() => setView('addAppointment')} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors shadow-md flex items-center gap-2">
                                <i className="fas fa-plus"></i> <span className="hidden sm:inline">New</span>
                            </button>
                        </div>
                    </div>

                    {viewMode === 'calendar' ? renderCalendar() : (
                        <div className="space-y-3">
                            {appointments.length === 0 ? (
                                <EmptyState 
                                    icon="fa-calendar-alt"
                                    title="Schedule is Empty"
                                    description="You don't have any appointments scheduled. Use the 'New' button or try the Magic Smart Fill to add one."
                                    actionLabel="Schedule Now"
                                    onAction={() => setView('addAppointment')}
                                    colorClass="text-blue-600"
                                    bgClass="bg-blue-50"
                                />
                            ) : appointments.sort((a,b) => new Date(a.date) - new Date(b.date)).map(job => (
                                <div key={job.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow">
                                    <div onClick={() => onEdit(job)} className="cursor-pointer">
                                        <div className="flex justify-between items-start mb-2">
                                            <div>
                                                <span className="text-[10px] font-bold text-blue-500 uppercase tracking-wider bg-blue-50 px-2 py-0.5 rounded">{job.type}</span>
                                                <h4 className="font-bold text-gray-800 text-lg mt-1">{job.clientName}</h4>
                                            </div>
                                            <span className={`text-[10px] px-2 py-1 rounded-full font-bold uppercase tracking-wide status-${job.status.toLowerCase()}`}>{job.status}</span>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4 text-sm text-gray-600 mt-3 pt-3 border-t border-gray-50">
                                            <div className="flex items-center gap-2"><i className="far fa-calendar-alt text-blue-400"></i> {job.date} at {job.time}</div>
                                            <div className="text-right font-bold text-gray-800">${job.fee}</div>
                                        </div>
                                    </div>
                                    <div className="mt-3 pt-2 border-t border-gray-100 flex justify-between items-center">
                                        <p className="text-[10px] text-gray-400 flex items-center gap-1"><i className="fas fa-map-marker-alt"></i> {job.location}</p>
                                        <button onClick={(e) => { e.stopPropagation(); handleInvoice(job); }} className={`text-xs font-bold flex items-center gap-1 px-2 py-1 rounded transition-colors ${user.plan === 'pro' ? 'text-blue-600 hover:bg-blue-50' : 'text-gray-400 hover:text-indigo-600'}`}>
                                            <i className={`fas ${user.plan === 'pro' ? 'fa-file-invoice' : 'fa-lock'}`}></i> {user.plan === 'pro' ? 'Invoice' : 'Invoice (Pro)'}
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const Journal = ({ onUpdate, user, onUpgrade }) => {
            const [entries, setEntries] = useState([]);
            const [showForm, setShowForm] = useState(false);

            useEffect(() => {
                const load = async () => {
                    const data = await DataManager.get('notary_journal');
                    setEntries(data);
                };
                load();
            }, []);

            const handleSave = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                await DataManager.save('notary_journal', { id: Date.now().toString(), date: formData.get('date'), time: formData.get('time'), signer: formData.get('signer'), docType: formData.get('docType'), idType: formData.get('idType'), fee: formData.get('fee') });
                onUpdate(); 
                setShowForm(false); 
                setEntries(await DataManager.get('notary_journal'));
                window.showToast("Journal entry logged!");
            };

            const handleExport = () => {
                 // GATE: Export is a Pro feature
                 if (user.plan !== 'pro') {
                    onUpgrade();
                    return;
                }
                if (window.jspdf) PDFGenerator.createReport("Notary Journal Log", ["Date", "Time", "Signer", "Doc Type", "Fee"], entries.map(e => [e.date, e.time, e.signer, e.docType, `$${e.fee}`]), "journal_log.pdf");
            };

            return (
                <div className="p-6 pb-24">
                     <div className="flex justify-between items-center mb-6">
                        <div className="flex gap-2 items-center">
                            <h3 className="text-lg font-bold text-gray-800">Journal</h3>
                            <button onClick={handleExport} className={`text-xs px-2 py-1 rounded border ${user.plan === 'pro' ? 'text-gray-500 hover:text-blue-600' : 'text-gray-300'}`} title="Export PDF">
                                <i className={`fas ${user.plan === 'pro' ? 'fa-file-export' : 'fa-lock'}`}></i>
                            </button>
                        </div>
                        <button onClick={() => setShowForm(true)} className="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-purple-700 transition-colors shadow-md"><i className="fas fa-plus mr-2"></i>Log</button>
                    </div>

                    {showForm && (
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-6">
                            <form onSubmit={handleSave} className="space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <input required name="date" type="date" defaultValue={new Date().toISOString().split('T')[0]} className="w-full p-3 bg-gray-50 border rounded-xl" />
                                    <input required name="time" type="time" defaultValue="12:00" className="w-full p-3 bg-gray-50 border rounded-xl" />
                                </div>
                                <input required name="signer" type="text" placeholder="Signer Name" className="w-full p-3 bg-gray-50 border rounded-xl" />
                                <div className="grid grid-cols-2 gap-4">
                                    <input required name="docType" type="text" placeholder="Document Type" className="w-full p-3 bg-gray-50 border rounded-xl" />
                                    <input required name="idType" type="text" placeholder="ID Type (e.g. DL)" className="w-full p-3 bg-gray-50 border rounded-xl" />
                                </div>
                                <input name="fee" type="number" placeholder="Fee Charged ($)" className="w-full p-3 bg-gray-50 border rounded-xl" />
                                <div className="flex gap-2">
                                    <button type="button" onClick={() => setShowForm(false)} className="flex-1 py-2 bg-gray-100 rounded-lg">Cancel</button>
                                    <button type="submit" className="flex-1 py-2 bg-purple-600 text-white rounded-lg">Save Entry</button>
                                </div>
                            </form>
                        </div>
                    )}

                    <div className="space-y-3">
                        {entries.length === 0 ? (
                            <EmptyState 
                                icon="fa-book"
                                title="Journal is Empty"
                                description="Maintain a compliant digital record of your notarizations. Log your first entry to stay organized."
                                actionLabel="Log First Entry"
                                onAction={() => setShowForm(true)}
                                colorClass="text-purple-600"
                                bgClass="bg-purple-50"
                            />
                        ) : entries.sort((a,b) => new Date(b.date) - new Date(a.date)).map(entry => (
                            <div key={entry.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <h4 className="font-bold text-gray-800">{entry.signer}</h4>
                                        <p className="text-xs text-gray-500 mt-1"><i className="far fa-file-alt mr-1"></i> {entry.docType}</p>
                                    </div>
                                    <span className="text-xs text-gray-400 font-mono">{entry.date}</span>
                                </div>
                                <div className="mt-3 pt-3 border-t border-gray-50 flex justify-between items-center text-xs text-gray-500">
                                    <span>ID: {entry.idType}</span>
                                    <span className="font-bold text-purple-600">${entry.fee}</span>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const Finances = () => {
            const [activeTab, setActiveTab] = useState('expenses');
            const [expenses, setExpenses] = useState([]);
            const [mileage, setMileage] = useState([]);
            const [showForm, setShowForm] = useState(false);

             useEffect(() => { const load = async () => { setExpenses(await DataManager.get('notary_expenses')); setMileage(await DataManager.get('notary_mileage')); }; load(); }, []);

            const handleSave = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                if (activeTab === 'expenses') {
                    await DataManager.save('notary_expenses', { id: Date.now().toString(), date: formData.get('date'), category: formData.get('category'), desc: formData.get('desc'), amount: formData.get('amount') });
                    setExpenses(await DataManager.get('notary_expenses'));
                    window.showToast("Expense saved!");
                } else {
                    await DataManager.save('notary_mileage', { id: Date.now().toString(), date: formData.get('date'), start: formData.get('start'), end: formData.get('end'), miles: formData.get('miles') });
                    setMileage(await DataManager.get('notary_mileage'));
                    window.showToast("Mileage logged!");
                }
                setShowForm(false);
            };
            
            const handleExport = () => {
                if (activeTab === 'expenses') PDFGenerator.createReport("Expense Report", ["Date", "Category", "Description", "Amount"], expenses.map(e => [e.date, e.category, e.desc, `-$${e.amount}`]), "expenses.pdf");
                else PDFGenerator.createReport("Mileage Log", ["Date", "Start", "End", "Miles"], mileage.map(m => [m.date, m.start, m.end, `${m.miles} mi`]), "mileage.pdf");
            };

            return (
                <div className="p-6 pb-24">
                    <div className="bg-white p-1 rounded-xl flex mb-6 border border-gray-200 shadow-sm"><button onClick={() => setActiveTab('expenses')} className={`flex-1 py-2 text-sm font-bold rounded-lg ${activeTab === 'expenses' ? 'bg-emerald-50 text-emerald-700 shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}>Expenses</button><button onClick={() => setActiveTab('mileage')} className={`flex-1 py-2 text-sm font-bold rounded-lg ${activeTab === 'mileage' ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}>Mileage</button></div>
                    <div className="flex justify-between items-center mb-6"><div><p className="text-xs text-gray-500 uppercase font-bold">Total</p><p className="text-2xl font-bold text-gray-800">{activeTab === 'expenses' ? `$${expenses.reduce((s, i) => s + parseFloat(i.amount||0), 0).toFixed(2)}` : `${mileage.reduce((s, i) => s + parseFloat(i.miles||0), 0)} mi`}</p></div><div className="flex gap-2"><button onClick={handleExport} className="bg-white text-gray-500 border w-10 h-10 rounded-full flex items-center justify-center"><i className="fas fa-file-export"></i></button><button onClick={() => setShowForm(true)} className="bg-gray-900 text-white w-10 h-10 rounded-full flex items-center justify-center"><i className="fas fa-plus"></i></button></div></div>
                    {showForm && <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-6"><form onSubmit={handleSave} className="space-y-4"><input required name="date" type="date" className="w-full p-3 bg-gray-50 border rounded-xl" />{activeTab === 'expenses' ? <><select name="category" className="w-full p-3 bg-gray-50 border rounded-xl"><option>Supplies</option><option>Insurance</option><option>Training</option><option>Software</option><option>Travel</option></select><input required name="desc" type="text" placeholder="Description" className="w-full p-3 bg-gray-50 border rounded-xl" /><input required name="amount" type="number" step="0.01" placeholder="Amount" className="w-full p-3 bg-gray-50 border rounded-xl" /></> : <><input required name="start" type="text" placeholder="Start" className="w-full p-3 bg-gray-50 border rounded-xl" /><input required name="end" type="text" placeholder="End" className="w-full p-3 bg-gray-50 border rounded-xl" /><input required name="miles" type="number" step="0.1" placeholder="Miles" className="w-full p-3 bg-gray-50 border rounded-xl" /></>}<div className="flex gap-2"><button type="button" onClick={() => setShowForm(false)} className="flex-1 py-2 bg-gray-100 rounded-lg">Cancel</button><button type="submit" className="flex-1 py-2 bg-gray-900 text-white rounded-lg">Save</button></div></form></div>}
                    <div className="space-y-3">
                        {activeTab === 'expenses' ? (
                            expenses.length === 0 ? (
                                <EmptyState 
                                    icon="fa-receipt"
                                    title="No Expenses"
                                    description="Track your business costs for tax season. Log supplies, insurance, and travel expenses here."
                                    actionLabel="Log Expense"
                                    onAction={() => setShowForm(true)}
                                    colorClass="text-emerald-600"
                                    bgClass="bg-emerald-50"
                                />
                            ) : expenses.map(e => <div key={e.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between"><div><p className="font-bold text-gray-800">{e.desc}</p><p className="text-xs text-gray-500">{e.date} &bull; {e.category}</p></div><span className="font-mono text-red-600">-${e.amount}</span></div>)
                        ) : (
                            mileage.length === 0 ? (
                                <EmptyState 
                                    icon="fa-car"
                                    title="No Mileage Logged"
                                    description="Don't miss out on mileage deductions. Track your travel to and from signing appointments."
                                    actionLabel="Log Mileage"
                                    onAction={() => setShowForm(true)}
                                    colorClass="text-blue-600"
                                    bgClass="bg-blue-50"
                                />
                            ) : mileage.map(m => <div key={m.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm"><div className="flex justify-between"><span className="text-xs text-gray-500">{m.date}</span><span className="font-bold text-blue-600">{m.miles} mi</span></div><div className="text-sm text-gray-800">{m.start} <i className="fas fa-arrow-right text-xs"></i> {m.end}</div></div>)
                        )}
                    </div>
                </div>
            );
        };

        const TrainerModule = ({ stateDB, courseMods, user, onUpgrade }) => {
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || '');
            const [hasKey, setHasKey] = useState(!!apiKey);
            const [selectedStateKey, setSelectedStateKey] = useState('OH');
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [mode, setMode] = useState('study'); 
            const [currentModule, setCurrentModule] = useState(0); 
            const [showCertModal, setShowCertModal] = useState(false);
            const [certType, setCertType] = useState('ack');
            const messagesEndRef = useRef(null);

            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

            const handleModeSwitch = (newMode) => {
                setMode(newMode);
                let msg = "";
                if (newMode === 'study') msg = "ðŸ“š **Study Mode Active.**\n\nAsk me any factual question about state laws, fees, or ID requirements. I'm here to help!";
                if (newMode === 'course') msg = "ðŸŽ“ **Course Mode Active.**\n\nI will guide you through the 10-module curriculum step-by-step. Click 'Start Module 1' below when ready.";
                if (newMode === 'scenario') msg = "ðŸŽ­ **Roleplay Mode Active.**\n\nI am now acting as your client. I might try to trick you with an illegal request. Type 'Hi' to start the simulation.";
                setMessages(prev => [...prev, { role: 'assistant', content: msg }]);
            };

            const startTraining = () => {
                if(apiKey.trim()) {
                    localStorage.setItem('gemini_api_key', apiKey);
                    setHasKey(true);
                    const stateName = stateDB[selectedStateKey].state;
                    setMessages([{ role: 'assistant', content: `**NotaryPro Mentor Online.**\n\nJurisdiction Locked: **${stateName}**.\n\nPlease select a mode above to begin your session.` }]);
                }
            };

            const sendMessage = async (overrideInput = null) => {
                const textToSend = overrideInput || input;
                if (!textToSend) return;
                
                const newMessages = [...messages, { role: 'user', content: textToSend }];
                setMessages(newMessages);
                setInput('');
                setLoading(true);

                const stateData = stateDB[selectedStateKey];
                
                let courseContext = "";
                if (mode === 'course' && currentModule > 0) {
                    const mod = courseMods[currentModule-1];
                    courseContext = `TEACHING MODULE ${mod.id}: ${mod.title}. TOPIC: ${mod.topic}. Explain concept using Markdown, then QUIZ user.`;
                }

                const SYSTEM_PROMPT = `
                    ${PERSONA}
                    STATE DATA (${stateData.state}): ${JSON.stringify(stateData)}
                    ${courseContext}
                    MODE: ${mode.toUpperCase()}
                    RULES: Use Markdown. Bold key terms. In Scenario mode, guide user gently if they make a mistake. Keep concise.
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: SYSTEM_PROMPT }] }, ...newMessages.map(m => ({ role: m.role === 'assistant' ? 'model' : 'user', parts: [{ text: m.content }] }))] })
                    });
                    const data = await response.json();
                    const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Error: No response.";
                    setMessages([...newMessages, { role: 'assistant', content: aiText }]);
                } catch (error) {
                    setMessages([...newMessages, { role: 'assistant', content: "API Error: " + error.message }]);
                } finally {
                    setLoading(false);
                }
            };

            // Cert Modal Logic
            const getCertText = (type) => {
                const stateData = stateDB[selectedStateKey];
                const text = type === 'ack' ? stateData.certificates.acknowledgment_text : stateData.certificates.jurat_text;
                if (!text || text === "null" || text === "Not specified") return "Specific certificate wording is not available in the current database for this state.";
                return text;
            };
            
            // --- GATEKEEPER ---
            if (user.plan !== 'pro') {
                return (
                     <div className="h-full flex flex-col items-center justify-center p-8 text-center">
                        <div className="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mb-6 text-indigo-500">
                            <i className="fas fa-lock text-3xl"></i>
                        </div>
                        <h2 className="text-2xl font-bold text-gray-800 mb-2">AI Trainer Locked</h2>
                        <p className="text-gray-500 max-w-sm mb-8">Upgrade to the Pro Plan to access the 50-State AI Mentor, Course Mode, and Unlimited Scenarios.</p>
                        <button onClick={onUpgrade} className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all">
                            Unlock for $19/mo
                        </button>
                    </div>
                );
            }

            if (!hasKey) return (
                <div className="h-full flex flex-col items-center justify-center p-6 text-center">
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 max-w-md w-full">
                        <i className="fas fa-robot text-5xl text-blue-600 mb-4"></i>
                        <h2 className="text-xl font-bold mb-2">Activate AI Trainer</h2>
                        <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} placeholder="API Key" className="w-full p-3 border rounded-xl mb-4" />
                        <button onClick={startTraining} className="w-full bg-blue-600 text-white p-3 rounded-xl font-bold">Start</button>
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col h-full bg-white relative pb-20 md:pb-0">
                    <div className="border-b px-4 py-3 flex justify-between items-center bg-gray-50">
                        <select value={selectedStateKey} onChange={e => { setSelectedStateKey(e.target.value); setMessages([]); }} className="bg-white border text-sm rounded-lg p-2 font-semibold text-gray-700">
                            {Object.entries(stateDB).map(([k,v]) => <option key={k} value={k}>{v.state}</option>)}
                        </select>
                        <div className="flex gap-2">
                            <button onClick={() => handleModeSwitch('study')} className={`px-3 py-1 rounded text-xs font-bold ${mode === 'study' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}`}>Study</button>
                            <button onClick={() => handleModeSwitch('course')} className={`px-3 py-1 rounded text-xs font-bold ${mode === 'course' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}`}>Course</button>
                            <button onClick={() => handleModeSwitch('scenario')} className={`px-3 py-1 rounded text-xs font-bold ${mode === 'scenario' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}`}>Sim</button>
                            <button onClick={() => setShowCertModal(true)} className="px-3 py-1 rounded text-xs font-bold bg-yellow-400 text-white ml-2"><i className="fas fa-file-contract"></i></button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 pb-4">
                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] p-4 rounded-2xl text-sm ${m.role === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-800'}`}>
                                    <div className="prose prose-sm max-w-none" dangerouslySetInnerHTML={{ __html: DOMPurify.sanitize(marked.parse(m.content)) }} />
                                </div>
                            </div>
                        ))}
                        {loading && <div className="typing-indicator ml-4"><span></span><span></span><span></span></div>}
                        <div ref={messagesEndRef} />
                    </div>
                    
                    {/* Disclaimer Footer in Chat Area */}
                    <div className="px-4 pb-2 text-[10px] text-gray-400 text-center italic">
                        AI may make mistakes. Always check your official state handbook.
                    </div>

                    <div className="p-4 border-t bg-white flex gap-2 pb-24 md:pb-4 safe-area-pb">
                        {mode === 'course' && (
                            <button onClick={() => { setCurrentModule(p => p+1); sendMessage(`Start Module ${currentModule+1}`); }} className="bg-green-600 text-white px-4 rounded-xl text-xs font-bold shadow-md hover:bg-green-700 transition-colors">Next</button>
                        )}
                        <input value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && sendMessage()} placeholder="Message AI..." className="flex-1 p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        <button onClick={() => sendMessage()} className="bg-blue-600 text-white w-12 rounded-xl shadow-md hover:bg-blue-700 transition-colors"><i className="fas fa-paper-plane"></i></button>
                    </div>

                    {/* CERT MODAL */}
                    {showCertModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                                <div className="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                                    <h3 className="font-bold text-lg text-gray-800">Certificates: {stateDB[selectedStateKey].state}</h3>
                                    <button onClick={() => setShowCertModal(false)} className="text-gray-500 hover:text-gray-800"><i className="fas fa-times text-xl"></i></button>
                                </div>
                                <div className="p-2 bg-white flex gap-2 border-b">
                                    <button onClick={() => setCertType('ack')} className={`flex-1 py-2 px-3 rounded text-sm font-medium ${certType === 'ack' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'}`}>Acknowledgment</button>
                                    <button onClick={() => setCertType('jurat')} className={`flex-1 py-2 px-3 rounded text-sm font-medium ${certType === 'jurat' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'}`}>Jurat</button>
                                </div>
                                <div className="p-6 overflow-y-auto bg-gray-100 flex-1">
                                    <div className="paper-doc p-8 text-sm sm:text-base leading-relaxed text-gray-800 relative">
                                        <div className="absolute inset-0 flex items-center justify-center opacity-[0.03] pointer-events-none"><i className="fas fa-stamp text-9xl"></i></div>
                                        <h4 className="font-bold text-center mb-6 uppercase underline tracking-wider">{certType === 'ack' ? 'Certificate of Acknowledgment' : 'Jurat / Verification on Oath'}</h4>
                                        <div className="whitespace-pre-wrap">{getCertText(certType)}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const WelcomeTour = ({ onComplete }) => {
            const [step, setStep] = useState(0);
            const steps = [
                {
                    title: "Welcome to NotaryOS! ðŸ“œ",
                    content: "The all-in-one operating system for modern notaries. Let's take a quick 5-step tour of your new workspace.",
                    icon: "fa-rocket",
                    color: "text-blue-600",
                    bg: "bg-blue-50"
                },
                {
                    title: "Business Dashboard",
                    content: "Track your monthly income, upcoming appointments, and get smart alerts for expiring credentials all in one place.",
                    icon: "fa-chart-pie",
                    color: "text-emerald-600",
                    bg: "bg-emerald-50"
                },
                {
                    title: "Schedule & Journal",
                    content: "Manage your appointments and maintain a digital, compliant journal of all your signing events.",
                    icon: "fa-calendar-check",
                    color: "text-purple-600",
                    bg: "bg-purple-50"
                },
                {
                    title: "AI Training Center",
                    content: "Access our 50-state knowledge base and practice with our 'Strict Mentor' AI to stay sharp on state laws.",
                    icon: "fa-robot",
                    color: "text-indigo-600",
                    bg: "bg-indigo-50"
                },
                {
                    title: "Settings & Profile",
                    content: "Customize your business details, commission info, and branding for professional PDF invoices.",
                    icon: "fa-cog",
                    color: "text-slate-600",
                    bg: "bg-slate-50"
                }
            ];

            const next = () => step < steps.length - 1 ? setStep(step + 1) : onComplete();
            const prev = () => step > 0 && setStep(step - 1);

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl shadow-2xl max-w-md w-full overflow-hidden auth-fade-in">
                        <div className={`p-8 ${steps[step].bg} flex flex-col items-center text-center transition-colors duration-500`}>
                            <div className={`w-20 h-20 ${steps[step].color} bg-white rounded-2xl shadow-lg flex items-center justify-center text-3xl mb-6 transform rotate-3`}>
                                <i className={`fas ${steps[step].icon}`}></i>
                            </div>
                            <h2 className="text-2xl font-extrabold text-gray-900 mb-2">{steps[step].title}</h2>
                            <p className="text-gray-600 leading-relaxed">{steps[step].content}</p>
                        </div>
                        <div className="p-6 bg-white">
                            <div className="flex justify-center gap-2 mb-6">
                                {steps.map((_, i) => (
                                    <div key={i} className={`h-1.5 rounded-full transition-all duration-300 ${i === step ? 'w-8 bg-blue-600' : 'w-2 bg-gray-200'}`}></div>
                                ))}
                            </div>
                            <div className="flex gap-3">
                                {step > 0 ? (
                                    <button onClick={prev} className="flex-1 py-3 px-4 rounded-xl font-bold text-gray-500 hover:bg-gray-50 transition-colors">
                                        Back
                                    </button>
                                ) : (
                                    <button onClick={onComplete} className="flex-1 py-3 px-4 rounded-xl font-bold text-gray-400 hover:text-gray-600 transition-colors">
                                        Skip
                                    </button>
                                )}
                                <button onClick={next} className="flex-[2] py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-200 transition-all transform active:scale-95">
                                    {step === steps.length - 1 ? "Get Started" : "Next Step"}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AdminPanel = ({ stateDB, onUpdateStateDB, courseMods, onUpdateCourseMods }) => {
            const [activeTab, setActiveTab] = useState('states');
            const [selectedState, setSelectedState] = useState(Object.keys(stateDB)[0]);
            const [editStateData, setEditStateData] = useState(stateDB[selectedState]);
            
            useEffect(() => { setEditStateData(stateDB[selectedState]); }, [selectedState, stateDB]);

            const handleStateSave = () => {
                const updatedDB = { ...stateDB, [selectedState]: editStateData };
                onUpdateStateDB(updatedDB);
                alert(`Saved changes for ${editStateData.state}`);
            };
            
            const handleCourseSave = (index, field, value) => {
                const newMods = [...courseMods];
                newMods[index][field] = value;
                onUpdateCourseMods(newMods);
            };

            return (
                <div className="p-6 pb-24">
                     <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                        <h3 className="font-bold text-red-800 flex items-center gap-2"><i className="fas fa-shield-alt"></i> Admin Control Panel</h3>
                        <p className="text-xs text-red-600">Changes made here update the AI Trainer immediately.</p>
                     </div>
                     <div className="bg-white p-1 rounded-xl flex mb-6 border border-gray-200 shadow-sm">
                        <button onClick={() => setActiveTab('states')} className={`flex-1 py-2 text-sm font-bold rounded-lg ${activeTab === 'states' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-500'}`}>State Laws</button>
                        <button onClick={() => setActiveTab('courses')} className={`flex-1 py-2 text-sm font-bold rounded-lg ${activeTab === 'courses' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-500'}`}>Curriculum</button>
                     </div>
                     {activeTab === 'states' ? (
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                             <div className="mb-4"><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Select Jurisdiction</label><select value={selectedState} onChange={e => setSelectedState(e.target.value)} className="w-full p-2 border rounded-lg">{Object.keys(stateDB).map(key => <option key={key} value={key}>{stateDB[key].state}</option>)}</select></div>
                             <div className="space-y-4">
                                <div><label className="text-xs font-bold text-gray-500 block mb-1">Specialized Services (Loan/Apostille/Marriage)</label><textarea value={JSON.stringify(editStateData.specialized || {}, null, 2)} onChange={e => { try { const parsed = JSON.parse(e.target.value); setEditStateData({...editStateData, specialized: parsed}); } catch(e){} }} className="w-full p-2 border rounded text-sm h-32 font-mono" placeholder='{"loan_signing": "..."}'></textarea></div>
                                <div className="grid grid-cols-3 gap-2">
                                    <div><label className="text-xs text-gray-400 block">Ack Fee</label><input type="text" value={editStateData.fees.acknowledgment} onChange={e => setEditStateData({...editStateData, fees: {...editStateData.fees, acknowledgment: e.target.value}})} className="w-full p-2 border rounded" /></div>
                                    <div><label className="text-xs text-gray-400 block">Jurat Fee</label><input type="text" value={editStateData.fees.jurat} onChange={e => setEditStateData({...editStateData, fees: {...editStateData.fees, jurat: e.target.value}})} className="w-full p-2 border rounded" /></div>
                                    <div><label className="text-xs text-gray-400 block">Oath Fee</label><input type="text" value={editStateData.fees.oath} onChange={e => setEditStateData({...editStateData, fees: {...editStateData.fees, oath: e.target.value}})} className="w-full p-2 border rounded" /></div>
                                </div>
                                <div><label className="text-xs font-bold text-gray-500 block mb-1">ID Rules</label><textarea value={editStateData.id_requirements.credible_witnesses} onChange={e => setEditStateData({...editStateData, id_requirements: {...editStateData.id_requirements, credible_witnesses: e.target.value}})} className="w-full p-2 border rounded text-sm h-20" placeholder="Credible witness rules..."></textarea></div>
                                <div><label className="text-xs font-bold text-red-500 block mb-1">Red Flags</label><textarea value={editStateData.red_flags.join(', ')} onChange={e => setEditStateData({...editStateData, red_flags: e.target.value.split(', ')})} className="w-full p-2 border rounded text-sm h-20 border-red-100 bg-red-50"></textarea></div>
                                <button onClick={handleStateSave} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700">Save Changes</button>
                             </div>
                        </div>
                     ) : (
                         <div className="space-y-4">
                            {courseMods.map((mod, idx) => (
                                <div key={mod.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                                    <div className="flex justify-between mb-2"><span className="text-xs font-bold text-gray-400">Module {mod.id}</span></div>
                                    <input type="text" value={mod.title} onChange={e => handleCourseSave(idx, 'title', e.target.value)} className="w-full p-2 border rounded mb-2 font-bold" />
                                    <textarea value={mod.topic} onChange={e => handleCourseSave(idx, 'topic', e.target.value)} className="w-full p-2 border rounded text-sm h-20"></textarea>
                                </div>
                            ))}
                            <div className="text-center text-xs text-gray-400">Changes save automatically</div>
                         </div>
                     )}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(() => JSON.parse(localStorage.getItem('notary_user_profile') || 'null'));
            const [currentView, setCurrentView] = useState(() => {
                const savedUser = localStorage.getItem('notary_user_profile');
                return savedUser ? 'dashboard' : 'landing';
            });
            const [appointments, setAppointments] = useState([]);
            const [editingAppt, setEditingAppt] = useState(null);
            const [credentials, setCredentials] = useState([]);
            const [showMobileMenu, setShowMobileMenu] = useState(false);
            const [isCloudConnected, setIsCloudConnected] = useState(false);
            const [showPricing, setShowPricing] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [showTour, setShowTour] = useState(false);
            const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(() => localStorage.getItem('notary_sidebar_collapsed') === 'true');
            const [toast, setToast] = useState(null);

            window.showToast = (message, type = 'success') => {
                setToast({ message, type });
            };

            const toggleSidebar = () => {
                const newState = !isSidebarCollapsed;
                setIsSidebarCollapsed(newState);
                localStorage.setItem('notary_sidebar_collapsed', newState);
            };
            
            // ADMIN STATE
            const [stateDB, setStateDB] = useState(() => JSON.parse(localStorage.getItem('notary_state_db')) || STATE_DATABASE);
            const [courseMods, setCourseMods] = useState(() => JSON.parse(localStorage.getItem('notary_course_mods')) || COURSE_MODULES);

            const handleUpdateStateDB = (newDB) => { setStateDB(newDB); localStorage.setItem('notary_state_db', JSON.stringify(newDB)); };
            const handleUpdateCourseMods = (newMods) => { setCourseMods(newMods); localStorage.setItem('notary_course_mods', JSON.stringify(newMods)); };

             useEffect(() => {
                const init = async () => {
                     if (typeof firebase !== 'undefined' && firebase.auth) {
                         firebase.auth().onAuthStateChanged(async (u) => {
                             if (u) {
                                 // Basic Cloud Sync Simulation for Plan Status
                                 const localProfile = JSON.parse(localStorage.getItem('notary_user_profile') || '{}');
                                 
                                 setUser({ 
                                     id: u.uid, 
                                     name: localProfile.name || u.displayName || u.email.split('@')[0], 
                                     email: u.email,
                                     plan: localProfile.plan || 'free', // Persist plan across reloads
                                     businessName: localProfile.businessName,
                                     address: localProfile.address,
                                     phone: localProfile.phone,
                                     commissionNumber: localProfile.commissionNumber,
                                     targetDate: localProfile.targetDate
                                 });
                                 setIsCloudConnected(true);
                                 setAppointments(await DataManager.get('notary_appointments'));
                                 setCredentials(await DataManager.get('notary_credentials'));
                                 
                                 // Check for first time tour
                                 if (!localStorage.getItem('notary_tour_completed')) {
                                     setShowTour(true);
                                 }
                                 // We don't auto-redirect here to avoid overriding 'landing' state if user manually logged out but firebase session persisted
                                 // However, for UX, if user is found, usually we go to dashboard.
                                 // Let's rely on the initial useState for currentView to handle refresh persistence
                             } else {
                                 setUser(null);
                                 setIsCloudConnected(false);
                             }
                         });
                     } else {
                         setAppointments(await DataManager.get('notary_appointments'));
                         setCredentials(await DataManager.get('notary_credentials'));
                         if (!localStorage.getItem('notary_tour_completed')) {
                             setShowTour(true);
                         }
                     }
                };
                init();
            }, []);
            
            // Payment Success Handler
            useEffect(() => {
                const queryParams = new URLSearchParams(window.location.search);
                if (queryParams.get('payment') === 'success') {
                    // Update user to PRO
                    const upgradedUser = { ...user, plan: 'pro' };
                    localStorage.setItem('notary_user_profile', JSON.stringify(upgradedUser));
                    setUser(upgradedUser);
                    alert("ðŸŽ‰ Payment Successful! You are now a Pro member.");
                    // Clean URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }, [user]);

            const handleLogout = async () => {
                if (typeof firebase !== 'undefined' && firebase.auth) await firebase.auth().signOut();
                localStorage.removeItem('notary_user_profile');
                setUser(null);
                setCurrentView('landing');
            };

            const handleUpgrade = () => {
                // REAL STRIPE REDIRECT LOGIC
                if (STRIPE_PAYMENT_LINK) {
                    window.location.href = STRIPE_PAYMENT_LINK;
                } else {
                    // Fallback Simulation for Testing
                    const upgradedUser = { ...user, plan: 'pro' };
                    setUser(upgradedUser);
                    localStorage.setItem('notary_user_profile', JSON.stringify(upgradedUser));
                    setShowPricing(false);
                    alert("ðŸŽ‰ (Simulation) Success! Welcome to NotaryOS Pro.");
                }
            };
            
            const handleUpdateProfile = (updatedData) => {
                const newUser = { ...user, ...updatedData };
                setUser(newUser);
                localStorage.setItem('notary_user_profile', JSON.stringify(newUser));
            };

            const handleSaveAppt = async (appt) => {
                const result = await DataManager.save('notary_appointments', appt);
                if (result.success) setAppointments(result.data);
                else setAppointments(result.data);
                setCurrentView('schedule');
                setEditingAppt(null);
            };
            
            const handleRefresh = async () => {
                 setAppointments(await DataManager.get('notary_appointments'));
                 setCredentials(await DataManager.get('notary_credentials')); 
            };

            const renderView = () => {
                switch(currentView) {
                    case 'landing': return <LandingPage onNavigate={() => setCurrentView('auth')} />;
                    case 'auth': return <AuthScreen onAuth={(profile) => { localStorage.setItem('notary_user_profile', JSON.stringify(profile)); setUser(profile); setCurrentView('dashboard'); }} onBack={() => setCurrentView('landing')} />;
                    case 'dashboard': return <Dashboard appointments={appointments} credentials={credentials} setView={setCurrentView} isCloud={isCloudConnected} />;
                    case 'schedule': return <Schedule appointments={appointments} setView={setCurrentView} onEdit={(a) => { setEditingAppt(a); setCurrentView('addAppointment'); }} user={user} onUpgrade={() => setShowPricing(true)} />;
                    case 'addAppointment': return <AppointmentForm onSave={handleSaveAppt} onCancel={() => setCurrentView('schedule')} initialData={editingAppt} />;
                    case 'journal': return <Journal onUpdate={handleRefresh} user={user} onUpgrade={() => setShowPricing(true)} />;
                    case 'finances': return <Finances />;
                    case 'credentials': return <Credentials onUpdate={handleRefresh} />;
                    case 'clients': return <Clients />;
                    case 'trainer': return <TrainerModule stateDB={stateDB} courseMods={courseMods} user={user} onUpgrade={() => setShowPricing(true)} />;
                    case 'admin': return <AdminPanel stateDB={stateDB} onUpdateStateDB={handleUpdateStateDB} courseMods={courseMods} onUpdateCourseMods={handleUpdateCourseMods} />;
                    default: return <div className="p-10 text-center text-gray-400">Module Coming Soon</div>;
                }
            };

            // If not logged in and not on landing/auth, force landing
            if (!user && currentView !== 'landing' && currentView !== 'auth') {
                setCurrentView('landing');
                return null;
            }
            
            if (currentView === 'landing' || currentView === 'auth') {
                return renderView();
            }

            return (
                <div className="flex h-screen overflow-hidden">
                    {showTour && <WelcomeTour onComplete={() => { setShowTour(false); localStorage.setItem('notary_tour_completed', 'true'); }} />}
                    {showPricing && <PricingModal onClose={() => setShowPricing(false)} onUpgrade={handleUpgrade} />}
                    {showSettings && <SettingsModal user={user} onClose={() => setShowSettings(false)} onSave={handleUpdateProfile} />}
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    
                    <Sidebar 
                        currentView={currentView} 
                        setView={setCurrentView} 
                        isOpen={showMobileMenu} 
                        onClose={() => setShowMobileMenu(false)} 
                        onLogout={handleLogout} 
                        userName={user.name} 
                        userPlan={user.plan} 
                        onUpgrade={() => setShowPricing(true)} 
                        onSettings={() => setShowSettings(true)}
                        isCollapsed={isSidebarCollapsed}
                        onToggleCollapse={toggleSidebar}
                    />
                    <main className={`flex-1 flex flex-col h-screen transition-all duration-300 relative bg-gray-50 ${isSidebarCollapsed ? 'lg:ml-20' : 'lg:ml-64'}`}>
                        <Header title={currentView === 'trainer' ? 'AI Training Center' : currentView.charAt(0).toUpperCase() + currentView.slice(1)} isCloud={isCloudConnected} />
                        <div className="flex-1 overflow-y-auto relative">{renderView()}</div>
                        <MobileNav currentView={currentView} setView={setCurrentView} onOpenMenu={() => setShowMobileMenu(true)} />
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
