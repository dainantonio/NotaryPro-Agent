<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NotaryOS</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“œ</text></svg>">

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Merriweather:wght@300;400;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

    <!-- Utilities -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- FIREBASE SDK (COMPAT MODE) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA32kVbmGOcY_CdDymrom9rWVzyXTj3so0",
            authDomain: "notaryos-67cd2.firebaseapp.com",
            projectId: "notaryos-67cd2",
            storageBucket: "notaryos-67cd2.firebasestorage.app",
            messagingSenderId: "660325303334",
            appId: "1:660325303334:web:bb0f062fd4da8c7fca12e7"
        };
        const STRIPE_PAYMENT_LINK = "";

        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase Connected");
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }
    </script>

    <style>
        :root {
            --app-bg: #f8fafc;
            --surface-bg: #ffffff;
            --surface-muted: #eef2ff;
            --text-primary: #0f172a;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --accent-color: #4f46e5;
            --accent-hover: #4338ca;
            --accent-soft: #e0e7ff;
        }

        body { font-family: 'Merriweather', serif; background-color: var(--app-bg); color: var(--text-primary); transition: background-color .25s ease, color .25s ease; }
        h1, h2, h3, h4, h5, h6, button, .font-sans { font-family: 'Poppins', sans-serif; }

        .theme-app-bg { background-color: var(--app-bg) !important; }
        .theme-surface { background-color: var(--surface-bg) !important; }
        .theme-surface-muted { background-color: var(--surface-muted) !important; }
        .theme-text { color: var(--text-primary) !important; }
        .theme-text-muted { color: var(--text-muted) !important; }
        .theme-border { border-color: var(--border-color) !important; }
        .theme-accent-btn { background-color: var(--accent-color) !important; color: #fff !important; border: 1px solid transparent; }
        .theme-accent-btn:hover { background-color: var(--accent-hover) !important; }
        .theme-pill { background-color: var(--accent-soft) !important; color: var(--accent-color) !important; border-color: var(--accent-color) !important; }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        .status-scheduled { background-color: #e0f2fe; color: #0369a1; }
        .status-completed { background-color: #dcfce7; color: #15803d; }
        .status-paid { background-color: #166534; color: white; }
        .status-cancelled { background-color: #fee2e2; color: #b91c1c; }

        .typing-indicator span { animation: blink 1.4s infinite both; height: 6px; width: 6px; background-color: #3b82f6; border-radius: 50%; display: inline-block; margin: 0 2px; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }

        .paper-doc { background-color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e5e7eb; font-family: 'Courier Prime', monospace; }
        .auth-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }
        .empty-state-dashed { background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%23CBD5E1FF' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e"); }
        /* FIXED: Moved bottom up to avoid overlapping with bottom nav on some mobile devices */
        .fab-ai { position: fixed; bottom: 90px; right: 20px; z-index: 50; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: grid; place-items: center; }
        @media (min-width: 768px) { .fab-ai { bottom: 30px; } }

        /* Toast Animation */
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }

        /* Dark Mode Landing Page Background */
        .landing-bg {
            background-color: #0f172a; /* Dark Slate 900 */
            background-image: radial-gradient(circle at 100% 0%, #1e293b 0%, #0f172a 50%);
        }

        /* Visual elements for landing page */
        .visual-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, border-color 0.3s ease;
        }
        .visual-card:hover {
            transform: translateY(-5px);
            border-color: rgba(59, 130, 246, 0.5);
        }

        /* AI Hero Glow */
        .ai-glow-box {
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.3), 0 0 60px rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(124, 58, 237, 0.3);
        }

        /* Phone Mockup */
        .phone-mockup {
            border: 8px solid #333;
            border-radius: 30px;
            overflow: hidden;
            position: relative;
            background: #fff;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .phone-notch {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40%;
            height: 20px;
            background: #333;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            z-index: 10;
        }

        .phone-stack {
            position: relative;
            min-height: 36rem;
            display: flex;
            align-items: center;
            justify-content: center;
            isolation: isolate;
        }

        .phone-stack::before,
        .phone-stack::after {
            content: '';
            position: absolute;
            width: 16rem;
            height: 16rem;
            border-radius: 9999px;
            filter: blur(45px);
            opacity: 0.45;
            z-index: 0;
        }

        .phone-stack::before {
            background: rgba(248, 113, 113, 0.7);
            top: 8%;
            left: 12%;
        }

        .phone-stack::after {
            background: rgba(74, 222, 128, 0.65);
            bottom: 10%;
            right: 8%;
        }

        .phone-stack-card {
            position: relative;
            z-index: 2;
            transition: transform 0.35s ease;
        }

        .phone-stack-card.left {
            transform: rotate(-14deg) translate(12%, 4%);
        }

        .phone-stack-card.right {
            transform: rotate(11deg) translate(-10%, -3%);
            z-index: 1;
        }

        .phone-stack-card:hover {
            transform: translateY(-8px) scale(1.01);
        }

        .phone-stack-card.left:hover {
            transform: rotate(-12deg) translate(12%, -1%) scale(1.01);
        }

        .phone-stack-card.right:hover {
            transform: rotate(10deg) translate(-10%, -7%) scale(1.01);
        }

        @media (max-width: 767px) {
            .phone-stack {
                min-height: auto;
                flex-direction: column;
                gap: 1.5rem;
                padding: 1.5rem 0.5rem;
            }

            .phone-stack::before {
                top: 4%;
                left: 8%;
            }

            .phone-stack::after {
                bottom: 4%;
                right: 8%;
            }

            .phone-stack-card.left,
            .phone-stack-card.right,
            .phone-stack-card.left:hover,
            .phone-stack-card.right:hover {
                transform: none;
            }
        }

        /* Notary Gold Accent */
        .text-notary-gold { color: #fbbf24; }
        .bg-notary-gold { background-color: #fbbf24; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        class AppErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, errorMsg: '' };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, errorMsg: error?.message || 'Unknown UI error' };
            }

            componentDidCatch(error, errorInfo) {
                console.error('NotaryOS runtime crash:', error, errorInfo);
            }

            handleReset = () => {
                try {
                    localStorage.removeItem('notary_user_profile');
                    localStorage.removeItem('notary_appointments');
                    localStorage.removeItem('notary_clients');
                    localStorage.removeItem('notary_credentials');
                    localStorage.removeItem('notary_journal');
                    localStorage.removeItem('notary_team');
                    localStorage.removeItem('notary_assignments');
                    localStorage.removeItem('notary_esignatures');
                    localStorage.removeItem('notary_active_trip');
                    localStorage.removeItem('notary_onboarded');
                    localStorage.removeItem('notary_tour_completed');
                } catch (e) {
                    console.error('Reset failed', e);
                }
                window.location.reload();
            };

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen bg-slate-50 flex items-center justify-center p-6 font-sans">
                            <div className="max-w-md w-full bg-white border border-red-100 rounded-2xl shadow-lg p-6 text-center">
                                <div className="w-14 h-14 mx-auto mb-3 rounded-full bg-red-50 text-red-600 grid place-items-center text-2xl"><i className="fas fa-triangle-exclamation"></i></div>
                                <h2 className="text-xl font-bold text-slate-800 mb-2">App recovered from a crash</h2>
                                <p className="text-sm text-slate-500 mb-4">We detected unstable local data or runtime state. You can reset local app data and reopen a stable session.</p>
                                <p className="text-xs text-slate-400 mb-4">Error: {this.state.errorMsg}</p>
                                <button onClick={this.handleReset} className="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold">Reset to Stable Mode</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- TOAST CONTEXT ---
        window.addToastFn = null;
        const showToast = (msg, type = 'success') => { if (window.addToastFn) window.addToastFn(msg, type); };

        const ToastContainer = () => {
            const [toasts, setToasts] = useState([]);

            useEffect(() => {
                window.addToastFn = (msg, type) => {
                    const id = Date.now();
                    setToasts(prev => [...prev, { id, msg, type }]);
                    setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3000);
                };
            }, []);

            return (
                <div className="fixed top-4 right-4 z-50 flex flex-col gap-2 pointer-events-none">
                    {toasts.map(t => (
                        <div key={t.id} className={`toast-enter px-4 py-3 rounded-xl shadow-lg flex items-center gap-2 text-white font-medium pointer-events-auto ${t.type === 'success' ? 'bg-green-600' : 'bg-red-600'}`}>
                            <i className={`fas ${t.type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}`}></i>
                            {t.msg}
                        </div>
                    ))}
                </div>
            );
        };

        // --- HELPER FUNCTIONS ---
        // Added simple feature access check to prevent undefined errors
        const hasFeatureAccess = (user, feature) => {
            if (!user) return false;
            if (user.role === 'agency') return true;
            if (user.plan === 'pro' || user.plan === 'team') return true;
            
            // Basic logic for free tier
            if (feature === 'agency' && user.role !== 'agency') return false;
            if (feature === 'trainer' && user.plan !== 'pro' && user.plan !== 'team') return false;
            
            return true;
        };

        // Added mock encryption/decryption to prevent ReferenceErrors in Journal
        const encryptPayload = (str) => {
            try { return btoa(str); } catch (e) { return str; }
        };
        const decryptPayload = (str) => {
            try { return atob(str); } catch (e) { return str; }
        };

        const safeStorageGet = (key, fallback = null) => {
            try {
                const value = localStorage.getItem(key);
                return value === null ? fallback : value;
            } catch (e) {
                return fallback;
            }
        };

        const safeStorageSet = (key, value) => {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (e) {
                return false;
            }
        };

        const safeParse = (value, fallback) => {
            if (value === null || value === undefined) return fallback;
            try {
                return JSON.parse(value);
            } catch (err) {
                return fallback;
            }
        };

        // --- DATA MANAGER ---
        const DataManager = {
            isCloud: () => typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser !== null,
            get: async (collectionName) => {
                if (DataManager.isCloud()) {
                    try {
                        const uid = firebase.auth().currentUser.uid;
                        const snapshot = await firebase.firestore().collection(collectionName).where("userId", "==", uid).get();
                        if (snapshot.empty) return DataManager.getLocal(collectionName);
                        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    } catch (e) { return DataManager.getLocal(collectionName); }
                } else { return DataManager.getLocal(collectionName); }
            },
            save: async (collectionName, item) => {
                const localData = DataManager.saveLocal(collectionName, item);
                if (DataManager.isCloud()) {
                    try {
                        const uid = firebase.auth().currentUser.uid;
                        const itemWithUser = { ...item, userId: uid };
                        const docId = item.id || Date.now().toString();
                        await firebase.firestore().collection(collectionName).doc(docId).set(itemWithUser);
                        const snapshot = await firebase.firestore().collection(collectionName).where("userId", "==", uid).get();
                        return { success: true, data: snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })) };
                    } catch (e) { return { success: false, data: localData }; }
                }
                return { success: false, data: localData };
            },
            saveLocal: (key, item) => {
                const list = safeParse(localStorage.getItem(key), []);
                const index = list.findIndex(i => i.id === item.id);
                if (index >= 0) list[index] = item; else list.push(item);
                localStorage.setItem(key, JSON.stringify(list));
                return list;
            },
            getLocal: (key) => safeParse(localStorage.getItem(key), []),
             delete: async (collectionName, id) => {
                const localData = DataManager.deleteLocal(collectionName, id);
                if (DataManager.isCloud()) { try { await firebase.firestore().collection(collectionName).doc(id).delete(); } catch(e) {} }
                return localData;
            },
            deleteLocal: (key, id) => {
                const list = safeParse(localStorage.getItem(key), []);
                const newList = list.filter(i => i.id !== id);
                localStorage.setItem(key, JSON.stringify(newList));
                return newList;
            }
        };

        // --- PDF GENERATORS ---
        const PDFGenerator = {
            createInvoice: (appt, user) => {
                if (!window.jspdf) { showToast("PDF Library Loading...", 'error'); return; }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const primaryColor = [37, 99, 235];
                const businessName = user.businessName || user.name || "Notary Public";
                doc.setFontSize(22); doc.setTextColor(...primaryColor); doc.text("INVOICE", 160, 20);
                doc.setFontSize(10); doc.setTextColor(100); doc.text(`ID: ${appt.id.substring(0,8)}`, 160, 26); doc.text(`Date: ${new Date().toLocaleDateString()}`, 160, 31);
                doc.setFontSize(12); doc.setTextColor(0); doc.text(businessName.toUpperCase(), 20, 20);
                doc.setFontSize(10); doc.setTextColor(100); doc.text(user.phone || "", 20, 26); doc.text(user.email || "", 20, 31);
                if(user.address) doc.text(user.address, 20, 36);
                doc.setTextColor(0); doc.text("BILL TO:", 20, 55);
                doc.setFontSize(14); doc.text(appt.clientName, 20, 62);
                doc.setFontSize(10); doc.text(appt.location, 20, 68);
                doc.autoTable({ startY: 80, head: [['Description', 'Date', 'Amount']], body: [[appt.type || 'Notary Service', appt.date, `$${appt.fee}`]], theme: 'grid', headStyles: { fillColor: primaryColor } });
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(12); doc.text(`Total Due: $${appt.fee}`, 160, finalY, { align: 'right' });

                // --- BUSINESS LOGO/SEAL IF UPLOADED ---
                if(user.logoUrl) {
                    try {
                        doc.addImage(user.logoUrl, 'PNG', 20, 5, 30, 30);
                    } catch(e) { console.log("Image error", e); }
                }

                doc.save(`invoice_${appt.clientName}.pdf`);
                showToast("Invoice Downloaded");
            },
            createSignedAgreement: ({ clientName, clientEmail, signature, signedAt, title, body }) => {
                if (!window.jspdf) { showToast("PDF Library Loading...", 'error'); return; }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(18); doc.text(title, 14, 20);
                doc.setFontSize(10); doc.text(`Client: ${clientName}`, 14, 28);
                doc.text(`Email: ${clientEmail}`, 14, 34);
                doc.text(`Signed: ${new Date(signedAt).toLocaleString()}`, 14, 40);
                doc.setFontSize(11);
                doc.text(body, 14, 52, { maxWidth: 180 });
                doc.setFontSize(12);
                doc.text(`Signature: ${signature}`, 14, 120);
                doc.save(`signed_${title.replace(/\s+/g, '_').toLowerCase()}.pdf`);
                showToast("Signed Document Downloaded");
            },
            createReport: (title, columns, data, filename) => {
                if (!window.jspdf) { showToast("PDF Library Loading...", 'error'); return; }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(18); doc.text(title, 14, 22);
                doc.setFontSize(10); doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 28);
                doc.autoTable({ startY: 35, head: [columns], body: data, theme: 'striped' });
                doc.save(filename);
                showToast("Report Downloaded");
            }
        };

        const STATE_DATABASE = {
            "AL": { "state": "Alabama", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Not specified" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "AK": { "state": "Alaska", "fees": { "acknowledgment": "$25.00", "jurat": "$25.00", "oath": "$25.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Not specified" }, "red_flags": ["Conflict of Interest"], "specialized": { "loan_signing": "Allowed", "apostille": "Lt. Governor", "marriage": "No" }},
            "AZ": { "state": "Arizona", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "1 or 2 allowed", "expired_id_rule": "Not allowed" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "AR": { "state": "Arkansas", "fees": { "acknowledgment": "Reasonable", "jurat": "Reasonable", "oath": "Reasonable" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Not specified" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "CA": { "state": "California", "fees": { "acknowledgment": "$15.00", "jurat": "$15.00", "oath": "$15.00" }, "id_requirements": { "credible_witnesses": "1 known OR 2 with ID", "expired_id_rule": "5 years" }, "red_flags": ["Thumbprint mandatory for Deeds/POA"], "specialized": { "loan_signing": "Background Check Required", "apostille": "Secretary of State", "marriage": "No" }},
            "CO": { "state": "Colorado", "fees": { "acknowledgment": "$15.00", "jurat": "$15.00", "oath": "$15.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "1 year" }, "red_flags": ["No Seal Embosser"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "CT": { "state": "Connecticut", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["Attorney State (Restriction)"], "specialized": { "loan_signing": "ATTORNEY STATE (Witness Only)", "apostille": "Secretary of State", "marriage": "No" }},
            "DE": { "state": "Delaware", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["Attorney State"], "specialized": { "loan_signing": "ATTORNEY STATE", "apostille": "Secretary of State", "marriage": "No" }},
            "DC": { "state": "District of Columbia", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Office of Notary", "marriage": "No" }},
            "FL": { "state": "Florida", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "1 known OR 2 with ID", "expired_id_rule": "5 years" }, "red_flags": ["No Family"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "YES ($30 Fee)" }},
            "GA": { "state": "Georgia", "fees": { "acknowledgment": "$2.00", "jurat": "$2.00", "oath": "$2.00" }, "id_requirements": { "credible_witnesses": "Not specified", "expired_id_rule": "Not specified" }, "red_flags": ["Attorney State"], "specialized": { "loan_signing": "ATTORNEY STATE", "apostille": "GSCCCA", "marriage": "No" }},
            "HI": { "state": "Hawaii", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Lt. Governor", "marriage": "No" }},
            "ID": { "state": "Idaho", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "IL": { "state": "Illinois", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["Cook County Record"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "IN": { "state": "Indiana", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["Title Producer License for LSA"], "specialized": { "loan_signing": "REQUIRES TPL LICENSE", "apostille": "Secretary of State", "marriage": "No" }},
            "IA": { "state": "Iowa", "fees": { "acknowledgment": "Reasonable", "jurat": "Reasonable", "oath": "Reasonable" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "KS": { "state": "Kansas", "fees": { "acknowledgment": "Reasonable", "jurat": "Reasonable", "oath": "Reasonable" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "KY": { "state": "Kentucky", "fees": { "acknowledgment": "Not set", "jurat": "Not set", "oath": "Not set" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "LA": { "state": "Louisiana", "fees": { "acknowledgment": "Not set", "jurat": "Not set", "oath": "Not set" }, "id_requirements": { "credible_witnesses": "2 witnesses", "expired_id_rule": "Current" }, "red_flags": ["Civil Law Notary"], "specialized": { "loan_signing": "Civil Law Notary Exam Required", "apostille": "Secretary of State", "marriage": "No" }},
            "ME": { "state": "Maine", "fees": { "acknowledgment": "Reasonable", "jurat": "Reasonable", "oath": "Reasonable" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "YES" }},
            "MD": { "state": "Maryland", "fees": { "acknowledgment": "$4.00", "jurat": "$4.00", "oath": "$4.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["TIP License Required"], "specialized": { "loan_signing": "REQUIRES TIP LICENSE", "apostille": "Secretary of State", "marriage": "No" }},
            "MA": { "state": "Massachusetts", "fees": { "acknowledgment": "Not set", "jurat": "Not set", "oath": "Not set" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["Attorney State"], "specialized": { "loan_signing": "ATTORNEY STATE", "apostille": "Secretary of the Commonwealth", "marriage": "No" }},
            "MI": { "state": "Michigan", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "MN": { "state": "Minnesota", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["Closing Agent License"], "specialized": { "loan_signing": "REQUIRES CLOSING LICENSE", "apostille": "Secretary of State", "marriage": "No" }},
            "MS": { "state": "Mississippi", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "5 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "MO": { "state": "Missouri", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "MT": { "state": "Montana", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "YES" }},
            "NE": { "state": "Nebraska", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$2.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "NV": { "state": "Nevada", "fees": { "acknowledgment": "$15.00", "jurat": "$15.00", "oath": "$7.50" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Notary Discretion" }, "red_flags": ["Escrow License for LSA"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "YES (Specific Cert Required)" }},
            "NH": { "state": "New Hampshire", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Not specified" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "NJ": { "state": "New Jersey", "fees": { "acknowledgment": "$2.50", "jurat": "$2.50", "oath": "$2.50" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Treasury Division", "marriage": "No" }},
            "NM": { "state": "New Mexico", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "1 year" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "NY": { "state": "New York", "fees": { "acknowledgment": "$2.00", "jurat": "$2.00", "oath": "$2.00" }, "id_requirements": { "credible_witnesses": "Not specified", "expired_id_rule": "Not specified" }, "red_flags": ["No Initials in Name"], "specialized": { "loan_signing": "Allowed", "apostille": "Dept of State", "marriage": "No" }},
            "NC": { "state": "North Carolina", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "ND": { "state": "North Dakota", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Valid" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "OH": { "state": "Ohio", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Not specified" }, "red_flags": ["Conflict of Interest"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "OK": { "state": "Oklahoma", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "OR": { "state": "Oregon", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "PA": { "state": "Pennsylvania", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of the Commonwealth", "marriage": "No" }},
            "RI": { "state": "Rhode Island", "fees": { "acknowledgment": "$25.00", "jurat": "$25.00", "oath": "$25.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "SC": { "state": "South Carolina", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["Attorney Supervision"], "specialized": { "loan_signing": "ATTORNEY STATE", "apostille": "Secretary of State", "marriage": "YES" }},
            "SD": { "state": "South Dakota", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "TN": { "state": "Tennessee", "fees": { "acknowledgment": "$0", "jurat": "$0", "oath": "$0" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["Reasonable Fees"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "YES" }},
            "TX": { "state": "Texas", "fees": { "acknowledgment": "$6.00", "jurat": "$6.00", "oath": "$6.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "UT": { "state": "Utah", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Valid" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Lt. Governor", "marriage": "No" }},
            "VT": { "state": "Vermont", "fees": { "acknowledgment": "No limit", "jurat": "No limit", "oath": "No limit" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["Attorney Supervision"], "specialized": { "loan_signing": "ATTORNEY STATE", "apostille": "Secretary of State", "marriage": "No" }},
            "VA": { "state": "Virginia", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of the Commonwealth", "marriage": "No" }},
            "WA": { "state": "Washington", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "WV": { "state": "West Virginia", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["Attorney State"], "specialized": { "loan_signing": "ATTORNEY STATE", "apostille": "Secretary of State", "marriage": "No" }},
            "WI": { "state": "Wisconsin", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "WY": { "state": "Wyoming", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "certificates": { "acknowledgment_text": "State of [State]...", "jurat_text": "Subscribed and sworn..." }
        };
        const COURSE_MODULES = [ { id: 1, title: "Authority", topic: "Commissioning authority." } ];
        const PERSONA = `ROLE: NOTARY MENTOR. TONE: Helpful.`;

        // --- COMPONENTS ---

        // 1. Modals & Helpers
        const TermsModal = ({ onClose }) => (
            <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 backdrop-blur-sm z-[100]">
                <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 animate-fade-in font-sans">
                    <div className="flex justify-between items-center mb-4 border-b pb-4">
                        <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2"><i className="fas fa-balance-scale text-blue-600"></i> Terms of Service</h2>
                        <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><i className="fas fa-times"></i></button>
                    </div>
                    <div className="text-sm text-gray-600 mb-6 space-y-3 max-h-[60vh] overflow-y-auto">
                        <p className="font-bold">Last Updated: February 2026</p>
                        <p><strong>1. Acceptance of Terms:</strong> By accessing and using NotaryOS, you accept and agree to be bound by the terms and provision of this agreement.</p>
                        <p><strong>2. Not Legal Advice:</strong> NotaryOS is a management and educational tool. The AI Trainer provides information based on general data. This tool does not constitute legal advice. Always verify with your official state handbook.</p>
                        <p><strong>3. User Responsibility:</strong> You are responsible for all notarial acts performed. NotaryOS is not liable for any errors, omissions, or legal actions resulting from your use of this software.</p>
                        <p><strong>4. Data Privacy:</strong> In this version, business data is stored locally on your device unless Cloud Sync is explicitly enabled.</p>
                    </div>
                    <button onClick={onClose} className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition-colors">I Understand & Agree</button>
                </div>
            </div>
        );

        const PricingModal = ({ onClose, onUpgrade }) => (
            <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 backdrop-blur-sm z-[100]">
                <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 text-center font-sans">
                    <h2 className="text-2xl font-bold mb-2">Upgrade to Pro</h2>
                    <p className="text-gray-500 mb-6">Unlock Unlimited AI, secure audit capture, payment processing, and client portal access.</p>
                    <div className="space-y-2 text-left text-sm text-gray-600 bg-gray-50 rounded-xl p-3 mb-4">
                        <p><i className="fas fa-check text-emerald-600 mr-2"></i>Pro: AI Trainer, Payments, Client Portal, Audit Capture</p>
                        <p><i className="fas fa-check text-indigo-600 mr-2"></i>Team: Agency mode with assignments & master calendar</p>
                    </div>
                    <button onClick={() => onUpgrade('pro')} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold mb-2">Get Pro - $19/mo</button>
                    <button onClick={() => onUpgrade('team')} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold mb-2">Get Team - $49/mo</button>
                    <button onClick={onClose} className="text-gray-400 text-sm">Close</button>
                </div>
            </div>
        );

        const SettingsModal = ({ user, onClose, onSave }) => {
            const [data, setData] = useState(user || {});

            // Handle logo upload simulation
            const handleLogoUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setData({ ...data, logoUrl: reader.result });
                    };
                    reader.readAsDataURL(file);
                }
            };

            // --- DATA BACKUP & RESTORE LOGIC ---
            const handleExportData = () => {
                const exportData = {};
                const keys = [
                    'notary_user_profile', 'notary_clients', 'notary_appointments',
                    'notary_journal', 'notary_expenses', 'notary_mileage',
                    'notary_credentials', 'notary_team', 'notary_assignments',
                    'notary_esignatures', 'gemini_api_key', 'notary_onboarded',
                    'notary_tour_completed'
                ];
                keys.forEach(key => {
                    const value = localStorage.getItem(key);
                    if (value) exportData[key] = value;
                });

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `notaryos_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                showToast("Backup downloaded successfully");
            };

            const handleImportData = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (typeof importedData !== 'object') throw new Error("Invalid backup file");

                        Object.keys(importedData).forEach(key => {
                            if (key.startsWith('notary_') || key === 'gemini_api_key') {
                                localStorage.setItem(key, importedData[key]);
                            }
                        });
                        showToast("Data restored! Reloading...");
                        setTimeout(() => window.location.reload(), 1500);
                    } catch (err) {
                        console.error(err);
                        showToast("Failed to restore data. Invalid file.", "error");
                    }
                };
                reader.readAsText(file);
            };

            const handleSave = (e) => { e.preventDefault(); onSave(data); onClose(); showToast("Profile Updated"); };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 backdrop-blur-sm z-[100]">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 font-sans max-h-[90vh] overflow-y-auto">
                        <h3 className="font-bold text-lg mb-4">Business Profile</h3>
                        <form onSubmit={handleSave} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Your Name</label>
                                <input className="w-full p-2 border rounded" placeholder="Your Name" value={data.name || ''} onChange={e => setData({...data, name: e.target.value})} />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Business Name</label>
                                <input className="w-full p-2 border rounded" placeholder="Business Name" value={data.businessName || ''} onChange={e => setData({...data, businessName: e.target.value})} />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Business Logo / Seal</label>
                                <div className="flex items-center gap-4">
                                    {data.logoUrl && <img src={data.logoUrl} alt="Logo Preview" className="w-12 h-12 object-contain border rounded" />}
                                    <input type="file" accept="image/*" onChange={handleLogoUpload} className="text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                                </div>
                                <p className="text-xs text-gray-400 mt-1">Used on invoices and reports.</p>
                            </div>
                             <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Gemini API Key (Optional)</label>
                                <input className="w-full p-2 border rounded font-mono text-sm" type="password" placeholder="AI Key for Smart Fill" value={data.apiKey || ''} onChange={e => { setData({...data, apiKey: e.target.value}); localStorage.setItem('gemini_api_key', e.target.value); }} />
                                <p className="text-xs text-gray-400 mt-1">Required for AI features to work fully.</p>
                            </div>

                            {/* DATA MANAGEMENT SECTION */}
                            <div className="pt-4 border-t border-gray-100 mt-4">
                                <h4 className="text-xs font-bold text-gray-500 uppercase mb-3">Data Management</h4>
                                <div className="grid grid-cols-2 gap-3">
                                    <button type="button" onClick={handleExportData} className="flex items-center justify-center gap-2 p-3 bg-emerald-50 text-emerald-700 rounded-lg border border-emerald-100 hover:bg-emerald-100 transition-colors font-semibold text-sm">
                                        <i className="fas fa-download"></i> Backup Data
                                    </button>
                                    <label className="flex items-center justify-center gap-2 p-3 bg-blue-50 text-blue-700 rounded-lg border border-blue-100 hover:bg-blue-100 transition-colors font-semibold text-sm cursor-pointer">
                                        <i className="fas fa-upload"></i> Restore Data
                                        <input type="file" accept=".json" onChange={handleImportData} className="hidden" />
                                    </label>
                                </div>
                                <p className="text-xs text-gray-400 mt-2">
                                    Download a backup of your clients, journal, and settings. Restore to recover data or move to a new device.
                                </p>
                            </div>

                            <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">Save Profile</button>
                            <button type="button" onClick={onClose} className="w-full text-gray-500 py-2">Cancel</button>
                        </form>
                    </div>
                </div>
            );
        };

        const AIHelperModal = ({ onClose }) => {
            const [input, setInput] = useState('');
            const [messages, setMessages] = useState([{ role: 'assistant', content: "ðŸ‘‹ Hi! Ask me about notary laws." }]);
            const [loading, setLoading] = useState(false);

            const handleSend = async () => {
                if (!input.trim()) return;
                const newMsgs = [...messages, { role: 'user', content: input }];
                setMessages(newMsgs);
                setInput('');
                setLoading(true);

                const apiKey = localStorage.getItem('gemini_api_key');
                if (!apiKey) {
                      setTimeout(() => {
                        setMessages([...newMsgs, { role: 'assistant', content: "Please add your API Key in Settings to enable AI responses." }]);
                        setLoading(false);
                    }, 800);
                    return;
                }

                try {
                     const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: `You are a helpful Notary Assistant. Answer concisely. User Query: ${input}` }] }] }) });
                     const data = await response.json();
                     const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Error.";
                     setMessages([...newMsgs, { role: 'assistant', content: aiText }]);
                } catch(e) { setMessages([...newMsgs, { role: 'assistant', content: "Error connecting to AI." }]); }
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none font-sans">
                    <div className="bg-white w-full sm:w-96 h-[60vh] shadow-2xl rounded-t-2xl sm:rounded-2xl flex flex-col pointer-events-auto border border-gray-200">
                        <div className="p-4 border-b flex justify-between bg-indigo-600 text-white rounded-t-2xl"><h3 className="font-bold">Quick Assist</h3><button onClick={onClose}>x</button></div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                            {messages.map((m, i) => <div key={i} className={`p-3 rounded-lg text-sm ${m.role === 'user' ? 'bg-indigo-100 ml-8' : 'bg-white mr-8 border'}`}>{m.content}</div>)}
                            {loading && <div className="text-xs text-gray-400">Thinking...</div>}
                        </div>
                        <div className="p-3 border-t bg-white flex gap-2"><input className="flex-1 p-2 border rounded" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSend()} /><button onClick={handleSend} className="bg-indigo-600 text-white w-10 rounded">></button></div>
                    </div>
                </div>
            );
        };

        // NEW: Reusable Empty State Component
        const EmptyState = ({ icon, title, description, actionLabel, onAction, colorClass = "text-blue-600", bgClass = "bg-blue-50" }) => (
            <div className="flex flex-col items-center justify-center py-20 px-6 text-center animate-fade-in bg-white rounded-2xl border border-gray-100 shadow-sm font-sans">
                <div className={`w-20 h-20 ${bgClass} ${colorClass} rounded-full flex items-center justify-center mb-6 text-3xl shadow-inner`}><i className={`fas ${icon}`}></i></div>
                <h3 className="text-xl font-bold text-gray-800 mb-2">{title}</h3>
                <p className="text-gray-500 max-w-xs mb-8 leading-relaxed text-sm">{description}</p>
                {onAction && <button onClick={onAction} className={`px-8 py-3 ${colorClass.replace('text', 'bg')} text-white rounded-xl font-bold shadow-lg transform transition-all hover:scale-105 active:scale-95`}>{actionLabel}</button>}
            </div>
        );

        const OnboardingTour = ({ onComplete }) => {
            const [selectedRole, setSelectedRole] = useState('solo');
            return (
                <div className="fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl p-8 text-center max-w-md font-sans">
                        <div className="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">ðŸš€</div>
                        <h2 className="text-2xl font-bold mb-2">Welcome to NotaryOS</h2>
                        <p className="text-gray-500 mb-6">Choose your setup so we can tailor features and guidance.</p>
                        <div className="grid grid-cols-1 gap-3 mb-6 text-left">
                            <button onClick={() => setSelectedRole('solo')} className={`p-3 rounded-xl border ${selectedRole === 'solo' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}>
                                <p className="font-semibold text-gray-800">Solo Notary</p>
                                <p className="text-xs text-gray-500">Best for independent mobile notaries.</p>
                            </button>
                            <button onClick={() => setSelectedRole('agency')} className={`p-3 rounded-xl border ${selectedRole === 'agency' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200'}`}>
                                <p className="font-semibold text-gray-800">Agency / Team</p>
                                <p className="text-xs text-gray-500">Manage multiple notaries and assignments.</p>
                            </button>
                        </div>
                        <button onClick={() => onComplete(selectedRole)} className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg">Continue</button>
                    </div>
                </div>
            );
        };

        const WelcomeTour = ({ onComplete }) => {
            const [step, setStep] = useState(1);
            const totalSteps = 5;

            const steps = [
                { id: 1, icon: 'fa-rocket', color: 'text-blue-600', bg: 'bg-blue-50', title: 'Welcome to NotaryOS', desc: 'Your all-in-one operating system for running a modern notary business.' },
                { id: 2, icon: 'fa-chart-pie', color: 'text-emerald-600', bg: 'bg-emerald-50', title: 'Business Dashboard', desc: 'Track your monthly income, upcoming jobs, and get alerts for expiring credentials.' },
                { id: 3, icon: 'fa-calendar-check', color: 'text-purple-600', bg: 'bg-purple-50', title: 'Schedule & Journal', desc: 'Manage appointments with Calendar view and log every signing for state compliance.' },
                { id: 4, icon: 'fa-robot', color: 'text-indigo-600', bg: 'bg-indigo-50', title: 'AI Training Center', desc: 'Get instant answers to state laws and practice difficult scenarios with your AI mentor.' },
                { id: 5, icon: 'fa-cog', color: 'text-slate-600', bg: 'bg-slate-50', title: 'You\'re All Set', desc: 'Customize your profile, set up your branding, and start accepting appointments!' }
            ];

            const current = steps[step - 1];

            return (
                <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 text-center relative overflow-hidden font-sans">
                        {/* Progress Bar */}
                        <div className="absolute top-0 left-0 h-1 bg-gray-100 w-full">
                            <div className="h-full bg-blue-600 transition-all duration-300" style={{ width: `${(step / totalSteps) * 100}%` }}></div>
                        </div>

                        <div className={`w-20 h-20 mx-auto rounded-full flex items-center justify-center text-3xl mb-6 shadow-sm ${current.bg} ${current.color} transition-colors duration-300`}>
                            <i className={`fas ${current.icon}`}></i>
                        </div>

                        <h2 className="text-2xl font-bold text-gray-800 mb-3 transition-opacity duration-300">{current.title}</h2>
                        <p className="text-gray-500 mb-8 leading-relaxed h-16">{current.desc}</p>

                        <div className="flex items-center gap-3">
                            {step > 1 && (
                                <button onClick={() => setStep(s => s - 1)} className="px-6 py-3 rounded-xl border border-gray-200 text-gray-600 font-bold hover:bg-gray-50">
                                    Back
                                </button>
                            )}
                            <button onClick={() => step < totalSteps ? setStep(s => s + 1) : onComplete()} className="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition-all">
                                {step < totalSteps ? 'Next Step' : 'Get Started'}
                            </button>
                        </div>

                        <button onClick={onComplete} className="mt-6 text-xs text-gray-400 font-semibold uppercase tracking-wide hover:text-gray-600">
                            Skip Tour
                        </button>
                    </div>
                </div>
            );
        };

        const LandingPage = ({ onNavigate }) => {
            const [activeTab, setActiveTab] = useState('before');
            const [weeklyAppts, setWeeklyAppts] = useState(5);
            const [adminMins, setAdminMins] = useState(20);
            const [billing, setBilling] = useState('monthly');
            const [demoQuestion, setDemoQuestion] = useState("");
            const [demoResponse, setDemoResponse] = useState(null);
            const [openFaqIndex, setOpenFaqIndex] = useState(0);

            const faqItems = [
                {
                    question: "Does NotaryOS support state-specific journal and compliance requirements?",
                    answer: "Yes. NotaryOS is designed as a guided workflow to help you capture the details typically required in notary journals (signer identity evidence, timestamp, document type, and audit notes). Because laws vary by state and can change, we pair in-app guidance with your final review so you can confidently stay aligned with your current handbook and commission rules."
                },
                {
                    question: "Is my client data secure?",
                    answer: "Security is built in at multiple layers: encrypted transport (HTTPS), authenticated access controls, and scoped data access by account. Sensitive signing details are displayed in role-appropriate views and your records stay tied to your account. We also emphasize least-privilege access patterns in the product architecture."
                },
                {
                    question: "How does the Gemini API key work inside NotaryOS?",
                    answer: "Your Gemini API key enables AI-powered compliance and workflow assistance. You provide your own key, which means usage and billing remain under your control. NotaryOS uses the key only to process the AI requests you initiate (for example, compliance Q&A or drafting help) and does not change your key ownership."
                },
                {
                    question: "What is the difference between Local Storage and Cloud Sync?",
                    answer: "Local Storage keeps data on your current device/browser onlyâ€”great for quick starts but vulnerable if the device is lost, reset, or switched. Cloud Sync stores records to your secure account so you can continue work across phone and desktop, recover history, and keep your team aligned in real time."
                },
                {
                    question: "Can I start on mobile and finish work later on desktop?",
                    answer: "Absolutely. The product is built around real field operations: start the appointment in the car or at the table, capture signer details and evidence on mobile, then complete invoicing, follow-ups, and reporting on desktop without losing context."
                },
                {
                    question: "Will this reduce support and setup confusion for my team?",
                    answer: "Yes. The FAQ, guided onboarding, and explicit in-app explanations (especially around AI key setup and sync behavior) are meant to reduce ambiguity before users even contact support. That translates into faster activation and fewer repetitive troubleshooting requests."
                }
            ];

            const hoursSaved = Math.round((weeklyAppts * adminMins * 52) / 60);
            const dollarsSaved = (hoursSaved * 50).toLocaleString();

            const handleDemoAsk = (e) => {
                e.preventDefault();
                setDemoResponse("loading");
                setTimeout(() => {
                    setDemoResponse("In California, the maximum fee for a jurat is $15 per signature, including the oath or affirmation. Always check the latest handbook!");
                }, 1500);
            };

            return (
                <div className="min-h-screen landing-bg text-white font-inter flex flex-col relative overflow-x-hidden">
                    <div className="w-full p-6 flex justify-between items-center z-20 container mx-auto">
                        <div className="flex items-center gap-2">
                            <i className="fas fa-file-signature text-xl text-teal-400"></i>
                            <h1 className="text-xl font-bold tracking-tight font-sans">NotaryOS</h1>
                        </div>
                        <button onClick={onNavigate} className="text-gray-300 hover:text-white font-medium text-sm transition-colors border border-gray-600 hover:border-gray-400 px-4 py-2 rounded-lg font-sans">Log In</button>
                    </div>

                    <div className="flex-1 flex flex-col justify-center items-center text-center px-6 relative z-10 py-20">
                        <h1 className="text-5xl md:text-7xl font-extrabold mb-6 leading-tight tracking-tight max-w-5xl drop-shadow-2xl font-sans">
                            Drowning in paperwork? <br />
                            <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-blue-500">Chasing payments?</span>
                        </h1>
                        <p className="text-lg text-slate-300 mb-10 max-w-2xl leading-relaxed">
                            Stop worrying about state compliance. NotaryOS handles it allâ€”so you can focus on signings, not spreadsheets.
                        </p>
                        <button onClick={onNavigate} className="bg-teal-500 hover:bg-teal-600 text-white px-10 py-4 rounded-xl font-bold text-lg shadow-xl shadow-teal-500/20 transition-all transform hover:-translate-y-1 font-sans">
                            Start Free Trial
                        </button>
                    </div>

                    {/* RESTORED AI Hero Feature Section */}
                    <div className="w-full bg-slate-900/50 border-y border-slate-800 py-20 relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-full bg-blue-500/5 blur-[100px] pointer-events-none"></div>
                        <div className="max-w-6xl mx-auto px-6 grid md:grid-cols-2 gap-12 items-center relative z-10">
                            <div className="text-left">
                                <div className="inline-block bg-teal-900/30 text-teal-300 px-3 py-1 rounded-full text-xs font-bold mb-4 border border-teal-500/30 font-sans">
                                    NEW: AI COMPLIANCE COACH
                                </div>
                                <h2 className="text-3xl md:text-4xl font-bold mb-4 leading-tight font-sans">
                                    Your personal compliance expert, <span className="text-teal-400">available 24/7.</span>
                                </h2>
                                <p className="text-slate-400 text-lg mb-8 leading-relaxed">
                                    Not just softwareâ€”it's a mentor. Get instant answers to state-specific questions, fee limits, and ID rules without searching through a 100-page handbook.
                                </p>
                                <form onSubmit={handleDemoAsk} className="relative font-sans">
                                    <input
                                        type="text"
                                        placeholder="e.g. What's the fee for a jurat in California?"
                                        className="w-full bg-slate-800 border border-slate-700 rounded-xl py-4 px-6 text-white focus:outline-none focus:border-teal-500 focus:ring-1 focus:ring-teal-500 transition-all shadow-lg"
                                        value={demoQuestion}
                                        onChange={(e) => setDemoQuestion(e.target.value)}
                                    />
                                    <button type="submit" className="absolute right-2 top-2 bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded-lg font-bold text-sm transition-colors">
                                        Ask AI
                                    </button>
                                </form>
                            </div>

                            <div className="ai-glow-box bg-slate-800/80 backdrop-blur-xl rounded-2xl p-6 border border-slate-700/50 shadow-2xl relative">
                                <div className="flex items-center gap-3 mb-6 border-b border-slate-700 pb-4">
                                    <div className="w-10 h-10 bg-teal-500 rounded-full flex items-center justify-center text-white"><i className="fas fa-robot"></i></div>
                                    <div>
                                        <h4 className="font-bold text-white font-sans">NotaryOS AI</h4>
                                        <div className="flex items-center gap-1.5 font-sans">
                                            <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                                            <span className="text-xs text-slate-400">Online Now</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-4 font-sans">
                                    <div className="flex justify-end">
                                        <div className="bg-blue-600 text-white px-4 py-3 rounded-2xl rounded-tr-none text-sm max-w-[80%] shadow-md">
                                            What's the fee for a jurat in California?
                                        </div>
                                    </div>

                                    {(demoResponse || true) && (
                                        <div className="flex justify-start">
                                             <div className="bg-slate-700 text-slate-200 px-4 py-3 rounded-2xl rounded-tl-none text-sm max-w-[90%] shadow-md border border-slate-600">
                                                {demoResponse === "loading" ? (
                                                    <div className="flex gap-1.5 py-1">
                                                        <span className="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></span>
                                                        <span className="w-2 h-2 bg-slate-400 rounded-full animate-bounce delay-100"></span>
                                                        <span className="w-2 h-2 bg-slate-400 rounded-full animate-bounce delay-200"></span>
                                                    </div>
                                                ) : (
                                                    demoResponse || "That depends on your state laws. For California, the maximum fee for a jurat is $15 per signature, including the oath or affirmation."
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Pain vs Power Section - Alternating Background: Dark Slate 800 */}
                    <div className="bg-slate-800 py-20 border-t border-slate-700 font-sans">
                        <div className="max-w-6xl mx-auto px-6 grid md:grid-cols-2 gap-12 items-center">
                            <div className="space-y-6">
                                <h3 className="text-3xl font-bold text-white">Before & After</h3>
                                <div className="flex bg-slate-900/50 p-1 rounded-xl mb-6 w-fit border border-slate-700">
                                    <button onClick={() => setActiveTab('before')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'before' ? 'bg-red-500/20 text-red-400 shadow-sm' : 'text-slate-500 hover:text-slate-300'}`}>The Old Way</button>
                                    <button onClick={() => setActiveTab('after')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'after' ? 'bg-teal-500/20 text-teal-400 shadow-sm' : 'text-slate-500 hover:text-slate-300'}`}>With NotaryOS</button>
                                </div>

                                {activeTab === 'before' ? (
                                    <div className="space-y-4 animate-fade-in">
                                        <div className="flex items-start gap-4 p-4 rounded-xl bg-red-900/10 border border-red-900/30">
                                            <div className="w-10 h-10 rounded-full bg-red-900/30 flex items-center justify-center text-red-400 shrink-0"><i className="fas fa-file-invoice-dollar"></i></div>
                                            <div><h4 className="font-bold text-red-200">Lost Invoices</h4><p className="text-sm text-slate-400">Tracking payments in Excel or paper logs leads to missed revenue.</p></div>
                                        </div>
                                        <div className="flex items-start gap-4 p-4 rounded-xl bg-red-900/10 border border-red-900/30">
                                            <div className="w-10 h-10 rounded-full bg-red-900/30 flex items-center justify-center text-red-400 shrink-0"><i className="fas fa-exclamation-triangle"></i></div>
                                            <div><h4 className="font-bold text-red-200">Compliance Risks</h4><p className="text-sm text-slate-400">Guessing fees or ID rules can cost you your commission.</p></div>
                                        </div>
                                        <div className="flex items-start gap-4 p-4 rounded-xl bg-red-900/10 border border-red-900/30">
                                            <div className="w-10 h-10 rounded-full bg-red-900/30 flex items-center justify-center text-red-400 shrink-0"><i className="fas fa-clock"></i></div>
                                            <div><h4 className="font-bold text-red-200">Admin Overload</h4><p className="text-sm text-slate-400">Spending hours manually entering journal data after every signing.</p></div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="space-y-4 animate-fade-in">
                                        <div className="flex items-start gap-4 p-4 rounded-xl bg-teal-900/10 border border-teal-900/30">
                                            <div className="w-10 h-10 rounded-full bg-teal-900/30 flex items-center justify-center text-teal-400 shrink-0"><i className="fas fa-magic"></i></div>
                                            <div><h4 className="font-bold text-teal-200">One-Click Invoicing</h4><p className="text-sm text-slate-400">Generate professional PDF invoices instantly from your appointment data.</p></div>
                                        </div>
                                        <div className="flex items-start gap-4 p-4 rounded-xl bg-teal-900/10 border border-teal-900/30">
                                            <div className="w-10 h-10 rounded-full bg-teal-900/30 flex items-center justify-center text-teal-400 shrink-0"><i className="fas fa-robot"></i></div>
                                            <div><h4 className="font-bold text-teal-200">AI Guardian</h4><p className="text-sm text-slate-400">Your personal compliance coach answers state law questions 24/7.</p></div>
                                        </div>
                                        <div className="flex items-start gap-4 p-4 rounded-xl bg-teal-900/10 border border-teal-900/30">
                                            <div className="w-10 h-10 rounded-full bg-teal-900/30 flex items-center justify-center text-teal-400 shrink-0"><i className="fas fa-cloud-upload-alt"></i></div>
                                            <div><h4 className="font-bold text-teal-200">Cloud Sync</h4><p className="text-sm text-slate-400">Start on your phone at the signing table, finish on your laptop at home.</p></div>
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className="bg-slate-900 p-8 rounded-2xl border border-slate-700 shadow-2xl">
                                <h4 className="text-xl font-bold text-white mb-6 text-center">Calculate Your Lost Time</h4>
                                <div className="space-y-4">
                                    <div>
                                        <div className="flex justify-between mb-2">
                                            <label className="text-xs font-bold text-slate-400 uppercase">Weekly Appointments</label>
                                            <span className="text-teal-400 font-bold">{weeklyAppts}</span>
                                        </div>
                                        <input type="range" min="1" max="50" value={weeklyAppts} onChange={e=>setWeeklyAppts(e.target.value)} className="w-full accent-teal-500 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
                                    </div>
                                    <div>
                                        <div className="flex justify-between mb-2">
                                            <label className="text-xs font-bold text-slate-400 uppercase">Admin Mins per Appt</label>
                                            <span className="text-teal-400 font-bold">{adminMins} min</span>
                                        </div>
                                        <input type="range" min="5" max="60" value={adminMins} onChange={e=>setAdminMins(e.target.value)} className="w-full accent-teal-500 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
                                    </div>
                                    <div className="pt-6 border-t border-slate-700 mt-4 text-center">
                                        <p className="text-sm text-slate-400">You could save</p>
                                        <div className="text-4xl font-extrabold text-white mb-2">{hoursSaved} Hours<span className="text-lg text-slate-500 font-normal">/yr</span></div>
                                        <div className="inline-block bg-teal-900/30 text-teal-400 px-3 py-1 rounded-full text-xs font-bold border border-teal-500/30">
                                            That's ${dollarsSaved} in billable time!
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Mobile-First Demo Section - Alternating Background: Dark Slate 900 */}
                    <div className="py-24 bg-slate-900 w-full border-t border-slate-800 font-sans">
                        <div className="max-w-7xl mx-auto px-6 grid lg:grid-cols-[1.2fr_1fr] gap-16 items-center">
                            <div className="order-2 lg:order-1">
                                <div className="phone-stack">
                                    <div className="phone-mockup phone-stack-card left w-[285px] h-[575px] md:w-[300px] md:h-[600px] bg-white border-8 border-gray-900 rounded-[3rem] shadow-2xl overflow-hidden">
                                        <div className="phone-notch"></div>
                                        <div className="h-full bg-gray-50 pt-10 px-4">
                                            <div className="flex justify-between items-center mb-6">
                                                <h3 className="font-bold text-lg text-gray-800">Today's Route</h3>
                                                <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-xs font-bold">JD</div>
                                            </div>
                                            <div className="space-y-3">
                                                <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 border-l-4 border-l-blue-500">
                                                    <div className="flex justify-between mb-2">
                                                        <span className="text-xs font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded">LOAN SIGNING</span>
                                                        <span className="text-xs text-gray-400">2:00 PM</span>
                                                    </div>
                                                    <h4 className="font-bold text-gray-800">Sarah Johnson</h4>
                                                    <p className="text-xs text-gray-500 mt-1"><i className="fas fa-map-marker-alt text-red-400 mr-1"></i> 123 Maple Dr, Seattle</p>
                                                </div>
                                                <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                                    <div className="flex justify-between mb-2">
                                                        <span className="text-xs font-bold text-purple-500 bg-purple-50 px-2 py-1 rounded">DEED</span>
                                                        <span className="text-xs text-gray-400">4:30 PM</span>
                                                    </div>
                                                    <h4 className="font-bold text-gray-800">Mike Chen</h4>
                                                    <p className="text-xs text-gray-500 mt-1"><i className="fas fa-map-marker-alt text-gray-300 mr-1"></i> Starbucks, 4th Ave</p>
                                                </div>
                                                <div className="bg-white p-3 rounded-xl border border-gray-100 shadow-sm">
                                                    <p className="text-[10px] uppercase font-bold text-slate-400">Coverage</p>
                                                    <div className="mt-2 flex items-center justify-between text-xs text-gray-600">
                                                        <span><i className="fas fa-signal text-emerald-500 mr-1"></i> Data: Unlimited</span>
                                                        <span><i className="fas fa-phone text-blue-500 mr-1"></i> Calls: Unlimited</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="phone-mockup phone-stack-card right w-[285px] h-[575px] md:w-[300px] md:h-[600px] bg-white border-8 border-gray-900 rounded-[3rem] shadow-2xl overflow-hidden">
                                        <div className="phone-notch"></div>
                                        <div className="h-full bg-gray-50 pt-10 px-4">
                                            <div className="flex justify-between items-center mb-6">
                                                <h3 className="font-bold text-lg text-gray-800">Payments</h3>
                                                <button className="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded">Send Invoice</button>
                                            </div>
                                            <div className="space-y-3">
                                                <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                                    <p className="text-xs text-gray-500">April Revenue</p>
                                                    <p className="text-2xl font-bold text-gray-800 mt-1">$3,420</p>
                                                    <div className="text-[11px] text-emerald-600 mt-1 font-semibold"><i className="fas fa-arrow-up"></i> 18% vs last month</div>
                                                </div>
                                                <div className="bg-white p-3 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between border-l-4 border-l-emerald-500">
                                                    <div>
                                                        <p className="text-xs font-semibold text-gray-800">Invoice #2948</p>
                                                        <p className="text-[11px] text-gray-500">Paid by Sarah Johnson</p>
                                                    </div>
                                                    <span className="text-xs font-bold text-emerald-700 bg-emerald-100 px-2 py-1 rounded-full">Paid</span>
                                                </div>
                                                <div className="bg-white p-3 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between">
                                                    <div>
                                                        <p className="text-xs font-semibold text-gray-800">Invoice #2951</p>
                                                        <p className="text-[11px] text-gray-500">Pending â€¢ Mike Chen</p>
                                                    </div>
                                                    <span className="text-xs font-bold text-amber-700 bg-amber-100 px-2 py-1 rounded-full">Pending</span>
                                                </div>
                                                <div className="bg-white p-3 rounded-xl border border-gray-100 shadow-sm">
                                                    <p className="text-[10px] uppercase font-bold text-slate-400">Inbox</p>
                                                    <div className="mt-2 flex items-center justify-between text-xs text-gray-600">
                                                        <span><i className="fas fa-envelope text-indigo-500 mr-1"></i> Client follow-up</span>
                                                        <span className="text-indigo-600 font-semibold">New</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="order-1 lg:order-2">
                                <h3 className="text-3xl font-bold text-white mb-6">Run your business from your pocket.</h3>
                                <p className="text-slate-400 text-lg mb-8 leading-relaxed">
                                    From booking to signature capture to final payout, NotaryOS mirrors how real mobile appointments happen. Start with your daily schedule, complete ID/journal checks at the table, then send and track payment before you drive to the next stop.
                                </p>
                                <ul className="space-y-4">
                                    <li className="flex items-center gap-3 text-slate-300">
                                        <div className="w-6 h-6 rounded-full bg-teal-500/20 text-teal-400 flex items-center justify-center text-xs"><i className="fas fa-mobile-alt"></i></div>
                                        1) Confirm today's route and appointment details
                                    </li>
                                    <li className="flex items-center gap-3 text-slate-300">
                                        <div className="w-6 h-6 rounded-full bg-teal-500/20 text-teal-400 flex items-center justify-center text-xs"><i className="fas fa-map-marker-alt"></i></div>
                                        2) Capture signer details and journal proof on site
                                    </li>
                                    <li className="flex items-center gap-3 text-slate-300">
                                        <div className="w-6 h-6 rounded-full bg-teal-500/20 text-teal-400 flex items-center justify-center text-xs"><i className="fas fa-bell"></i></div>
                                        3) Send invoice and track paid/pending status instantly
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    {/* FAQ Section - Trust, Security & Clarity */}
                    <div className="bg-slate-950/80 py-24 w-full border-t border-slate-800 font-sans">
                        <div className="max-w-5xl mx-auto px-6">
                            <div className="text-center mb-12">
                                <div className="inline-flex items-center gap-2 bg-slate-900/80 border border-slate-700 text-teal-300 px-4 py-2 rounded-full text-xs font-bold tracking-wide">
                                    <i className="fas fa-shield-alt"></i>
                                    TRUST & COMPLIANCE FAQ
                                </div>
                                <h3 className="text-3xl md:text-4xl font-bold text-white mt-5 mb-4">Questions every serious notary asks first.</h3>
                                <p className="text-slate-400 max-w-3xl mx-auto">
                                    Built for risk-aware professionals: get clear answers on compliance workflows, data security, AI key usage, and local vs cloud storage without cluttering the interface.
                                </p>
                            </div>

                            <div className="space-y-4">
                                {faqItems.map((item, index) => {
                                    const isOpen = openFaqIndex === index;
                                    return (
                                        <div key={item.question} className="bg-slate-900/70 border border-slate-700 rounded-2xl overflow-hidden shadow-lg shadow-black/20">
                                            <button
                                                type="button"
                                                className="w-full text-left px-6 py-5 flex items-center justify-between gap-4 hover:bg-slate-800/60 transition-colors"
                                                onClick={() => setOpenFaqIndex(isOpen ? -1 : index)}
                                                aria-expanded={isOpen}
                                            >
                                                <span className="text-white font-semibold leading-snug">{item.question}</span>
                                                <span className={`text-teal-400 transition-transform duration-300 ${isOpen ? 'rotate-180' : 'rotate-0'}`}>
                                                    <i className="fas fa-chevron-down"></i>
                                                </span>
                                            </button>
                                            {isOpen && (
                                                <div className="px-6 pb-6 text-slate-300 leading-relaxed border-t border-slate-800">
                                                    <p className="pt-4">{item.answer}</p>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>

                    {/* Pricing Section - Alternating Background: Dark Slate 800 */}
                    <div className="bg-slate-800 py-24 w-full border-t border-slate-700 font-sans">
                        <div className="max-w-6xl mx-auto px-6">
                            <div className="text-center mb-10">
                                <h3 className="text-3xl font-bold text-white mb-4">Simple, Transparent Pricing</h3>
                                <p className="text-slate-400 mb-8">Everything you need to grow your business.</p>

                                <div className="max-w-3xl mx-auto mb-8 bg-slate-900/70 border border-slate-700 rounded-xl px-5 py-4 text-left flex items-center justify-between gap-4">
                                    <div>
                                        <p className="text-slate-400 text-sm font-semibold">Current plan</p>
                                        <p className="text-slate-200">You are currently on the <span className="font-bold text-white">Starter Plan</span>.</p>
                                    </div>
                                    <button type="button" className="shrink-0 px-4 py-2 rounded-lg border border-slate-600 text-slate-300 hover:text-white hover:border-slate-400 transition-colors text-sm">
                                        Manage
                                    </button>
                                </div>

                                {/* Billing Toggle */}
                                <div className="inline-flex bg-slate-900 p-1 rounded-xl border border-slate-700 relative">
                                    <button onClick={() => setBilling('monthly')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${billing === 'monthly' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-400 hover:text-white'}`}>Monthly</button>
                                    <button onClick={() => setBilling('yearly')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${billing === 'yearly' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-400 hover:text-white'}`}>Yearly</button>
                                    {billing === 'yearly' && <span className="absolute -top-3 -right-3 bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-lg animate-bounce">SAVE 20%</span>}
                                </div>
                            </div>
                            <div className="grid md:grid-cols-3 gap-8 items-center">
                                {/* Free Plan */}
                                <div className="visual-card p-8 rounded-2xl flex flex-col bg-slate-900/50 border border-slate-700 h-fit">
                                    <h4 className="text-xl font-bold text-white mb-2">Starter</h4>
                                    <p className="text-xs text-slate-400 mb-4">For the side-hustle notary.</p>
                                    <div className="text-4xl font-bold text-white mb-6">$0<span className="text-sm text-slate-400 font-normal">/mo</span></div>
                                    <ul className="space-y-3 mb-8 text-slate-300 text-sm flex-1">
                                        <li className="flex gap-2"><i className="fas fa-check text-green-400"></i> 5 Appointments/mo</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-green-400"></i> Basic Journal</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-green-400"></i> Local Storage Only</li>
                                    </ul>
                                    <button onClick={onNavigate} className="w-full py-3 rounded-xl border border-slate-600 text-white hover:bg-slate-700 transition-colors">Get Started</button>
                                </div>

                                {/* Pro Plan */}
                                <div className="visual-card p-8 rounded-2xl flex flex-col relative border-teal-500 bg-slate-900 shadow-2xl shadow-teal-900/20 transform scale-105 z-10">
                                    <div className="absolute top-0 right-0 bg-teal-500 text-white text-xs font-bold px-3 py-1 rounded-bl-xl rounded-tr-xl">BEST VALUE</div>
                                    <h4 className="text-xl font-bold text-white mb-2">Pro</h4>
                                    <p className="text-xs text-slate-400 mb-4">For the full-time professional.</p>
                                    <div className="text-4xl font-bold text-white mb-6">${billing === 'monthly' ? '19' : '15'}<span className="text-sm text-slate-400 font-normal">/mo</span></div>
                                    <ul className="space-y-3 mb-8 text-slate-300 text-sm flex-1">
                                        <li className="flex gap-2"><i className="fas fa-check text-teal-400"></i> Unlimited Appointments</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-teal-400"></i> Cloud Sync & Backups</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-teal-400"></i> AI Compliance Coach</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-teal-400"></i> PDF Invoicing</li>
                                    </ul>
                                    <button onClick={onNavigate} className="w-full py-3 rounded-xl bg-teal-500 text-white hover:bg-teal-600 transition-colors font-bold shadow-lg shadow-teal-500/20">Start 7-Day Trial</button>
                                </div>

                                {/* Enterprise */}
                                <div className="visual-card p-8 rounded-2xl flex flex-col bg-slate-900/50 border border-slate-700 h-fit">
                                    <h4 className="text-xl font-bold text-white mb-2">Agency</h4>
                                    <p className="text-xs text-slate-400 mb-4">For scaling your signing service.</p>
                                    <div className="text-4xl font-bold text-white mb-6">${billing === 'monthly' ? '49' : '39'}<span className="text-sm text-slate-400 font-normal">/mo</span></div>
                                    <ul className="space-y-3 mb-8 text-slate-300 text-sm flex-1">
                                        <li className="flex gap-2"><i className="fas fa-check text-green-400"></i> Everything in Pro</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-green-400"></i> Multi-User Support</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-green-400"></i> API Access</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-green-400"></i> Priority Support</li>
                                    </ul>
                                    <button className="w-full py-3 rounded-xl border border-slate-600 text-white hover:bg-slate-700 transition-colors">Contact Sales</button>
                                </div>
                            </div>

                            <div className="mt-14 overflow-x-auto rounded-2xl border border-slate-700 bg-slate-900/50">
                                <table className="min-w-full text-sm text-left text-slate-300">
                                    <thead className="bg-slate-900/90 text-slate-200">
                                        <tr>
                                            <th className="px-4 py-3 font-semibold">Compare plans</th>
                                            <th className="px-4 py-3 font-semibold">Starter</th>
                                            <th className="px-4 py-3 font-semibold">Pro</th>
                                            <th className="px-4 py-3 font-semibold">Agency</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-800">
                                        <tr>
                                            <td className="px-4 py-3 text-slate-400">Appointments per month</td>
                                            <td className="px-4 py-3">5</td>
                                            <td className="px-4 py-3">Unlimited</td>
                                            <td className="px-4 py-3">Unlimited + team routing</td>
                                        </tr>
                                        <tr>
                                            <td className="px-4 py-3 text-slate-400">Journal workflows</td>
                                            <td className="px-4 py-3"><i className="fas fa-check text-emerald-400 mr-2"></i>Basic</td>
                                            <td className="px-4 py-3"><i className="fas fa-check text-emerald-400 mr-2"></i>Advanced + templates</td>
                                            <td className="px-4 py-3"><i className="fas fa-check text-emerald-400 mr-2"></i>Team oversight</td>
                                        </tr>
                                        <tr>
                                            <td className="px-4 py-3 text-slate-400">Storage & sync</td>
                                            <td className="px-4 py-3">Local only</td>
                                            <td className="px-4 py-3">Cloud sync + backups</td>
                                            <td className="px-4 py-3">Cloud sync + multi-user</td>
                                        </tr>
                                        <tr>
                                            <td className="px-4 py-3 text-slate-400">AI compliance coach</td>
                                            <td className="px-4 py-3 text-slate-500">â€”</td>
                                            <td className="px-4 py-3"><i className="fas fa-check text-teal-400 mr-2"></i>Included</td>
                                            <td className="px-4 py-3"><i className="fas fa-check text-teal-400 mr-2"></i>Included</td>
                                        </tr>
                                        <tr>
                                            <td className="px-4 py-3 text-slate-400">API access</td>
                                            <td className="px-4 py-3 text-slate-500">â€”</td>
                                            <td className="px-4 py-3 text-slate-500">â€”</td>
                                            <td className="px-4 py-3"><i className="fas fa-check text-teal-400 mr-2"></i>Included</td>
                                        </tr>
                                        <tr>
                                            <td className="px-4 py-3 text-slate-400">Best for</td>
                                            <td className="px-4 py-3">Getting started</td>
                                            <td className="px-4 py-3">Full-time solo notary</td>
                                            <td className="px-4 py-3">Growing signing teams</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div className="mt-14 rounded-3xl border border-slate-700/80 bg-gradient-to-r from-slate-950 to-slate-900 px-8 py-10 text-center shadow-2xl shadow-blue-950/20">
                                <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-indigo-500/20 border border-indigo-400/30 text-indigo-200 text-xs font-semibold mb-5">
                                    <span className="w-2 h-2 rounded-full bg-indigo-300"></span>
                                    For enterprise
                                </div>
                                <h4 className="text-3xl md:text-4xl font-bold text-white mb-4">SOC2 Type II â€¢ GDPR â€¢ 50-state compliance</h4>
                                <p className="text-slate-300 text-lg max-w-3xl mx-auto mb-7">
                                    NotaryOS is built for demanding legal and financial workflows with secure infrastructure, standardized controls, and support for all U.S. notarial jurisdictions.
                                </p>
                                <button onClick={onNavigate} className="bg-indigo-500 hover:bg-indigo-600 text-white font-bold px-6 py-3 rounded-xl shadow-lg shadow-indigo-500/30 transition-colors">
                                    Contact sales <i className="fas fa-arrow-right ml-2"></i>
                                </button>
                            </div>
                        </div>
                        <div className="mt-16 border-t border-slate-700 pt-8 mx-6 flex flex-col md:flex-row items-center justify-between gap-4 text-xs text-slate-500">
                            <p>&copy; 2026 NotaryOS Inc. All rights reserved.</p>
                            <div className="flex items-center gap-4 md:gap-6">
                                <button type="button" className="hover:text-slate-300 transition-colors">Privacy</button>
                                <button type="button" className="hover:text-slate-300 transition-colors">Terms</button>
                                <button type="button" className="hover:text-slate-300 transition-colors">Security</button>
                                <button type="button" className="hover:text-slate-300 transition-colors">Contact</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 2. Auth Screen (Redesigned + Terms)
        const AuthScreen = ({ onAuth, onBack }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [formData, setFormData] = useState({ name: '', email: '', password: '' });
            const [showTermsModal, setShowTermsModal] = useState(false);
            const [error, setError] = useState('');

            const handleAuth = (e) => {
                e.preventDefault();
                setError('');
                onAuth({ id: '1', name: isLogin ? 'User' : formData.name, email: formData.email, plan: 'free', role: 'solo' });
            };

            const handleGoogleAuth = async () => { try { const provider = new firebase.auth.GoogleAuthProvider(); await firebase.auth().signInWithPopup(provider); } catch (err) { setError(err.message); } };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4 font-inter">
                    {showTermsModal && <TermsModal onClose={() => setShowTermsModal(false)} onAccept={() => setShowTermsModal(false)} />}
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl flex overflow-hidden min-h-[600px] animate-fade-in">
                        <div className="w-1/2 bg-slate-900 text-white p-12 hidden md:flex flex-col justify-center relative overflow-hidden"><button onClick={onBack} className="absolute top-8 left-8 text-slate-400 hover:text-white flex items-center gap-2 text-sm font-medium z-20"><i className="fas fa-arrow-left"></i> Back</button><div className="absolute -top-20 -right-20 w-64 h-64 bg-blue-600/20 rounded-full blur-3xl"></div><div className="absolute -bottom-20 -left-20 w-64 h-64 bg-purple-600/20 rounded-full blur-3xl"></div><div className="relative z-10"><div className="mb-6"><div className="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center text-2xl mb-4 shadow-lg shadow-blue-500/30"><i className="fas fa-user-tie"></i></div><h1 className="text-4xl font-bold mb-2">NotaryOS</h1><p className="text-blue-200 text-lg">The Operating System for Modern Notaries.</p></div><div className="space-y-4 mt-8"><div className="flex items-center gap-3"><i className="fas fa-check-circle text-emerald-400 text-xl"></i><span className="font-medium">Business Management Suite</span></div><div className="flex items-center gap-3"><i className="fas fa-check-circle text-emerald-400 text-xl"></i><span className="font-medium">AI-Powered Compliance Coach</span></div><div className="flex items-center gap-3"><i className="fas fa-check-circle text-emerald-400 text-xl"></i><span className="font-medium">50-State Law Database</span></div></div></div></div>
                        <div className="w-full md:w-1/2 p-12 flex flex-col justify-center"><div className="max-w-sm mx-auto w-full"><h2 className="text-3xl font-bold text-slate-900 mb-8">{isLogin ? 'Welcome Back' : 'Create Account'}</h2>{error && <div className="bg-red-100 text-red-700 p-3 rounded mb-4 text-xs">{error}</div>}<form onSubmit={handleAuth} className="space-y-5">{!isLogin && (<div><label className="block text-xs font-bold text-slate-500 uppercase mb-2 tracking-wide">Full Name</label><input type="text" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" value={formData.name} onChange={e=>setFormData({...formData, name: e.target.value})} placeholder="Jane Doe" /></div>)}<div><label className="block text-xs font-bold text-slate-500 uppercase mb-2 tracking-wide">Email Address</label><input type="email" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" value={formData.email} onChange={e=>setFormData({...formData, email: e.target.value})} placeholder="name@example.com" /></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-2 tracking-wide">Password</label><input type="password" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-xl tracking-widest" value={formData.password} onChange={e=>setFormData({...formData, password: e.target.value})} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" /></div><button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-lg shadow-md transition-all transform active:scale-95 mt-4">{isLogin ? 'Sign In' : 'Create Account'}</button></form><div className="relative flex py-6 items-center"><div className="flex-grow border-t border-slate-200"></div><span className="flex-shrink-0 mx-4 text-slate-400 text-xs font-medium uppercase">OR</span><div className="flex-grow border-t border-slate-200"></div></div><button className="w-full bg-white border border-slate-200 text-slate-700 font-bold py-3.5 rounded-lg hover:bg-slate-50 transition-all flex items-center justify-center gap-2 shadow-sm"><i className="fab fa-google text-red-500 text-lg"></i><span>Continue with Google</span></button><div className="mt-8 text-center text-sm text-slate-500">{isLogin ? "New to NotaryOS?" : "Already have an account?"} <button onClick={() => setIsLogin(!isLogin)} className="text-blue-600 font-bold hover:underline ml-1">{isLogin ? 'Create Account' : 'Log In'}</button></div>
                            <div className="mt-8 pt-4 border-t border-slate-100 text-xs text-center text-slate-400">
                                By continuing, you agree to our
                                <button onClick={() => setShowTermsModal(true)} className="underline cursor-pointer hover:text-slate-600 ml-1">Terms of Service</button>.
                            </div>
                        </div></div>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ currentView, setView, isOpen, onClose, onLogout, userName, userPlan, userRole, onSettings, onUpgrade }) => {
            const [isCollapsed, setIsCollapsed] = useState(false);
            const menuItems = [
                { id: 'dashboard', icon: 'fa-chart-pie', label: 'Dashboard', color: 'text-blue-400' },
                { id: 'schedule', icon: 'fa-calendar-alt', label: 'Schedule', color: 'text-green-400' },
                { id: 'clients', icon: 'fa-address-book', label: 'Clients', color: 'text-pink-400' },
                { id: 'portal', icon: 'fa-door-open', label: 'Client Portal', color: 'text-cyan-400' },
                { id: 'journal', icon: 'fa-book', label: 'Journal', color: 'text-purple-400' },
                { id: 'finances', icon: 'fa-wallet', label: 'Finances', color: 'text-emerald-400' },
                { id: 'credentials', icon: 'fa-id-card', label: 'Credentials', color: 'text-orange-400' },
                { id: 'agency', icon: 'fa-building', label: 'Agency', color: 'text-sky-400' },
                { id: 'trainer', icon: 'fa-robot', label: 'AI Trainer', color: 'text-indigo-400', isPro: true },
                { id: 'admin', icon: 'fa-shield-alt', label: 'Admin', color: 'text-red-500' }
            ];

            return (
                <>
                    <div className={`fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden ${isOpen ? 'block' : 'hidden'}`} onClick={onClose}></div>
                    <div className={`fixed inset-y-0 left-0 bg-slate-900 text-white z-50 transform transition-all duration-300 ease-in-out lg:static lg:flex lg:flex-col ${isOpen ? 'translate-x-0' : '-translate-x-full'} ${isCollapsed ? 'w-20' : 'w-64'} lg:translate-x-0`}>
                        <div className="p-4 flex justify-between items-center border-b border-slate-700 h-16">
                            {!isCollapsed && <span className="font-bold text-xl">NotaryOS</span>}
                            <button onClick={() => setIsCollapsed(!isCollapsed)} className="hidden lg:block text-gray-400 hover:text-white"><i className={`fas ${isCollapsed ? 'fa-chevron-right' : 'fa-chevron-left'}`}></i></button>
                            <button onClick={onClose} className="lg:hidden text-gray-400"><i className="fas fa-times"></i></button>
                        </div>
                        <nav className="flex-1 p-2 space-y-2 overflow-y-auto">
                            {menuItems.map(item => {
                                const locked = item.access && !hasFeatureAccess({ plan: userPlan, role: userRole }, item.access);
                                return (
                                    <button key={item.id} onClick={() => { if (locked) onUpgrade(); else { setView(item.id); onClose(); } }} className={`w-full flex items-center gap-3 px-3 py-3 rounded-xl transition-colors hover:bg-slate-800 ${currentView === item.id ? 'bg-blue-600 text-white' : 'text-gray-400'} ${isCollapsed ? 'justify-center' : ''}`} title={locked ? `${item.label} (Upgrade required)` : item.label}>
                                            <i className={`fas ${item.icon} text-lg ${currentView !== item.id ? item.color : ''}`}></i>
                                            {!isCollapsed && <span className="text-sm font-medium">{item.label}</span>}
                                            {!isCollapsed && locked && <i className="fas fa-lock text-[10px] ml-auto text-amber-300"></i>}
                                    </button>
                                );
                            })}
                        </nav>
                        <div className="p-4 border-t border-slate-700">
                             <button onClick={onSettings} className={`w-full flex items-center gap-3 px-3 py-2 mb-2 hover:bg-slate-800 rounded transition-colors group ${isCollapsed ? 'justify-center' : ''}`}>
                                <div className="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-blue-300 flex-shrink-0">{userName ? userName.substring(0,2).toUpperCase() : 'US'}</div>
                                {!isCollapsed && (
                                    <div className="flex-1 overflow-hidden text-left">
                                        <p className="text-xs font-bold truncate group-hover:text-white">{userName || 'User'}</p>
                                        <p className="text-[10px] text-slate-400 capitalize">{userPlan} Plan</p>
                                    </div>
                                )}
                                {!isCollapsed && <i className="fas fa-cog text-slate-500 group-hover:text-white ml-auto"></i>}
                            </button>
                             <button onClick={onLogout} className={`w-full flex items-center gap-2 text-red-400 hover:text-white ${isCollapsed ? 'justify-center' : ''}`}><i className="fas fa-sign-out-alt"></i> {!isCollapsed && "Logout"}</button>
                        </div>
                    </div>
                </>
            );
        };

        const MobileNav = ({ setView, onOpenMenu }) => (
            <div className="md:hidden fixed bottom-0 w-full bg-white/70 border-t border-slate-200/70 p-2 flex justify-around z-30 safe-area-pb shadow-sm backdrop-blur">
                <button onClick={() => setView('dashboard')}><i className="fas fa-home text-slate-400 text-lg"></i></button>
                <button onClick={() => setView('schedule')}><i className="fas fa-calendar-alt text-slate-400 text-lg"></i></button>
                
                {/* IMPROVED FAB/ADD BUTTON FOR MOBILE */}
                <button onClick={() => setView('addAppointment')} className="-mt-8 bg-blue-600 text-white rounded-full p-4 shadow-xl border-4 border-white active:scale-95 transition-transform"><i className="fas fa-plus text-2xl"></i></button>
                
                <button onClick={() => setView('trainer')}><i className="fas fa-robot text-slate-400 text-lg"></i></button>
                <button onClick={onOpenMenu}><i className="fas fa-bars text-slate-400 text-lg"></i></button>
            </div>
        );

        const Header = ({ title, onNotify, onSyncNow }) => {
            const [isOnline, setIsOnline] = useState(typeof navigator !== 'undefined' ? navigator.onLine : true);
            useEffect(() => {
                const onOnline = () => setIsOnline(true);
                const onOffline = () => setIsOnline(false);
                window.addEventListener('online', onOnline);
                window.addEventListener('offline', onOffline);
                return () => {
                    window.removeEventListener('online', onOnline);
                    window.removeEventListener('offline', onOffline);
                };
            }, []);
            return (
                <div className="theme-surface theme-border border-b p-4 flex justify-between items-center z-20">
                    <h2 className="font-bold theme-text text-lg">{title}</h2>
                    <div className="flex gap-2 items-center">
                        <span className="hidden md:inline-flex items-center gap-1 text-[10px] font-bold uppercase px-2 py-1 rounded-full theme-pill border"><i className="fas fa-shield-alt"></i> Trusted Workflow</span>
                        <button onClick={onSyncNow} className={`inline-flex items-center gap-1 text-[10px] font-bold uppercase px-2 py-1 rounded-full border ${isOnline ? 'theme-pill' : 'bg-amber-50 text-amber-700 border-amber-100'}`}>
                            <i className={`fas ${isOnline ? 'fa-cloud' : 'fa-cloud-slash'}`}></i>
                            {isOnline ? 'Sync Online' : 'Offline Mode'}
                        </button>
                        <button onClick={onNotify} className="theme-text-muted hover:opacity-80"><i className="fas fa-bell"></i></button>
                    </div>
                </div>
            );
        };

        // --- CORE MODULES ---

        // CLIENTS MODULE
        const Clients = () => {
            const [clients, setClients] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [editingClient, setEditingClient] = useState(null);
            useEffect(() => { DataManager.get('notary_clients').then(setClients); }, []);
            const handleSave = async (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                await DataManager.save('notary_clients', {
                    id: editingClient?.id || Date.now().toString(),
                    name: fd.get('name'),
                    phone: fd.get('phone'),
                    email: fd.get('email'),
                    address: fd.get('address'),
                    notes: fd.get('notes')
                });
                setShowForm(false);
                setEditingClient(null);
                setClients(await DataManager.get('notary_clients'));
                showToast(editingClient ? "Client Updated" : "Client Saved");
            };
            const handleDelete = async (id) => { await DataManager.delete('notary_clients', id); setClients(await DataManager.get('notary_clients')); showToast("Client Deleted", 'error'); };

            return (
                <div className="p-6 pb-24">
                     <div className="flex justify-between mb-4"><h3 className="font-bold text-lg text-gray-800">Client Directory</h3><button onClick={()=>{setEditingClient(null); setShowForm(true);}} className="bg-pink-600 text-white px-3 py-1 rounded">Add</button></div>
                    {showForm && <form onSubmit={handleSave} className="bg-white p-4 rounded shadow mb-4 space-y-2"><input name="name" defaultValue={editingClient?.name || ''} placeholder="Name" className="w-full border p-2 rounded" required /><input name="phone" defaultValue={editingClient?.phone || ''} placeholder="Phone" className="w-full border p-2 rounded" /><input name="email" defaultValue={editingClient?.email || ''} placeholder="Email" className="w-full border p-2 rounded" /><div className="flex gap-2"><button type="button" onClick={() => { setShowForm(false); setEditingClient(null); }} className="flex-1 bg-gray-100 rounded py-2">Cancel</button><button className="flex-1 bg-pink-600 text-white px-4 py-2 rounded">{editingClient ? 'Update' : 'Save'}</button></div></form>}
                    <div className="space-y-3">
                        {clients.length === 0 ? (
                            <EmptyState
                                icon="fa-address-book"
                                title="No Clients Yet"
                                description="Start building your digital rolodex. Add your first client to keep their details handy for future signings."
                                actionLabel="Add Client"
                                onAction={() => setShowForm(true)}
                                colorClass="text-pink-600"
                                bgClass="bg-pink-50"
                            />
                        ) : clients.map(c => <div key={c.id} className="bg-white p-3 rounded shadow"><div className="flex justify-between items-start"><div><b>{c.name}</b><p className="text-sm text-gray-500">{c.phone}</p></div><div className="flex gap-2"><button onClick={() => { setEditingClient(c); setShowForm(true); }} className="text-blue-600 hover:text-blue-800 transition-colors"><i className="fas fa-edit"></i></button><button onClick={() => handleDelete(c.id)} className="text-red-400 hover:text-red-600 transition-colors"><i className="fas fa-trash"></i></button></div></div></div>)}
                    </div>
                </div>
            );
        };

        // Feature #1: Income Chart
        const IncomeChart = ({ appointments }) => {
            const canvasRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;
                const ctx = canvasRef.current.getContext('2d');

                // Group by Month
                const monthlyData = {};
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                months.forEach(m => monthlyData[m] = 0);

                appointments.forEach(a => {
                    const date = new Date(a.date);
                    const m = date.toLocaleString('default', { month: 'short' });
                    if(monthlyData[m] !== undefined) monthlyData[m] += parseFloat(a.fee || 0);
                });

                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Income',
                            data: Object.values(monthlyData),
                            borderColor: '#4F46E5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } }
                    }
                });

                return () => chart.destroy();
            }, [appointments]);

            return <div className="h-24 w-full"><canvas ref={canvasRef}></canvas></div>;
        };

        const Dashboard = ({ appointments, credentials, setView, isCloud }) => {
            const today = new Date().toISOString().split('T')[0];
            const safeAppointments = Array.isArray(appointments) ? appointments : [];
            const todaysJobs = safeAppointments.filter(a => a.date === today);

            const safeCredentials = Array.isArray(credentials) ? credentials : [];
            const expiringCreds = safeCredentials.filter(c => {
                const exp = new Date(c.expiry);
                return Math.ceil((exp - new Date()) / (1000 * 60 * 60 * 24)) <= 60;
            });
            const monthlyIncome = safeAppointments.filter(a => a.status === 'Paid').reduce((sum, a) => sum + parseFloat(a.fee || 0), 0);

            return (
                <div className="p-6 space-y-6 pb-24">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden"><div className="absolute right-0 top-0 w-24 h-24 bg-green-50 rounded-bl-full -mr-4 -mt-4"></div><div className="relative"><div className="text-gray-500 text-xs font-bold uppercase mb-1">Monthly Income</div><div className="text-2xl font-bold text-gray-800">${monthlyIncome.toFixed(2)}</div>
                            <IncomeChart appointments={safeAppointments} />
                        </div></div>
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden"><div className="absolute right-0 top-0 w-24 h-24 bg-blue-50 rounded-bl-full -mr-4 -mt-4"></div><div className="relative"><div className="text-gray-500 text-xs font-bold uppercase mb-1">Today's Jobs</div><div className="text-2xl font-bold text-gray-800">{todaysJobs.length}</div></div></div>
                        <div onClick={() => setView('credentials')} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 cursor-pointer hover:bg-gray-50 relative overflow-hidden"><div className={`absolute right-0 top-0 w-24 h-24 rounded-bl-full -mr-4 -mt-4 ${expiringCreds.length > 0 ? 'bg-red-50' : 'bg-gray-50'}`}></div><div className="relative"><div className="text-gray-500 text-xs font-bold uppercase mb-1">Compliance Alerts</div><div className={`text-2xl font-bold ${expiringCreds.length > 0 ? 'text-red-600' : 'text-green-600'}`}>{expiringCreds.length}</div></div></div>
                    </div>
                    <div>
                        <h3 className="text-lg font-bold text-gray-800 mb-4">Today's Agenda</h3>
                        {todaysJobs.length === 0 ? <EmptyState icon="fa-calendar-day" title="No jobs today" description="Schedule clear. Good day for marketing or training!" actionLabel="Add Job" onAction={() => setView('addAppointment')} colorClass="text-blue-600" bgClass="bg-blue-50" /> : <div className="space-y-3">{todaysJobs.map(j => <div key={j.id} className="bg-white p-4 rounded shadow">{j.clientName}</div>)}</div>}
                    </div>
                </div>
            );
        };

        const AppointmentForm = ({ onSave, onCancel, initialData }) => {
            const [formData, setFormData] = useState({ clientName: '', date: '', time: '', fee: '', status: 'Scheduled' });
            const [magicInput, setMagicInput] = useState('');
            useEffect(() => {
                if (initialData) setFormData({
                    clientName: initialData.clientName || '',
                    date: initialData.date || '',
                    time: initialData.time || '',
                    fee: initialData.fee || '',
                    status: initialData.status || 'Scheduled',
                    type: initialData.type || ''
                });
            }, [initialData]);

            // --- UPDATED SMART FILL TO USE API KEY IF AVAILABLE ---
            const handleSmartFill = async () => {
                const apiKey = localStorage.getItem('gemini_api_key');

                if (apiKey) {
                    showToast("Analyzing with Gemini AI...", "success");
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    role: "user",
                                    parts: [{ text: `Extract appointment details from this text into JSON {clientName, date (YYYY-MM-DD), time (HH:MM), fee (number)}: "${magicInput}". Current year is 2026.` }]
                                }]
                            })
                        });
                        const data = await response.json();
                        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        // Extract JSON from text (simple regex for demo resilience)
                        const jsonMatch = text.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            const parsed = JSON.parse(jsonMatch[0]);
                            setFormData({
                                ...formData,
                                clientName: parsed.clientName || formData.clientName,
                                date: parsed.date || formData.date,
                                time: parsed.time || formData.time,
                                fee: parsed.fee || formData.fee
                            });
                            showToast("Form Auto-Filled!");
                        } else {
                            showToast("Could not parse details.", "error");
                        }
                    } catch (e) {
                        console.error(e);
                        showToast("AI Error. Check API Key.", "error");
                    }
                } else if (magicInput.toLowerCase().includes('john')) {
                    // Fallback Demo Mode
                    setFormData({...formData, clientName: 'John Doe', date: '2026-12-01', time: '14:00', fee: '150'});
                    showToast("Form Filled (Demo Mode)");
                } else {
                      alert("Please add your Gemini API Key in Settings for real AI extraction, or type 'John' to see the demo.");
                }
            };

            const handleSubmit = (e) => { e.preventDefault(); onSave({...formData, id: initialData?.id || Date.now().toString()}); showToast(initialData ? "Appointment Updated" : "Appointment Scheduled"); };

            return (
                <div className="p-6 pb-24 max-w-2xl mx-auto">
                    <div className="bg-white rounded-2xl shadow p-6">
                        <h3 className="font-bold text-lg mb-4">{initialData ? 'Edit Appointment' : 'New Appointment'}</h3>
                        <div className="mb-6 p-4 bg-blue-50 rounded-xl border border-blue-100">
                            <label className="text-xs font-bold text-blue-600 uppercase block mb-2"><i className="fas fa-magic"></i> Smart Fill</label>
                            <div className="flex gap-2"><input value={magicInput} onChange={e=>setMagicInput(e.target.value)} className="flex-1 p-2 border rounded text-sm" placeholder="e.g. Loan signing with Sarah tomorrow at 2pm for $150..." /><button onClick={handleSmartFill} className="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold">Fill</button></div>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input className="w-full p-3 border rounded-xl" placeholder="Client Name" value={formData.clientName} onChange={e=>setFormData({...formData, clientName: e.target.value})} required />
                            <div className="grid grid-cols-2 gap-4"><input type="date" className="w-full p-3 border rounded-xl" value={formData.date} onChange={e=>setFormData({...formData, date: e.target.value})} /><input type="time" className="w-full p-3 border rounded-xl" value={formData.time} onChange={e=>setFormData({...formData, time: e.target.value})} /></div>
                            <input className="w-full p-3 border rounded-xl" type="number" placeholder="Fee ($)" value={formData.fee} onChange={e=>setFormData({...formData, fee: e.target.value})} />
                            <div className="flex gap-3"><button type="button" onClick={onCancel} className="flex-1 py-3 bg-gray-100 rounded-xl">Cancel</button><button type="submit" className="flex-1 py-3 bg-blue-600 text-white rounded-xl">Save</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        const Schedule = ({ appointments, setView, onMarkPaid, onEdit, onAdd }) => {
            const [viewMode, setViewMode] = useState('list');
            const [paymentTarget, setPaymentTarget] = useState(null);
            const safeAppointments = Array.isArray(appointments) ? appointments : [];
            const CalendarView = () => {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                const firstDay = new Date(year, month, 1);
                const startWeekday = firstDay.getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const cells = [];
                for (let i = 0; i < startWeekday; i++) cells.push(null);
                for (let day = 1; day <= daysInMonth; day++) cells.push(day);
                while (cells.length % 7 !== 0) cells.push(null);

                const dateKey = (d) => `${year}-${String(month + 1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                return (
                    <div className="bg-white p-4 rounded-2xl shadow border border-gray-100 select-none">
                        <div className="grid grid-cols-7 gap-2 text-center text-xs font-bold text-gray-400 mb-2">
                            {['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d => <div key={d}>{d}</div>)}
                        </div>
                        <div className="grid grid-cols-7 gap-2">
                            {cells.map((day, idx) => {
                                if (!day) return <div key={`blank-${idx}`} className="h-24 rounded-lg bg-gray-50/50"></div>;
                                const dateStr = dateKey(day);
                                const dayEvents = safeAppointments.filter(a => a.date === dateStr);
                                const isToday = new Date().toISOString().split('T')[0] === dateStr;
                                return (
                                    <div 
                                        key={day} 
                                        onClick={() => onAdd(dateStr)}
                                        className={`h-24 rounded-lg border p-1 overflow-hidden transition-colors cursor-pointer hover:bg-blue-50/50 relative group ${isToday ? 'border-blue-300 bg-blue-50' : 'border-gray-100 bg-white'}`}
                                    >
                                        <div className={`text-xs font-bold mb-1 ${isToday ? 'text-blue-600' : 'text-gray-700'}`}>{day}</div>
                                        <div className="space-y-1 overflow-y-auto h-16 scrollbar-hide">
                                            {dayEvents.map(ev => (
                                                <div 
                                                    key={ev.id} 
                                                    onClick={(e) => { e.stopPropagation(); onEdit(ev); }}
                                                    className="text-[10px] bg-blue-100 text-blue-800 px-1 py-0.5 rounded truncate hover:bg-blue-200 transition-colors"
                                                    title={ev.clientName}
                                                >
                                                    {ev.time} {ev.clientName}
                                                </div>
                                            ))}
                                        </div>
                                        <div className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <i className="fas fa-plus-circle text-blue-400 text-xs"></i>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };
            return (
                <div className="p-6 pb-24">
                    <div className="flex justify-between items-center mb-6"><h3 className="font-bold text-lg">Schedule</h3><div className="bg-gray-200 p-1 rounded-lg flex"><button onClick={()=>setViewMode('list')} className={`px-3 py-1 text-xs font-bold rounded-md ${viewMode==='list'?'bg-white shadow':''}`}>List</button><button onClick={()=>setViewMode('calendar')} className={`px-3 py-1 text-xs font-bold rounded-md ${viewMode==='calendar'?'bg-white shadow':''}`}>Calendar</button></div></div>
                    {viewMode === 'calendar' ? <CalendarView /> : (
                        <div className="space-y-3">
                            {safeAppointments.length === 0 ? <EmptyState icon="fa-calendar-alt" title="Schedule Empty" description="Add your first signing." actionLabel="Add" onAction={() => setView('addAppointment')} colorClass="text-green-600" bgClass="bg-green-50" /> : safeAppointments.sort((a,b) => new Date(a.date) - new Date(b.date)).map(job => (
                                <div key={job.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm relative group">
                                    <div className="cursor-pointer" onClick={() => onEdit(job)}>
                                        <div className="flex justify-between items-start mb-2">
                                            <div>
                                                <span className="text-xs font-bold text-gray-400 uppercase">{job.type}</span>
                                                <h4 className="font-bold text-gray-800 text-lg">{job.clientName}</h4>
                                            </div>
                                            <span className={`text-[10px] px-2 py-1 rounded-full font-bold uppercase status-${job.status.toLowerCase()}`}>{job.status}</span>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4 text-sm text-gray-600 mt-3 pt-3 border-t border-gray-50">
                                            <div className="flex items-center gap-2"><i className="far fa-calendar-alt text-blue-400"></i> {job.date} {job.time}</div>
                                            <div className="text-right font-bold text-gray-800">${job.fee}</div>
                                        </div>
                                    </div>
                                    
                                    <div className="mt-4 flex flex-wrap items-center justify-between gap-3 text-sm">
                                        {job.status !== 'Paid' ? (
                                            <button onClick={() => setPaymentTarget(job)} className="bg-emerald-600 text-white px-3 py-2 rounded-lg text-xs font-semibold">Take Payment</button>
                                        ) : (
                                            <span className="text-xs font-bold text-emerald-600"><i className="fas fa-check-circle"></i> Paid</span>
                                        )}
                                        <div className="flex gap-2 ml-auto">
                                            <button onClick={() => onEdit(job)} className="text-blue-500 hover:text-blue-700 p-2"><i className="fas fa-edit"></i></button>
                                            <button onClick={() => {}} className="text-red-400 hover:text-red-600 p-2"><i className="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    {paymentTarget && (
                        <PaymentModal
                            appointment={paymentTarget}
                            onClose={() => setPaymentTarget(null)}
                            onPaid={async () => {
                                await onMarkPaid(paymentTarget);
                                setPaymentTarget(null);
                            }}
                        />
                    )}
                </div>
            );
        };

        const PaymentModal = ({ appointment, onClose, onPaid }) => {
            const handlePayLink = () => {
                if (STRIPE_PAYMENT_LINK) {
                    window.open(STRIPE_PAYMENT_LINK, '_blank', 'noopener');
                    showToast("Payment link opened");
                } else {
                    showToast("Add a Stripe payment link in configuration.", "error");
                }
            };

            return (
                <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl shadow-xl max-w-lg w-full p-6">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <h4 className="text-lg font-semibold text-gray-800">Collect Payment</h4>
                                <p className="text-sm text-gray-500">Invoice for {appointment.clientName} â€¢ ${appointment.fee}</p>
                            </div>
                            <button onClick={onClose} className="text-gray-400"><i className="fas fa-times"></i></button>
                        </div>
                        <div className="space-y-3">
                            <button onClick={onPaid} className="w-full bg-emerald-600 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2">
                                <i className="fas fa-wifi"></i> Tap to Pay (Simulated)
                            </button>
                            <button onClick={handlePayLink} className="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2">
                                <i className="fas fa-link"></i> Send Stripe Payment Link
                            </button>
                            <div className="bg-slate-50 border border-slate-200 rounded-xl p-3 text-xs text-slate-500">
                                Record payments here to automatically mark invoices as paid in the journal.
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ClientPortal = ({ user, appointments }) => {
            const [clients, setClients] = useState([]);
            const [portalClient, setPortalClient] = useState(null);
            const [loginData, setLoginData] = useState({ email: '', code: '' });
            const [portalError, setPortalError] = useState('');
            const [signatures, setSignatures] = useState([]);
            const [activeDoc, setActiveDoc] = useState(null);
            const [signatureInput, setSignatureInput] = useState('');
            const [consentChecked, setConsentChecked] = useState(false);

            useEffect(() => {
                DataManager.get('notary_clients').then(setClients);
                DataManager.get('notary_esignatures').then(setSignatures);
            }, []);

            const documents = [
                {
                    id: 'service-agreement',
                    title: 'Service Agreement',
                    description: 'Review the service scope, travel policies, and payment terms before your appointment.',
                    body: 'By signing this service agreement, you confirm the appointment details, travel policies, and payment terms provided by your notary. You agree to pay the agreed fee upon completion of service and acknowledge cancellation policies communicated by the notary.'
                },
                {
                    id: 'privacy-consent',
                    title: 'Privacy & Communication Consent',
                    description: 'Authorize appointment reminders and secure document handling.',
                    body: 'By signing this consent, you authorize the notary to send appointment confirmations, reminders, and follow-ups to the contact information you provided. You acknowledge that your data will be handled securely and only used for the purposes of the notarial service.'
                }
            ];

            const safeAppointments = Array.isArray(appointments) ? appointments : [];
            const portalAppointments = portalClient
                ? safeAppointments.filter(appt => appt.clientName?.toLowerCase().includes(portalClient.name.toLowerCase()))
                : [];

            const handlePortalLogin = (e) => {
                e.preventDefault();
                setPortalError('');
                const client = clients.find(c => c.email?.toLowerCase() === loginData.email.toLowerCase());
                if (!client) {
                    setPortalError("We couldn't find a client profile with that email.");
                    return;
                }
                const last4 = (client.phone || '').replace(/\D/g, '').slice(-4);
                const accessCode = client.accessCode || last4;
                if (!loginData.code || loginData.code !== accessCode) {
                    setPortalError("Access code invalid. Please use your secure code or phone last four digits.");
                    return;
                }
                setPortalClient(client);
                showToast("Welcome to your secure portal!");
            };

            const handleSignDocument = async (doc) => {
                if (!portalClient) return;
                if (!signatureInput || !consentChecked) {
                    showToast("Please type your full name and consent to sign.", "error");
                    return;
                }
                const signedAt = new Date().toISOString();
                const record = {
                    id: `${doc.id}-${portalClient.email}`,
                    clientEmail: portalClient.email,
                    clientName: portalClient.name,
                    documentId: doc.id,
                    documentTitle: doc.title,
                    signature: signatureInput,
                    signedAt
                };
                await DataManager.save('notary_esignatures', record);
                setSignatures(await DataManager.get('notary_esignatures'));
                setSignatureInput('');
                setConsentChecked(false);
                setActiveDoc(null);
                showToast("Document Signed");
            };

            const handleDownloadSigned = (doc) => {
                const signatureRecord = signatures.find(s => s.documentId === doc.id && s.clientEmail === portalClient?.email);
                if (!signatureRecord) return;
                PDFGenerator.createSignedAgreement({
                    clientName: signatureRecord.clientName,
                    clientEmail: signatureRecord.clientEmail,
                    signature: signatureRecord.signature,
                    signedAt: signatureRecord.signedAt,
                    title: doc.title,
                    body: doc.body
                });
            };

            return (
                <div className="p-6 pb-24">
                    <div className="max-w-5xl mx-auto space-y-6">
                        <div className="bg-white p-6 rounded-2xl shadow border border-gray-100">
                            <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                <div>
                                    <h3 className="text-xl font-bold text-gray-900">Client Portal & E-Sign</h3>
                                    <p className="text-sm text-gray-500">Securely review appointments, download invoices, and sign non-notarial documents.</p>
                                </div>
                                {portalClient && (
                                    <div className="flex items-center gap-3 bg-blue-50 text-blue-700 px-4 py-2 rounded-xl text-sm">
                                        <i className="fas fa-shield-alt"></i>
                                        <span>Logged in as {portalClient.name}</span>
                                        <button onClick={() => setPortalClient(null)} className="text-blue-600 font-semibold ml-2">Log out</button>
                                    </div>
                                )}
                            </div>
                        </div>

                        {!portalClient ? (
                            <div className="bg-white p-6 rounded-2xl shadow border border-gray-100 max-w-xl">
                                <h4 className="text-lg font-semibold text-gray-800 mb-3">Client Secure Login</h4>
                                <p className="text-sm text-gray-500 mb-4">Use your email and access code (or last 4 digits of your phone) to enter.</p>
                                {portalError && <div className="bg-red-50 text-red-600 text-sm p-3 rounded mb-4">{portalError}</div>}
                                <form onSubmit={handlePortalLogin} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 uppercase mb-1 block">Email</label>
                                        <input type="email" className="w-full p-3 border rounded-xl" value={loginData.email} onChange={(e) => setLoginData({ ...loginData, email: e.target.value })} required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 uppercase mb-1 block">Access Code</label>
                                        <input type="text" className="w-full p-3 border rounded-xl" value={loginData.code} onChange={(e) => setLoginData({ ...loginData, code: e.target.value })} required />
                                    </div>
                                    <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold">Enter Portal</button>
                                </form>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div className="lg:col-span-2 space-y-6">
                                    <div className="bg-white p-6 rounded-2xl shadow border border-gray-100">
                                        <h4 className="text-lg font-semibold text-gray-800 mb-3">Your Upcoming Appointments</h4>
                                        {portalAppointments.length === 0 ? (
                                            <EmptyState 
                                                icon="fa-calendar-check"
                                                title="No upcoming appointments"
                                                description="Your notary will update your schedule here once it is booked."
                                                actionLabel="Need help?"
                                                onAction={() => showToast("Please contact your notary.", "success")}
                                                colorClass="text-blue-600"
                                                bgClass="bg-blue-50"
                                            />
                                        ) : (
                                            <div className="space-y-3">
                                                {portalAppointments.map(appt => (
                                                    <div key={appt.id} className="border border-gray-100 rounded-xl p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                                                        <div>
                                                            <p className="text-xs font-semibold text-gray-400 uppercase">{appt.type || 'Notary Service'}</p>
                                                            <p className="text-lg font-semibold text-gray-800">{appt.date} â€¢ {appt.time}</p>
                                                            <p className="text-sm text-gray-500">Location: {appt.location || 'Provided by notary'}</p>
                                                        </div>
                                                        <div className="text-right">
                                                            <p className="text-sm text-gray-500">Fee</p>
                                                            <p className="text-lg font-bold text-gray-800">${appt.fee || '--'}</p>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>

                                    <div className="bg-white p-6 rounded-2xl shadow border border-gray-100">
                                        <h4 className="text-lg font-semibold text-gray-800 mb-3">Completed Invoices</h4>
                                        {portalAppointments.filter(appt => ['Completed', 'Paid'].includes(appt.status)).length === 0 ? (
                                            <EmptyState 
                                                icon="fa-file-invoice"
                                                title="No invoices yet"
                                                description="After your appointment is completed, invoices will appear here for download."
                                                actionLabel="Contact notary"
                                                onAction={() => showToast("We will notify you when invoices are ready.", "success")}
                                                colorClass="text-emerald-600"
                                                bgClass="bg-emerald-50"
                                            />
                                        ) : (
                                            <div className="space-y-3">
                                                {portalAppointments.filter(appt => ['Completed', 'Paid'].includes(appt.status)).map(appt => (
                                                    <div key={appt.id} className="flex items-center justify-between border border-gray-100 rounded-xl p-4">
                                                        <div>
                                                            <p className="font-semibold text-gray-800">{appt.date} Invoice</p>
                                                            <p className="text-sm text-gray-500">Total: ${appt.fee}</p>
                                                        </div>
                                                        <button onClick={() => PDFGenerator.createInvoice(appt, user)} className="bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-semibold">Download</button>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="space-y-6">
                                    <div className="bg-white p-6 rounded-2xl shadow border border-gray-100">
                                        <h4 className="text-lg font-semibold text-gray-800 mb-3">E-Sign Documents</h4>
                                        <div className="space-y-4">
                                            {documents.map(doc => {
                                                const signed = signatures.find(s => s.documentId === doc.id && s.clientEmail === portalClient.email);
                                                return (
                                                    <div key={doc.id} className="border border-gray-100 rounded-xl p-4">
                                                        <div className="flex items-start justify-between gap-4">
                                                            <div>
                                                                <p className="font-semibold text-gray-800">{doc.title}</p>
                                                                <p className="text-sm text-gray-500">{doc.description}</p>
                                                            </div>
                                                            {signed ? (
                                                                <span className="text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full">Signed</span>
                                                            ) : (
                                                                <span className="text-xs font-bold text-amber-600 bg-amber-50 px-2 py-1 rounded-full">Pending</span>
                                                            )}
                                                        </div>
                                                        <div className="mt-3 flex flex-wrap gap-2">
                                                            {!signed ? (
                                                                <button onClick={() => { setActiveDoc(doc); setSignatureInput(''); setConsentChecked(false); }} className="bg-blue-600 text-white px-3 py-2 rounded-lg text-xs font-semibold">Review & Sign</button>
                                                            ) : (
                                                                <button onClick={() => handleDownloadSigned(doc)} className="bg-gray-900 text-white px-3 py-2 rounded-lg text-xs font-semibold">Download Copy</button>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>

                                    <div className="bg-slate-900 text-white p-6 rounded-2xl shadow">
                                        <h4 className="text-lg font-semibold mb-2">Secure by Design</h4>
                                        <p className="text-sm text-slate-200">Clients access only their own records using email + access code verification. Signed documents are timestamped for audit readiness.</p>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {activeDoc && (
                        <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl shadow-xl max-w-lg w-full p-6">
                                <div className="flex justify-between items-start mb-4">
                                    <div>
                                        <h4 className="text-lg font-semibold text-gray-800">{activeDoc.title}</h4>
                                        <p className="text-sm text-gray-500">{activeDoc.description}</p>
                                    </div>
                                    <button onClick={() => setActiveDoc(null)} className="text-gray-400"><i className="fas fa-times"></i></button>
                                </div>
                                <div className="bg-gray-50 border border-gray-200 rounded-xl p-4 text-sm text-gray-600 max-h-40 overflow-y-auto">
                                    {activeDoc.body}
                                </div>
                                <div className="mt-4 space-y-3">
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 uppercase mb-1 block">Type your full name</label>
                                        <input className="w-full p-3 border rounded-xl" value={signatureInput} onChange={(e) => setSignatureInput(e.target.value)} placeholder="Full legal name" />
                                    </div>
                                    <label className="flex items-start gap-2 text-sm text-gray-500">
                                        <input type="checkbox" checked={consentChecked} onChange={(e) => setConsentChecked(e.target.checked)} className="mt-1" />
                                        I agree that this e-signature is the legal equivalent of my handwritten signature.
                                    </label>
                                    <button onClick={() => handleSignDocument(activeDoc)} className="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold">Sign & Submit</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const Journal = ({ user, onUpgrade, quickEntry, onQuickEntryUsed }) => {
            const [entries, setEntries] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [idCapture, setIdCapture] = useState(null);
            const [idPreview, setIdPreview] = useState('');
            const [selectedEntry, setSelectedEntry] = useState(null);
            useEffect(() => { DataManager.get('notary_journal').then(setEntries); }, []);
            const handleSave = async (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const encryptedId = idCapture ? encryptPayload(idCapture) : null;
                await DataManager.save('notary_journal', {
                    id: Date.now().toString(),
                    date: fd.get('date'),
                    signer: fd.get('signer'),
                    docType: fd.get('docType'),
                    fee: fd.get('fee'),
                    idCapture: encryptedId
                });
                setShowForm(false);
                setIdCapture(null);
                setIdPreview('');
                setEntries(await DataManager.get('notary_journal'));
                showToast("Entry Logged");
            };
            const handleIdUpload = (file) => {
                if (!file) {
                    setIdCapture(null);
                    setIdPreview('');
                    return;
                }
                const reader = new FileReader();
                reader.onloadend = () => {
                    const result = reader.result;
                    setIdCapture(typeof result === 'string' ? result : null);
                    setIdPreview(typeof result === 'string' ? result : '');
                };
                reader.readAsDataURL(file);
            };
            const handleExport = () => { if (user.plan !== 'pro') { onUpgrade(); return; } if (window.jspdf) PDFGenerator.createReport("Notary Journal", ["Date", "Signer", "Doc", "Fee"], entries.map(e => [e.date, e.signer, e.docType, `$${e.fee}`]), "journal.pdf"); };
            return (
                <div className="p-6 pb-24">
                    <div className="flex justify-between items-center mb-6">
                        <div className="flex gap-2">
                            <h3 className="text-lg font-bold text-gray-800">Journal</h3>
                            <button onClick={handleExport} className="text-gray-400 hover:text-blue-600"><i className="fas fa-file-export"></i></button>
                        </div>
                        <button onClick={() => setShowForm(true)} className="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold"><i className="fas fa-plus mr-2"></i>Log</button>
                    </div>
                    {showForm && (
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-6">
                            <form onSubmit={handleSave} className="space-y-4">
                                <input required name="date" type="date" className="w-full p-3 bg-gray-50 border rounded-xl" />
                                <input required name="signer" type="text" placeholder="Signer" className="w-full p-3 bg-gray-50 border rounded-xl" />
                                <input name="docType" type="text" placeholder="Document Type" className="w-full p-3 bg-gray-50 border rounded-xl" />
                                <input name="fee" type="number" placeholder="Fee" className="w-full p-3 bg-gray-50 border rounded-xl" />
                                <div className="bg-slate-50 border border-slate-200 rounded-xl p-4 space-y-2">
                                    <label className="text-xs font-bold text-slate-500 uppercase block">Audit-Proof Capture (ID/Thumbprint)</label>
                                    <input type="file" accept="image/*" capture="environment" onChange={(e) => handleIdUpload(e.target.files?.[0])} className="text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-purple-100 file:text-purple-700 hover:file:bg-purple-200" />
                                    {idPreview && <img src={idPreview} alt="ID capture preview" className="w-full max-h-48 object-contain rounded-lg border border-slate-200" />}
                                    <p className="text-xs text-slate-400">Captured image is stored locally with light encryption for audit review.</p>
                                </div>
                                <div className="flex gap-2">
                                    <button type="button" onClick={() => setShowForm(false)} className="flex-1 bg-gray-100 rounded-lg">Cancel</button>
                                    <button type="submit" className="flex-1 bg-purple-600 text-white rounded-lg">Save</button>
                                </div>
                            </form>
                        </div>
                    )}
                    <div className="space-y-3">
                        {entries.length === 0 ? (
                            <EmptyState icon="fa-book" title="Journal Empty" description="Log your notarial acts." actionLabel="Log" onAction={()=>setShowForm(true)} colorClass="text-purple-600" bgClass="bg-purple-50" />
                        ) : entries.map(e => {
                            const decrypted = e.idCapture ? decryptPayload(e.idCapture) : null;
                            return (
                                <div key={e.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                                    <div className="flex items-start justify-between gap-4">
                                        <div>
                                            <h4 className="font-semibold text-gray-800">{e.signer}</h4>
                                            <p className="text-xs text-gray-500">{e.docType || 'Notarial Entry'}</p>
                                        </div>
                                        {e.idCapture && (
                                            <button onClick={() => setSelectedEntry({ ...e, decrypted })} className="text-xs font-semibold text-purple-600 bg-purple-50 px-2 py-1 rounded-full">View Capture</button>
                                        )}
                                    </div>
                                    {e.fee && <p className="text-xs text-gray-400 mt-2">Fee: ${e.fee}</p>}
                                </div>
                            );
                        })}
                    </div>
                    {selectedEntry && (
                        <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl shadow-xl max-w-lg w-full p-6">
                                <div className="flex justify-between items-start mb-4">
                                    <div>
                                        <h4 className="text-lg font-semibold text-gray-800">Audit Capture</h4>
                                        <p className="text-sm text-gray-500">{selectedEntry.signer} â€¢ {selectedEntry.date}</p>
                                    </div>
                                    <button onClick={() => setSelectedEntry(null)} className="text-gray-400"><i className="fas fa-times"></i></button>
                                </div>
                                {selectedEntry.decrypted ? (
                                    <img src={selectedEntry.decrypted} alt="Audit capture" className="w-full max-h-80 object-contain rounded-xl border border-slate-200" />
                                ) : (
                                    <p className="text-sm text-gray-500">Unable to decrypt capture.</p>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const Finances = () => {
            const [activeTab, setActiveTab] = useState('expenses');
            const [expenses, setExpenses] = useState([]);
            const [mileage, setMileage] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [currentTrip, setCurrentTrip] = useState(null);
            const [locationStatus, setLocationStatus] = useState('');
             useEffect(() => { const load = async () => { setExpenses(await DataManager.get('notary_expenses')); setMileage(await DataManager.get('notary_mileage')); }; load(); }, []);
            useEffect(() => { setCurrentTrip(safeParse(localStorage.getItem('notary_active_trip'), null)); }, []);
            const handleSave = async (e) => { e.preventDefault(); const formData = new FormData(e.target); if (activeTab === 'expenses') { await DataManager.save('notary_expenses', { id: Date.now().toString(), date: formData.get('date'), category: formData.get('category'), desc: formData.get('desc'), amount: formData.get('amount') }); setExpenses(await DataManager.get('notary_expenses')); } else { await DataManager.save('notary_mileage', { id: Date.now().toString(), date: formData.get('date'), start: formData.get('start'), end: formData.get('end'), miles: formData.get('miles') }); setMileage(await DataManager.get('notary_mileage')); } setShowForm(false); showToast("Record Saved"); };
            const handleExport = () => { if (activeTab === 'expenses') PDFGenerator.createReport("Expense Report", ["Date", "Category", "Description", "Amount"], expenses.map(e => [e.date, e.category, e.desc, `-$${e.amount}`]), "expenses.pdf"); else PDFGenerator.createReport("Mileage Log", ["Date", "Start", "End", "Miles"], mileage.map(m => [m.date, m.start, m.end, `${m.miles} mi`]), "mileage.pdf"); };
            const haversineMiles = (start, end) => {
                const toRad = (value) => (value * Math.PI) / 180;
                const R = 3958.8;
                const dLat = toRad(end.lat - start.lat);
                const dLng = toRad(end.lng - start.lng);
                const lat1 = toRad(start.lat);
                const lat2 = toRad(end.lat);
                const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLng / 2) ** 2;
                return 2 * R * Math.asin(Math.sqrt(a));
            };
            const getPosition = () => new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation unavailable'));
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
                    (err) => reject(err),
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            });

            const handleStartTrip = async () => {
                setLocationStatus('Requesting GPS...');
                try {
                    const coords = await getPosition();
                    const startTrip = { id: Date.now().toString(), start: coords, startTime: new Date().toISOString() };
                    localStorage.setItem('notary_active_trip', JSON.stringify(startTrip));
                    setCurrentTrip(startTrip);
                    setLocationStatus('Trip started. Tracking mileage.');
                    showToast("Trip Started");
                } catch (err) {
                    setLocationStatus('Unable to access GPS. Please enable location permissions.');
                    showToast("GPS Error", "error");
                }
            };

            const handleEndTrip = async () => {
                if (!currentTrip) return;
                setLocationStatus('Calculating mileage...');
                try {
                    const coords = await getPosition();
                    const distance = haversineMiles(currentTrip.start, coords);
                    const entry = {
                        id: currentTrip.id,
                        date: new Date().toISOString().split('T')[0],
                        start: `${currentTrip.start.lat.toFixed(4)}, ${currentTrip.start.lng.toFixed(4)}`,
                        end: `${coords.lat.toFixed(4)}, ${coords.lng.toFixed(4)}`,
                        miles: distance.toFixed(2),
                        startTime: currentTrip.startTime,
                        endTime: new Date().toISOString()
                    };
                    await DataManager.save('notary_mileage', entry);
                    setMileage(await DataManager.get('notary_mileage'));
                    localStorage.removeItem('notary_active_trip');
                    setCurrentTrip(null);
                    setLocationStatus(`Trip saved â€¢ ${distance.toFixed(2)} mi`);
                    showToast("Trip Saved");
                } catch (err) {
                    setLocationStatus('Unable to access GPS. Try again.');
                    showToast("GPS Error", "error");
                }
            };
            return (
                <div className="p-6 pb-24">
                    <div className="bg-white p-1 rounded-xl flex mb-6 border border-gray-200 shadow-sm"><button onClick={() => setActiveTab('expenses')} className={`flex-1 py-2 text-sm font-bold rounded-lg ${activeTab === 'expenses' ? 'bg-emerald-50 text-emerald-700' : 'text-gray-500'}`}>Expenses</button><button onClick={() => setActiveTab('mileage')} className={`flex-1 py-2 text-sm font-bold rounded-lg ${activeTab === 'mileage' ? 'bg-blue-50 text-blue-700' : 'text-gray-500'}`}>Mileage</button></div>
                    <div className="flex justify-between items-center mb-6"><div><p className="text-xs text-gray-500 uppercase font-bold">Total</p><p className="text-2xl font-bold text-gray-800">{activeTab === 'expenses' ? `$${expenses.reduce((s, i) => s + parseFloat(i.amount||0), 0).toFixed(2)}` : `${mileage.reduce((s, i) => s + parseFloat(i.miles||0), 0)} mi`}</p></div><div className="flex gap-2"><button onClick={handleExport} className="bg-white text-gray-500 border w-10 h-10 rounded-full flex items-center justify-center"><i className="fas fa-file-export"></i></button><button onClick={() => setShowForm(true)} className="bg-gray-900 text-white w-10 h-10 rounded-full flex items-center justify-center"><i className="fas fa-plus"></i></button></div></div>
                    {activeTab === 'mileage' && (
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 mb-6">
                            <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                <div>
                                    <p className="text-xs font-bold text-blue-600 uppercase">Smart Mileage Tracker</p>
                                    <h4 className="text-lg font-semibold text-gray-800">Start & end trips with GPS</h4>
                                    <p className="text-sm text-gray-500">Tap Start Trip to capture your location, then End Trip when you arrive. We'll log the mileage automatically.</p>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button onClick={handleStartTrip} disabled={!!currentTrip} className={`px-4 py-2 rounded-lg text-sm font-semibold ${currentTrip ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-blue-600 text-white'}`}>Start Trip</button>
                                    <button onClick={handleEndTrip} disabled={!currentTrip} className={`px-4 py-2 rounded-lg text-sm font-semibold ${currentTrip ? 'bg-gray-900 text-white' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}`}>End Trip</button>
                                </div>
                            </div>
                            <div className="mt-4 flex flex-wrap items-center gap-3 text-sm">
                                <span className={`px-3 py-1 rounded-full ${currentTrip ? 'bg-emerald-50 text-emerald-700' : 'bg-slate-100 text-slate-500'}`}>
                                    {currentTrip ? 'Trip in progress' : 'No active trip'}
                                </span>
                                {currentTrip && <span className="text-gray-500">Started {new Date(currentTrip.startTime).toLocaleTimeString()}</span>}
                                {locationStatus && <span className="text-gray-500">{locationStatus}</span>}
                            </div>
                        </div>
                    )}
                    {showForm && <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-6"><form onSubmit={handleSave} className="space-y-4"><input required name="date" type="date" className="w-full p-3 bg-gray-50 border rounded-xl" />{activeTab === 'expenses' ? <><input name="category" placeholder="Category" className="w-full p-3 border rounded-xl" /><input name="desc" placeholder="Description" className="w-full p-3 border rounded-xl" /><input name="amount" placeholder="Amount" className="w-full p-3 border rounded-xl" /></> : <><input name="start" placeholder="Start" className="w-full p-3 border rounded-xl" /><input name="end" placeholder="End" className="w-full p-3 border rounded-xl" /><input name="miles" placeholder="Miles" className="w-full p-3 border rounded-xl" /></>}<button className="w-full bg-gray-900 text-white py-3 rounded-lg">Save</button></form></div>}

                    <div className="space-y-3">
                        {activeTab === 'expenses' && expenses.length === 0 ? (
                            <EmptyState
                                icon="fa-receipt"
                                title="No Expenses Logged"
                                description="Track your business spending for tax time. Add your first expense."
                                actionLabel="Log Expense"
                                onAction={() => setShowForm(true)}
                                colorClass="text-emerald-600"
                                bgClass="bg-emerald-50"
                            />
                        ) : activeTab === 'mileage' && mileage.length === 0 ? (
                            <EmptyState
                                icon="fa-road"
                                title="No Mileage Logged"
                                description="Don't miss out on tax deductions. Track the miles you drive for work."
                                actionLabel="Log Mileage"
                                onAction={() => setShowForm(true)}
                                colorClass="text-blue-600"
                                bgClass="bg-blue-50"
                            />
                        ) : (
                            activeTab === 'expenses' ? expenses.map(e => <div key={e.id} className="bg-white p-3 rounded shadow"><span>{e.desc}</span></div>) : mileage.map(m => <div key={m.id} className="bg-white p-3 rounded shadow"><span>{m.start} to {m.end}</span></div>)
                        )}
                    </div>
                </div>
            );
        };

        const AgencyManagement = ({ appointments }) => {
            const [team, setTeam] = useState([]);
            const [assignments, setAssignments] = useState([]);
            const [showForm, setShowForm] = useState(false);

            useEffect(() => {
                const load = async () => {
                    setTeam(await DataManager.get('notary_team'));
                    setAssignments(await DataManager.get('notary_assignments'));
                };
                load();
            }, []);

            const safeAppointments = Array.isArray(appointments) ? appointments : [];
            const activeAppointments = safeAppointments
                .filter(appt => appt.status !== 'Cancelled')
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            const aggregateRevenue = safeAppointments
                .filter(appt => ['Paid', 'Completed'].includes(appt.status))
                .reduce((sum, appt) => sum + parseFloat(appt.fee || 0), 0);

            const handleAddNotary = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const entry = {
                    id: Date.now().toString(),
                    name: formData.get('name'),
                    email: formData.get('email'),
                    region: formData.get('region') || 'Unassigned',
                    status: formData.get('status') || 'Available'
                };
                await DataManager.save('notary_team', entry);
                setTeam(await DataManager.get('notary_team'));
                setShowForm(false);
                showToast("Team Member Added");
            };

            const handleAssign = async (appointmentId, notaryId) => {
                if (!notaryId) return;
                const assignment = {
                    id: appointmentId,
                    appointmentId,
                    notaryId,
                    assignedAt: new Date().toISOString()
                };
                await DataManager.save('notary_assignments', assignment);
                setAssignments(await DataManager.get('notary_assignments'));
                showToast("Assignment Updated");
            };

            const getAssignedNotary = (appointmentId) => {
                const assignment = assignments.find(item => item.appointmentId === appointmentId);
                return assignment ? team.find(member => member.id === assignment.notaryId) : null;
            };

            return (
                <div className="p-6 pb-24">
                    <div className="max-w-6xl mx-auto space-y-6">
                        <div className="bg-white p-6 rounded-2xl shadow border border-gray-100 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
                            <div>
                                <p className="text-xs font-bold text-sky-600 uppercase">Team Mode</p>
                                <h3 className="text-2xl font-bold text-gray-900">Agency Management</h3>
                                <p className="text-sm text-gray-500">Assign jobs to notaries, manage capacity, and track revenue across your organization.</p>
                            </div>
                            <div className="flex flex-wrap gap-4">
                                <div className="bg-slate-900 text-white rounded-xl px-5 py-4 min-w-[180px]">
                                    <p className="text-xs uppercase text-slate-300">Active Notaries</p>
                                    <p className="text-2xl font-bold">{team.length}</p>
                                </div>
                                <div className="bg-white border border-slate-200 rounded-xl px-5 py-4 min-w-[180px]">
                                    <p className="text-xs uppercase text-slate-500">Monthly Revenue</p>
                                    <p className="text-2xl font-bold text-slate-900">${aggregateRevenue.toFixed(2)}</p>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="bg-white p-6 rounded-2xl shadow border border-gray-100">
                                <div className="flex items-center justify-between mb-4">
                                    <h4 className="text-lg font-semibold text-gray-800">Notary Team</h4>
                                    <button onClick={() => setShowForm(true)} className="text-sm font-semibold text-blue-600">Add</button>
                                </div>
                                {showForm && (
                                    <form onSubmit={handleAddNotary} className="space-y-3 mb-4">
                                        <input name="name" required placeholder="Full Name" className="w-full p-2 border rounded-lg" />
                                        <input name="email" type="email" required placeholder="Email" className="w-full p-2 border rounded-lg" />
                                        <input name="region" placeholder="Region / City" className="w-full p-2 border rounded-lg" />
                                        <select name="status" className="w-full p-2 border rounded-lg">
                                            <option>Available</option>
                                            <option>On Assignment</option>
                                            <option>Off Duty</option>
                                        </select>
                                        <div className="flex gap-2">
                                            <button type="button" onClick={() => setShowForm(false)} className="flex-1 bg-gray-100 rounded-lg py-2">Cancel</button>
                                            <button type="submit" className="flex-1 bg-blue-600 text-white rounded-lg py-2">Save</button>
                                        </div>
                                    </form>
                                )}
                                <div className="space-y-3">
                                    {team.length === 0 ? (
                                        <EmptyState 
                                            icon="fa-users"
                                            title="No team members yet"
                                            description="Add your first notary to start assigning jobs."
                                            actionLabel="Add Notary"
                                            onAction={() => setShowForm(true)}
                                            colorClass="text-sky-600"
                                            bgClass="bg-sky-50"
                                        />
                                    ) : (
                                        team.map(member => (
                                            <div key={member.id} className="border border-gray-100 rounded-xl p-3">
                                                <div className="flex items-start justify-between">
                                                    <div>
                                                        <p className="font-semibold text-gray-800">{member.name}</p>
                                                        <p className="text-xs text-gray-500">{member.email}</p>
                                                    </div>
                                                    <span className="text-[10px] uppercase font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded-full">{member.status}</span>
                                                </div>
                                                <p className="text-xs text-gray-400 mt-2">{member.region}</p>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>

                            <div className="lg:col-span-2 space-y-6">
                                <div className="bg-white p-6 rounded-2xl shadow border border-gray-100">
                                    <h4 className="text-lg font-semibold text-gray-800 mb-3">Master Calendar</h4>
                                    {activeAppointments.length === 0 ? (
                                        <EmptyState 
                                            icon="fa-calendar-alt"
                                            title="No appointments scheduled"
                                            description="Once appointments are booked, they'll show here for assignment."
                                            actionLabel="Refresh"
                                            onAction={() => showToast("Calendar Updated", "success")}
                                            colorClass="text-blue-600"
                                            bgClass="bg-blue-50"
                                        />
                                    ) : (
                                        <div className="space-y-3">
                                            {activeAppointments.map(appt => {
                                                const assignedNotary = getAssignedNotary(appt.id);
                                                return (
                                                    <div key={appt.id} className="border border-gray-100 rounded-xl p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                                        <div>
                                                            <p className="text-xs font-semibold text-gray-400 uppercase">{appt.type || 'Notary Service'}</p>
                                                            <p className="text-lg font-semibold text-gray-800">{appt.clientName}</p>
                                                            <p className="text-sm text-gray-500">{appt.date} â€¢ {appt.time || 'TBD'}</p>
                                                        </div>
                                                        <div className="flex items-center gap-3">
                                                            <div className="text-right">
                                                                <p className="text-xs text-gray-400">Assigned</p>
                                                                <p className="text-sm font-semibold text-gray-700">{assignedNotary ? assignedNotary.name : 'Unassigned'}</p>
                                                            </div>
                                                            <select
                                                                value={assignedNotary?.id || ''}
                                                                onChange={(e) => handleAssign(appt.id, e.target.value)}
                                                                className="border border-gray-200 rounded-lg p-2 text-sm"
                                                            >
                                                                <option value="">Assign Notary</option>
                                                                {team.map(member => (
                                                                    <option key={member.id} value={member.id}>{member.name}</option>
                                                                ))}
                                                            </select>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>

                                <div className="bg-slate-900 text-white p-6 rounded-2xl shadow">
                                    <h4 className="text-lg font-semibold mb-2">Agency Insights</h4>
                                    <p className="text-sm text-slate-200">Track assignments and revenue in one place. Expand your team and keep every signing accounted for.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        const Credentials = ({ onUpdate }) => {
            const [creds, setCreds] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [editingCred, setEditingCred] = useState(null);
            useEffect(() => { DataManager.get('notary_credentials').then(setCreds); }, []);
            const handleSave = async (e) => { e.preventDefault(); const fd = new FormData(e.target); await DataManager.save('notary_credentials', { id: editingCred?.id || Date.now().toString(), name: fd.get('name'), expiry: fd.get('expiry') }); setShowForm(false); setEditingCred(null); setCreds(await DataManager.get('notary_credentials')); showToast(editingCred ? "Credential Updated" : "Credential Saved"); };
            const handleDelete = async (id) => { await DataManager.delete('notary_credentials', id); setCreds(await DataManager.get('notary_credentials')); showToast("Credential Deleted", 'error'); };

            return (
                <div className="p-6 pb-24">
                    <div className="flex justify-between mb-4"><h3 className="font-bold">Credentials</h3><button onClick={()=>{ setEditingCred(null); setShowForm(true); }} className="bg-indigo-600 text-white px-3 py-1 rounded">Add</button></div>
                    {showForm && <form onSubmit={handleSave} className="bg-white p-4 rounded shadow mb-4 space-y-2"><input name="name" defaultValue={editingCred?.name || ''} placeholder="Name" className="w-full border p-2 rounded" /><input name="expiry" defaultValue={editingCred?.expiry || ''} type="date" className="w-full border p-2 rounded" /><div className="flex gap-2"><button type="button" onClick={() => { setShowForm(false); setEditingCred(null); }} className="flex-1 bg-gray-100 rounded py-2">Cancel</button><button className="flex-1 bg-indigo-600 text-white px-4 py-2 rounded">{editingCred ? 'Update' : 'Save'}</button></div></form>}
                    <div className="space-y-3">
                        {creds.length === 0 ? (
                            <EmptyState
                                icon="fa-id-card"
                                title="No Credentials"
                                description="Keep track of your commission, bond, and insurance. We'll alert you before they expire."
                                actionLabel="Add Credential"
                                onAction={() => setShowForm(true)}
                                colorClass="text-orange-600"
                                bgClass="bg-orange-50"
                            />
                        ) : creds.map(c => <div key={c.id} className="bg-white p-3 rounded shadow flex justify-between"><div><b>{c.name}</b><br/><span className="text-sm text-gray-500">{c.expiry}</span></div><div className="flex gap-2"><button onClick={() => { setEditingCred(c); setShowForm(true); }} className="text-blue-600 hover:text-blue-800 transition-colors"><i className="fas fa-edit"></i></button><button onClick={()=>handleDelete(c.id)} className="text-red-400 hover:text-red-600 transition-colors"><i className="fas fa-trash"></i></button></div></div>)}
                    </div>
                </div>
            );
        };

        const TrainerModule = ({ stateDB, courseMods, user, onUpgrade }) => {
            const [selectedStateKey, setSelectedStateKey] = useState('CA');
            const [mode, setMode] = useState('study');
            const [messages, setMessages] = useState([{ role: 'assistant', content: "Hello! I am your AI Mentor. Ask me anything about notary laws." }]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => {
                scrollRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);

            const sendMessage = async () => {
                if (!input.trim()) return;
                const newMsgs = [...messages, { role: 'user', content: input }];
                setMessages(newMsgs);
                setInput('');
                setLoading(true);

                // Simulation logic - In a real app this would connect to Gemini
                setTimeout(() => {
                    setMessages([...newMsgs, { role: 'assistant', content: "This is a simulated AI response. Please configure your API Key in Settings to enable the full AI Mentor experience." }]);
                    setLoading(false);
                }, 800);
            };

            return (
                <div className="flex flex-col h-full bg-white relative pb-20 md:pb-0">
                    <div className="border-b px-4 py-3 flex justify-between items-center bg-gray-50">
                        <select value={selectedStateKey} onChange={e => setSelectedStateKey(e.target.value)} className="bg-white border rounded p-1">
                            {Object.keys(stateDB).map(k => <option key={k} value={k}>{stateDB[k].state}</option>)}
                        </select>
                        <div className="flex gap-2">
                            <button onClick={() => setMode('study')} className={`px-2 py-1 text-xs rounded ${mode==='study' ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}>Study</button>
                            <button onClick={() => setMode('course')} className={`px-2 py-1 text-xs rounded ${mode==='course' ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}>Course</button>
                            <button onClick={() => setMode('sim')} className={`px-2 py-1 text-xs rounded ${mode==='sim' ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}>Sim</button>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 pb-4">
                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] p-3 rounded-lg text-sm ${m.role === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}>
                                    {m.content}
                                </div>
                            </div>
                        ))}
                        {loading && <div className="text-xs text-gray-400 ml-4">Thinking...</div>}
                        <div ref={scrollRef} />
                    </div>
                    
                    <div className="p-4 border-t bg-white flex gap-2 pb-24 md:pb-4 safe-area-pb">
                        <input value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && sendMessage()} placeholder="Ask AI..." className="flex-1 p-2 border rounded" />
                        <button onClick={sendMessage} className="bg-blue-600 text-white px-4 rounded">Send</button>
                    </div>
                </div>
            );
        };

        const AdminPanel = ({ stateDB }) => {
            const [activeTab, setActiveTab] = useState('states');
            const [selectedState, setSelectedState] = useState('CA');

            return (
                <div className="p-6 pb-24">
                    <div className="bg-red-50 border border-red-200 rounded p-4 mb-4"><h3 className="font-bold text-red-800">Admin Panel</h3></div>
                    <div className="flex gap-2 mb-4">
                        <button onClick={()=>setActiveTab('states')} className={`px-3 py-1 rounded ${activeTab==='states'?'bg-indigo-100 text-indigo-800':''}`}>States</button>
                        <button onClick={()=>setActiveTab('curriculum')} className={`px-3 py-1 rounded ${activeTab==='curriculum'?'bg-indigo-100 text-indigo-800':''}`}>Curriculum</button>
                    </div>
                    {activeTab === 'states' ? (
                        <div className="bg-white p-4 rounded shadow border">
                            <select className="w-full border p-2 mb-4" value={selectedState} onChange={e=>setSelectedState(e.target.value)}>
                                {Object.keys(stateDB).map(k=><option key={k} value={k}>{stateDB[k].state}</option>)}
                            </select>
                            <div className="space-y-2">
                                <label className="text-xs font-bold text-gray-500">Fees (Ack)</label>
                                <input className="w-full border p-2 rounded" defaultValue={stateDB[selectedState].fees.acknowledgment} />
                                <button className="bg-indigo-600 text-white px-4 py-2 rounded w-full">Save Changes</button>
                            </div>
                        </div>
                    ) : (
                        <div className="bg-white p-4 rounded shadow border"><p>Curriculum Editor Placeholder</p></div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(() => safeParse(safeStorageGet('notary_user_profile', null), null));
            const [currentView, setCurrentView] = useState(user ? 'dashboard' : 'landing');
            const [appointments, setAppointments] = useState([]);
            const [credentials, setCredentials] = useState([]);
            const [showMobileMenu, setShowMobileMenu] = useState(false);
            const [isCloudConnected, setIsCloudConnected] = useState(false);
            const [showPricing, setShowPricing] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [showOnboarding, setShowOnboarding] = useState(false);
            const [showWelcomeTour, setShowWelcomeTour] = useState(false);
            const [showAIModal, setShowAIModal] = useState(false); 
            const [showWhatsNew, setShowWhatsNew] = useState(() => !!user && !localStorage.getItem('notary_whats_new_seen_v2'));
            const [editingAppointment, setEditingAppointment] = useState(null);
            const theme = 'default';

            useEffect(() => {
                DataManager.get('notary_appointments').then(setAppointments);
                DataManager.get('notary_credentials').then(setCredentials);
                
                // Onboarding Logic Flow
                if (user) {
                    const isOnboarded = localStorage.getItem('notary_onboarded');
                    const isTourComplete = localStorage.getItem('notary_tour_completed');
                    
                    if (!isOnboarded) {
                        setShowOnboarding(true);
                    } else if (!isTourComplete) {
                        setShowWelcomeTour(true);
                    }
                }
            }, [user]);

            useEffect(() => {
                document.body.setAttribute('data-theme', theme);
            }, [theme]);

            const handleUpdateProfile = (updatedData) => {
                const newUser = { ...user, ...updatedData };
                setUser(newUser);
                localStorage.setItem('notary_user_profile', JSON.stringify(newUser));
                showToast("Profile Saved");
            };

            const handleLogin = (profile) => {
                localStorage.setItem('notary_user_profile', JSON.stringify(profile));
                setUser(profile);
                setCurrentView('dashboard');
                // Onboarding triggers will handle the rest via useEffect
                showToast("Welcome Back!");
            };

            const handleLogout = () => {
                localStorage.removeItem('notary_user_profile');
                setUser(null);
                setCurrentView('landing');
            };

            const handleUpgrade = (targetPlan = 'pro') => {
                const upgraded = {
                    ...user,
                    plan: targetPlan,
                    role: targetPlan === 'team' ? 'agency' : (user?.role || 'solo')
                };
                setUser(upgraded);
                localStorage.setItem('notary_user_profile', JSON.stringify(upgraded));
                setShowPricing(false);
                showToast("Upgrade Successful!");
            };

            const handleOnboardingComplete = (selectedRole) => {
                const nextUser = {
                    ...(user || {}),
                    role: selectedRole,
                    plan: selectedRole === 'agency' ? ((user?.plan === 'team') ? 'team' : 'free') : (user?.plan || 'free')
                };
                setUser(nextUser);
                localStorage.setItem('notary_user_profile', JSON.stringify(nextUser));
                localStorage.setItem('notary_onboarded', 'true');
                setShowOnboarding(false);
                
                // Show tour immediately after role selection
                setShowWelcomeTour(true);
                
                if (selectedRole === 'agency' && !hasFeatureAccess(nextUser, 'agency')) setShowPricing(true);
            };

            const handleTourComplete = () => {
                localStorage.setItem('notary_tour_completed', 'true');
                setShowWelcomeTour(false);
                showToast("You're all set!");
            };

            const handleSaveAppt = async (appt) => {
                await DataManager.save('notary_appointments', appt);
                setAppointments(await DataManager.get('notary_appointments'));
                setCurrentView('schedule');
                setEditingAppointment(null);
                showToast("Appointment Saved");
            };
            
            const handleEditAppt = (appt) => {
                setEditingAppointment(appt);
                setCurrentView('addAppointment');
            };
            
            const handleAddApptWithDate = (dateStr) => {
                setEditingAppointment({ date: dateStr });
                setCurrentView('addAppointment');
            };

            const handleMarkPaid = async (appt) => {
                const updated = { ...appt, status: 'Paid' };
                await DataManager.save('notary_appointments', updated);
                await DataManager.save('notary_journal', {
                    id: `pay-${updated.id}`,
                    date: new Date().toISOString().split('T')[0],
                    signer: updated.clientName,
                    docType: `Payment â€¢ ${updated.type || 'Notary Service'}`,
                    fee: updated.fee
                });
                setAppointments(await DataManager.get('notary_appointments'));
                showToast("Payment Recorded");
            };
            
            const handleRefresh = async () => {
                 setAppointments(await DataManager.get('notary_appointments'));
                 setCredentials(await DataManager.get('notary_credentials'));
            };

            const handleNotify = () => {
                showToast("No new notifications", "success");
            };

            const handleSyncNow = async () => {
                showToast("Syncing data...");
                await handleRefresh();
                showToast("Sync complete", "success");
            };

            const renderView = () => {
                switch(currentView) {
                    case 'landing': return <LandingPage onNavigate={() => setCurrentView('auth')} />;
                    case 'auth': return <AuthScreen onAuth={handleLogin} onBack={() => setCurrentView('landing')} />;
                    case 'dashboard': return <Dashboard appointments={appointments} credentials={credentials} setView={setCurrentView} isCloud={isCloudConnected} />;
                    case 'schedule': return <Schedule appointments={appointments} setView={setCurrentView} onMarkPaid={handleMarkPaid} onEdit={handleEditAppt} onAdd={handleAddApptWithDate} />;
                    case 'addAppointment': return <AppointmentForm onSave={handleSaveAppt} onCancel={() => { setEditingAppointment(null); setCurrentView('schedule'); }} initialData={editingAppointment} />;
                    case 'clients': return <Clients />;
                    case 'portal': return <ClientPortal user={user} appointments={appointments} />;
                    case 'journal': return <Journal user={user} onUpgrade={()=>{}} />;
                    case 'finances': return <Finances />;
                    case 'credentials': return <Credentials onUpdate={handleRefresh} />;
                    case 'agency': return <AgencyManagement appointments={appointments} />;
                    case 'trainer': return <TrainerModule stateDB={STATE_DATABASE} courseMods={COURSE_MODULES} user={user} onUpgrade={()=>{}} />;
                    case 'admin': return <AdminPanel stateDB={STATE_DATABASE} onUpdateStateDB={()=>{}} />;
                    default: return <div>Not found</div>;
                }
            };

            if (!user && currentView !== 'landing' && currentView !== 'auth') { return <LandingPage onNavigate={() => setCurrentView('auth')} />; }
            if (currentView === 'landing' || currentView === 'auth') return renderView();

            return (
                <div className="flex h-screen overflow-hidden font-sans theme-app-bg">
                    <ToastContainer />

                    {/* Hide FAB on Trainer Page to avoid overlap/redundancy */}
                    {currentView !== 'trainer' && (
                        <button onClick={() => setShowAIModal(true)} className="fab-ai bg-indigo-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-2xl hover:bg-indigo-700 transition-transform transform hover:scale-110">
                            <i className="fas fa-robot text-2xl"></i>
                        </button>
                    )}

                    {showAIModal && <AIHelperModal onClose={() => setShowAIModal(false)} />}
                    {showPricing && <PricingModal onClose={() => setShowPricing(false)} onUpgrade={handleUpgrade} />}
                    {showSettings && <SettingsModal user={user} onClose={() => setShowSettings(false)} onSave={handleUpdateProfile} />}
                    {showOnboarding && <OnboardingTour onComplete={handleOnboardingComplete} />}
                    {showWelcomeTour && <WelcomeTour onComplete={handleTourComplete} />}
                    
                    {showWhatsNew && (
                        <div className="fixed top-4 left-1/2 -translate-x-1/2 z-40 max-w-xl w-[92%] bg-white border border-blue-100 rounded-2xl shadow-xl p-4 font-sans">
                            <div className="flex items-start justify-between gap-3">
                                <div>
                                    <p className="text-xs font-bold uppercase text-blue-600">What's New</p>
                                    <p className="text-sm text-gray-600 mt-1">Payments, Client Portal, Smart Mileage, Audit Journal Capture, and Team Mode are now available by plan.</p>
                                </div>
                                <button onClick={() => { localStorage.setItem('notary_whats_new_seen_v2', 'true'); setShowWhatsNew(false); }} className="text-gray-400"><i className="fas fa-times"></i></button>
                            </div>
                        </div>
                    )}
                    
                    <Sidebar 
                        currentView={currentView} 
                        setView={setCurrentView} 
                        isOpen={showMobileMenu} 
                        onClose={() => setShowMobileMenu(false)} 
                        onLogout={handleLogout} 
                        userName={user.name} 
                        userPlan={user.plan} 
                        userRole={user.role || 'solo'}
                        onUpgrade={() => setShowPricing(true)} 
                        onSettings={() => setShowSettings(true)}
                    />
                    <main className="flex-1 flex flex-col h-screen md:ml-64 relative theme-app-bg">
                        <Header title={currentView.charAt(0).toUpperCase() + currentView.slice(1)} onNotify={handleNotify} onSyncNow={handleSyncNow} />
                        <div className="flex-1 overflow-y-auto relative">{renderView()}</div>
                        <MobileNav currentView={currentView} setView={setCurrentView} onOpenMenu={() => setShowMobileMenu(true)} />
                    </main>
                </div>
            );
        };

        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(
                <AppErrorBoundary>
                    <App />
                </AppErrorBoundary>
            );
        } catch (e) {
            const mount = document.getElementById('root');
            if (mount) {
                mount.innerHTML = `<div style="min-height:100vh;display:grid;place-items:center;padding:24px;font-family:sans-serif;background:#f8fafc;color:#0f172a;"><div style="max-width:520px;background:#fff;border:1px solid #e2e8f0;border-radius:16px;padding:20px;box-shadow:0 10px 25px rgba(2,6,23,.08);"><h2 style="margin:0 0 8px;font-size:20px;">NotaryOS failed to load</h2><p style="margin:0 0 10px;color:#475569;">A browser/runtime issue prevented startup. Refresh the page or clear site data and retry.</p><p style="margin:0;color:#64748b;font-size:12px;word-break:break-word;">${(e && e.message) ? e.message : 'Unknown startup error'}</p></div></div>`;
            }
            console.error('Root render failure:', e);
        }
    </script>
</body>
</html>
