<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NotaryOS</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“œ</text></svg>">
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Utilities -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

    <!-- FIREBASE SDK (COMPAT MODE - Stable) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyA32kVbmGOcY_CdDymrom9rWVzyXTj3so0",
            authDomain: "notaryos-67cd2.firebaseapp.com",
            projectId: "notaryos-67cd2",
            storageBucket: "notaryos-67cd2.firebasestorage.app",
            messagingSenderId: "660325303334",
            appId: "1:660325303334:web:bb0f062fd4da8c7fca12e7"
        };

        // Initialize
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase Connected - v1.2");
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }
    </script>

    <!-- Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Courier+Prime&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Status Badges */
        .status-scheduled { background-color: #e0f2fe; color: #0369a1; }
        .status-completed { background-color: #dcfce7; color: #15803d; }
        .status-paid { background-color: #166534; color: white; }
        .status-cancelled { background-color: #fee2e2; color: #b91c1c; }

        /* Chat Styles */
        .typing-indicator span {
            animation: blink 1.4s infinite both;
            height: 6px; width: 6px; background-color: #3b82f6; border-radius: 50%; display: inline-block; margin: 0 2px;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }

        /* Markdown Styles */
        .prose p { margin-bottom: 0.5em; margin-top: 0.5em; line-height: 1.5; }
        .prose ul { margin-top: 0.25em; margin-bottom: 0.25em; padding-left: 1.5em; list-style-type: disc;}
        .prose strong { color: inherit; font-weight: 700; }
        .user-content .prose { color: white; }
        .user-content .prose strong { color: white; }

        .paper-doc {
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
            font-family: 'Courier Prime', monospace;
        }
        
        /* Auth Animations */
        .auth-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .sidebar-transition { transition: width 0.3s ease-in-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- HYBRID DATA MANAGER (Cloud + Local Fallback) ---
        const DataManager = {
            isCloud: () => firebase.auth().currentUser !== null,
            
            // Generic Fetch
            get: async (collectionName) => {
                if (DataManager.isCloud()) {
                    try {
                        const uid = firebase.auth().currentUser.uid;
                        const snapshot = await firebase.firestore().collection(collectionName).where("userId", "==", uid).get();
                        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    } catch (e) {
                        console.error("Cloud fetch error:", e);
                        return [];
                    }
                } else {
                    return JSON.parse(localStorage.getItem(collectionName) || '[]');
                }
            },
            
            // Generic Save
            save: async (collectionName, item) => {
                if (DataManager.isCloud()) {
                    try {
                        const uid = firebase.auth().currentUser.uid;
                        const itemWithUser = { ...item, userId: uid };
                        // Use provided ID or generate one if missing
                        const docId = item.id || Date.now().toString();
                        await firebase.firestore().collection(collectionName).doc(docId).set(itemWithUser);
                        
                        return await DataManager.get(collectionName); // Refresh
                    } catch (e) {
                        console.error("Cloud save error:", e);
                        return [];
                    }
                } else {
                    const list = JSON.parse(localStorage.getItem(collectionName) || '[]');
                    const index = list.findIndex(i => i.id === item.id);
                    if (index >= 0) list[index] = item;
                    else list.push(item);
                    localStorage.setItem(collectionName, JSON.stringify(list));
                    return list;
                }
            },
            
             delete: async (collectionName, id) => {
                if (DataManager.isCloud()) {
                     try {
                        await firebase.firestore().collection(collectionName).doc(id).delete();
                        return await DataManager.get(collectionName);
                     } catch(e) {
                         console.error("Delete error", e);
                         return [];
                     }
                } else {
                    const list = JSON.parse(localStorage.getItem(collectionName) || '[]');
                    const newList = list.filter(i => i.id !== id);
                    localStorage.setItem(collectionName, JSON.stringify(newList));
                    return newList;
                }
            }
        };

        // --- KNOWLEDGE BASE (Abridged for Size - Logic Remains) ---
        const STATE_DATABASE = {
             "CA": { "state": "California", "fees": { "acknowledgment": "$15 per sig", "jurat": "$15", "oath": "$15", "travel": "null" }, "id_requirements": { "credible_witnesses": "One witness (personally known) OR Two witnesses (proven with IDs).", "expired_id_rule": "Allowed if current or issued within 5 years." }, "biometrics": { "journal_thumbprint": "REQUIRED for deeds, quitclaim deeds, deeds of trust, powers of attorney." }, "certificates": { "acknowledgment_text": "A notary public or other officer completing this certificate verifies only the identity of the individual...", "jurat_text": "Subscribed and sworn to (or affirmed) before me on this ____ day of _________, 20___..." }, "red_flags": [ "Cannot use title 'notario publico'", "Cannot use seal for non-notarial purposes" ] },
             "TX": { "state": "Texas", "fees": { "acknowledgment": "$6 (first signature) + $1 (each additional)", "jurat": "$6", "oath": "$6", "travel": "null" }, "id_requirements": { "credible_witnesses": "1 credible witness (personally known to notary)", "expired_id_rule": "Must be current" }, "biometrics": { "journal_thumbprint": "Not specified" }, "certificates": { "acknowledgment_text": "State of Texas\nCounty of ______\n\nThis instrument was acknowledged before me...", "jurat_text": "State of Texas\nCounty of ______\n\nSworn to and subscribed before me..." }, "red_flags": ["Check state handbook for specific prohibited acts"] },
             "FL": { "state": "Florida", "fees": { "acknowledgment": "Maximum $10 per notarial act", "jurat": "Maximum $10", "oath": "Maximum $10", "travel": "null" }, "id_requirements": { "credible_witnesses": "1 witness (personally known) OR 2 witnesses (proven by ID).", "expired_id_rule": "Acceptable if issued within past 5 years." }, "biometrics": { "journal_thumbprint": "null" }, "certificates": { "acknowledgment_text": "STATE OF FLORIDA\nCOUNTY OF ______...", "jurat_text": "STATE OF FLORIDA\nCOUNTY OF ______..." }, "red_flags": [ "Cannot notarize own signature.", "Physical presence required unless RON." ] },
             "OH": { "state": "Ohio", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00", "travel": "Reasonable fee" }, "id_requirements": { "credible_witnesses": "Proof of identity by third person known to notary", "expired_id_rule": "Not specified" }, "biometrics": { "journal_thumbprint": "Not required" }, "certificates": { "acknowledgment_text": "State of Ohio\nCounty of ______...", "jurat_text": "State of Ohio\nCounty of ______..." }, "red_flags": [ "Never prepare instruments or give advice", "Cannot notarize if you have an interest" ] },
             "NY": { "state": "New York", "fees": { "acknowledgment": "$2.00", "jurat": "$2.00", "oath": "$2.00" }, "id_requirements": { "credible_witnesses": "Not specified", "expired_id_rule": "Not specified" }, "biometrics": { "journal_thumbprint": "Not required" }, "certificates": { "acknowledgment_text": "State of New York\nCounty of ______...", "jurat_text": "Sworn to before me on this ___ day of ___..." }, "red_flags": [ "Name must match signature exactly", "No initials if commissioned name is full" ] }
        };

        const COURSE_MODULES = [
            { id: 1, title: "Authority & Qualifications", topic: "Commissioning authority, term length, and jurisdiction." },
            { id: 2, title: "The Core 5 Steps", topic: "Personal Appearance, ID, Willingness, Awareness, Certificates." },
            { id: 3, title: "Notarial Acts", topic: "Acknowledgments vs. Jurats vs. Oaths." },
            { id: 4, title: "Identification Standards", topic: "Satisfactory Evidence, Credible Witnesses." },
            { id: 5, title: "Rules, Fees, & Journals", topic: "Maximum fees, Journal requirements, Seal rules." },
            { id: 6, title: "Special Circumstances", topic: "RON, Signature by Mark/Proxy, Foreign language." },
            { id: 7, title: "Misconduct & Liability", topic: "Prohibited acts (UPL), Penalties, Liability." }
        ];

        const PERSONA = `
            ROLE: SUPPORTIVE NOTARY MENTOR.
            TONE: Encouraging, professional, clear.
            APPROACH: Guide the user. Explain the "Why" behind laws.
            RULES: Teach One Topic -> Quiz -> Feedback.
        `;

        // --- COMPONENTS ---

        const TermsModal = ({ onAccept }) => {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden auth-fade-in">
                        <div className="p-6 border-b border-gray-100 bg-gray-50">
                            <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <i className="fas fa-balance-scale text-blue-600"></i> Terms of Service
                            </h2>
                        </div>
                        <div className="p-6 text-sm text-gray-600 space-y-4 max-h-[60vh] overflow-y-auto">
                            <p className="font-bold text-gray-800">Please review and accept to continue.</p>
                            <p><strong>1. Not Legal Advice:</strong> NotaryOS is an educational and management tool. The AI Trainer provides information based on general data and may produce inaccuracies. This tool does not constitute legal advice.</p>
                            <p><strong>2. User Responsibility:</strong> You are responsible for verifying all laws with your state's official Notary Handbook. NotaryOS is not liable for any notarial errors, fines, or legal actions resulting from the use of this software.</p>
                            <p><strong>3. Data Privacy:</strong> In this Beta version, your business data is stored locally on your device unless Cloud Sync is enabled.</p>
                            <p><strong>4. AI Limitations:</strong> The AI features utilize Google Gemini. AI responses should always be fact-checked against official statutes.</p>
                        </div>
                        <div className="p-6 border-t border-gray-100 bg-gray-50">
                            <button 
                                onClick={onAccept}
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg transform active:scale-95"
                            >
                                I Understand & Agree
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const AuthScreen = ({ onAuth }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [formData, setFormData] = useState({ name: '', email: '', password: '' });
            const [showTerms, setShowTerms] = useState(false);
            const [error, setError] = useState('');

            const handleAuth = (e) => {
                e.preventDefault();
                setError('');
                setShowTerms(true); // Trigger Terms Modal
            };

            const completeAuth = async () => {
                try {
                    let user;
                    // Check if Firebase is active
                    if (firebase.auth()) {
                        if (isLogin) {
                            const cred = await firebase.auth().signInWithEmailAndPassword(formData.email, formData.password);
                            user = cred.user;
                        } else {
                            const cred = await firebase.auth().createUserWithEmailAndPassword(formData.email, formData.password);
                            user = cred.user;
                        }
                    } else {
                        // Fallback Local Auth
                         console.warn("Firebase not configured properly. Using Local Simulation.");
                    }

                    const profile = {
                        id: user ? user.uid : Date.now().toString(),
                        name: isLogin ? (formData.email.split('@')[0] || "User") : formData.name, 
                        email: formData.email,
                        joined: new Date().toLocaleDateString()
                    };
                    onAuth(profile);
                } catch (err) {
                    setShowTerms(false);
                    setError(err.message);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                    {showTerms && <TermsModal onAccept={completeAuth} />}
                    
                    <div className="bg-white rounded-2xl shadow-2xl overflow-hidden max-w-4xl w-full flex flex-col md:flex-row auth-fade-in">
                        {/* Brand Side */}
                        <div className="bg-slate-900 text-white p-8 md:w-1/2 flex flex-col justify-center relative overflow-hidden">
                             <div className="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 bg-blue-600 rounded-full opacity-20"></div>
                             <div className="absolute bottom-0 left-0 -ml-16 -mb-16 w-48 h-48 bg-purple-600 rounded-full opacity-20"></div>
                            <div className="mb-8 relative z-10">
                                <div className="flex items-center gap-3 mb-2">
                                    <div className="bg-blue-600 p-2 rounded-lg"><i className="fas fa-stamp text-2xl"></i></div>
                                    <h1 className="text-4xl font-bold">NotaryOS</h1>
                                </div>
                                <p className="text-blue-200 text-lg">The Operating System for Modern Notaries.</p>
                            </div>
                            <ul className="space-y-4 text-gray-300 relative z-10">
                                <li className="flex items-center gap-3"><i className="fas fa-check-circle text-green-400"></i> Business Management Suite</li>
                                <li className="flex items-center gap-3"><i className="fas fa-check-circle text-green-400"></i> AI-Powered Compliance Coach</li>
                                <li className="flex items-center gap-3"><i className="fas fa-check-circle text-green-400"></i> 50-State Law Database</li>
                            </ul>
                        </div>
                        
                        {/* Form Side */}
                        <div className="p-8 md:w-1/2 flex flex-col justify-center bg-white">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6">{isLogin ? 'Welcome Back' : 'Create Account'}</h2>
                            {error && <div className="bg-red-100 text-red-700 p-3 rounded mb-4 text-sm">{error}</div>}
                            
                            <form onSubmit={handleAuth} className="space-y-4">
                                {!isLogin && (
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Full Name</label>
                                        <input required type="text" className="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} placeholder="Jane Doe" />
                                    </div>
                                )}
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Email Address</label>
                                    <input required type="email" className="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} placeholder="notary@example.com" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Password</label>
                                    <input required type="password" className="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
                                </div>
                                <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-all shadow-md transform active:scale-95">
                                    {isLogin ? 'Sign In' : 'Start Free Trial'}
                                </button>
                            </form>
                            <div className="mt-6 text-center text-sm">
                                <span className="text-gray-500">{isLogin ? "Don't have an account?" : "Already have an account?"}</span>
                                <button onClick={() => setIsLogin(!isLogin)} className="ml-2 text-blue-600 font-bold hover:underline focus:outline-none">
                                    {isLogin ? 'Sign Up' : 'Log In'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ currentView, setView, isOpen, onClose, onLogout, userName }) => {
            const menuItems = [
                { id: 'dashboard', icon: 'fa-chart-pie', label: 'Dashboard', color: 'text-blue-400' },
                { id: 'schedule', icon: 'fa-calendar-alt', label: 'Schedule', color: 'text-green-400' },
                { id: 'journal', icon: 'fa-book', label: 'Journal', color: 'text-purple-400' },
                { id: 'finances', icon: 'fa-wallet', label: 'Finances', color: 'text-emerald-400' },
                { id: 'credentials', icon: 'fa-id-card', label: 'Credentials', color: 'text-orange-400' },
                { id: 'trainer', icon: 'fa-robot', label: 'AI Trainer', color: 'text-indigo-400' },
            ];

            return (
                <>
                    <div className={`fixed inset-0 bg-black bg-opacity-50 z-40 transition-opacity duration-300 lg:hidden ${isOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`} onClick={onClose}></div>
                    <div className={`fixed inset-y-0 left-0 bg-slate-900 text-white z-50 transform transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:flex lg:flex-col ${isOpen ? 'translate-x-0' : '-translate-x-full'} w-64`}>
                        <div className="p-6 border-b border-slate-700 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 p-2 rounded-lg"><i className="fas fa-stamp"></i></div>
                                <h1 className="font-bold text-xl tracking-tight">NotaryOS</h1>
                            </div>
                            <button onClick={onClose} className="lg:hidden text-slate-400 hover:text-white">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
                            {menuItems.map(item => (
                                <button 
                                    key={item.id}
                                    onClick={() => { setView(item.id); onClose(); }}
                                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${currentView === item.id ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}
                                >
                                    <i className={`fas ${item.icon} w-5 text-center ${item.color}`}></i>
                                    <span className="font-medium text-sm">{item.label}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-slate-700">
                            <div className="flex items-center gap-3 px-4 py-2 mb-2">
                                <div className="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-blue-300">
                                    {userName ? userName.substring(0,2).toUpperCase() : 'US'}
                                </div>
                                <div className="flex-1 overflow-hidden">
                                    <p className="text-xs font-bold truncate">{userName || 'User'}</p>
                                    <p className="text-[10px] text-slate-400">Pro Plan</p>
                                </div>
                            </div>
                            <button onClick={onLogout} className="w-full text-left px-4 py-2 text-xs text-red-400 hover:text-red-300 hover:bg-slate-800 rounded flex items-center gap-2 transition-colors">
                                <i className="fas fa-sign-out-alt"></i> Log Out
                            </button>
                        </div>
                    </div>
                </>
            );
        };

        const MobileNav = ({ currentView, setView, onOpenMenu }) => {
            const menuItems = [
                { id: 'dashboard', icon: 'fa-chart-pie', label: 'Home', color: 'text-blue-500' },
                { id: 'schedule', icon: 'fa-calendar-alt', label: 'Schedule', color: 'text-green-500' },
                { id: 'add', icon: 'fa-plus-circle', label: 'Add', special: true },
                { id: 'trainer', icon: 'fa-robot', label: 'Trainer', color: 'text-indigo-500' },
                { id: 'menu', icon: 'fa-bars', label: 'Menu', action: onOpenMenu },
            ];

            return (
                <div className="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 flex justify-around items-center px-2 py-2 z-30 shadow-[0_-2px_10px_rgba(0,0,0,0.05)] safe-area-pb">
                    {menuItems.map(item => (
                        <button 
                            key={item.id}
                            onClick={() => item.special ? setView('add_appointment') : (item.action ? item.action() : setView(item.id))}
                            className={`flex flex-col items-center justify-center w-full py-1 ${item.special ? '-mt-6' : ''}`}
                        >
                            {item.special ? (
                                <div className="w-14 h-14 bg-blue-600 rounded-full flex items-center justify-center text-white shadow-lg shadow-blue-600/30">
                                    <i className={`fas ${item.icon} text-2xl`}></i>
                                </div>
                            ) : (
                                <>
                                    <i className={`fas ${item.icon} text-lg mb-1 ${currentView === item.id ? 'text-blue-600' : 'text-gray-400'} ${item.color}`}></i>
                                    <span className={`text-[10px] font-medium ${currentView === item.id ? 'text-blue-600' : 'text-gray-400'}`}>{item.label}</span>
                                </>
                            )}
                        </button>
                    ))}
                </div>
            );
        };

        const Header = ({ title }) => (
            <div className="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center sticky top-0 z-20">
                <h2 className="text-xl font-bold text-gray-800">{title}</h2>
                <div className="flex items-center gap-4">
                    <button className="relative text-gray-400 hover:text-blue-600 transition-colors">
                        <i className="fas fa-bell text-xl"></i>
                        <span className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
                    </button>
                </div>
            </div>
        );

        // --- MODULES ---

        const Dashboard = ({ appointments, credentials, setView }) => {
            const today = new Date().toISOString().split('T')[0];
            const todaysJobs = appointments.filter(a => a.date === today && a.status !== 'Cancelled');
            const monthlyIncome = appointments.filter(a => a.status === 'Paid').reduce((sum, a) => sum + parseFloat(a.fee || 0), 0);
            
            // Calc Alerts
            const expiringCreds = credentials.filter(c => {
                const exp = new Date(c.expiry);
                const now = new Date();
                const diffTime = exp - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays <= 60; 
            });

            return (
                <div className="p-6 space-y-6 pb-24">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden">
                            <div className="absolute right-0 top-0 w-24 h-24 bg-green-50 rounded-bl-full -mr-4 -mt-4"></div>
                            <div className="relative">
                                <div className="text-gray-500 text-xs font-bold uppercase mb-1">Monthly Income</div>
                                <div className="text-2xl font-bold text-gray-800">${monthlyIncome.toFixed(2)}</div>
                                <div className="text-xs text-green-500 mt-1 font-medium"><i className="fas fa-arrow-up"></i> Updated just now</div>
                            </div>
                        </div>
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden">
                            <div className="absolute right-0 top-0 w-24 h-24 bg-blue-50 rounded-bl-full -mr-4 -mt-4"></div>
                            <div className="relative">
                                <div className="text-gray-500 text-xs font-bold uppercase mb-1">Today's Jobs</div>
                                <div className="text-2xl font-bold text-gray-800">{todaysJobs.length}</div>
                                <div className="text-xs text-blue-500 mt-1 font-medium"><i className="fas fa-calendar-day"></i> Check schedule</div>
                            </div>
                        </div>
                        <div onClick={() => setView('credentials')} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 cursor-pointer hover:bg-gray-50 relative overflow-hidden">
                            <div className={`absolute right-0 top-0 w-24 h-24 rounded-bl-full -mr-4 -mt-4 ${expiringCreds.length > 0 ? 'bg-red-50' : 'bg-gray-50'}`}></div>
                            <div className="relative">
                                <div className="text-gray-500 text-xs font-bold uppercase mb-1">Compliance Alerts</div>
                                <div className={`text-2xl font-bold ${expiringCreds.length > 0 ? 'text-red-600' : 'text-green-600'}`}>
                                    {expiringCreds.length}
                                </div>
                                <div className="text-xs text-gray-400 mt-1 font-medium">
                                    {expiringCreds.length > 0 ? `${expiringCreds.length} items expiring soon` : "All credentials active"}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 className="text-lg font-bold text-gray-800 mb-4">Today's Agenda</h3>
                        {todaysJobs.length === 0 ? (
                            <div className="bg-white rounded-2xl p-8 text-center border border-gray-100">
                                <div className="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-400">
                                    <i className="fas fa-coffee"></i>
                                </div>
                                <p className="text-gray-500 text-sm">No appointments scheduled for today.</p>
                                <button onClick={() => setView('schedule')} className="mt-4 text-blue-600 text-sm font-semibold hover:underline">Add one now</button>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {todaysJobs.map(job => (
                                    <div key={job.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center">
                                        <div className="flex gap-4 items-center">
                                            <div className="bg-blue-50 text-blue-600 w-12 h-12 rounded-lg flex flex-col items-center justify-center text-xs font-bold leading-none">
                                                <span>{job.time.split(':')[0]}</span>
                                                <span className="text-[10px] opacity-70">{job.time.split(':')[1]}</span>
                                            </div>
                                            <div>
                                                <h4 className="font-bold text-gray-800">{job.clientName}</h4>
                                                <p className="text-xs text-gray-500"><i className="fas fa-map-marker-alt mr-1"></i>{job.location}</p>
                                            </div>
                                        </div>
                                        <span className={`text-[10px] px-2 py-1 rounded-full font-bold uppercase tracking-wide status-${job.status.toLowerCase()}`}>
                                            {job.status}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const Credentials = ({ onUpdate }) => {
            const [creds, setCreds] = useState([]);
            const [showForm, setShowForm] = useState(false);
            
            useEffect(() => {
                const load = async () => {
                    const data = await DataManager.get('notary_credentials');
                    setCreds(data);
                };
                load();
            }, []);

            const handleSave = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                await DataManager.save('notary_credentials', {
                    id: Date.now().toString(),
                    name: formData.get('name'),
                    expiry: formData.get('expiry')
                });
                const updated = await DataManager.get('notary_credentials');
                setCreds(updated);
                onUpdate();
                setShowForm(false);
            };

            const handleDelete = async (id) => {
                await DataManager.delete('notary_credentials', id);
                const updated = await DataManager.get('notary_credentials');
                setCreds(updated);
                onUpdate();
            };

            return (
                <div className="p-6 pb-24">
                     <div className="flex justify-between items-center mb-6">
                        <h3 className="text-lg font-bold text-gray-800">My Credentials</h3>
                        <button onClick={() => setShowForm(true)} className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-indigo-700 transition-colors shadow-md"><i className="fas fa-plus mr-2"></i>Add</button>
                    </div>

                    {showForm && (
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-6 animate-fade-in">
                            <form onSubmit={handleSave} className="space-y-4">
                                <input required name="name" type="text" placeholder="Credential Name (e.g. Commission, Bond)" className="w-full p-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" />
                                <input required name="expiry" type="date" className="w-full p-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" />
                                <div className="flex gap-2">
                                    <button type="button" onClick={() => setShowForm(false)} className="flex-1 py-2 bg-gray-100 rounded-lg font-medium">Cancel</button>
                                    <button type="submit" className="flex-1 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700">Save</button>
                                </div>
                            </form>
                        </div>
                    )}

                    <div className="space-y-3">
                        {creds.length === 0 ? (
                            <div className="text-center py-12">
                                <div className="w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-300">
                                    <i className="fas fa-id-card text-2xl"></i>
                                </div>
                                <p className="text-gray-400">No credentials tracked yet.</p>
                            </div>
                        ) : creds.sort((a,b) => new Date(a.expiry) - new Date(b.expiry)).map(c => {
                            const daysLeft = Math.ceil((new Date(c.expiry) - new Date()) / (1000 * 60 * 60 * 24));
                            const statusColor = daysLeft < 0 ? 'bg-red-100 text-red-700' : (daysLeft < 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-700');
                            
                            return (
                                <div key={c.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center">
                                    <div>
                                        <h4 className="font-bold text-gray-800">{c.name}</h4>
                                        <p className="text-xs text-gray-500 mt-1"><i className="far fa-calendar-alt mr-1"></i> Expires: {c.expiry}</p>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <span className={`text-xs px-3 py-1 rounded-full font-bold uppercase ${statusColor}`}>
                                            {daysLeft < 0 ? 'EXPIRED' : `${daysLeft} days`}
                                        </span>
                                        <button onClick={() => handleDelete(c.id)} className="text-gray-300 hover:text-red-500 w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 transition-colors"><i className="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const AppointmentForm = ({ onSave, onCancel, initialData }) => {
            const [formData, setFormData] = useState(initialData || {
                clientName: '', date: new Date().toISOString().split('T')[0], time: '12:00',
                location: '', type: 'General Notarization', fee: '', status: 'Scheduled', notes: ''
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({ ...formData, id: initialData?.id || Date.now().toString() });
            };

            return (
                <div className="p-6 max-w-2xl mx-auto">
                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                        <h3 className="text-lg font-bold mb-6 flex items-center gap-2"><i className="fas fa-calendar-plus text-blue-600"></i>{initialData ? 'Edit Appointment' : 'New Appointment'}</h3>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input required type="text" placeholder="Client Name" className="w-full p-3 bg-gray-50 border rounded-xl" value={formData.clientName} onChange={e => setFormData({...formData, clientName: e.target.value})} />
                            <div className="grid grid-cols-2 gap-4">
                                <input required type="date" className="w-full p-3 bg-gray-50 border rounded-xl" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} />
                                <input required type="time" className="w-full p-3 bg-gray-50 border rounded-xl" value={formData.time} onChange={e => setFormData({...formData, time: e.target.value})} />
                            </div>
                            <input required type="text" placeholder="Location" className="w-full p-3 bg-gray-50 border rounded-xl" value={formData.location} onChange={e => setFormData({...formData, location: e.target.value})} />
                            <div className="grid grid-cols-2 gap-4">
                                <input required type="number" placeholder="Fee ($)" className="w-full p-3 bg-gray-50 border rounded-xl" value={formData.fee} onChange={e => setFormData({...formData, fee: e.target.value})} />
                                <select className="w-full p-3 bg-gray-50 border rounded-xl" value={formData.status} onChange={e => setFormData({...formData, status: e.target.value})}>
                                    <option>Scheduled</option><option>Completed</option><option>Paid</option><option>Cancelled</option>
                                </select>
                            </div>
                            <div className="flex gap-3 pt-4">
                                <button type="button" onClick={onCancel} className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl">Cancel</button>
                                <button type="submit" className="flex-1 py-3 bg-blue-600 text-white rounded-xl">Save</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const Schedule = ({ appointments, setView, onEdit }) => {
            return (
                <div className="p-6 pb-24">
                    <div className="flex justify-between items-center mb-6">
                        <h3 className="text-lg font-bold text-gray-800">All Appointments</h3>
                        <button onClick={() => setView('add_appointment')} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors shadow-md"><i className="fas fa-plus mr-2"></i>New</button>
                    </div>
                    <div className="space-y-3">
                        {appointments.length === 0 ? <p className="text-center text-gray-400 py-10">Schedule empty.</p> : appointments.sort((a,b) => new Date(a.date) - new Date(b.date)).map(job => (
                            <div key={job.id} onClick={() => { onEdit(job); }} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm cursor-pointer hover:shadow-md transition-shadow">
                                <div className="flex justify-between items-start mb-2">
                                    <div><span className="text-xs font-bold text-gray-400 uppercase tracking-wider">{job.type}</span><h4 className="font-bold text-gray-800 text-lg">{job.clientName}</h4></div>
                                    <span className={`text-[10px] px-2 py-1 rounded-full font-bold uppercase tracking-wide status-${job.status.toLowerCase()}`}>{job.status}</span>
                                </div>
                                <div className="grid grid-cols-2 gap-4 text-sm text-gray-600 mt-3 pt-3 border-t border-gray-50">
                                    <div className="flex items-center gap-2"><i className="far fa-calendar-alt text-blue-400"></i> {job.date} {job.time}</div>
                                    <div className="text-right font-bold text-gray-800">${job.fee}</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const Journal = ({ onUpdate }) => {
            const [entries, setEntries] = useState([]);
            const [showForm, setShowForm] = useState(false);

            useEffect(() => {
                const load = async () => {
                    const data = await DataManager.get('notary_journal');
                    setEntries(data);
                };
                load();
            }, []);

            const handleSave = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                await DataManager.save('notary_journal', {
                    id: Date.now().toString(),
                    date: formData.get('date'),
                    time: formData.get('time'),
                    signer: formData.get('signer'),
                    docType: formData.get('docType'),
                    idType: formData.get('idType'),
                    fee: formData.get('fee')
                });
                const updated = await DataManager.get('notary_journal');
                setEntries(updated);
                onUpdate();
                setShowForm(false);
            };

            return (
                <div className="p-6 pb-24">
                     <div className="flex justify-between items-center mb-6">
                        <h3 className="text-lg font-bold text-gray-800">Notary Journal</h3>
                        <button onClick={() => setShowForm(true)} className="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-purple-700 transition-colors shadow-md"><i className="fas fa-plus mr-2"></i>Log Entry</button>
                    </div>

                    {showForm && (
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-6">
                            <form onSubmit={handleSave} className="space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <input required name="date" type="date" defaultValue={new Date().toISOString().split('T')[0]} className="w-full p-3 bg-gray-50 border rounded-xl" />
                                    <input required name="time" type="time" defaultValue="12:00" className="w-full p-3 bg-gray-50 border rounded-xl" />
                                </div>
                                <input required name="signer" type="text" placeholder="Signer Name" className="w-full p-3 bg-gray-50 border rounded-xl" />
                                <div className="grid grid-cols-2 gap-4">
                                    <input required name="docType" type="text" placeholder="Document Type" className="w-full p-3 bg-gray-50 border rounded-xl" />
                                    <input required name="idType" type="text" placeholder="ID Type (e.g. DL)" className="w-full p-3 bg-gray-50 border rounded-xl" />
                                </div>
                                <input name="fee" type="number" placeholder="Fee Charged ($)" className="w-full p-3 bg-gray-50 border rounded-xl" />
                                <div className="flex gap-2">
                                    <button type="button" onClick={() => setShowForm(false)} className="flex-1 py-2 bg-gray-100 rounded-lg">Cancel</button>
                                    <button type="submit" className="flex-1 py-2 bg-purple-600 text-white rounded-lg">Save Entry</button>
                                </div>
                            </form>
                        </div>
                    )}

                    <div className="space-y-3">
                        {entries.length === 0 ? <p className="text-center text-gray-400 py-10">No journal entries yet.</p> : entries.sort((a,b) => new Date(b.date) - new Date(a.date)).map(entry => (
                            <div key={entry.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <h4 className="font-bold text-gray-800">{entry.signer}</h4>
                                        <p className="text-xs text-gray-500 mt-1"><i className="far fa-file-alt mr-1"></i> {entry.docType}</p>
                                    </div>
                                    <span className="text-xs text-gray-400 font-mono">{entry.date}</span>
                                </div>
                                <div className="mt-3 pt-3 border-t border-gray-50 flex justify-between items-center text-xs text-gray-500">
                                    <span>ID: {entry.idType}</span>
                                    <span className="font-bold text-purple-600">${entry.fee}</span>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const Finances = () => {
            const [activeTab, setActiveTab] = useState('expenses');
            const [expenses, setExpenses] = useState([]);
            const [mileage, setMileage] = useState([]);
            const [showForm, setShowForm] = useState(false);

             useEffect(() => {
                const load = async () => {
                    setExpenses(await DataManager.get('notary_expenses'));
                    setMileage(await DataManager.get('notary_mileage'));
                };
                load();
            }, []);

            const handleSave = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                if (activeTab === 'expenses') {
                    await DataManager.save('notary_expenses', {
                        id: Date.now().toString(),
                        date: formData.get('date'),
                        category: formData.get('category'),
                        desc: formData.get('desc'),
                        amount: formData.get('amount')
                    });
                    setExpenses(await DataManager.get('notary_expenses'));
                } else {
                    await DataManager.save('notary_mileage', {
                        id: Date.now().toString(),
                        date: formData.get('date'),
                        start: formData.get('start'),
                        end: formData.get('end'),
                        miles: formData.get('miles')
                    });
                    setMileage(await DataManager.get('notary_mileage'));
                }
                setShowForm(false);
            };

            const totalExp = expenses.reduce((s, i) => s + parseFloat(i.amount||0), 0);
            const totalMiles = mileage.reduce((s, i) => s + parseFloat(i.miles||0), 0);

            return (
                <div className="p-6 pb-24">
                    <div className="bg-white p-1 rounded-xl flex mb-6 border border-gray-200 shadow-sm">
                        <button onClick={() => setActiveTab('expenses')} className={`flex-1 py-2 text-sm font-bold rounded-lg transition-all ${activeTab === 'expenses' ? 'bg-emerald-50 text-emerald-700 shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}>Expenses</button>
                        <button onClick={() => setActiveTab('mileage')} className={`flex-1 py-2 text-sm font-bold rounded-lg transition-all ${activeTab === 'mileage' ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}>Mileage</button>
                    </div>

                    <div className="flex justify-between items-center mb-6">
                        <div>
                            <p className="text-xs text-gray-500 uppercase font-bold tracking-wide">{activeTab === 'expenses' ? 'Total Expenses' : 'Total Mileage'}</p>
                            <p className="text-2xl font-bold text-gray-800">{activeTab === 'expenses' ? `$${totalExp.toFixed(2)}` : `${totalMiles} mi`}</p>
                        </div>
                        <button onClick={() => setShowForm(true)} className="bg-gray-900 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg hover:bg-gray-700 transition-colors"><i className="fas fa-plus"></i></button>
                    </div>

                    {showForm && (
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-6">
                            <form onSubmit={handleSave} className="space-y-4">
                                <input required name="date" type="date" defaultValue={new Date().toISOString().split('T')[0]} className="w-full p-3 bg-gray-50 border rounded-xl" />
                                {activeTab === 'expenses' ? (
                                    <>
                                        <select name="category" className="w-full p-3 bg-gray-50 border rounded-xl">
                                            <option>Supplies</option><option>Insurance</option><option>Training</option><option>Software</option><option>Travel</option>
                                        </select>
                                        <input required name="desc" type="text" placeholder="Description (e.g. Printer Paper)" className="w-full p-3 bg-gray-50 border rounded-xl" />
                                        <input required name="amount" type="number" step="0.01" placeholder="Amount ($)" className="w-full p-3 bg-gray-50 border rounded-xl" />
                                    </>
                                ) : (
                                    <>
                                        <input required name="start" type="text" placeholder="Start Location" className="w-full p-3 bg-gray-50 border rounded-xl" />
                                        <input required name="end" type="text" placeholder="End Location" className="w-full p-3 bg-gray-50 border rounded-xl" />
                                        <input required name="miles" type="number" step="0.1" placeholder="Distance (Miles)" className="w-full p-3 bg-gray-50 border rounded-xl" />
                                    </>
                                )}
                                <div className="flex gap-2">
                                    <button type="button" onClick={() => setShowForm(false)} className="flex-1 py-2 bg-gray-100 rounded-lg">Cancel</button>
                                    <button type="submit" className="flex-1 py-2 bg-gray-900 text-white rounded-lg">Save</button>
                                </div>
                            </form>
                        </div>
                    )}

                    <div className="space-y-3">
                        {activeTab === 'expenses' ? 
                            expenses.map(e => (
                                <div key={e.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center">
                                    <div><p className="font-bold text-gray-800">{e.desc}</p><p className="text-xs text-gray-500">{e.date} &bull; {e.category}</p></div>
                                    <span className="font-mono font-bold text-red-600">-${e.amount}</span>
                                </div>
                            )) :
                            mileage.map(m => (
                                <div key={m.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-xs text-gray-500">{m.date}</span>
                                        <span className="font-bold text-blue-600">{m.miles} mi</span>
                                    </div>
                                    <div className="text-sm text-gray-800 flex items-center gap-2">
                                        <span className="truncate max-w-[40%]">{m.start}</span>
                                        <i className="fas fa-arrow-right text-xs text-gray-400"></i>
                                        <span className="truncate max-w-[40%]">{m.end}</span>
                                    </div>
                                </div>
                            ))
                        }
                    </div>
                </div>
            );
        };

        const TrainerModule = () => {
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || '');
            const [hasKey, setHasKey] = useState(!!apiKey);
            const [selectedStateKey, setSelectedStateKey] = useState('OH');
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [mode, setMode] = useState('study'); 
            const [currentModule, setCurrentModule] = useState(0); 
            const [showCertModal, setShowCertModal] = useState(false);
            const [certType, setCertType] = useState('ack');
            const messagesEndRef = useRef(null);

            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

            const handleModeSwitch = (newMode) => {
                setMode(newMode);
                let msg = "";
                if (newMode === 'study') msg = "ðŸ“š **Study Mode Active.**\n\nAsk me any factual question about state laws, fees, or ID requirements. I'm here to help!";
                if (newMode === 'course') msg = "ðŸŽ“ **Course Mode Active.**\n\nI will guide you through the 7-module curriculum step-by-step. Click 'Start Module 1' below when ready.";
                if (newMode === 'scenario') msg = "ðŸŽ­ **Roleplay Mode Active.**\n\nI am now acting as your client. I might try to trick you with an illegal request. Type 'Hi' to start the simulation.";
                setMessages(prev => [...prev, { role: 'assistant', content: msg }]);
            };

            const startTraining = () => {
                if(apiKey.trim()) {
                    localStorage.setItem('gemini_api_key', apiKey);
                    setHasKey(true);
                    const stateName = STATE_DATABASE[selectedStateKey].state;
                    setMessages([{ role: 'assistant', content: `**NotaryPro Mentor Online.**\n\nJurisdiction Locked: **${stateName}**.\n\nPlease select a mode above to begin your session.` }]);
                }
            };

            const sendMessage = async (overrideInput = null) => {
                const textToSend = overrideInput || input;
                if (!textToSend) return;
                
                const newMessages = [...messages, { role: 'user', content: textToSend }];
                setMessages(newMessages);
                setInput('');
                setLoading(true);

                const stateData = STATE_DATABASE[selectedStateKey];
                
                let courseContext = "";
                if (mode === 'course' && currentModule > 0) {
                    const mod = COURSE_MODULES[currentModule-1];
                    courseContext = `TEACHING MODULE ${mod.id}: ${mod.title}. TOPIC: ${mod.topic}. Explain concept using Markdown, then QUIZ user.`;
                }

                const SYSTEM_PROMPT = `
                    ${PERSONA}
                    STATE DATA (${stateData.state}): ${JSON.stringify(stateData)}
                    ${courseContext}
                    MODE: ${mode.toUpperCase()}
                    RULES: Use Markdown. Bold key terms. In Scenario mode, guide user gently if they make a mistake. Keep concise.
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: SYSTEM_PROMPT }] }, ...newMessages.map(m => ({ role: m.role === 'assistant' ? 'model' : 'user', parts: [{ text: m.content }] }))] })
                    });
                    const data = await response.json();
                    const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Error: No response.";
                    setMessages([...newMessages, { role: 'assistant', content: aiText }]);
                } catch (error) {
                    setMessages([...newMessages, { role: 'assistant', content: "API Error: " + error.message }]);
                } finally {
                    setLoading(false);
                }
            };

            // Cert Modal Logic
            const getCertText = (type) => {
                const stateData = STATE_DATABASE[selectedStateKey];
                const text = type === 'ack' ? stateData.certificates.acknowledgment_text : stateData.certificates.jurat_text;
                if (!text || text === "null" || text === "Not specified") return "Specific certificate wording is not available in the current database for this state.";
                return text;
            };

            if (!hasKey) return (
                <div className="h-full flex flex-col items-center justify-center p-6 text-center">
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 max-w-md w-full">
                        <i className="fas fa-robot text-5xl text-blue-600 mb-4"></i>
                        <h2 className="text-xl font-bold mb-2">Activate AI Trainer</h2>
                        <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} placeholder="API Key" className="w-full p-3 border rounded-xl mb-4" />
                        <button onClick={startTraining} className="w-full bg-blue-600 text-white p-3 rounded-xl font-bold">Start</button>
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col h-full bg-white relative pb-20 md:pb-0">
                    <div className="border-b px-4 py-3 flex justify-between items-center bg-gray-50">
                        <select value={selectedStateKey} onChange={e => { setSelectedStateKey(e.target.value); setMessages([]); }} className="bg-white border text-sm rounded-lg p-2 font-semibold text-gray-700">
                            {Object.entries(STATE_DATABASE).map(([k,v]) => <option key={k} value={k}>{v.state}</option>)}
                        </select>
                        <div className="flex gap-2">
                            <button onClick={() => handleModeSwitch('study')} className={`px-3 py-1 rounded text-xs font-bold ${mode === 'study' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}`}>Study</button>
                            <button onClick={() => handleModeSwitch('course')} className={`px-3 py-1 rounded text-xs font-bold ${mode === 'course' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}`}>Course</button>
                            <button onClick={() => handleModeSwitch('scenario')} className={`px-3 py-1 rounded text-xs font-bold ${mode === 'scenario' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}`}>Sim</button>
                            <button onClick={() => setShowCertModal(true)} className="px-3 py-1 rounded text-xs font-bold bg-yellow-400 text-white ml-2"><i className="fas fa-file-contract"></i></button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 pb-4">
                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] p-4 rounded-2xl text-sm ${m.role === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-800'}`}>
                                    <div className="prose prose-sm max-w-none" dangerouslySetInnerHTML={{ __html: DOMPurify.sanitize(marked.parse(m.content)) }} />
                                </div>
                            </div>
                        ))}
                        {loading && <div className="typing-indicator ml-4"><span></span><span></span><span></span></div>}
                        <div ref={messagesEndRef} />
                    </div>
                    
                    {/* Disclaimer Footer in Chat Area */}
                    <div className="px-4 pb-2">
                         <p className="text-[10px] text-gray-400 text-center italic">AI may make mistakes. Always check your official state handbook.</p>
                    </div>

                    <div className="p-4 border-t bg-white flex gap-2 pb-24 md:pb-4">
                        {mode === 'course' && (
                            <button onClick={() => { setCurrentModule(p => p+1); sendMessage(`Start Module ${currentModule+1}`); }} className="bg-green-600 text-white px-4 rounded-xl text-xs font-bold shadow-md hover:bg-green-700 transition-colors">Next</button>
                        )}
                        <input value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && sendMessage()} placeholder="Message AI..." className="flex-1 p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        <button onClick={() => sendMessage()} className="bg-blue-600 text-white w-12 rounded-xl shadow-md hover:bg-blue-700 transition-colors"><i className="fas fa-paper-plane"></i></button>
                    </div>

                    {/* CERT MODAL */}
                    {showCertModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                                <div className="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                                    <h3 className="font-bold text-lg text-gray-800">Certificates: {STATE_DATABASE[selectedStateKey].state}</h3>
                                    <button onClick={() => setShowCertModal(false)} className="text-gray-500 hover:text-gray-800"><i className="fas fa-times text-xl"></i></button>
                                </div>
                                <div className="p-2 bg-white flex gap-2 border-b">
                                    <button onClick={() => setCertType('ack')} className={`flex-1 py-2 px-3 rounded text-sm font-medium ${certType === 'ack' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'}`}>Acknowledgment</button>
                                    <button onClick={() => setCertType('jurat')} className={`flex-1 py-2 px-3 rounded text-sm font-medium ${certType === 'jurat' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'}`}>Jurat</button>
                                </div>
                                <div className="p-6 overflow-y-auto bg-gray-100 flex-1">
                                    <div className="paper-doc p-8 text-sm sm:text-base leading-relaxed text-gray-800 relative">
                                        <div className="absolute inset-0 flex items-center justify-center opacity-[0.03] pointer-events-none"><i className="fas fa-stamp text-9xl"></i></div>
                                        <h4 className="font-bold text-center mb-6 uppercase underline tracking-wider">{certType === 'ack' ? 'Certificate of Acknowledgment' : 'Jurat / Verification on Oath'}</h4>
                                        <div className="whitespace-pre-wrap">{getCertText(certType)}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(() => JSON.parse(localStorage.getItem('notary_user_profile') || 'null'));
            const [currentView, setCurrentView] = useState('dashboard');
            const [appointments, setAppointments] = useState([]);
            const [editingAppt, setEditingAppt] = useState(null);
            
            const [credentials, setCredentials] = useState([]);
            
            const [showMobileMenu, setShowMobileMenu] = useState(false);

             useEffect(() => {
                const init = async () => {
                    // Check auth state on load
                     if (window.firebase && window.firebase.auth) {
                         window.firebase.auth().onAuthStateChanged(async (u) => {
                             if (u) {
                                 setUser({ id: u.uid, name: u.email.split('@')[0], email: u.email });
                                 setAppointments(await DataManager.get('notary_appointments'));
                                 setCredentials(await DataManager.get('notary_credentials'));
                             } else {
                                 setUser(null);
                             }
                         });
                     } else {
                         // Fallback Load
                         setAppointments(await DataManager.get('notary_appointments'));
                         setCredentials(await DataManager.get('notary_credentials'));
                     }
                };
                init();
            }, []);


            if (!user) {
                return <AuthScreen onAuth={(profile) => {
                    localStorage.setItem('notary_user_profile', JSON.stringify(profile));
                    setUser(profile);
                }} />;
            }

            const handleLogout = async () => {
                if (window.firebase && window.firebase.auth) {
                     await window.firebase.auth().signOut();
                }
                localStorage.removeItem('notary_user_profile');
                setUser(null);
            };

            const handleSaveAppt = async (appt) => {
                await DataManager.save('notary_appointments', appt);
                setAppointments(await DataManager.get('notary_appointments'));
                setCurrentView('schedule');
                setEditingAppt(null);
            };
            
            const handleRefresh = async () => {
                 setAppointments(await DataManager.get('notary_appointments'));
                 setCredentials(await DataManager.get('notary_credentials')); // Refresh creds for dashboard
            };

            const renderView = () => {
                switch(currentView) {
                    case 'dashboard': return <Dashboard appointments={appointments} credentials={credentials} setView={setCurrentView} />;
                    case 'schedule': return <Schedule appointments={appointments} setView={setCurrentView} onEdit={(a) => { setEditingAppt(a); setCurrentView('add_appointment'); }} />;
                    case 'add_appointment': return <AppointmentForm onSave={handleSaveAppt} onCancel={() => setCurrentView('schedule')} initialData={editingAppt} />;
                    case 'journal': return <Journal onUpdate={handleRefresh} />;
                    case 'finances': return <Finances />;
                    case 'credentials': return <Credentials onUpdate={handleRefresh} />; // New Credentials Module
                    case 'trainer': return <TrainerModule />;
                    default: return <div className="p-10 text-center text-gray-400">Module Coming Soon</div>;
                }
            };

            return (
                <div className="flex h-screen overflow-hidden">
                    <Sidebar currentView={currentView} setView={setCurrentView} isOpen={showMobileMenu} onClose={() => setShowMobileMenu(false)} onLogout={handleLogout} userName={user.name} />
                    <main className="flex-1 flex flex-col h-screen md:ml-64 relative bg-gray-50">
                        <Header title={currentView === 'trainer' ? 'AI Training Center' : currentView.charAt(0).toUpperCase() + currentView.slice(1)} />
                        <div className="flex-1 overflow-y-auto relative">{renderView()}</div>
                        <MobileNav currentView={currentView} setView={setCurrentView} onOpenMenu={() => setShowMobileMenu(true)} />
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
