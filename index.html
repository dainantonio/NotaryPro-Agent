<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NotaryOS</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“œ</text></svg>">

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Merriweather:wght@300;400;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

    <!-- Utilities -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- FIREBASE SDK (COMPAT MODE) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA32kVbmGOcY_CdDymrom9rWVzyXTj3so0",
            authDomain: "notaryos-67cd2.firebaseapp.com",
            projectId: "notaryos-67cd2",
            storageBucket: "notaryos-67cd2.firebasestorage.app",
            messagingSenderId: "660325303334",
            appId: "1:660325303334:web:bb0f062fd4da8c7fca12e7"
        };
        const STRIPE_PAYMENT_LINK = "";
        const STRIPE_BILLING_PORTAL_LINK = "";
        const TRIAL_DAYS = 14;

        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase Connected");
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }
    </script>

    <style>
        :root {
            --app-bg: #f8fafc;
            --surface-bg: #ffffff;
            --surface-muted: #eef2ff;
            --text-primary: #0f172a;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --accent-color: #4f46e5;
            --accent-hover: #4338ca;
            --accent-soft: #e0e7ff;
        }

        body { font-family: 'Merriweather', serif; background-color: var(--app-bg); color: var(--text-primary); transition: background-color .25s ease, color .25s ease; }
        h1, h2, h3, h4, h5, h6, button, .font-sans { font-family: 'Poppins', sans-serif; }

        .theme-app-bg { background-color: var(--app-bg) !important; }
        .theme-surface { background-color: var(--surface-bg) !important; }
        .theme-surface-muted { background-color: var(--surface-muted) !important; }
        .theme-text { color: var(--text-primary) !important; }
        .theme-text-muted { color: var(--text-muted) !important; }
        .theme-border { border-color: var(--border-color) !important; }
        .theme-accent-btn { background-color: var(--accent-color) !important; color: #fff !important; border: 1px solid transparent; }
        .theme-accent-btn:hover { background-color: var(--accent-hover) !important; }
        .theme-pill { background-color: var(--accent-soft) !important; color: var(--accent-color) !important; border-color: var(--accent-color) !important; }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        .status-scheduled { background-color: #e0f2fe; color: #0369a1; }
        .status-completed { background-color: #dcfce7; color: #15803d; }
        .status-paid { background-color: #166534; color: white; }
        .status-cancelled { background-color: #fee2e2; color: #b91c1c; }

        .typing-indicator span { animation: blink 1.4s infinite both; height: 6px; width: 6px; background-color: #3b82f6; border-radius: 50%; display: inline-block; margin: 0 2px; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }

        .paper-doc { background-color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e5e7eb; font-family: 'Courier Prime', monospace; }
        .auth-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }
        .empty-state-dashed { background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%23CBD5E1FF' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e"); }
        /* FIXED: Moved bottom up to avoid overlapping with bottom nav on some mobile devices */
        .fab-ai { position: fixed; bottom: 90px; right: 20px; z-index: 50; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: grid; place-items: center; }
        @media (min-width: 768px) { .fab-ai { bottom: 30px; } }

        /* Toast Animation */
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }

        /* Dark Mode Landing Page Background */
        .landing-bg {
            background-color: #0f172a; /* Dark Slate 900 */
            background-image: radial-gradient(circle at 100% 0%, #1e293b 0%, #0f172a 50%);
        }

        /* Visual elements for landing page */
        .visual-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, border-color 0.3s ease;
        }
        .visual-card:hover {
            transform: translateY(-5px);
            border-color: rgba(59, 130, 246, 0.5);
        }

        /* AI Hero Glow */
        .ai-glow-box {
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.3), 0 0 60px rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(124, 58, 237, 0.3);
        }

        /* Phone Mockup */
        .phone-mockup {
            border: 8px solid #333;
            border-radius: 30px;
            overflow: hidden;
            position: relative;
            background: #fff;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .phone-notch {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40%;
            height: 20px;
            background: #333;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            z-index: 10;
        }

        .phone-stack {
            position: relative;
            min-height: 36rem;
            display: flex;
            align-items: center;
            justify-content: center;
            isolation: isolate;
        }

        .phone-stack::before,
        .phone-stack::after {
            content: '';
            position: absolute;
            width: 16rem;
            height: 16rem;
            border-radius: 9999px;
            filter: blur(45px);
            opacity: 0.45;
            z-index: 0;
        }

        .phone-stack::before {
            background: rgba(248, 113, 113, 0.7);
            top: 8%;
            left: 12%;
        }

        .phone-stack::after {
            background: rgba(74, 222, 128, 0.65);
            bottom: 10%;
            right: 8%;
        }

        .phone-stack-card {
            position: relative;
            z-index: 2;
            transition: transform 0.35s ease;
        }

        .phone-stack-card.left {
            transform: rotate(-14deg) translate(12%, 4%);
        }

        .phone-stack-card.right {
            transform: rotate(11deg) translate(-10%, -3%);
            z-index: 1;
        }

        .phone-stack-card:hover {
            transform: translateY(-8px) scale(1.01);
        }

        .phone-stack-card.left:hover {
            transform: rotate(-12deg) translate(12%, -1%) scale(1.01);
        }

        .phone-stack-card.right:hover {
            transform: rotate(10deg) translate(-10%, -7%) scale(1.01);
        }

        @media (max-width: 767px) {
            .phone-stack {
                min-height: auto;
                flex-direction: column;
                gap: 1.5rem;
                padding: 1.5rem 0.5rem;
            }

            .phone-stack::before {
                top: 4%;
                left: 8%;
            }

            .phone-stack::after {
                bottom: 4%;
                right: 8%;
            }

            .phone-stack-card.left,
            .phone-stack-card.right,
            .phone-stack-card.left:hover,
            .phone-stack-card.right:hover {
                transform: none;
            }
        }

        /* Notary Gold Accent */
        .text-notary-gold { color: #fbbf24; }
        .bg-notary-gold { background-color: #fbbf24; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        class AppErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, errorMsg: '' };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, errorMsg: error?.message || 'Unknown UI error' };
            }

            componentDidCatch(error, errorInfo) {
                console.error('NotaryOS runtime crash:', error, errorInfo);
            }

            handleReset = () => {
                try {
                    localStorage.removeItem('notary_user_profile');
                    localStorage.removeItem('notary_appointments');
                    localStorage.removeItem('notary_clients');
                    localStorage.removeItem('notary_credentials');
                    localStorage.removeItem('notary_journal');
                    localStorage.removeItem('notary_team');
                    localStorage.removeItem('notary_assignments');
                    localStorage.removeItem('notary_esignatures');
                    localStorage.removeItem('notary_active_trip');
                    localStorage.removeItem('notary_onboarded');
                    localStorage.removeItem('notary_tour_completed');
                } catch (e) {
                    console.error('Reset failed', e);
                }
                window.location.reload();
            };

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen bg-slate-50 flex items-center justify-center p-6 font-sans">
                            <div className="max-w-md w-full bg-white border border-red-100 rounded-2xl shadow-lg p-6 text-center">
                                <div className="w-14 h-14 mx-auto mb-3 rounded-full bg-red-50 text-red-600 grid place-items-center text-2xl"><i className="fas fa-triangle-exclamation"></i></div>
                                <h2 className="text-xl font-bold text-slate-800 mb-2">App recovered from a crash</h2>
                                <p className="text-sm text-slate-500 mb-4">We detected unstable local data or runtime state. You can reset local app data and reopen a stable session.</p>
                                <p className="text-xs text-slate-400 mb-4">Error: {this.state.errorMsg}</p>
                                <button onClick={this.handleReset} className="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold">Reset to Stable Mode</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- TOAST CONTEXT ---
        window.addToastFn = null;
        const showToast = (msg, type = 'success') => { if (window.addToastFn) window.addToastFn(msg, type); };

        const ToastContainer = () => {
            const [toasts, setToasts] = useState([]);

            useEffect(() => {
                window.addToastFn = (msg, type) => {
                    const id = Date.now();
                    setToasts(prev => [...prev, { id, msg, type }]);
                    setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3000);
                };
            }, []);

            return (
                <div className="fixed top-4 right-4 z-50 flex flex-col gap-2 pointer-events-none">
                    {toasts.map(t => (
                        <div key={t.id} className={`toast-enter px-4 py-3 rounded-xl shadow-lg flex items-center gap-2 text-white font-medium pointer-events-auto ${t.type === 'success' ? 'bg-green-600' : 'bg-red-600'}`}>
                            <i className={`fas ${t.type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}`}></i>
                            {t.msg}
                        </div>
                    ))}
                </div>
            );
        };

        // --- HELPER FUNCTIONS ---
        // Added simple feature access check to prevent undefined errors
        const hasFeatureAccess = (user, feature) => {
            if (!user) return false;
            const plan = user.plan || 'free';
            const role = user.role || 'solo';

            if (role === 'admin') return true;
            if (feature === 'agency') return plan === 'team' || role === 'agency';
            if (feature === 'pro') return plan === 'pro' || plan === 'team';

            return true;
        };

        // Added mock encryption/decryption to prevent ReferenceErrors in Journal
        const encryptPayload = (str) => {
            try { return btoa(str); } catch (e) { return str; }
        };
        const decryptPayload = (str) => {
            try { return atob(str); } catch (e) { return str; }
        };

        const safeStorageGet = (key, fallback = null) => {
            try {
                const value = localStorage.getItem(key);
                return value === null ? fallback : value;
            } catch (e) {
                return fallback;
            }
        };

        const safeStorageSet = (key, value) => {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (e) {
                return false;
            }
        };

        const safeParse = (value, fallback) => {
            if (value === null || value === undefined) return fallback;
            try {
                return JSON.parse(value);
            } catch (err) {
                return fallback;
            }
        };

        // --- DATA MANAGER ---
        const DataManager = {
            isCloud: () => typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser !== null,
            get: async (collectionName) => {
                if (DataManager.isCloud()) {
                    try {
                        const uid = firebase.auth().currentUser.uid;
                        const snapshot = await firebase.firestore().collection(collectionName).where("userId", "==", uid).get();
                        if (snapshot.empty) return DataManager.getLocal(collectionName);
                        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    } catch (e) { return DataManager.getLocal(collectionName); }
                } else { return DataManager.getLocal(collectionName); }
            },
            save: async (collectionName, item) => {
                const localData = DataManager.saveLocal(collectionName, item);
                if (DataManager.isCloud()) {
                    try {
                        const uid = firebase.auth().currentUser.uid;
                        const itemWithUser = { ...item, userId: uid };
                        const docId = item.id || Date.now().toString();
                        await firebase.firestore().collection(collectionName).doc(docId).set(itemWithUser);
                        const snapshot = await firebase.firestore().collection(collectionName).where("userId", "==", uid).get();
                        return { success: true, data: snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })) };
                    } catch (e) { return { success: false, data: localData }; }
                }
                return { success: false, data: localData };
            },
            saveLocal: (key, item) => {
                const list = safeParse(localStorage.getItem(key), []);
                const index = list.findIndex(i => i.id === item.id);
                if (index >= 0) list[index] = item; else list.push(item);
                localStorage.setItem(key, JSON.stringify(list));
                return list;
            },
            getLocal: (key) => safeParse(localStorage.getItem(key), []),
             delete: async (collectionName, id) => {
                const localData = DataManager.deleteLocal(collectionName, id);
                if (DataManager.isCloud()) { try { await firebase.firestore().collection(collectionName).doc(id).delete(); } catch(e) {} }
                return localData;
            },
            deleteLocal: (key, id) => {
                const list = safeParse(localStorage.getItem(key), []);
                const newList = list.filter(i => i.id !== id);
                localStorage.setItem(key, JSON.stringify(newList));
                return newList;
            }
        };

        // --- PDF GENERATORS ---
        const PDFGenerator = {
            createInvoice: (appt, user) => {
                if (!window.jspdf) { showToast("PDF Library Loading...", 'error'); return; }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const primaryColor = [37, 99, 235];
                const businessName = user.businessName || user.name || "Notary Public";
                doc.setFontSize(22); doc.setTextColor(...primaryColor); doc.text("INVOICE", 160, 20);
                doc.setFontSize(10); doc.setTextColor(100); doc.text(`ID: ${appt.id.substring(0,8)}`, 160, 26); doc.text(`Date: ${new Date().toLocaleDateString()}`, 160, 31);
                doc.setFontSize(12); doc.setTextColor(0); doc.text(businessName.toUpperCase(), 20, 20);
                doc.setFontSize(10); doc.setTextColor(100); doc.text(user.phone || "", 20, 26); doc.text(user.email || "", 20, 31);
                if(user.address) doc.text(user.address, 20, 36);
                doc.setTextColor(0); doc.text("BILL TO:", 20, 55);
                doc.setFontSize(14); doc.text(appt.clientName, 20, 62);
                doc.setFontSize(10); doc.text(appt.location, 20, 68);
                doc.autoTable({ startY: 80, head: [['Description', 'Date', 'Amount']], body: [[appt.type || 'Notary Service', appt.date, `$${appt.fee}`]], theme: 'grid', headStyles: { fillColor: primaryColor } });
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(12); doc.text(`Total Due: $${appt.fee}`, 160, finalY, { align: 'right' });

                // --- BUSINESS LOGO/SEAL IF UPLOADED ---
                if(user.logoUrl) {
                    try {
                        doc.addImage(user.logoUrl, 'PNG', 20, 5, 30, 30);
                    } catch(e) { console.log("Image error", e); }
                }

                doc.save(`invoice_${appt.clientName}.pdf`);
                showToast("Invoice Downloaded");
            },
            createSignedAgreement: ({ clientName, clientEmail, signature, signedAt, title, body }) => {
                if (!window.jspdf) { showToast("PDF Library Loading...", 'error'); return; }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(18); doc.text(title, 14, 20);
                doc.setFontSize(10); doc.text(`Client: ${clientName}`, 14, 28);
                doc.text(`Email: ${clientEmail}`, 14, 34);
                doc.text(`Signed: ${new Date(signedAt).toLocaleString()}`, 14, 40);
                doc.setFontSize(11);
                doc.text(body, 14, 52, { maxWidth: 180 });
                doc.setFontSize(12);
                doc.text(`Signature: ${signature}`, 14, 120);
                doc.save(`signed_${title.replace(/\s+/g, '_').toLowerCase()}.pdf`);
                showToast("Signed Document Downloaded");
            },
            createReport: (title, columns, data, filename) => {
                if (!window.jspdf) { showToast("PDF Library Loading...", 'error'); return; }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(18); doc.text(title, 14, 22);
                doc.setFontSize(10); doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 28);
                doc.autoTable({ startY: 35, head: [columns], body: data, theme: 'striped' });
                doc.save(filename);
                showToast("Report Downloaded");
            }
        };

        const STATE_DATABASE = {
            "AL": { "state": "Alabama", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Not specified" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "AK": { "state": "Alaska", "fees": { "acknowledgment": "$25.00", "jurat": "$25.00", "oath": "$25.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Not specified" }, "red_flags": ["Conflict of Interest"], "specialized": { "loan_signing": "Allowed", "apostille": "Lt. Governor", "marriage": "No" }},
            "AZ": { "state": "Arizona", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "1 or 2 allowed", "expired_id_rule": "Not allowed" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "AR": { "state": "Arkansas", "fees": { "acknowledgment": "Reasonable", "jurat": "Reasonable", "oath": "Reasonable" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Not specified" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "CA": { "state": "California", "fees": { "acknowledgment": "$15.00", "jurat": "$15.00", "oath": "$15.00" }, "id_requirements": { "credible_witnesses": "1 known OR 2 with ID", "expired_id_rule": "5 years" }, "red_flags": ["Thumbprint mandatory for Deeds/POA"], "specialized": { "loan_signing": "Background Check Required", "apostille": "Secretary of State", "marriage": "No" }},
            "CO": { "state": "Colorado", "fees": { "acknowledgment": "$15.00", "jurat": "$15.00", "oath": "$15.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "1 year" }, "red_flags": ["No Seal Embosser"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "CT": { "state": "Connecticut", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["Attorney State (Restriction)"], "specialized": { "loan_signing": "ATTORNEY STATE (Witness Only)", "apostille": "Secretary of State", "marriage": "No" }},
            "DE": { "state": "Delaware", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["Attorney State"], "specialized": { "loan_signing": "ATTORNEY STATE", "apostille": "Secretary of State", "marriage": "No" }},
            "DC": { "state": "District of Columbia", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Office of Notary", "marriage": "No" }},
            "FL": { "state": "Florida", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "1 known OR 2 with ID", "expired_id_rule": "5 years" }, "red_flags": ["No Family"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "YES ($30 Fee)" }},
            "GA": { "state": "Georgia", "fees": { "acknowledgment": "$2.00", "jurat": "$2.00", "oath": "$2.00" }, "id_requirements": { "credible_witnesses": "Not specified", "expired_id_rule": "Not specified" }, "red_flags": ["Attorney State"], "specialized": { "loan_signing": "ATTORNEY STATE", "apostille": "GSCCCA", "marriage": "No" }},
            "HI": { "state": "Hawaii", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Lt. Governor", "marriage": "No" }},
            "ID": { "state": "Idaho", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "IL": { "state": "Illinois", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["Cook County Record"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "IN": { "state": "Indiana", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["Title Producer License for LSA"], "specialized": { "loan_signing": "REQUIRES TPL LICENSE", "apostille": "Secretary of State", "marriage": "No" }},
            "IA": { "state": "Iowa", "fees": { "acknowledgment": "Reasonable", "jurat": "Reasonable", "oath": "Reasonable" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "KS": { "state": "Kansas", "fees": { "acknowledgment": "Reasonable", "jurat": "Reasonable", "oath": "Reasonable" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "KY": { "state": "Kentucky", "fees": { "acknowledgment": "Not set", "jurat": "Not set", "oath": "Not set" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "LA": { "state": "Louisiana", "fees": { "acknowledgment": "Not set", "jurat": "Not set", "oath": "Not set" }, "id_requirements": { "credible_witnesses": "2 witnesses", "expired_id_rule": "Current" }, "red_flags": ["Civil Law Notary"], "specialized": { "loan_signing": "Civil Law Notary Exam Required", "apostille": "Secretary of State", "marriage": "No" }},
            "ME": { "state": "Maine", "fees": { "acknowledgment": "Reasonable", "jurat": "Reasonable", "oath": "Reasonable" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "YES" }},
            "MD": { "state": "Maryland", "fees": { "acknowledgment": "$4.00", "jurat": "$4.00", "oath": "$4.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["TIP License Required"], "specialized": { "loan_signing": "REQUIRES TIP LICENSE", "apostille": "Secretary of State", "marriage": "No" }},
            "MA": { "state": "Massachusetts", "fees": { "acknowledgment": "Not set", "jurat": "Not set", "oath": "Not set" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["Attorney State"], "specialized": { "loan_signing": "ATTORNEY STATE", "apostille": "Secretary of the Commonwealth", "marriage": "No" }},
            "MI": { "state": "Michigan", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "MN": { "state": "Minnesota", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["Closing Agent License"], "specialized": { "loan_signing": "REQUIRES CLOSING LICENSE", "apostille": "Secretary of State", "marriage": "No" }},
            "MS": { "state": "Mississippi", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "5 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "MO": { "state": "Missouri", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "MT": { "state": "Montana", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "YES" }},
            "NE": { "state": "Nebraska", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$2.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "NV": { "state": "Nevada", "fees": { "acknowledgment": "$15.00", "jurat": "$15.00", "oath": "$7.50" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Notary Discretion" }, "red_flags": ["Escrow License for LSA"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "YES (Specific Cert Required)" }},
            "NH": { "state": "New Hampshire", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Not specified" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "NJ": { "state": "New Jersey", "fees": { "acknowledgment": "$2.50", "jurat": "$2.50", "oath": "$2.50" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Treasury Division", "marriage": "No" }},
            "NM": { "state": "New Mexico", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "1 year" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "NY": { "state": "New York", "fees": { "acknowledgment": "$2.00", "jurat": "$2.00", "oath": "$2.00" }, "id_requirements": { "credible_witnesses": "Not specified", "expired_id_rule": "Not specified" }, "red_flags": ["No Initials in Name"], "specialized": { "loan_signing": "Allowed", "apostille": "Dept of State", "marriage": "No" }},
            "NC": { "state": "North Carolina", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "ND": { "state": "North Dakota", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Valid" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "OH": { "state": "Ohio", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Not specified" }, "red_flags": ["Conflict of Interest"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "OK": { "state": "Oklahoma", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "OR": { "state": "Oregon", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "PA": { "state": "Pennsylvania", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of the Commonwealth", "marriage": "No" }},
            "RI": { "state": "Rhode Island", "fees": { "acknowledgment": "$25.00", "jurat": "$25.00", "oath": "$25.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "SC": { "state": "South Carolina", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["Attorney Supervision"], "specialized": { "loan_signing": "ATTORNEY STATE", "apostille": "Secretary of State", "marriage": "YES" }},
            "SD": { "state": "South Dakota", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "TN": { "state": "Tennessee", "fees": { "acknowledgment": "$0", "jurat": "$0", "oath": "$0" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["Reasonable Fees"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "YES" }},
            "TX": { "state": "Texas", "fees": { "acknowledgment": "$6.00", "jurat": "$6.00", "oath": "$6.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "UT": { "state": "Utah", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Valid" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Lt. Governor", "marriage": "No" }},
            "VT": { "state": "Vermont", "fees": { "acknowledgment": "No limit", "jurat": "No limit", "oath": "No limit" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["Attorney Supervision"], "specialized": { "loan_signing": "ATTORNEY STATE", "apostille": "Secretary of State", "marriage": "No" }},
            "VA": { "state": "Virginia", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "Current" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of the Commonwealth", "marriage": "No" }},
            "WA": { "state": "Washington", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "WV": { "state": "West Virginia", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["Attorney State"], "specialized": { "loan_signing": "ATTORNEY STATE", "apostille": "Secretary of State", "marriage": "No" }},
            "WI": { "state": "Wisconsin", "fees": { "acknowledgment": "$5.00", "jurat": "$5.00", "oath": "$5.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "WY": { "state": "Wyoming", "fees": { "acknowledgment": "$10.00", "jurat": "$10.00", "oath": "$10.00" }, "id_requirements": { "credible_witnesses": "Allowed", "expired_id_rule": "3 years" }, "red_flags": ["No Notarios"], "specialized": { "loan_signing": "Allowed", "apostille": "Secretary of State", "marriage": "No" }},
            "certificates": { "acknowledgment_text": "State of [State]...", "jurat_text": "Subscribed and sworn..." }
        };
        const COURSE_MODULES = [ { id: 1, title: "Authority", topic: "Commissioning authority." } ];
        const PERSONA = `ROLE: NOTARY MENTOR. TONE: Helpful.`;

        // --- COMPONENTS ---

        // 1. Modals & Helpers
        const TermsModal = ({ onClose }) => (
            <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 backdrop-blur-sm z-[100]">
                <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 animate-fade-in font-sans">
                    <div className="flex justify-between items-center mb-4 border-b pb-4">
                        <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2"><i className="fas fa-balance-scale text-blue-600"></i> Terms of Service</h2>
                        <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><i className="fas fa-times"></i></button>
                    </div>
                    <div className="text-sm text-gray-600 mb-6 space-y-3 max-h-[60vh] overflow-y-auto">
                        <p className="font-bold">Last Updated: February 2026</p>
                        <p><strong>1. Acceptance of Terms:</strong> By accessing and using NotaryOS, you accept and agree to be bound by the terms and provision of this agreement.</p>
                        <p><strong>2. Not Legal Advice:</strong> NotaryOS is a management and educational tool. The AI Trainer provides information based on general data. This tool does not constitute legal advice. Always verify with your official state handbook.</p>
                        <p><strong>3. User Responsibility:</strong> You are responsible for all notarial acts performed. NotaryOS is not liable for any errors, omissions, or legal actions resulting from your use of this software.</p>
                        <p><strong>4. Data Privacy:</strong> In this version, business data is stored locally on your device unless Cloud Sync is explicitly enabled.</p>
                    </div>
                    <button onClick={onClose} className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition-colors">I Understand & Agree</button>
                </div>
            </div>
        );


        const LEGAL_DOCS = {
            privacy: {
                title: 'Privacy Policy',
                icon: 'fa-user-shield',
                updated: 'February 2026',
                sections: [
                    'We collect account, usage, and business record data only to operate NotaryOS features you enable.',
                    'Core records may be stored locally in your browser for MVP workflows unless cloud sync is enabled and authenticated.',
                    'AI prompts are sent to the configured model provider only when AI features are used.',
                    'You may export backups at any time and request account-data deletion through support.'
                ]
            },
            dataProcessing: {
                title: 'Data Processing',
                icon: 'fa-database',
                updated: 'February 2026',
                sections: [
                    'NotaryOS acts as a processor for business records you create in the platform.',
                    'Data is scoped to authenticated user accounts when cloud mode is active.',
                    'Retention follows your active account lifecycle and deletion/export actions.',
                    'Subprocessors are limited to infrastructure and AI providers required for requested features.'
                ]
            },
            security: {
                title: 'Security Standards',
                icon: 'fa-shield-alt',
                updated: 'February 2026',
                sections: [
                    'We use authenticated access controls and account-scoped records for cloud collections.',
                    'Transport-level encryption is enforced for external API and provider requests.',
                    'Least-privilege design is applied across product features and data access patterns.',
                    'Users remain responsible for endpoint security on devices storing local records.'
                ]
            },
            compliance: {
                title: 'Compliance Center',
                icon: 'fa-balance-scale',
                updated: 'February 2026',
                sections: [
                    'NotaryOS supports 50-state notarial workflows with guided data capture and compliance prompts.',
                    'Content is educational and operational; it does not replace legal advice or state handbooks.',
                    'Teams should maintain jurisdiction-specific SOPs and annual legal review procedures.',
                    'Compliance artifacts can be exported for recordkeeping and internal audit processes.'
                ]
            },
            subscription: {
                title: 'Subscription Terms',
                icon: 'fa-credit-card',
                updated: 'February 2026',
                sections: [
                    'Plans renew on the billing interval selected at purchase until cancelled.',
                    'Upgrades apply immediately; downgrades take effect at the next billing period.',
                    'Feature access is plan-gated and may be limited after cancellation or failed payment.',
                    'Pricing and packaging updates will be announced before taking effect.'
                ]
            },
            acceptableUse: {
                title: 'Acceptable Use',
                icon: 'fa-gavel',
                updated: 'February 2026',
                sections: [
                    'Do not use NotaryOS for unlawful activity, fraud, identity abuse, or unauthorized data access.',
                    'You must not upload malicious code, attempt service disruption, or bypass plan restrictions.',
                    'Only store and process information you are authorized to handle.',
                    'Violations may result in account suspension or termination.'
                ]
            },
            cookie: {
                title: 'Cookie Policy',
                icon: 'fa-cookie-bite',
                updated: 'February 2026',
                sections: [
                    'Essential browser storage is used to keep sessions and product preferences functioning.',
                    'Analytics and marketing cookies are minimized in MVP mode and may expand with consent tooling.',
                    'You can clear local browser data at any time, which may remove saved offline records.',
                    'By continuing to use NotaryOS, you consent to required operational storage mechanisms.'
                ]
            }
        };

        const LegalDocModal = ({ doc, onClose }) => {
            const content = LEGAL_DOCS[doc];
            if (!content) return null;

            return (
                <div className="fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-6 animate-fade-in font-sans max-h-[85vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-4 border-b pb-4">
                            <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2"><i className={`fas ${content.icon} text-blue-600`}></i> {content.title}</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><i className="fas fa-times"></i></button>
                        </div>
                        <p className="text-xs text-gray-500 mb-4">Last Updated: {content.updated}</p>
                        <div className="text-sm text-gray-600 space-y-3">
                            {content.sections.map((item, idx) => (
                                <p key={idx}><strong>{idx + 1}.</strong> {item}</p>
                            ))}
                        </div>
                        <button onClick={onClose} className="w-full mt-6 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition-colors">Close</button>
                    </div>
                </div>
            );
        };

        const PricingModal = ({ onClose, onUpgrade }) => (

            <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 backdrop-blur-sm z-[100]">
                <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 text-center font-sans">
                    <h2 className="text-2xl font-bold mb-2">Upgrade to Pro</h2>
                    <p className="text-gray-500 mb-6">Unlock Unlimited AI, secure audit capture, payment processing, and client portal access.</p>
                    <div className="space-y-2 text-left text-sm text-gray-600 bg-gray-50 rounded-xl p-3 mb-4">
                        <p><i className="fas fa-check text-emerald-600 mr-2"></i>Pro: AI Trainer, Payments, Client Portal, Audit Capture</p>
                        <p><i className="fas fa-check text-indigo-600 mr-2"></i>Team: Agency mode with assignments & master calendar</p>
                    </div>
                    <button onClick={() => onUpgrade('pro')} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold mb-2">Get Pro - $19/mo</button>
                    <button onClick={() => onUpgrade('team')} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold mb-2">Get Team - $49/mo</button>
                    <button onClick={onClose} className="text-gray-400 text-sm">Close</button>
                </div>
            </div>
        );

        const SettingsModal = ({ user, onClose, onSave, onOpenBillingPortal, onUpgrade, onEnableAdminPreview }) => {
            const [data, setData] = useState(user || {});

            const handleLogoUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onloadend = () => setData({ ...data, logoUrl: reader.result });
                reader.readAsDataURL(file);
            };

            const handleExportData = () => {
                const exportData = {};
                const keys = [
                    'notary_user_profile', 'notary_clients', 'notary_appointments', 'notary_journal',
                    'notary_expenses', 'notary_mileage', 'notary_credentials', 'notary_team',
                    'notary_assignments', 'notary_esignatures', 'gemini_api_key',
                    'notary_onboarded', 'notary_tour_completed'
                ];
                keys.forEach(key => {
                    const value = localStorage.getItem(key);
                    if (value) exportData[key] = value;
                });
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `notaryos_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                showToast('Backup downloaded successfully');
            };

            const handleImportData = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        Object.keys(importedData).forEach(key => {
                            if (key.startsWith('notary_') || key === 'gemini_api_key') localStorage.setItem(key, importedData[key]);
                        });
                        showToast('Data restored! Reloading...');
                        setTimeout(() => window.location.reload(), 1500);
                    } catch (err) {
                        showToast('Failed to restore data. Invalid file.', 'error');
                    }
                };
                reader.readAsText(file);
            };

            const handleSave = (e) => {
                e.preventDefault();
                onSave(data);
                onClose();
                showToast('Profile Updated');
            };

            return (
                <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                    <div className="theme-surface rounded-2xl shadow-2xl border theme-border max-w-3xl w-full max-h-[92vh] overflow-y-auto font-sans">
                        <div className="p-6 border-b theme-border flex items-center justify-between">
                            <div>
                                <h3 className="text-2xl font-bold theme-text">Settings & Workspace</h3>
                                <p className="theme-text-muted text-sm">Manage profile, branding, AI setup, and backup controls.</p>
                            </div>
                            <button onClick={onClose} className="theme-text-muted"><i className="fas fa-times"></i></button>
                        </div>

                        <form onSubmit={handleSave} className="p-6 space-y-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold theme-text-muted uppercase mb-1">Your Name</label>
                                    <input className="w-full px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" value={data.name || ''} onChange={e => setData({ ...data, name: e.target.value })} />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold theme-text-muted uppercase mb-1">Business Name</label>
                                    <input className="w-full px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" value={data.businessName || ''} onChange={e => setData({ ...data, businessName: e.target.value })} />
                                </div>
                            </div>

                            <div className="theme-surface-muted border theme-border rounded-xl p-4">
                                <label className="block text-xs font-bold theme-text-muted uppercase mb-2">Branding (Logo / Seal)</label>
                                <div className="flex flex-wrap items-center gap-4">
                                    {data.logoUrl && <img src={data.logoUrl} alt="Logo Preview" className="w-12 h-12 object-contain border theme-border rounded" />}
                                    <input type="file" accept="image/*" onChange={handleLogoUpload} className="text-sm theme-text-muted" />
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-bold theme-text-muted uppercase mb-1">AI Coach API Key (Gemini)</label>
                                <input
                                    type="password"
                                    className="w-full px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text"
                                    value={data.geminiKey || localStorage.getItem('gemini_api_key') || ''}
                                    onChange={e => {
                                        setData({ ...data, geminiKey: e.target.value });
                                        localStorage.setItem('gemini_api_key', e.target.value);
                                    }}
                                    placeholder="Paste API key"
                                />
                            </div>

                            <div className="theme-surface-muted border theme-border rounded-xl p-4 space-y-3">
                                <p className="text-xs font-bold theme-text-muted uppercase">Billing & Subscription</p>
                                <div className="flex flex-wrap items-center justify-between gap-2">
                                    <p className="text-sm theme-text">Current plan: <span className="font-semibold uppercase">{(user?.plan || 'free')}</span></p>
                                    {user?.trialEndsAt && user?.plan === 'free' && (
                                        <p className="text-xs theme-text-muted">Trial ends {new Date(user.trialEndsAt).toLocaleDateString()}</p>
                                    )}
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    {user?.plan === 'free' && <button type="button" onClick={() => onUpgrade?.('pro')} className="px-3 py-2 rounded-lg theme-accent-btn text-sm font-semibold">Upgrade with Stripe</button>}
                                    <button type="button" onClick={onOpenBillingPortal} className="px-3 py-2 rounded-lg border theme-border theme-text text-sm"><i className="fas fa-credit-card mr-2"></i>Manage Billing</button>
                                </div>
                            </div>

                            <div className="theme-surface-muted border theme-border rounded-xl p-4 space-y-3">
                                <p className="text-xs font-bold theme-text-muted uppercase">Admin Preview</p>
                                <p className="text-sm theme-text-muted">Need to inspect paid and agency experiences? Enable local admin preview access.</p>
                                <button
                                    type="button"
                                    onClick={onEnableAdminPreview}
                                    disabled={user?.role === 'admin'}
                                    className="px-3 py-2 rounded-lg border theme-border theme-text text-sm disabled:opacity-60 disabled:cursor-not-allowed"
                                >
                                    {user?.role === 'admin' ? 'Admin Access Enabled' : 'Enable Admin Access'}
                                </button>
                            </div>

                            <div className="theme-surface-muted border theme-border rounded-xl p-4 space-y-3">
                                <p className="text-xs font-bold theme-text-muted uppercase">Data Management</p>
                                <div className="flex flex-wrap gap-2">
                                    <button type="button" onClick={handleExportData} className="px-3 py-2 rounded-lg border theme-border theme-text text-sm"><i className="fas fa-download mr-2"></i>Export Backup</button>
                                    <label className="px-3 py-2 rounded-lg border theme-border theme-text text-sm cursor-pointer"><i className="fas fa-upload mr-2"></i>Import Backup<input type="file" accept="application/json" className="hidden" onChange={handleImportData} /></label>
                                </div>
                            </div>

                            <div className="flex justify-end gap-2 pt-2">
                                <button type="button" onClick={onClose} className="px-4 py-2 rounded-lg border theme-border theme-text">Cancel</button>
                                <button className="theme-accent-btn px-4 py-2 rounded-lg font-semibold">Save Settings</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const AIHelperModal = ({ onClose }) => {
            const [input, setInput] = useState('');
            const [messages, setMessages] = useState([{ role: 'assistant', content: "ðŸ‘‹ Hi! Ask me about notary laws." }]);
            const [loading, setLoading] = useState(false);

            const handleSend = async () => {
                if (!input.trim()) return;
                const newMsgs = [...messages, { role: 'user', content: input }];
                setMessages(newMsgs);
                setInput('');
                setLoading(true);

                const apiKey = localStorage.getItem('gemini_api_key');
                if (!apiKey) {
                      setTimeout(() => {
                        setMessages([...newMsgs, { role: 'assistant', content: "Please add your API Key in Settings to enable AI responses." }]);
                        setLoading(false);
                    }, 800);
                    return;
                }

                try {
                     const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: `You are a helpful Notary Assistant. Answer concisely. User Query: ${input}` }] }] }) });
                     const data = await response.json();
                     const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Error.";
                     setMessages([...newMsgs, { role: 'assistant', content: aiText }]);
                } catch(e) { setMessages([...newMsgs, { role: 'assistant', content: "Error connecting to AI." }]); }
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none font-sans">
                    <div className="bg-white w-full sm:w-96 h-[60vh] shadow-2xl rounded-t-2xl sm:rounded-2xl flex flex-col pointer-events-auto border border-gray-200">
                        <div className="p-4 border-b flex justify-between bg-indigo-600 text-white rounded-t-2xl"><h3 className="font-bold">Quick Assist</h3><button onClick={onClose}>x</button></div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                            {messages.map((m, i) => <div key={i} className={`p-3 rounded-lg text-sm ${m.role === 'user' ? 'bg-indigo-100 ml-8' : 'bg-white mr-8 border'}`}>{m.content}</div>)}
                            {loading && <div className="text-xs text-gray-400">Thinking...</div>}
                        </div>
                        <div className="p-3 border-t bg-white flex gap-2"><input className="flex-1 p-2 border rounded" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSend()} /><button onClick={handleSend} className="bg-indigo-600 text-white w-10 rounded">></button></div>
                    </div>
                </div>
            );
        };

        // NEW: Reusable Empty State Component
        const EmptyState = ({ icon, title, description, actionLabel, onAction, colorClass = "text-blue-600", bgClass = "bg-blue-50" }) => (
            <div className="flex flex-col items-center justify-center py-20 px-6 text-center animate-fade-in bg-white rounded-2xl border border-gray-100 shadow-sm font-sans">
                <div className={`w-20 h-20 ${bgClass} ${colorClass} rounded-full flex items-center justify-center mb-6 text-3xl shadow-inner`}><i className={`fas ${icon}`}></i></div>
                <h3 className="text-xl font-bold text-gray-800 mb-2">{title}</h3>
                <p className="text-gray-500 max-w-xs mb-8 leading-relaxed text-sm">{description}</p>
                {onAction && <button onClick={onAction} className={`px-8 py-3 ${colorClass.replace('text', 'bg')} text-white rounded-xl font-bold shadow-lg transform transition-all hover:scale-105 active:scale-95`}>{actionLabel}</button>}
            </div>
        );

        const OnboardingTour = ({ onComplete }) => {
            const [selectedRole, setSelectedRole] = useState('solo');
            return (
                <div className="fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl p-8 text-center max-w-md font-sans">
                        <div className="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">ðŸš€</div>
                        <h2 className="text-2xl font-bold mb-2">Welcome to NotaryOS</h2>
                        <p className="text-gray-500 mb-6">Choose your setup so we can tailor features and guidance.</p>
                        <div className="grid grid-cols-1 gap-3 mb-6 text-left">
                            <button onClick={() => setSelectedRole('solo')} className={`p-3 rounded-xl border ${selectedRole === 'solo' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}>
                                <p className="font-semibold text-gray-800">Solo Notary</p>
                                <p className="text-xs text-gray-500">Best for independent mobile notaries.</p>
                            </button>
                            <button onClick={() => setSelectedRole('agency')} className={`p-3 rounded-xl border ${selectedRole === 'agency' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200'}`}>
                                <p className="font-semibold text-gray-800">Agency / Team</p>
                                <p className="text-xs text-gray-500">Manage multiple notaries and assignments.</p>
                            </button>
                        </div>
                        <button onClick={() => onComplete(selectedRole)} className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg">Continue</button>
                    </div>
                </div>
            );
        };

        const WelcomeTour = ({ onComplete }) => {
            const [step, setStep] = useState(1);
            const totalSteps = 5;

            const steps = [
                { id: 1, icon: 'fa-rocket', color: 'text-blue-600', bg: 'bg-blue-50', title: 'Welcome to NotaryOS', desc: 'Your all-in-one operating system for running a modern notary business.' },
                { id: 2, icon: 'fa-chart-pie', color: 'text-emerald-600', bg: 'bg-emerald-50', title: 'Business Dashboard', desc: 'Track your monthly income, upcoming jobs, and get alerts for expiring credentials.' },
                { id: 3, icon: 'fa-calendar-check', color: 'text-purple-600', bg: 'bg-purple-50', title: 'Schedule & Journal', desc: 'Manage appointments with Calendar view and log every signing for state compliance.' },
                { id: 4, icon: 'fa-robot', color: 'text-indigo-600', bg: 'bg-indigo-50', title: 'AI Training Center', desc: 'Get instant answers to state laws and practice difficult scenarios with your AI Coach.' },
                { id: 5, icon: 'fa-cog', color: 'text-slate-600', bg: 'bg-slate-50', title: 'You\'re All Set', desc: 'Customize your profile, set up your branding, and start accepting appointments!' }
            ];

            const current = steps[step - 1];

            return (
                <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 text-center relative overflow-hidden font-sans">
                        {/* Progress Bar */}
                        <div className="absolute top-0 left-0 h-1 bg-gray-100 w-full">
                            <div className="h-full bg-blue-600 transition-all duration-300" style={{ width: `${(step / totalSteps) * 100}%` }}></div>
                        </div>

                        <div className={`w-20 h-20 mx-auto rounded-full flex items-center justify-center text-3xl mb-6 shadow-sm ${current.bg} ${current.color} transition-colors duration-300`}>
                            <i className={`fas ${current.icon}`}></i>
                        </div>

                        <h2 className="text-2xl font-bold text-gray-800 mb-3 transition-opacity duration-300">{current.title}</h2>
                        <p className="text-gray-500 mb-8 leading-relaxed h-16">{current.desc}</p>

                        <div className="flex items-center gap-3">
                            {step > 1 && (
                                <button onClick={() => setStep(s => s - 1)} className="px-6 py-3 rounded-xl border border-gray-200 text-gray-600 font-bold hover:bg-gray-50">
                                    Back
                                </button>
                            )}
                            <button onClick={() => step < totalSteps ? setStep(s => s + 1) : onComplete()} className="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition-all">
                                {step < totalSteps ? 'Next Step' : 'Get Started'}
                            </button>
                        </div>

                        <button onClick={onComplete} className="mt-6 text-xs text-gray-400 font-semibold uppercase tracking-wide hover:text-gray-600">
                            Skip Tour
                        </button>
                    </div>
                </div>
            );
        };

        const LandingPage = ({ onNavigate }) => {
            const [activeTab, setActiveTab] = useState('before');
            const [weeklyAppts, setWeeklyAppts] = useState(5);
            const [adminMins, setAdminMins] = useState(20);
            const [billing, setBilling] = useState('monthly');
            const [demoQuestion, setDemoQuestion] = useState("");
            const [demoResponse, setDemoResponse] = useState(null);
            const [openFaqIndex, setOpenFaqIndex] = useState(0);
            const [legalDoc, setLegalDoc] = useState(null);
            const [showTermsModal, setShowTermsModal] = useState(false);

            const faqItems = [
                {
                    question: "Does this support all 50-state compliance workflows?",
                    answer: "Yes. NotaryOS is built to support 50-state notarial operations with guided journal capture, compliance prompts, and structured records. Because regulations can evolve, your final notarial judgment and state handbook remain authoritative."
                },
                {
                    question: "Is my client data secure?",
                    answer: "Security is layered: encrypted transit, authenticated access controls, and account-scoped records. Sensitive signing and identity metadata are stored with least-privilege principles in mind."
                },
                {
                    question: "How does the AI assistant and Gemini API key work?",
                    answer: "Your Gemini API key powers AI compliance guidance and drafting assistance. You control the key and usage. NotaryOS uses it only for the requests you trigger within the app."
                },
                {
                    question: "What is the difference between local storage and cloud sync?",
                    answer: "Local storage keeps data only on the current browser/device. Cloud sync allows secure multi-device continuity, backup recovery, and team-level visibility for growing operations."
                }
            ];

            const hoursSaved = Math.round((weeklyAppts * adminMins * 52) / 60);
            const dollarsSaved = (hoursSaved * 50).toLocaleString();

            const handleDemoAsk = (e) => {
                e.preventDefault();
                setDemoResponse("loading");
                setTimeout(() => {
                    setDemoResponse("In California, the maximum fee for a jurat is $15 per signature, including the oath or affirmation. Always check the latest handbook!");
                }, 1500);
            };

            return (
                <div className="min-h-screen landing-bg text-white font-inter flex flex-col relative overflow-x-hidden">
                    {legalDoc && <LegalDocModal doc={legalDoc} onClose={() => setLegalDoc(null)} />}
                    {showTermsModal && <TermsModal onClose={() => setShowTermsModal(false)} />}
                    <div className="w-full p-6 flex justify-between items-center z-20 container mx-auto">
                        <div className="flex items-center gap-2">
                            <i className="fas fa-file-signature text-xl text-teal-400"></i>
                            <h1 className="text-xl font-bold tracking-tight font-sans">NotaryOS</h1>
                        </div>
                        <button onClick={onNavigate} className="text-gray-300 hover:text-white font-medium text-sm transition-colors border border-gray-600 hover:border-gray-400 px-4 py-2 rounded-lg font-sans">Log In</button>
                    </div>

                    <div className="flex-1 flex flex-col justify-center items-center text-center px-6 relative z-10 py-20">
                        <h1 className="text-5xl md:text-7xl font-extrabold mb-6 leading-tight tracking-tight max-w-5xl drop-shadow-2xl font-sans">
                            Drowning in paperwork? <br />
                            <span className="text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-blue-500">Chasing payments?</span>
                        </h1>
                        <p className="text-lg text-slate-300 mb-10 max-w-2xl leading-relaxed">
                            Stop worrying about state compliance. NotaryOS handles it allâ€”so you can focus on signings, not spreadsheets.
                        </p>
                        <button onClick={onNavigate} className="bg-teal-500 hover:bg-teal-600 text-white px-10 py-4 rounded-xl font-bold text-lg shadow-xl shadow-teal-500/20 transition-all transform hover:-translate-y-1 font-sans">
                            Start Free Trial
                        </button>
                    </div>

                    {/* Trust & Security Banner */}
                    <div className="w-full px-6 pb-8">
                        <div className="max-w-6xl mx-auto grid md:grid-cols-3 gap-3 bg-slate-900/70 border border-slate-700 rounded-2xl p-4 md:p-5 font-sans">
                            <div className="flex items-center gap-3 text-slate-200"><i className="fas fa-lock text-teal-400"></i><span className="font-semibold">100% Local Privacy</span></div>
                            <div className="flex items-center gap-3 text-slate-200"><i className="fas fa-brain text-indigo-400"></i><span className="font-semibold">Powered by Advanced AI</span></div>
                            <div className="flex items-center gap-3 text-slate-200"><i className="fas fa-shield-alt text-emerald-400"></i><span className="font-semibold">50-State Compliant</span></div>
                        </div>
                    </div>

                    {/* RESTORED AI Hero Feature Section */}
                    <div className="w-full bg-slate-900/50 border-y border-slate-800 py-20 relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-full bg-blue-500/5 blur-[100px] pointer-events-none"></div>
                        <div className="max-w-6xl mx-auto px-6 grid md:grid-cols-2 gap-12 items-center relative z-10">
                            <div className="text-left">
                                <div className="inline-block bg-teal-900/30 text-teal-300 px-3 py-1 rounded-full text-xs font-bold mb-4 border border-teal-500/30 font-sans">
                                    NEW: AI COMPLIANCE COACH
                                </div>
                                <h2 className="text-3xl md:text-4xl font-bold mb-4 leading-tight font-sans">
                                    Your personal compliance expert, <span className="text-teal-400">available 24/7.</span>
                                </h2>
                                <p className="text-slate-400 text-lg mb-8 leading-relaxed">
                                    Not just softwareâ€”it's a mentor. Get instant answers to state-specific questions, fee limits, and ID rules without searching through a 100-page handbook.
                                </p>
                                <form onSubmit={handleDemoAsk} className="relative font-sans">
                                    <input
                                        type="text"
                                        placeholder="e.g. What's the fee for a jurat in California?"
                                        className="w-full bg-slate-800 border border-slate-700 rounded-xl py-4 px-6 text-white focus:outline-none focus:border-teal-500 focus:ring-1 focus:ring-teal-500 transition-all shadow-lg"
                                        value={demoQuestion}
                                        onChange={(e) => setDemoQuestion(e.target.value)}
                                    />
                                    <button type="submit" className="absolute right-2 top-2 bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded-lg font-bold text-sm transition-colors">
                                        Ask AI
                                    </button>
                                </form>
                            </div>

                            <div className="ai-glow-box bg-slate-800/80 backdrop-blur-xl rounded-2xl p-6 border border-slate-700/50 shadow-2xl relative">
                                <div className="flex items-center gap-3 mb-6 border-b border-slate-700 pb-4">
                                    <div className="w-10 h-10 bg-teal-500 rounded-full flex items-center justify-center text-white"><i className="fas fa-robot"></i></div>
                                    <div>
                                        <h4 className="font-bold text-white font-sans">NotaryOS AI</h4>
                                        <div className="flex items-center gap-1.5 font-sans">
                                            <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                                            <span className="text-xs text-slate-400">Online Now</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-4 font-sans">
                                    <div className="flex justify-end">
                                        <div className="bg-blue-600 text-white px-4 py-3 rounded-2xl rounded-tr-none text-sm max-w-[80%] shadow-md">
                                            What's the fee for a jurat in California?
                                        </div>
                                    </div>

                                    {(demoResponse || true) && (
                                        <div className="flex justify-start">
                                             <div className="bg-slate-700 text-slate-200 px-4 py-3 rounded-2xl rounded-tl-none text-sm max-w-[90%] shadow-md border border-slate-600">
                                                {demoResponse === "loading" ? (
                                                    <div className="flex gap-1.5 py-1">
                                                        <span className="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></span>
                                                        <span className="w-2 h-2 bg-slate-400 rounded-full animate-bounce delay-100"></span>
                                                        <span className="w-2 h-2 bg-slate-400 rounded-full animate-bounce delay-200"></span>
                                                    </div>
                                                ) : (
                                                    demoResponse || "That depends on your state laws. For California, the maximum fee for a jurat is $15 per signature, including the oath or affirmation."
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Pain vs Power Section - Alternating Background: Dark Slate 800 */}
                    <div className="bg-slate-800 py-20 border-t border-slate-700 font-sans">
                        <div className="max-w-6xl mx-auto px-6 grid md:grid-cols-2 gap-12 items-center">
                            <div className="space-y-6">
                                <h3 className="text-3xl font-bold text-white">Before & After</h3>
                                <div className="flex bg-slate-900/50 p-1 rounded-xl mb-6 w-fit border border-slate-700">
                                    <button onClick={() => setActiveTab('before')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'before' ? 'bg-red-500/20 text-red-400 shadow-sm' : 'text-slate-500 hover:text-slate-300'}`}>The Old Way</button>
                                    <button onClick={() => setActiveTab('after')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'after' ? 'bg-teal-500/20 text-teal-400 shadow-sm' : 'text-slate-500 hover:text-slate-300'}`}>With NotaryOS</button>
                                </div>

                                {activeTab === 'before' ? (
                                    <div className="space-y-4 animate-fade-in">
                                        <div className="flex items-start gap-4 p-4 rounded-xl bg-red-900/10 border border-red-900/30">
                                            <div className="w-10 h-10 rounded-full bg-red-900/30 flex items-center justify-center text-red-400 shrink-0"><i className="fas fa-file-invoice-dollar"></i></div>
                                            <div><h4 className="font-bold text-red-200">Lost Invoices</h4><p className="text-sm text-slate-400">Tracking payments in Excel or paper logs leads to missed revenue.</p></div>
                                        </div>
                                        <div className="flex items-start gap-4 p-4 rounded-xl bg-red-900/10 border border-red-900/30">
                                            <div className="w-10 h-10 rounded-full bg-red-900/30 flex items-center justify-center text-red-400 shrink-0"><i className="fas fa-exclamation-triangle"></i></div>
                                            <div><h4 className="font-bold text-red-200">Compliance Risks</h4><p className="text-sm text-slate-400">Guessing fees or ID rules can cost you your commission.</p></div>
                                        </div>
                                        <div className="flex items-start gap-4 p-4 rounded-xl bg-red-900/10 border border-red-900/30">
                                            <div className="w-10 h-10 rounded-full bg-red-900/30 flex items-center justify-center text-red-400 shrink-0"><i className="fas fa-clock"></i></div>
                                            <div><h4 className="font-bold text-red-200">Admin Overload</h4><p className="text-sm text-slate-400">Spending hours manually entering journal data after every signing.</p></div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="space-y-4 animate-fade-in">
                                        <div className="flex items-start gap-4 p-4 rounded-xl bg-teal-900/10 border border-teal-900/30">
                                            <div className="w-10 h-10 rounded-full bg-teal-900/30 flex items-center justify-center text-teal-400 shrink-0"><i className="fas fa-magic"></i></div>
                                            <div><h4 className="font-bold text-teal-200">One-Click Invoicing</h4><p className="text-sm text-slate-400">Generate professional PDF invoices instantly from your appointment data.</p></div>
                                        </div>
                                        <div className="flex items-start gap-4 p-4 rounded-xl bg-teal-900/10 border border-teal-900/30">
                                            <div className="w-10 h-10 rounded-full bg-teal-900/30 flex items-center justify-center text-teal-400 shrink-0"><i className="fas fa-robot"></i></div>
                                            <div><h4 className="font-bold text-teal-200">AI Coach</h4><p className="text-sm text-slate-400">Your personal compliance coach answers state law questions 24/7.</p></div>
                                        </div>
                                        <div className="flex items-start gap-4 p-4 rounded-xl bg-teal-900/10 border border-teal-900/30">
                                            <div className="w-10 h-10 rounded-full bg-teal-900/30 flex items-center justify-center text-teal-400 shrink-0"><i className="fas fa-cloud-upload-alt"></i></div>
                                            <div><h4 className="font-bold text-teal-200">Cloud Sync</h4><p className="text-sm text-slate-400">Start on your phone at the signing table, finish on your laptop at home.</p></div>
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className="bg-slate-900 p-8 rounded-2xl border border-slate-700 shadow-2xl">
                                <h4 className="text-xl font-bold text-white mb-6 text-center">Calculate Your Lost Time</h4>
                                <div className="space-y-4">
                                    <div>
                                        <div className="flex justify-between mb-2">
                                            <label className="text-xs font-bold text-slate-400 uppercase">Weekly Appointments</label>
                                            <span className="text-teal-400 font-bold">{weeklyAppts}</span>
                                        </div>
                                        <input type="range" min="1" max="50" value={weeklyAppts} onChange={e=>setWeeklyAppts(e.target.value)} className="w-full accent-teal-500 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
                                    </div>
                                    <div>
                                        <div className="flex justify-between mb-2">
                                            <label className="text-xs font-bold text-slate-400 uppercase">Admin Mins per Appt</label>
                                            <span className="text-teal-400 font-bold">{adminMins} min</span>
                                        </div>
                                        <input type="range" min="5" max="60" value={adminMins} onChange={e=>setAdminMins(e.target.value)} className="w-full accent-teal-500 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
                                    </div>
                                    <div className="pt-6 border-t border-slate-700 mt-4 text-center">
                                        <p className="text-sm text-slate-400">You could save</p>
                                        <div className="text-4xl font-extrabold text-white mb-2">{hoursSaved} Hours<span className="text-lg text-slate-500 font-normal">/yr</span></div>
                                        <div className="inline-block bg-teal-900/30 text-teal-400 px-3 py-1 rounded-full text-xs font-bold border border-teal-500/30">
                                            That's ${dollarsSaved} in billable time!
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Mobile-First Demo Section - Alternating Background: Dark Slate 900 */}
                    <div className="py-24 bg-slate-900 w-full border-t border-slate-800 font-sans">
                        <div className="max-w-7xl mx-auto px-6 grid lg:grid-cols-[1.2fr_1fr] gap-16 items-center">
                            <div className="order-2 lg:order-1">
                                <div className="phone-stack">
                                    <div className="phone-mockup phone-stack-card left w-[285px] h-[575px] md:w-[300px] md:h-[600px] bg-white border-8 border-gray-900 rounded-[3rem] shadow-2xl overflow-hidden">
                                        <div className="phone-notch"></div>
                                        <div className="h-full bg-gray-50 pt-10 px-4">
                                            <div className="flex justify-between items-center mb-6">
                                                <h3 className="font-bold text-lg text-gray-800">Today's Route</h3>
                                                <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-xs font-bold">JD</div>
                                            </div>
                                            <div className="space-y-3">
                                                <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 border-l-4 border-l-blue-500">
                                                    <div className="flex justify-between mb-2">
                                                        <span className="text-xs font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded">LOAN SIGNING</span>
                                                        <span className="text-xs text-gray-400">2:00 PM</span>
                                                    </div>
                                                    <h4 className="font-bold text-gray-800">Sarah Johnson</h4>
                                                    <p className="text-xs text-gray-500 mt-1"><i className="fas fa-map-marker-alt text-red-400 mr-1"></i> 123 Maple Dr, Seattle</p>
                                                </div>
                                                <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                                    <div className="flex justify-between mb-2">
                                                        <span className="text-xs font-bold text-purple-500 bg-purple-50 px-2 py-1 rounded">DEED</span>
                                                        <span className="text-xs text-gray-400">4:30 PM</span>
                                                    </div>
                                                    <h4 className="font-bold text-gray-800">Mike Chen</h4>
                                                    <p className="text-xs text-gray-500 mt-1"><i className="fas fa-map-marker-alt text-gray-300 mr-1"></i> Starbucks, 4th Ave</p>
                                                </div>
                                                <div className="bg-white p-3 rounded-xl border border-gray-100 shadow-sm">
                                                    <p className="text-[10px] uppercase font-bold text-slate-400">Coverage</p>
                                                    <div className="mt-2 flex items-center justify-between text-xs text-gray-600">
                                                        <span><i className="fas fa-signal text-emerald-500 mr-1"></i> Data: Unlimited</span>
                                                        <span><i className="fas fa-phone text-blue-500 mr-1"></i> Calls: Unlimited</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="phone-mockup phone-stack-card right w-[285px] h-[575px] md:w-[300px] md:h-[600px] bg-white border-8 border-gray-900 rounded-[3rem] shadow-2xl overflow-hidden">
                                        <div className="phone-notch"></div>
                                        <div className="h-full bg-gray-50 pt-10 px-4">
                                            <div className="flex justify-between items-center mb-6">
                                                <h3 className="font-bold text-lg text-gray-800">Payments</h3>
                                                <button className="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded">Send Invoice</button>
                                            </div>
                                            <div className="space-y-3">
                                                <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                                    <p className="text-xs text-gray-500">April Revenue</p>
                                                    <p className="text-2xl font-bold text-gray-800 mt-1">$3,420</p>
                                                    <div className="text-[11px] text-emerald-600 mt-1 font-semibold"><i className="fas fa-arrow-up"></i> 18% vs last month</div>
                                                </div>
                                                <div className="bg-white p-3 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between border-l-4 border-l-emerald-500">
                                                    <div>
                                                        <p className="text-xs font-semibold text-gray-800">Invoice #2948</p>
                                                        <p className="text-[11px] text-gray-500">Paid by Sarah Johnson</p>
                                                    </div>
                                                    <span className="text-xs font-bold text-emerald-700 bg-emerald-100 px-2 py-1 rounded-full">Paid</span>
                                                </div>
                                                <div className="bg-white p-3 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between">
                                                    <div>
                                                        <p className="text-xs font-semibold text-gray-800">Invoice #2951</p>
                                                        <p className="text-[11px] text-gray-500">Pending â€¢ Mike Chen</p>
                                                    </div>
                                                    <span className="text-xs font-bold text-amber-700 bg-amber-100 px-2 py-1 rounded-full">Pending</span>
                                                </div>
                                                <div className="bg-white p-3 rounded-xl border border-gray-100 shadow-sm">
                                                    <p className="text-[10px] uppercase font-bold text-slate-400">Inbox</p>
                                                    <div className="mt-2 flex items-center justify-between text-xs text-gray-600">
                                                        <span><i className="fas fa-envelope text-indigo-500 mr-1"></i> Client follow-up</span>
                                                        <span className="text-indigo-600 font-semibold">New</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="order-1 lg:order-2">
                                <h3 className="text-3xl font-bold text-white mb-6">Run your business from your pocket.</h3>
                                <p className="text-slate-400 text-lg mb-8 leading-relaxed">
                                    From booking to signature capture to final payout, NotaryOS mirrors how real mobile appointments happen. Start with your daily schedule, complete ID/journal checks at the table, then send and track payment before you drive to the next stop.
                                </p>
                                <ul className="space-y-4">
                                    <li className="flex items-center gap-3 text-slate-300">
                                        <div className="w-6 h-6 rounded-full bg-teal-500/20 text-teal-400 flex items-center justify-center text-xs"><i className="fas fa-mobile-alt"></i></div>
                                        1) Confirm today's route and appointment details
                                    </li>
                                    <li className="flex items-center gap-3 text-slate-300">
                                        <div className="w-6 h-6 rounded-full bg-teal-500/20 text-teal-400 flex items-center justify-center text-xs"><i className="fas fa-map-marker-alt"></i></div>
                                        2) Capture signer details and journal proof on site
                                    </li>
                                    <li className="flex items-center gap-3 text-slate-300">
                                        <div className="w-6 h-6 rounded-full bg-teal-500/20 text-teal-400 flex items-center justify-center text-xs"><i className="fas fa-bell"></i></div>
                                        3) Send invoice and track paid/pending status instantly
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    {/* How It Works + Built For */}
                    <div className="w-full border-t border-slate-800 font-sans bg-[#020b26]">
                        <div className="py-24">
                            <div className="max-w-6xl mx-auto px-6">
                                <h3 className="text-4xl font-bold text-white text-center mb-4">How NotaryOS works</h3>
                                <p className="text-slate-400 text-center max-w-3xl mx-auto mb-12 text-lg">A streamlined workflow from booking to payoutâ€”designed for mobile-first notaries.</p>
                                <div className="grid md:grid-cols-3 gap-6">
                                    <div className="rounded-2xl border border-slate-700 bg-[#081330] p-7 shadow-lg shadow-black/10">
                                        <p className="text-xs text-teal-300 font-bold uppercase tracking-wide mb-4">Step 1</p>
                                        <h4 className="text-3xl/none font-semibold text-white mb-3 flex items-center gap-3"><i className="fas fa-calendar-check text-teal-400 text-xl"></i>Book the Job</h4>
                                        <p className="text-slate-400 text-[1.1rem] leading-relaxed">Capture client info quickly with Smart Fill and appointment templates.</p>
                                    </div>
                                    <div className="rounded-2xl border border-slate-700 bg-[#081330] p-7 shadow-lg shadow-black/10">
                                        <p className="text-xs text-teal-300 font-bold uppercase tracking-wide mb-4">Step 2</p>
                                        <h4 className="text-3xl/none font-semibold text-white mb-3 flex items-center gap-3"><i className="fas fa-mobile-alt text-indigo-300 text-xl"></i>Do the Signing</h4>
                                        <p className="text-slate-400 text-[1.1rem] leading-relaxed">Use Mobile Journal flow for ID capture, proof, and compliant on-site execution.</p>
                                    </div>
                                    <div className="rounded-2xl border border-slate-700 bg-[#081330] p-7 shadow-lg shadow-black/10">
                                        <p className="text-xs text-teal-300 font-bold uppercase tracking-wide mb-4">Step 3</p>
                                        <h4 className="text-3xl/none font-semibold text-white mb-3 flex items-center gap-3"><i className="fas fa-file-invoice-dollar text-emerald-400 text-xl"></i>Get Paid</h4>
                                        <p className="text-slate-400 text-[1.1rem] leading-relaxed">Auto-generate invoices, track payment status, and close the loop instantly.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="py-24 bg-[#0d1836] border-t border-slate-800/80">
                            <div className="max-w-6xl mx-auto px-6">
                                <h3 className="text-5xl font-bold text-white text-center mb-12 leading-tight">Built for every modern notary business model</h3>
                                <div className="grid md:grid-cols-3 gap-6">
                                    <div className="rounded-2xl border border-slate-700 bg-slate-800/50 p-7">
                                        <h4 className="text-4xl/none font-semibold text-white mb-4 flex items-center gap-3"><i className="fas fa-car-side text-blue-400 text-2xl"></i>Mobile Notaries</h4>
                                        <p className="text-slate-400 text-[1.1rem] leading-relaxed">Run route-based signings, capture compliant entries on-site, and complete admin later from desktop.</p>
                                    </div>
                                    <div className="rounded-2xl border border-slate-700 bg-slate-800/50 p-7">
                                        <h4 className="text-4xl/none font-semibold text-white mb-4 flex items-center gap-3"><i className="fas fa-home text-purple-400 text-2xl"></i>Loan Signing Agents</h4>
                                        <p className="text-slate-400 text-[1.1rem] leading-relaxed">Manage high-volume closings with reliable documentation, invoicing, and audit-ready workflows.</p>
                                    </div>
                                    <div className="rounded-2xl border border-slate-700 bg-slate-800/50 p-7">
                                        <h4 className="text-4xl/none font-semibold text-white mb-4 flex items-center gap-3"><i className="fas fa-users text-teal-400 text-2xl"></i>Signing Agencies</h4>
                                        <p className="text-slate-400 text-[1.1rem] leading-relaxed">Coordinate team dispatch, centralize records, and scale with standardized processes.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* FAQ Section - Trust, Security & Clarity */}
                    <div className="bg-slate-950/80 py-24 w-full border-t border-slate-800 font-sans">
                        <div className="max-w-5xl mx-auto px-6">
                            <div className="text-center mb-12">
                                <div className="inline-flex items-center gap-2 bg-slate-900/80 border border-slate-700 text-teal-300 px-4 py-2 rounded-full text-xs font-bold tracking-wide">
                                    <i className="fas fa-shield-alt"></i>
                                    TRUST & COMPLIANCE FAQ
                                </div>
                                <h3 className="text-3xl md:text-4xl font-bold text-white mt-5 mb-4">Questions every serious notary asks first.</h3>
                                <p className="text-slate-400 max-w-3xl mx-auto">
                                    Built for risk-aware professionals: get clear answers on compliance workflows, data security, AI key usage, and local vs cloud storage without cluttering the interface.
                                </p>
                            </div>

                            <div className="space-y-4">
                                {faqItems.map((item, index) => {
                                    const isOpen = openFaqIndex === index;
                                    return (
                                        <div key={item.question} className="bg-slate-900/70 border border-slate-700 rounded-2xl overflow-hidden shadow-lg shadow-black/20">
                                            <button
                                                type="button"
                                                className="w-full text-left px-6 py-5 flex items-center justify-between gap-4 hover:bg-slate-800/60 transition-colors"
                                                onClick={() => setOpenFaqIndex(isOpen ? -1 : index)}
                                                aria-expanded={isOpen}
                                            >
                                                <span className="text-white font-semibold leading-snug">{item.question}</span>
                                                <span className={`text-teal-400 transition-transform duration-300 ${isOpen ? 'rotate-180' : 'rotate-0'}`}>
                                                    <i className="fas fa-chevron-down"></i>
                                                </span>
                                            </button>
                                            {isOpen && (
                                                <div className="px-6 pb-6 text-slate-300 leading-relaxed border-t border-slate-800">
                                                    <p className="pt-4">{item.answer}</p>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>

                    {/* Pricing Section - Alternating Background: Dark Slate 800 */}
                    <div className="bg-slate-800 py-24 w-full border-t border-slate-700 font-sans">
                        <div className="max-w-6xl mx-auto px-6">
                            <div className="text-center mb-10">
                                <h3 className="text-3xl font-bold text-white mb-4">Simple, Transparent Pricing</h3>
                                <p className="text-slate-400 mb-8">Everything you need to grow your business.</p>

                                <div className="max-w-3xl mx-auto mb-8 bg-slate-900/70 border border-slate-700 rounded-xl px-5 py-4 text-left flex items-center justify-between gap-4">
                                    <div>
                                        <p className="text-slate-400 text-sm font-semibold">Current plan</p>
                                        <p className="text-slate-200">You are currently on the <span className="font-bold text-white">Starter Plan</span>.</p>
                                    </div>
                                    <button type="button" onClick={onNavigate} className="shrink-0 px-4 py-2 rounded-lg border border-slate-600 text-slate-300 hover:text-white hover:border-slate-400 transition-colors text-sm">
                                        Manage
                                    </button>
                                </div>

                                {/* Billing Toggle */}
                                <div className="inline-flex bg-slate-900 p-1 rounded-xl border border-slate-700 relative">
                                    <button onClick={() => setBilling('monthly')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${billing === 'monthly' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-400 hover:text-white'}`}>Monthly</button>
                                    <button onClick={() => setBilling('yearly')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${billing === 'yearly' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-400 hover:text-white'}`}>Yearly</button>
                                    {billing === 'yearly' && <span className="absolute -top-3 -right-3 bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-lg animate-bounce">SAVE 20%</span>}
                                </div>
                            </div>
                            <div className="grid md:grid-cols-3 gap-8 items-center">
                                {/* Free Plan */}
                                <div className="visual-card p-8 rounded-2xl flex flex-col bg-slate-900/50 border border-slate-700 h-fit">
                                    <h4 className="text-xl font-bold text-white mb-2">Starter</h4>
                                    <p className="text-xs text-slate-400 mb-4">For the side-hustle notary.</p>
                                    <div className="text-4xl font-bold text-white mb-6">$0<span className="text-sm text-slate-400 font-normal">/mo</span></div>
                                    <ul className="space-y-3 mb-8 text-slate-300 text-sm flex-1">
                                        <li className="flex gap-2"><i className="fas fa-check text-green-400"></i> 5 Appointments/mo</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-green-400"></i> Basic Journal</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-green-400"></i> Local Storage Only</li>
                                    </ul>
                                    <button onClick={onNavigate} className="w-full py-3 rounded-xl border border-slate-600 text-white hover:bg-slate-700 transition-colors">Get Started</button>
                                </div>

                                {/* Pro Plan */}
                                <div className="visual-card p-8 rounded-2xl flex flex-col relative border-teal-500 bg-slate-900 shadow-2xl shadow-teal-900/20 transform scale-105 z-10">
                                    <div className="absolute top-0 right-0 bg-teal-500 text-white text-xs font-bold px-3 py-1 rounded-bl-xl rounded-tr-xl">MOST POPULAR</div>
                                    <h4 className="text-xl font-bold text-white mb-2">Pro</h4>
                                    <p className="text-xs text-slate-400 mb-4">For the full-time professional.</p>
                                    <div className="text-4xl font-bold text-white mb-6">${billing === 'monthly' ? '19' : '15'}<span className="text-sm text-slate-400 font-normal">/mo</span></div>
                                    <ul className="space-y-3 mb-8 text-slate-300 text-sm flex-1">
                                        <li className="flex gap-2"><i className="fas fa-check text-teal-400"></i> Unlimited Appointments</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-teal-400"></i> Cloud Sync & Backups</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-teal-400"></i> AI Compliance Coach</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-teal-400"></i> GPS Mileage</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-teal-400"></i> Basic Signer Portal</li>
                                    </ul>
                                    <button onClick={onNavigate} className="w-full py-3 rounded-xl bg-teal-500 text-white hover:bg-teal-600 transition-colors font-bold shadow-lg shadow-teal-500/20">Start 7-Day Trial</button>
                                </div>

                                {/* Enterprise */}
                                <div className="visual-card p-8 rounded-2xl flex flex-col bg-slate-900/50 border border-slate-700 h-fit">
                                    <h4 className="text-xl font-bold text-white mb-2">Agency</h4>
                                    <p className="text-xs text-slate-400 mb-4">For scaling your signing service.</p>
                                    <div className="text-4xl font-bold text-white mb-6">${billing === 'monthly' ? '49' : '39'}<span className="text-sm text-slate-400 font-normal">/mo</span></div>
                                    <ul className="space-y-3 mb-8 text-slate-300 text-sm flex-1">
                                        <li className="flex gap-2"><i className="fas fa-check text-green-400"></i> Multi-Notary Dispatch</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-green-400"></i> Stripe Integration</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-green-400"></i> QuickBooks Sync</li>
                                        <li className="flex gap-2"><i className="fas fa-check text-green-400"></i> White-labeled Portal</li>
                                    </ul>
                                    <button className="w-full py-3 rounded-xl border border-slate-600 text-white hover:bg-slate-700 transition-colors">Contact Sales</button>
                                </div>
                            </div>

                            <div className="mt-14 overflow-x-auto rounded-2xl border border-slate-700 bg-slate-900/50">
                                <table className="min-w-full text-sm text-left text-slate-300">
                                    <thead className="bg-slate-900/90 text-slate-200">
                                        <tr>
                                            <th className="px-4 py-3 font-semibold">Compare plans</th>
                                            <th className="px-4 py-3 font-semibold">Starter</th>
                                            <th className="px-4 py-3 font-semibold">Pro</th>
                                            <th className="px-4 py-3 font-semibold">Agency</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-800">
                                        <tr>
                                            <td className="px-4 py-3 text-slate-400">Appointments per month</td>
                                            <td className="px-4 py-3">5</td>
                                            <td className="px-4 py-3">Unlimited</td>
                                            <td className="px-4 py-3">Unlimited + team routing</td>
                                        </tr>
                                        <tr>
                                            <td className="px-4 py-3 text-slate-400">Journal workflows</td>
                                            <td className="px-4 py-3"><i className="fas fa-check text-emerald-400 mr-2"></i>Basic</td>
                                            <td className="px-4 py-3"><i className="fas fa-check text-emerald-400 mr-2"></i>Advanced + templates</td>
                                            <td className="px-4 py-3"><i className="fas fa-check text-emerald-400 mr-2"></i>Team oversight</td>
                                        </tr>
                                        <tr>
                                            <td className="px-4 py-3 text-slate-400">Storage & sync</td>
                                            <td className="px-4 py-3">Local only</td>
                                            <td className="px-4 py-3">Cloud sync + backups</td>
                                            <td className="px-4 py-3">Cloud sync + multi-user</td>
                                        </tr>
                                        <tr>
                                            <td className="px-4 py-3 text-slate-400">AI compliance coach</td>
                                            <td className="px-4 py-3 text-slate-500">â€”</td>
                                            <td className="px-4 py-3"><i className="fas fa-check text-teal-400 mr-2"></i>Included</td>
                                            <td className="px-4 py-3"><i className="fas fa-check text-teal-400 mr-2"></i>Included</td>
                                        </tr>
                                        <tr>
                                            <td className="px-4 py-3 text-slate-400">API access</td>
                                            <td className="px-4 py-3 text-slate-500">â€”</td>
                                            <td className="px-4 py-3 text-slate-500">â€”</td>
                                            <td className="px-4 py-3"><i className="fas fa-check text-teal-400 mr-2"></i>Included</td>
                                        </tr>
                                        <tr>
                                            <td className="px-4 py-3 text-slate-400">Best for</td>
                                            <td className="px-4 py-3">Getting started</td>
                                            <td className="px-4 py-3">Full-time solo notary</td>
                                            <td className="px-4 py-3">Growing signing teams</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div className="mt-14 rounded-3xl border border-slate-700/80 bg-gradient-to-r from-slate-950 to-slate-900 px-8 py-10 text-center shadow-2xl shadow-blue-950/20">
                                <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-indigo-500/20 border border-indigo-400/30 text-indigo-200 text-xs font-semibold mb-5">
                                    <span className="w-2 h-2 rounded-full bg-indigo-300"></span>
                                    For enterprise
                                </div>
                                <h4 className="text-3xl md:text-4xl font-bold text-white mb-4">SOC2 Type II â€¢ GDPR â€¢ 50-state compliance</h4>
                                <p className="text-slate-300 text-lg max-w-3xl mx-auto mb-7">
                                    NotaryOS is built for demanding legal and financial workflows with secure infrastructure, standardized controls, and support for all U.S. notarial jurisdictions.
                                </p>
                                <button onClick={onNavigate} className="bg-indigo-500 hover:bg-indigo-600 text-white font-bold px-6 py-3 rounded-xl shadow-lg shadow-indigo-500/30 transition-colors">
                                    Contact sales <i className="fas fa-arrow-right ml-2"></i>
                                </button>
                            </div>
                        </div>
                        <footer className="mt-16 border-t border-slate-700 pt-10 pb-8 px-6 bg-slate-950/40 rounded-t-2xl">
                            <div className="max-w-6xl mx-auto grid sm:grid-cols-2 lg:grid-cols-5 gap-8 text-sm">
                                <div>
                                    <h4 className="text-white font-bold text-lg mb-3">NotaryOS</h4>
                                    <p className="text-slate-400">Fortune-500-grade operating system for notaries and signing teams.</p>
                                </div>
                                <div>
                                    <p className="text-white font-semibold mb-3">Product</p>
                                    <ul className="space-y-2 text-slate-400">
                                        <li>Scheduling</li>
                                        <li>Mobile Journal</li>
                                        <li>Auto Invoicing</li>
                                        <li>Signer Portal</li>
                                    </ul>
                                </div>
                                <div>
                                    <p className="text-white font-semibold mb-3">Legal</p>
                                    <ul className="space-y-2 text-slate-400">
                                        <li><button type="button" onClick={() => setLegalDoc('privacy')} className="hover:text-white transition-colors">Privacy Policy</button></li>
                                        <li><button type="button" onClick={() => setLegalDoc('dataProcessing')} className="hover:text-white transition-colors">Data Processing</button></li>
                                        <li><button type="button" onClick={() => setLegalDoc('security')} className="hover:text-white transition-colors">Security Standards</button></li>
                                        <li><button type="button" onClick={() => setLegalDoc('compliance')} className="hover:text-white transition-colors">Compliance Center</button></li>
                                    </ul>
                                </div>
                                <div>
                                    <p className="text-white font-semibold mb-3">Terms</p>
                                    <ul className="space-y-2 text-slate-400">
                                        <li><button type="button" onClick={() => setShowTermsModal(true)} className="hover:text-white transition-colors">Terms of Service</button></li>
                                        <li><button type="button" onClick={() => setLegalDoc('subscription')} className="hover:text-white transition-colors">Subscription Terms</button></li>
                                        <li><button type="button" onClick={() => setLegalDoc('acceptableUse')} className="hover:text-white transition-colors">Acceptable Use</button></li>
                                        <li><button type="button" onClick={() => setLegalDoc('cookie')} className="hover:text-white transition-colors">Cookie Policy</button></li>
                                    </ul>
                                </div>
                                <div>
                                    <p className="text-white font-semibold mb-3">Support</p>
                                    <ul className="space-y-2 text-slate-400">
                                        <li>Help Center</li>
                                        <li>Contact Support</li>
                                        <li>System Status</li>
                                        <li>Sales Team</li>
                                    </ul>
                                </div>
                            </div>
                            <div className="max-w-6xl mx-auto mt-8 pt-5 border-t border-slate-800 flex flex-col md:flex-row items-center justify-between gap-4 text-xs text-slate-500">
                                <p>&copy; 2026 NotaryOS Inc. All rights reserved.</p>
                                <div className="flex gap-4 text-slate-400 text-base">
                                    <i className="fab fa-linkedin hover:text-white"></i>
                                    <i className="fab fa-x-twitter hover:text-white"></i>
                                    <i className="fab fa-youtube hover:text-white"></i>
                                </div>
                            </div>
                        </footer>
                    </div>
                </div>
            );
        };

        // 2. Auth Screen (Redesigned + Terms)
        const AuthScreen = ({ onAuth, onBack }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [formData, setFormData] = useState({ name: '', email: '', password: '' });
            const [showTermsModal, setShowTermsModal] = useState(false);
            const [error, setError] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            const normalizeAuthUser = (authUser, fallbackName) => ({
                id: authUser?.uid || Date.now().toString(),
                name: authUser?.displayName || fallbackName || authUser?.email?.split('@')[0] || 'User',
                email: authUser?.email || formData.email,
                plan: 'free',
                role: 'solo'
            });

            const handleAuth = async (e) => {
                e.preventDefault();
                setError('');

                if (!formData.email || !formData.password) {
                    setError('Please enter both email and password.');
                    return;
                }
                if (!isLogin && !formData.name.trim()) {
                    setError('Please enter your full name.');
                    return;
                }

                setIsSubmitting(true);
                try {
                    if (typeof firebase !== 'undefined' && firebase.auth) {
                        if (isLogin) {
                            const credential = await firebase.auth().signInWithEmailAndPassword(formData.email, formData.password);
                            onAuth(normalizeAuthUser(credential.user, formData.name));
                        } else {
                            const credential = await firebase.auth().createUserWithEmailAndPassword(formData.email, formData.password);
                            if (credential.user && formData.name.trim()) await credential.user.updateProfile({ displayName: formData.name.trim() });
                            onAuth(normalizeAuthUser(credential.user, formData.name.trim()));
                        }
                    } else {
                        onAuth(normalizeAuthUser(null, isLogin ? 'User' : formData.name.trim()));
                    }
                } catch (err) {
                    setError(err?.message || 'Unable to authenticate right now. Please try again.');
                } finally {
                    setIsSubmitting(false);
                }
            };

            const handleGoogleAuth = async () => {
                setError('');
                setIsSubmitting(true);
                try {
                    if (typeof firebase === 'undefined' || !firebase.auth) throw new Error('Google sign-in is unavailable in this environment.');
                    const provider = new firebase.auth.GoogleAuthProvider();
                    const result = await firebase.auth().signInWithPopup(provider);
                    onAuth(normalizeAuthUser(result.user, result.user?.displayName));
                } catch (err) {
                    setError(err?.message || 'Google sign-in failed. Please try again.');
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4 font-inter">
                    {showTermsModal && <TermsModal onClose={() => setShowTermsModal(false)} onAccept={() => setShowTermsModal(false)} />}
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl flex overflow-hidden min-h-[600px] animate-fade-in">
                        <div className="w-1/2 bg-slate-900 text-white p-12 hidden md:flex flex-col justify-center relative overflow-hidden"><button onClick={onBack} className="absolute top-8 left-8 text-slate-400 hover:text-white flex items-center gap-2 text-sm font-medium z-20"><i className="fas fa-arrow-left"></i> Back</button><div className="absolute -top-20 -right-20 w-64 h-64 bg-blue-600/20 rounded-full blur-3xl"></div><div className="absolute -bottom-20 -left-20 w-64 h-64 bg-purple-600/20 rounded-full blur-3xl"></div><div className="relative z-10"><div className="mb-6"><div className="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center text-2xl mb-4 shadow-lg shadow-blue-500/30"><i className="fas fa-user-tie"></i></div><h1 className="text-4xl font-bold mb-2">NotaryOS</h1><p className="text-blue-200 text-lg">The Operating System for Modern Notaries.</p></div><div className="space-y-4 mt-8"><div className="flex items-center gap-3"><i className="fas fa-check-circle text-emerald-400 text-xl"></i><span className="font-medium">Business Management Suite</span></div><div className="flex items-center gap-3"><i className="fas fa-check-circle text-emerald-400 text-xl"></i><span className="font-medium">AI-Powered Compliance Coach</span></div><div className="flex items-center gap-3"><i className="fas fa-check-circle text-emerald-400 text-xl"></i><span className="font-medium">50-State Law Database</span></div></div></div></div>
                        <div className="w-full md:w-1/2 p-12 flex flex-col justify-center"><div className="max-w-sm mx-auto w-full"><h2 className="text-3xl font-bold text-slate-900 mb-8">{isLogin ? 'Welcome Back' : 'Create Account'}</h2>{error && <div className="bg-red-100 text-red-700 p-3 rounded mb-4 text-xs">{error}</div>}<form onSubmit={handleAuth} className="space-y-5">{!isLogin && (<div><label className="block text-xs font-bold text-slate-500 uppercase mb-2 tracking-wide">Full Name</label><input type="text" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" value={formData.name} onChange={e=>setFormData({...formData, name: e.target.value})} placeholder="Jane Doe" /></div>)}<div><label className="block text-xs font-bold text-slate-500 uppercase mb-2 tracking-wide">Email Address</label><input type="email" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" value={formData.email} onChange={e=>setFormData({...formData, email: e.target.value})} placeholder="name@example.com" /></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-2 tracking-wide">Password</label><input type="password" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-xl tracking-widest" value={formData.password} onChange={e=>setFormData({...formData, password: e.target.value})} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" /></div><button type="submit" disabled={isSubmitting} className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white font-bold py-3.5 rounded-lg shadow-md transition-all transform active:scale-95 mt-4">{isSubmitting ? 'Please waitâ€¦' : (isLogin ? 'Sign In' : 'Create Account')}</button></form><div className="relative flex py-6 items-center"><div className="flex-grow border-t border-slate-200"></div><span className="flex-shrink-0 mx-4 text-slate-400 text-xs font-medium uppercase">OR</span><div className="flex-grow border-t border-slate-200"></div></div><button type="button" onClick={handleGoogleAuth} disabled={isSubmitting} className="w-full bg-white border border-slate-200 text-slate-700 font-bold py-3.5 rounded-lg hover:bg-slate-50 disabled:bg-slate-100 transition-all flex items-center justify-center gap-2 shadow-sm"><i className="fab fa-google text-red-500 text-lg"></i><span>Continue with Google</span></button><div className="mt-8 text-center text-sm text-slate-500">{isLogin ? "New to NotaryOS?" : "Already have an account?"} <button onClick={() => setIsLogin(!isLogin)} className="text-blue-600 font-bold hover:underline ml-1">{isLogin ? 'Create Account' : 'Log In'}</button></div>
                            <div className="mt-8 pt-4 border-t border-slate-100 text-xs text-center text-slate-400">
                                By continuing, you agree to our
                                <button onClick={() => setShowTermsModal(true)} className="underline cursor-pointer hover:text-slate-600 ml-1">Terms of Service</button>.
                            </div>
                        </div></div>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ currentView, setView, isOpen, onClose, onLogout, userName, userPlan, userRole, onSettings, onUpgrade, onLockedFeature }) => {
            const [isCollapsed, setIsCollapsed] = useState(false);
            const menuItems = [
                { id: 'dashboard', icon: 'fa-chart-pie', label: 'Dashboard', color: 'text-blue-400' },
                { id: 'schedule', icon: 'fa-calendar-alt', label: 'Schedule', color: 'text-green-400' },
                { id: 'clients', icon: 'fa-address-book', label: 'Clients', color: 'text-pink-400' },
                { id: 'portal', icon: 'fa-door-open', label: 'Signer Portal', color: 'text-cyan-400', access: 'pro', badge: 'PRO' },
                { id: 'journal', icon: 'fa-book', label: 'Journal', color: 'text-purple-400' },
                { id: 'finances', icon: 'fa-wallet', label: 'Finances', color: 'text-emerald-400' },
                { id: 'credentials', icon: 'fa-id-card', label: 'Credentials', color: 'text-orange-400' },
                { id: 'agency', icon: 'fa-building', label: 'Team Dispatch', color: 'text-sky-400', access: 'agency', badge: 'AGENCY' },
                { id: 'trainer', icon: 'fa-robot', label: 'AI Trainer', color: 'text-indigo-400', access: 'pro', badge: 'PRO' },
                { id: 'admin', icon: 'fa-shield-alt', label: 'Admin', color: 'text-red-500' }
            ];

            return (
                <>
                    <div className={`fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden ${isOpen ? 'block' : 'hidden'}`} onClick={onClose}></div>
                    <div className={`fixed inset-y-0 left-0 bg-slate-900 text-white z-50 transform transition-all duration-300 ease-in-out lg:static lg:flex lg:flex-col ${isOpen ? 'translate-x-0' : '-translate-x-full'} ${isCollapsed ? 'w-20' : 'w-64'} lg:translate-x-0`}>
                        <div className="p-4 flex justify-between items-center border-b border-slate-700 h-16">
                            {!isCollapsed && <span className="font-bold text-xl">NotaryOS</span>}
                            <button onClick={() => setIsCollapsed(!isCollapsed)} className="hidden lg:block text-gray-400 hover:text-white"><i className={`fas ${isCollapsed ? 'fa-chevron-right' : 'fa-chevron-left'}`}></i></button>
                            <button onClick={onClose} className="lg:hidden text-gray-400"><i className="fas fa-times"></i></button>
                        </div>
                        <nav className="flex-1 p-2 space-y-2 overflow-y-auto">
                            {menuItems.map(item => {
                                const locked = !!item.access && !hasFeatureAccess({ plan: userPlan, role: userRole }, item.access);
                                return (
                                    <button key={item.id} onClick={() => { if (locked) { onLockedFeature(item.id); onClose(); } else { setView(item.id); onClose(); } }} className={`w-full flex items-center gap-3 px-3 py-3 rounded-xl transition-colors hover:bg-slate-800 ${currentView === item.id ? 'bg-blue-600 text-white' : 'text-gray-400'} ${isCollapsed ? 'justify-center' : ''}`} title={locked ? `${item.label} (Upgrade required)` : item.label}>
                                            <i className={`fas ${item.icon} text-lg ${currentView !== item.id ? item.color : ''}`}></i>
                                            {!isCollapsed && <span className="text-sm font-medium">{item.label}</span>}
                                            {!isCollapsed && item.badge && (
                                                <span className={`ml-auto text-[9px] px-2 py-0.5 rounded-full font-bold ${item.badge === 'AGENCY' ? 'bg-slate-700 text-slate-100' : 'bg-amber-500/20 text-amber-300 border border-amber-400/30'}`}>{item.badge}</span>
                                            )}
                                            {!isCollapsed && locked && <i className="fas fa-lock text-[10px] text-amber-300"></i>}
                                    </button>
                                );
                            })}
                        </nav>
                        <div className="p-4 border-t border-slate-700">
                            {!isCollapsed && userPlan === 'free' && (
                                <button onClick={() => onUpgrade('pro')} className="w-full mb-3 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold py-2.5 shadow-lg shadow-indigo-900/40 hover:opacity-90 transition-opacity">ðŸš€ Upgrade to Pro</button>
                            )}
                             <button onClick={onSettings} className={`w-full flex items-center gap-3 px-3 py-2 mb-2 hover:bg-slate-800 rounded transition-colors group ${isCollapsed ? 'justify-center' : ''}`}>
                                <div className="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-blue-300 flex-shrink-0">{userName ? userName.substring(0,2).toUpperCase() : 'US'}</div>
                                {!isCollapsed && (
                                    <div className="flex-1 overflow-hidden text-left">
                                        <p className="text-xs font-bold truncate group-hover:text-white">{userName || 'User'}</p>
                                        <p className="text-[10px] text-slate-400 capitalize">{userPlan} Plan</p>
                                    </div>
                                )}
                                {!isCollapsed && <i className="fas fa-cog text-slate-500 group-hover:text-white ml-auto"></i>}
                            </button>
                             <button onClick={onLogout} className={`w-full flex items-center gap-2 text-red-400 hover:text-white ${isCollapsed ? 'justify-center' : ''}`}><i className="fas fa-sign-out-alt"></i> {!isCollapsed && "Logout"}</button>
                        </div>
                    </div>
                </>
            );
        };

        const MobileNav = ({ setView, onOpenMenu, user, onLockedFeature }) => {
            const trainerLocked = !hasFeatureAccess(user, 'pro');
            return (
                <div className="md:hidden fixed bottom-0 w-full bg-white/70 border-t border-slate-200/70 p-2 flex justify-around z-30 safe-area-pb shadow-sm backdrop-blur">
                    <button onClick={() => setView('dashboard')}><i className="fas fa-home text-slate-400 text-lg"></i></button>
                    <button onClick={() => setView('schedule')}><i className="fas fa-calendar-alt text-slate-400 text-lg"></i></button>
                    <button onClick={() => setView('addAppointment')} className="-mt-8 bg-blue-600 text-white rounded-full p-4 shadow-xl border-4 border-white active:scale-95 transition-transform"><i className="fas fa-plus text-2xl"></i></button>
                    <button onClick={() => trainerLocked ? onLockedFeature('trainer') : setView('trainer')} className="relative">
                        <i className="fas fa-robot text-slate-400 text-lg"></i>
                        <span className="absolute -top-2 -right-4 text-[9px] px-1.5 py-0.5 rounded-full bg-amber-500/20 text-amber-600 font-bold">PRO</span>
                    </button>
                    <button onClick={onOpenMenu}><i className="fas fa-bars text-slate-400 text-lg"></i></button>
                </div>
            );
        };

        const PaywallState = ({ featureKey = 'pro', onUpgrade }) => {
            const copy = {
                portal: {
                    title: 'Unlock the Signer Portal',
                    tier: 'PRO',
                    desc: 'Give clients a polished signing experience with secure document access, status visibility, and less back-and-forth.'
                },
                trainer: {
                    title: 'Unlock AI Trainer',
                    tier: 'PRO',
                    desc: 'Access premium compliance simulations and adaptive coaching to improve confidence before every appointment.'
                },
                agency: {
                    title: 'Unlock Team Dispatch',
                    tier: 'AGENCY',
                    desc: 'Coordinate multi-notary operations with dispatch controls, team routing, and centralized oversight.'
                },
                pro: {
                    title: 'Upgrade to Pro',
                    tier: 'PRO',
                    desc: 'Get advanced workflows, cloud sync, and AI-assisted compliance for serious notary growth.'
                }
            };
            const item = copy[featureKey] || copy.pro;
            return (
                <div className="p-6 md:p-10">
                    <div className="max-w-3xl mx-auto bg-white rounded-3xl border border-slate-200 shadow-xl p-8 md:p-10 text-center">
                        <span className={`inline-flex px-3 py-1 rounded-full text-xs font-bold mb-4 ${item.tier === 'AGENCY' ? 'bg-slate-800 text-white' : 'bg-amber-100 text-amber-800'}`}>{item.tier} FEATURE</span>
                        <h3 className="text-3xl font-bold text-slate-900 mb-4">{item.title}</h3>
                        <p className="text-slate-600 mb-8">{item.desc}</p>
                        <div className="grid sm:grid-cols-3 gap-3 text-left mb-8">
                            <div className="bg-slate-50 rounded-xl p-3 text-sm"><i className="fas fa-check text-emerald-500 mr-2"></i>Premium workflows</div>
                            <div className="bg-slate-50 rounded-xl p-3 text-sm"><i className="fas fa-check text-emerald-500 mr-2"></i>Secure cloud sync</div>
                            <div className="bg-slate-50 rounded-xl p-3 text-sm"><i className="fas fa-check text-emerald-500 mr-2"></i>Priority support</div>
                        </div>
                        <button onClick={() => onUpgrade('pro')} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-7 py-3 rounded-xl shadow-lg">Upgrade for $19/mo</button>
                    </div>
                </div>
            );
        };

        const Header = ({ title, onNotify, onSyncNow }) => {
            const [isOnline, setIsOnline] = useState(typeof navigator !== 'undefined' ? navigator.onLine : true);
            useEffect(() => {
                const onOnline = () => setIsOnline(true);
                const onOffline = () => setIsOnline(false);
                window.addEventListener('online', onOnline);
                window.addEventListener('offline', onOffline);
                return () => {
                    window.removeEventListener('online', onOnline);
                    window.removeEventListener('offline', onOffline);
                };
            }, []);
            return (
                <div className="theme-surface theme-border border-b p-4 flex justify-between items-center z-20">
                    <h2 className="font-bold theme-text text-lg">{title}</h2>
                    <div className="flex gap-2 items-center">
                        <span className="hidden md:inline-flex items-center gap-1 text-[10px] font-bold uppercase px-2 py-1 rounded-full theme-pill border"><i className="fas fa-shield-alt"></i> Trusted Workflow</span>
                        <button onClick={onSyncNow} className={`inline-flex items-center gap-1 text-[10px] font-bold uppercase px-2 py-1 rounded-full border ${isOnline ? 'theme-pill' : 'bg-amber-50 text-amber-700 border-amber-100'}`}>
                            <i className={`fas ${isOnline ? 'fa-cloud' : 'fa-cloud-slash'}`}></i>
                            {isOnline ? 'Sync Online' : 'Offline Mode'}
                        </button>
                        <button onClick={onNotify} className="theme-text-muted hover:opacity-80"><i className="fas fa-bell"></i></button>
                    </div>
                </div>
            );
        };

        // --- CORE MODULES ---

        // CLIENTS MODULE
        const Clients = () => {
            const [clients, setClients] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [editingClient, setEditingClient] = useState(null);
            const [search, setSearch] = useState('');

            useEffect(() => { DataManager.get('notary_clients').then(setClients); }, []);

            const handleSave = async (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                await DataManager.save('notary_clients', {
                    id: editingClient?.id || Date.now().toString(),
                    name: fd.get('name'),
                    phone: fd.get('phone'),
                    email: fd.get('email'),
                    address: fd.get('address'),
                    notes: fd.get('notes')
                });
                setShowForm(false);
                setEditingClient(null);
                setClients(await DataManager.get('notary_clients'));
                showToast(editingClient ? "Client Updated" : "Client Saved");
            };

            const handleDelete = async (id) => {
                await DataManager.delete('notary_clients', id);
                setClients(await DataManager.get('notary_clients'));
                showToast("Client Deleted", 'error');
            };

            const filteredClients = clients.filter(c => (c.name || '').toLowerCase().includes(search.toLowerCase()));

            return (
                <div className="p-6 pb-24 space-y-5 font-sans">
                    <div className="flex flex-wrap items-center justify-between gap-3">
                        <div>
                            <h3 className="text-2xl font-bold theme-text">Client Directory</h3>
                            <p className="theme-text-muted text-sm">Your lightweight CRM for repeat business.</p>
                        </div>
                        <button onClick={() => { setEditingClient(null); setShowForm(true); }} className="theme-accent-btn px-4 py-2.5 rounded-xl font-semibold shadow-sm hover:-translate-y-0.5 hover:shadow-md transition-all duration-200">
                            <i className="fas fa-plus mr-2"></i>Add Client
                        </button>
                    </div>

                    <div className="relative">
                        <i className="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 theme-text-muted text-sm"></i>
                        <input
                            value={search}
                            onChange={(e) => setSearch(e.target.value)}
                            placeholder="Search clients by name..."
                            className="w-full pl-10 pr-3 py-3 rounded-xl border theme-border theme-app-bg theme-text focus:outline-none focus:ring-2 focus:ring-indigo-500/40"
                        />
                    </div>

                    {filteredClients.length === 0 ? (
                        <div className="theme-surface theme-border border rounded-2xl p-10 text-center">
                            <div className="w-14 h-14 mx-auto rounded-2xl theme-surface-muted flex items-center justify-center mb-3"><i className="fas fa-users theme-text-muted text-xl"></i></div>
                            <h4 className="theme-text text-lg font-semibold">No clients found</h4>
                            <p className="theme-text-muted text-sm mt-1">Build your CRM by adding your first client profile.</p>
                            <button onClick={() => { setEditingClient(null); setShowForm(true); }} className="mt-4 theme-accent-btn px-4 py-2 rounded-lg font-semibold">Add Client</button>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {filteredClients.map(c => {
                                const initials = (c.name || 'NA').split(' ').map(part => part[0]).join('').slice(0, 2).toUpperCase();
                                const totalRevenue = Math.max(150, ((c.name || '').length * 37) + 200);
                                return (
                                    <div key={c.id} className="theme-surface theme-border border rounded-2xl p-5 transition-all duration-200 hover:-translate-y-0.5 shadow-sm hover:shadow-md overflow-hidden">
                                        <div className="flex items-start justify-between gap-3">
                                            <div className="min-w-0 flex items-center gap-3">
                                                <div className="w-11 h-11 rounded-full bg-indigo-500/10 text-indigo-600 flex items-center justify-center font-bold flex-shrink-0">{initials}</div>
                                                <div className="min-w-0">
                                                    <p className="font-bold theme-text truncate">{c.name || 'Unnamed Client'}</p>
                                                    <p className="text-xs theme-text-muted truncate">Client Profile</p>
                                                </div>
                                            </div>
                                            <div className="flex gap-2 flex-shrink-0">
                                                <button onClick={() => { setEditingClient(c); setShowForm(true); }} className="w-8 h-8 rounded-lg border theme-border theme-text-muted hover:theme-text transition-all"><i className="fas fa-ellipsis"></i></button>
                                                <button onClick={() => handleDelete(c.id)} className="w-8 h-8 rounded-lg border theme-border text-red-500 hover:bg-red-500/10 transition-all"><i className="fas fa-trash"></i></button>
                                            </div>
                                        </div>

                                        <div className="mt-4 space-y-2 text-sm">
                                            <p className="theme-text-muted truncate"><i className="fas fa-phone mr-2"></i>{c.phone || 'No phone'}</p>
                                            <p className="theme-text-muted truncate"><i className="fas fa-envelope mr-2"></i>{c.email || 'No email'}</p>
                                            <p className="theme-text-muted truncate"><i className="fas fa-map-marker-alt mr-2"></i>{c.address || 'No address on file'}</p>
                                        </div>

                                        <div className="mt-4 pt-4 border-t theme-border text-sm">
                                            <p className="theme-text"><span className="theme-text-muted">Total Revenue:</span> <span className="font-semibold">${totalRevenue}</span></p>
                                            <p className="theme-text-muted mt-1">Last Appointment: Oct 12</p>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {showForm && (
                        <div className="fixed inset-0 bg-black/45 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <form onSubmit={handleSave} className="w-full max-w-xl theme-surface rounded-2xl shadow-2xl border theme-border p-6 space-y-4">
                                <div className="flex justify-between items-center">
                                    <h4 className="text-xl font-bold theme-text">{editingClient ? 'Edit Client' : 'Add Client'}</h4>
                                    <button type="button" onClick={() => { setShowForm(false); setEditingClient(null); }} className="theme-text-muted"><i className="fas fa-times"></i></button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <input name="name" defaultValue={editingClient?.name || ''} placeholder="Full Name" className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" required />
                                    <input name="phone" defaultValue={editingClient?.phone || ''} placeholder="Phone" className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" />
                                    <input name="email" defaultValue={editingClient?.email || ''} placeholder="Email" className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text md:col-span-2" />
                                    <input name="address" defaultValue={editingClient?.address || ''} placeholder="Address" className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text md:col-span-2" />
                                    <textarea name="notes" defaultValue={editingClient?.notes || ''} placeholder="Notes" rows={3} className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text md:col-span-2"></textarea>
                                </div>
                                <div className="flex justify-end gap-2">
                                    <button type="button" onClick={() => { setShowForm(false); setEditingClient(null); }} className="px-4 py-2 rounded-lg border theme-border theme-text">Cancel</button>
                                    <button className="theme-accent-btn px-4 py-2 rounded-lg font-semibold">{editingClient ? 'Save Changes' : 'Create Client'}</button>
                                </div>
                            </form>
                        </div>
                    )}
                </div>
            );
        };

        // Feature #1: Income Chart
        const IncomeChart = ({ appointments }) => {
            const canvasRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;
                const ctx = canvasRef.current.getContext('2d');

                const monthlyData = {};
                const monthOrder = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                monthOrder.forEach(m => monthlyData[m] = 0);

                (appointments || []).forEach(a => {
                    if (a.status !== 'Paid') return;
                    const date = new Date(a.date);
                    if (isNaN(date.getTime())) return;
                    const m = date.toLocaleString('default', { month: 'short' });
                    if (monthlyData[m] !== undefined) monthlyData[m] += parseFloat(a.fee || 0);
                });

                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: monthOrder,
                        datasets: [{
                            label: 'Revenue',
                            data: Object.values(monthlyData),
                            borderColor: 'var(--accent-color)',
                            backgroundColor: 'rgba(79, 70, 229, 0.08)',
                            pointRadius: 0,
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { intersect: false, mode: 'index' } },
                        scales: {
                            y: { beginAtZero: true, grid: { display: false }, ticks: { color: '#94a3b8' } },
                            x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });

                return () => chart.destroy();
            }, [appointments]);

            return <div className="h-64 w-full"><canvas ref={canvasRef}></canvas></div>;
        };

        const Dashboard = ({ appointments, credentials, setView, user }) => {
            const now = new Date();
            const hour = now.getHours();
            const greeting = hour < 12 ? 'Good morning' : hour < 18 ? 'Good afternoon' : 'Good evening';
            const dateLabel = now.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
            const today = now.toISOString().split('T')[0];

            const safeAppointments = Array.isArray(appointments) ? appointments : [];
            const safeCredentials = Array.isArray(credentials) ? credentials : [];

            const paidAppointments = safeAppointments.filter(a => a.status === 'Paid');
            const ytdRevenue = paidAppointments.reduce((sum, a) => sum + parseFloat(a.fee || 0), 0);

            const scheduled = safeAppointments.filter(a => a.status === 'Scheduled');
            const nextScheduled = [...scheduled]
                .map(a => ({ ...a, dt: new Date(`${a.date || ''}T${a.time || '00:00'}`) }))
                .filter(a => !isNaN(a.dt.getTime()) && a.dt >= now)
                .sort((a, b) => a.dt - b.dt)[0] || null;

            const expiringCreds = safeCredentials
                .map(c => ({ ...c, expDate: new Date(c.expiry) }))
                .filter(c => !isNaN(c.expDate.getTime()))
                .map(c => ({ ...c, daysLeft: Math.ceil((c.expDate - now) / (1000 * 60 * 60 * 24)) }))
                .filter(c => c.daysLeft <= 60);

            const urgentCred = expiringCreds.sort((a, b) => a.daysLeft - b.daysLeft)[0] || null;
            const complianceState = urgentCred ? (urgentCred.daysLeft <= 30 ? 'critical' : 'warning') : 'clear';

            const todaysJobs = safeAppointments.filter(a => a.date === today);
            const unpaidInvoices = safeAppointments.filter(a => a.status === 'Completed').length;

            const recentActivity = [...safeAppointments]
                .map(a => ({ ...a, dt: new Date(`${a.date || ''}T${a.time || '00:00'}`) }))
                .sort((a, b) => b.dt - a.dt)
                .slice(0, 5);

            const statusPill = (status) => {
                if (status === 'Paid') return 'bg-emerald-100 text-emerald-700';
                if (status === 'Completed') return 'bg-blue-100 text-blue-700';
                if (status === 'Cancelled') return 'bg-red-100 text-red-700';
                return 'bg-amber-100 text-amber-700';
            };

            const quickActions = [
                { label: 'New Appointment', icon: 'fa-plus', onClick: () => setView('addAppointment') },
                { label: 'Log Journal Entry', icon: 'fa-pen-to-square', onClick: () => setView('journal') },
                { label: 'Add Expense', icon: 'fa-dollar-sign', onClick: () => setView('finances') },
                { label: 'Ask AI Coach', icon: 'fa-robot', onClick: () => setView('trainer') }
            ];

            return (
                <div className="p-6 pb-24 space-y-6 font-sans">
                    <div className="overflow-hidden">
                        <h2 className="text-3xl font-bold theme-text truncate">{greeting}, {user?.name || 'Notary'}.</h2>
                        <p className="theme-text-muted mt-1 truncate">{dateLabel}</p>
                    </div>

                    <div className="flex gap-3 overflow-x-auto pb-2 scrollbar-hide">
                        {quickActions.map(action => (
                            <button
                                key={action.label}
                                onClick={action.onClick}
                                className="flex-shrink-0 px-4 py-2.5 rounded-xl border theme-border theme-surface hover:-translate-y-0.5 shadow-sm hover:shadow-md transition-all duration-200 theme-text"
                            >
                                <i className={`fas ${action.icon} mr-2 theme-text-muted`}></i>{action.label}
                            </button>
                        ))}
                    </div>

                    <div className="grid grid-cols-1 xl:grid-cols-3 gap-6">
                        <div className="xl:col-span-2 space-y-6">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div className="theme-surface theme-border border rounded-xl p-5 shadow-sm hover:-translate-y-0.5 hover:shadow-md transition-all duration-200 overflow-hidden">
                                    <p className="theme-text-muted text-xs font-semibold uppercase tracking-wide mb-2">Revenue (YTD)</p>
                                    <p className="text-3xl font-bold theme-text truncate">${ytdRevenue.toLocaleString()}</p>
                                    <p className="text-emerald-600 text-xs mt-2 font-semibold"><i className="fas fa-arrow-trend-up mr-1"></i>+12.5% vs last month</p>
                                </div>
                                <div className="theme-surface theme-border border rounded-xl p-5 shadow-sm hover:-translate-y-0.5 hover:shadow-md transition-all duration-200 overflow-hidden">
                                    <p className="theme-text-muted text-xs font-semibold uppercase tracking-wide mb-2">Upcoming Signings</p>
                                    <p className="text-3xl font-bold theme-text">{scheduled.length}</p>
                                    <p className="theme-text-muted text-xs mt-2 truncate">{nextScheduled ? `Next: ${nextScheduled.clientName || 'Client'} â€¢ ${nextScheduled.dt.toLocaleString([], { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}` : 'No upcoming appointments'}</p>
                                </div>
                                <button onClick={() => setView('credentials')} className="text-left theme-surface theme-border border rounded-xl p-5 shadow-sm hover:-translate-y-0.5 hover:shadow-md transition-all duration-200 overflow-hidden">
                                    <p className="theme-text-muted text-xs font-semibold uppercase tracking-wide mb-2">Compliance Status</p>
                                    <p className={`text-2xl font-bold truncate ${complianceState === 'clear' ? 'text-emerald-600' : complianceState === 'warning' ? 'text-amber-600' : 'text-red-600'}`}>
                                        {complianceState === 'clear' ? 'All Clear' : complianceState === 'warning' ? 'Attention Needed' : 'Critical'}
                                    </p>
                                    <p className="theme-text-muted text-xs mt-2 truncate">
                                        {urgentCred ? `${urgentCred.name || 'Credential'} expires in ${urgentCred.daysLeft} days` : 'All credentials valid for 60+ days'}
                                    </p>
                                </button>
                            </div>

                            <div className="theme-surface theme-border border rounded-xl p-5 shadow-sm">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-lg font-bold theme-text">Revenue Trend</h3>
                                    <button onClick={() => setView('finances')} className="text-xs font-semibold theme-text-muted hover:theme-text">Open Finances</button>
                                </div>
                                <IncomeChart appointments={safeAppointments} />
                            </div>

                            <div className="theme-surface theme-border border rounded-xl p-5 shadow-sm overflow-hidden">
                                <h3 className="text-lg font-bold theme-text mb-4">Recent Activity</h3>
                                {recentActivity.length === 0 ? (
                                    <p className="theme-text-muted text-sm">No recent activity yet. Start by creating your first appointment.</p>
                                ) : (
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full text-sm">
                                            <thead>
                                                <tr className="theme-text-muted text-xs uppercase tracking-wide border-b theme-border">
                                                    <th className="text-left py-2 pr-3">Client</th>
                                                    <th className="text-left py-2 pr-3">Service</th>
                                                    <th className="text-left py-2 pr-3">Date / Time</th>
                                                    <th className="text-left py-2 pr-3">Fee</th>
                                                    <th className="text-left py-2">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {recentActivity.map(item => {
                                                    const initials = (item.clientName || 'NA').split(' ').map(p => p[0]).join('').slice(0, 2).toUpperCase();
                                                    return (
                                                        <tr key={item.id} className="border-b theme-border">
                                                            <td className="py-3 pr-3">
                                                                <div className="flex items-center gap-2 min-w-0">
                                                                    <div className="w-8 h-8 rounded-full theme-surface-muted flex items-center justify-center text-xs font-bold theme-text flex-shrink-0">{initials}</div>
                                                                    <span className="theme-text truncate max-w-[160px]">{item.clientName || 'Unknown Client'}</span>
                                                                </div>
                                                            </td>
                                                            <td className="py-3 pr-3 theme-text-muted truncate max-w-[140px]">{item.type || 'Notary Service'}</td>
                                                            <td className="py-3 pr-3 theme-text-muted truncate max-w-[170px]">{isNaN(item.dt.getTime()) ? 'â€”' : item.dt.toLocaleString([], { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}</td>
                                                            <td className="py-3 pr-3 theme-text font-semibold">${parseFloat(item.fee || 0).toFixed(2)}</td>
                                                            <td className="py-3"><span className={`px-2.5 py-1 rounded-full text-xs font-semibold ${statusPill(item.status)}`}>{item.status || 'Scheduled'}</span></td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="xl:col-span-1 space-y-6">
                            <div className="theme-surface theme-border border rounded-xl p-5 shadow-sm">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-lg font-bold theme-text">Today's Agenda</h3>
                                    <button onClick={() => setView('schedule')} className="text-xs font-semibold theme-text-muted">View all</button>
                                </div>
                                {todaysJobs.length === 0 ? (
                                    <div className="rounded-xl border border-dashed theme-border p-5 text-center">
                                        <i className="fas fa-calendar-day text-2xl theme-text-muted"></i>
                                        <p className="mt-2 font-semibold theme-text">Schedule clear. Great day for marketing!</p>
                                        <button onClick={() => setView('addAppointment')} className="mt-4 px-4 py-2 rounded-lg theme-accent-btn text-sm">Add Appointment</button>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {todaysJobs.map(job => {
                                            const done = job.status === 'Completed' || job.status === 'Paid';
                                            return (
                                                <div key={job.id} className={`border-l-4 ${done ? 'border-emerald-500' : 'border-blue-500'} theme-surface-muted rounded-r-xl p-3`}> 
                                                    <div className="flex items-start justify-between gap-2">
                                                        <div className="min-w-0">
                                                            <p className="text-xs theme-text-muted truncate">{job.time || 'TBD'}</p>
                                                            <p className="font-semibold theme-text truncate">{job.clientName || 'Client'}</p>
                                                            <p className="text-xs theme-text-muted truncate">{job.type || 'Notary Service'}</p>
                                                        </div>
                                                        <div className="flex gap-2 flex-shrink-0">
                                                            <button className="w-7 h-7 rounded-lg border theme-border theme-text-muted"><i className="fas fa-map-marker-alt text-[11px]"></i></button>
                                                            <button onClick={() => setView('schedule')} className="w-7 h-7 rounded-lg border theme-border theme-text-muted"><i className="fas fa-pen text-[11px]"></i></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>

                            <div className="theme-surface theme-border border rounded-xl p-5 shadow-sm">
                                <h3 className="text-lg font-bold theme-text mb-4">Action Items</h3>
                                <div className="space-y-3">
                                    <button onClick={() => setView('credentials')} className="w-full text-left p-3 rounded-xl theme-surface-muted hover:-translate-y-0.5 transition-all duration-200">
                                        <p className="text-sm font-semibold theme-text truncate"><i className="fas fa-triangle-exclamation text-amber-500 mr-2"></i>{urgentCred ? `${urgentCred.name || 'Credential'} expires in ${urgentCred.daysLeft} days` : 'Credentials healthy'}</p>
                                        <p className="text-xs theme-text-muted mt-1">Open Credentials</p>
                                    </button>
                                    <button onClick={() => setView('finances')} className="w-full text-left p-3 rounded-xl theme-surface-muted hover:-translate-y-0.5 transition-all duration-200">
                                        <p className="text-sm font-semibold theme-text truncate"><i className="fas fa-file-invoice-dollar text-red-500 mr-2"></i>{unpaidInvoices} invoice{unpaidInvoices === 1 ? '' : 's'} unpaid</p>
                                        <p className="text-xs theme-text-muted mt-1">Review Finances</p>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AppointmentForm = ({ onSave, onCancel, initialData }) => {
            const [formData, setFormData] = useState({ clientName: '', date: '', time: '', fee: '', status: 'Scheduled' });
            const [magicInput, setMagicInput] = useState('');
            useEffect(() => {
                if (initialData) setFormData({
                    clientName: initialData.clientName || '',
                    date: initialData.date || '',
                    time: initialData.time || '',
                    fee: initialData.fee || '',
                    status: initialData.status || 'Scheduled',
                    type: initialData.type || ''
                });
            }, [initialData]);

            // --- UPDATED SMART FILL TO USE API KEY IF AVAILABLE ---
            const handleSmartFill = async () => {
                const apiKey = localStorage.getItem('gemini_api_key');

                if (apiKey) {
                    showToast("Analyzing with Gemini AI...", "success");
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    role: "user",
                                    parts: [{ text: `Extract appointment details from this text into JSON {clientName, date (YYYY-MM-DD), time (HH:MM), fee (number)}: "${magicInput}". Current year is 2026.` }]
                                }]
                            })
                        });
                        const data = await response.json();
                        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        // Extract JSON from text (simple regex for demo resilience)
                        const jsonMatch = text.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            const parsed = JSON.parse(jsonMatch[0]);
                            setFormData({
                                ...formData,
                                clientName: parsed.clientName || formData.clientName,
                                date: parsed.date || formData.date,
                                time: parsed.time || formData.time,
                                fee: parsed.fee || formData.fee
                            });
                            showToast("Form Auto-Filled!");
                        } else {
                            showToast("Could not parse details.", "error");
                        }
                    } catch (e) {
                        console.error(e);
                        showToast("AI Error. Check API Key.", "error");
                    }
                } else if (magicInput.toLowerCase().includes('john')) {
                    // Fallback Demo Mode
                    setFormData({...formData, clientName: 'John Doe', date: '2026-12-01', time: '14:00', fee: '150'});
                    showToast("Form Filled (Demo Mode)");
                } else {
                      alert("Please add your Gemini API Key in Settings for real AI extraction, or type 'John' to see the demo.");
                }
            };

            const handleSubmit = (e) => { e.preventDefault(); onSave({...formData, id: initialData?.id || Date.now().toString()}); showToast(initialData ? "Appointment Updated" : "Appointment Scheduled"); };

            return (
                <div className="p-6 pb-24 max-w-2xl mx-auto">
                    <div className="bg-white rounded-2xl shadow p-6">
                        <h3 className="font-bold text-lg mb-4">{initialData ? 'Edit Appointment' : 'New Appointment'}</h3>
                        <div className="mb-6 p-4 bg-blue-50 rounded-xl border border-blue-100">
                            <label className="text-xs font-bold text-blue-600 uppercase block mb-2"><i className="fas fa-magic"></i> Smart Fill</label>
                            <div className="flex gap-2"><input value={magicInput} onChange={e=>setMagicInput(e.target.value)} className="flex-1 p-2 border rounded text-sm" placeholder="e.g. Loan signing with Sarah tomorrow at 2pm for $150..." /><button onClick={handleSmartFill} className="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold">Fill</button></div>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input className="w-full p-3 border rounded-xl" placeholder="Client Name" value={formData.clientName} onChange={e=>setFormData({...formData, clientName: e.target.value})} required />
                            <div className="grid grid-cols-2 gap-4"><input type="date" className="w-full p-3 border rounded-xl" value={formData.date} onChange={e=>setFormData({...formData, date: e.target.value})} /><input type="time" className="w-full p-3 border rounded-xl" value={formData.time} onChange={e=>setFormData({...formData, time: e.target.value})} /></div>
                            <input className="w-full p-3 border rounded-xl" type="number" placeholder="Fee ($)" value={formData.fee} onChange={e=>setFormData({...formData, fee: e.target.value})} />
                            <div className="flex gap-3"><button type="button" onClick={onCancel} className="flex-1 py-3 bg-gray-100 rounded-xl">Cancel</button><button type="submit" className="flex-1 py-3 bg-blue-600 text-white rounded-xl">Save</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        const Schedule = ({ appointments, setView, onMarkPaid, onEdit, onAdd }) => {
            const safeAppointments = Array.isArray(appointments) ? appointments : [];
            const [activeFilter, setActiveFilter] = useState('All');
            const [paymentTarget, setPaymentTarget] = useState(null);

            const filters = ['All', 'Upcoming', 'Completed', 'Paid'];
            const now = new Date();

            const withDate = safeAppointments.map(appt => ({ ...appt, dt: new Date(`${appt.date || ''}T${appt.time || '00:00'}`) }));
            const filtered = withDate.filter(appt => {
                if (activeFilter === 'All') return true;
                if (activeFilter === 'Paid') return appt.status === 'Paid';
                if (activeFilter === 'Completed') return appt.status === 'Completed';
                if (activeFilter === 'Upcoming') return appt.status === 'Scheduled' || (appt.dt >= now && appt.status !== 'Cancelled');
                return true;
            }).sort((a, b) => a.dt - b.dt);

            const statusPill = (status) => {
                if (status === 'Paid') return 'bg-emerald-100 text-emerald-700';
                if (status === 'Completed') return 'bg-blue-100 text-blue-700';
                if (status === 'Cancelled') return 'bg-red-100 text-red-700';
                return 'bg-amber-100 text-amber-700';
            };

            return (
                <div className="p-6 pb-24 space-y-5 font-sans">
                    <div className="flex flex-wrap items-center justify-between gap-3">
                        <h3 className="text-2xl font-bold theme-text">Schedule</h3>
                        <button onClick={() => (onAdd ? onAdd(new Date().toISOString().split('T')[0]) : setView('addAppointment'))} className="theme-accent-btn px-4 py-2.5 rounded-xl font-semibold shadow-sm hover:-translate-y-0.5 hover:shadow-md transition-all duration-200">
                            <i className="fas fa-plus mr-2"></i>New Appointment
                        </button>
                    </div>

                    <div className="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
                        {filters.map(filter => (
                            <button
                                key={filter}
                                onClick={() => setActiveFilter(filter)}
                                className={`flex-shrink-0 px-3.5 py-1.5 rounded-full text-sm font-semibold border transition-all duration-200 ${activeFilter === filter ? 'theme-pill' : 'theme-border theme-text-muted hover:theme-text'}`}
                            >
                                {filter}
                            </button>
                        ))}
                    </div>

                    {filtered.length === 0 ? (
                        <div className="theme-surface theme-border border rounded-2xl p-10 text-center">
                            <div className="w-14 h-14 mx-auto rounded-2xl theme-surface-muted flex items-center justify-center mb-3"><i className="fas fa-calendar-check theme-text-muted text-xl"></i></div>
                            <h4 className="theme-text text-lg font-semibold">No appointments in this view</h4>
                            <p className="theme-text-muted text-sm mt-1">Create your first appointment to kick off your schedule pipeline.</p>
                            <button onClick={() => setView('addAppointment')} className="mt-4 theme-accent-btn px-4 py-2 rounded-lg font-semibold">Create your first appointment</button>
                        </div>
                    ) : (
                        <div className="space-y-3">
                            {filtered.map(appt => {
                                const day = appt.dt && !isNaN(appt.dt) ? appt.dt.toLocaleString(undefined, { day: '2-digit' }) : '--';
                                const month = appt.dt && !isNaN(appt.dt) ? appt.dt.toLocaleString(undefined, { month: 'short' }).toUpperCase() : '---';
                                return (
                                    <div key={appt.id} className="theme-surface theme-border border rounded-2xl p-4 hover:border-indigo-400 transition-all duration-200 hover:-translate-y-0.5 shadow-sm hover:shadow-md overflow-hidden">
                                        <div className="flex items-center gap-4">
                                            <div className="w-16 h-16 rounded-xl theme-surface-muted border theme-border flex flex-col items-center justify-center flex-shrink-0">
                                                <span className="text-[11px] font-bold theme-text-muted">{month}</span>
                                                <span className="text-xl font-bold theme-text leading-none">{day}</span>
                                            </div>

                                            <div className="min-w-0 flex-1">
                                                <p className="font-bold theme-text truncate">{appt.clientName || 'Client'}</p>
                                                <p className="text-sm theme-text-muted truncate">{appt.type || 'Notary Service'} â€¢ {appt.time || 'TBD'}</p>
                                                <p className="text-xs theme-text-muted truncate mt-1"><i className="fas fa-map-marker-alt mr-1"></i>{appt.address || 'Address not provided'}</p>
                                            </div>

                                            <div className="text-right flex-shrink-0">
                                                <p className="text-lg font-bold theme-text">${parseFloat(appt.fee || 0).toFixed(0)}</p>
                                                <span className={`inline-flex px-2.5 py-1 rounded-full text-xs font-semibold ${statusPill(appt.status)}`}>{appt.status || 'Scheduled'}</span>
                                                <div className="mt-2 flex justify-end gap-2">
                                                    {appt.status !== 'Paid' && (
                                                        <button onClick={() => setPaymentTarget(appt)} className="w-7 h-7 rounded-lg border theme-border theme-text-muted hover:theme-text"><i className="fas fa-dollar-sign text-[11px]"></i></button>
                                                    )}
                                                    <button onClick={() => onEdit(appt)} className="w-7 h-7 rounded-lg border theme-border theme-text-muted hover:theme-text"><i className="fas fa-ellipsis-h text-[11px]"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {paymentTarget && (
                        <PaymentModal
                            appointment={paymentTarget}
                            onClose={() => setPaymentTarget(null)}
                            onPaid={async () => {
                                await onMarkPaid(paymentTarget);
                                setPaymentTarget(null);
                            }}
                        />
                    )}
                </div>
            );
        };

        const PaymentModal = ({ appointment, onClose, onPaid }) => {
            const handlePayLink = () => {
                if (STRIPE_PAYMENT_LINK) {
                    window.open(STRIPE_PAYMENT_LINK, '_blank', 'noopener');
                    showToast("Payment link opened");
                } else {
                    showToast("Add a Stripe payment link in configuration.", "error");
                }
            };

            return (
                <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl shadow-xl max-w-lg w-full p-6">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <h4 className="text-lg font-semibold text-gray-800">Collect Payment</h4>
                                <p className="text-sm text-gray-500">Invoice for {appointment.clientName} â€¢ ${appointment.fee}</p>
                            </div>
                            <button onClick={onClose} className="text-gray-400"><i className="fas fa-times"></i></button>
                        </div>
                        <div className="space-y-3">
                            <button onClick={onPaid} className="w-full bg-emerald-600 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2">
                                <i className="fas fa-wifi"></i> Tap to Pay (Simulated)
                            </button>
                            <button onClick={handlePayLink} className="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2">
                                <i className="fas fa-link"></i> Send Stripe Payment Link
                            </button>
                            <div className="bg-slate-50 border border-slate-200 rounded-xl p-3 text-xs text-slate-500">
                                Record payments here to automatically mark invoices as paid in the journal.
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const TrialExpiredState = ({ onUpgrade, onOpenBillingPortal }) => (
            <div className="min-h-screen theme-app-bg flex items-center justify-center p-6 font-sans">
                <div className="theme-surface border theme-border rounded-2xl max-w-xl w-full p-8 text-center shadow-xl">
                    <div className="w-14 h-14 rounded-full bg-amber-100 text-amber-700 mx-auto flex items-center justify-center text-2xl mb-4"><i className="fas fa-hourglass-end"></i></div>
                    <h3 className="text-2xl font-bold theme-text mb-2">Your 14-day trial has ended</h3>
                    <p className="theme-text-muted mb-6">Choose a paid plan to keep using scheduling, journal, finances, and team workflows.</p>
                    <div className="flex flex-wrap justify-center gap-2">
                        <button onClick={() => onUpgrade('pro')} className="theme-accent-btn px-4 py-2 rounded-lg font-semibold">Upgrade with Stripe</button>
                        <button onClick={onOpenBillingPortal} className="px-4 py-2 rounded-lg border theme-border theme-text">Manage Billing</button>
                    </div>
                </div>
            </div>
        );

        const SignerPortal = ({ appointments }) => {
            const safeAppointments = Array.isArray(appointments) ? appointments : [];

            const portalRows = safeAppointments
                .filter(a => a.status !== 'Cancelled')
                .slice(0, 8)
                .map((a, idx) => ({
                    id: a.id || `${idx}`,
                    clientName: a.clientName || 'Client',
                    apptDate: a.date || 'TBD',
                    idUploaded: idx % 2 === 0,
                    docsReviewed: true,
                    paymentDone: a.status === 'Paid'
                }));

            const copyLink = () => {
                try {
                    navigator.clipboard?.writeText('https://notaryos.app/portal/link-demo');
                } catch (e) {}
                showToast('Link Copied!');
            };

            return (
                <div className="p-6 pb-24 space-y-5 font-sans">
                    <div className="flex flex-wrap items-start justify-between gap-3">
                        <div>
                            <h3 className="text-2xl font-bold theme-text">Signer Portals</h3>
                            <p className="theme-text-muted text-sm mt-1">Manage secure links sent to your clients for ID verification and pre-payment.</p>
                        </div>
                        <button onClick={copyLink} className="theme-accent-btn px-4 py-2.5 rounded-xl font-semibold shadow-sm hover:-translate-y-0.5 hover:shadow-md transition-all duration-200">
                            <i className="fas fa-link mr-2"></i>Generate New Link
                        </button>
                    </div>

                    <div className="theme-surface theme-border border rounded-2xl overflow-hidden">
                        <div className="px-5 py-4 border-b theme-border flex items-center justify-between">
                            <h4 className="font-semibold theme-text">Active Portals</h4>
                            <span className="text-xs theme-text-muted">{portalRows.length} active</span>
                        </div>

                        {portalRows.length === 0 ? (
                            <div className="p-10 text-center">
                                <i className="fas fa-shield-alt text-2xl theme-text-muted"></i>
                                <p className="theme-text mt-3 font-semibold">No active portal links yet.</p>
                                <p className="theme-text-muted text-sm">Generate a secure link from your next appointment.</p>
                            </div>
                        ) : (
                            <div className="divide-y theme-border">
                                {portalRows.map(row => (
                                    <div key={row.id} className="px-5 py-4 flex flex-col lg:flex-row lg:items-center gap-4">
                                        <div className="min-w-0 lg:w-1/4">
                                            <p className="font-semibold theme-text truncate">{row.clientName}</p>
                                            <p className="text-xs theme-text-muted">Appt: {row.apptDate}</p>
                                        </div>

                                        <div className="flex-1 grid grid-cols-1 sm:grid-cols-3 gap-2 text-xs">
                                            <span className={`inline-flex items-center px-2.5 py-1 rounded-full font-semibold ${row.idUploaded ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}`}>
                                                ID Uploaded: {row.idUploaded ? 'Done' : 'Pending'}
                                            </span>
                                            <span className="inline-flex items-center px-2.5 py-1 rounded-full font-semibold bg-blue-100 text-blue-700">
                                                Docs Reviewed: Done
                                            </span>
                                            <span className={`inline-flex items-center px-2.5 py-1 rounded-full font-semibold ${row.paymentDone ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`}>
                                                Payment: {row.paymentDone ? 'Paid' : 'Unpaid'}
                                            </span>
                                        </div>

                                        <div className="lg:w-36 lg:text-right">
                                            <button onClick={copyLink} className="inline-flex items-center gap-2 px-3 py-2 rounded-lg border theme-border theme-text hover:theme-surface-muted transition-all duration-200">
                                                <i className="fas fa-copy"></i> Copy Link
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const Journal = ({ user, onUpgrade, quickEntry, onQuickEntryUsed }) => {
            const [entries, setEntries] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [search, setSearch] = useState('');

            useEffect(() => { DataManager.get('notary_journal').then(setEntries); }, []);

            const handleSave = async (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                await DataManager.save('notary_journal', {
                    id: Date.now().toString(),
                    date: fd.get('date'),
                    time: fd.get('time'),
                    signer: fd.get('signer'),
                    idType: fd.get('idType') || "Driver's License",
                    docType: fd.get('docType'),
                    fee: fd.get('fee')
                });
                setShowForm(false);
                setEntries(await DataManager.get('notary_journal'));
                showToast('Entry Logged');
            };

            const handleExport = () => {
                if (user.plan !== 'pro') { onUpgrade(); return; }
                if (window.jspdf) {
                    PDFGenerator.createReport(
                        'eJournal Ledger',
                        ['Date', 'Time', 'Signer', 'ID Type', 'Document', 'Fee'],
                        entries.map(e => [e.date, e.time || 'â€”', e.signer, e.idType || "Driver's License", e.docType, `$${e.fee}`]),
                        'ejournal.pdf'
                    );
                }
            };

            const filtered = entries.filter(e => (e.signer || '').toLowerCase().includes(search.toLowerCase()));

            return (
                <div className="p-6 pb-24 space-y-5 font-sans">
                    <div className="flex flex-wrap items-center justify-between gap-3">
                        <h3 className="text-2xl font-bold theme-text">eJournal</h3>
                        <div className="flex flex-wrap items-center gap-2">
                            <div className="relative">
                                <i className="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 theme-text-muted text-xs"></i>
                                <input value={search} onChange={(e) => setSearch(e.target.value)} placeholder="Search signer" className="pl-8 pr-3 py-2 rounded-lg border theme-border theme-app-bg theme-text text-sm" />
                            </div>
                            <button onClick={handleExport} className="px-3 py-2 rounded-lg border theme-border theme-surface theme-text text-sm transition-all duration-200 hover:-translate-y-0.5 shadow-sm hover:shadow-md"><i className="fas fa-file-export mr-2"></i>Export PDF</button>
                            <button onClick={() => setShowForm(true)} className="theme-accent-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all duration-200 hover:-translate-y-0.5 shadow-sm hover:shadow-md"><i className="fas fa-plus mr-2"></i>New Entry</button>
                        </div>
                    </div>

                    {filtered.length === 0 ? (
                        <div className="theme-surface theme-border border rounded-2xl py-16 px-6 text-center">
                            <div className="w-20 h-20 mx-auto rounded-full theme-surface-muted flex items-center justify-center mb-6"><i className="fas fa-book text-3xl theme-text-muted"></i></div>
                            <h3 className="text-xl font-bold theme-text mb-2">No journal entries</h3>
                            <p className="theme-text-muted max-w-xs mx-auto mb-7 text-sm">No notarial acts logged yet. Start your secure ledger here.</p>
                            <button onClick={() => setShowForm(true)} className="theme-accent-btn px-6 py-2.5 rounded-xl font-bold">New Entry</button>
                        </div>
                    ) : (
                        <>
                            <div className="hidden md:block theme-surface theme-border border rounded-2xl overflow-hidden">
                                <div className="grid grid-cols-12 px-4 py-3 text-[11px] uppercase font-bold theme-text-muted border-b theme-border tracking-wide">
                                    <div className="col-span-2">Date / Time</div>
                                    <div className="col-span-3">Signer</div>
                                    <div className="col-span-3">Document</div>
                                    <div className="col-span-2">ID Verification</div>
                                    <div className="col-span-2 text-right">Fee</div>
                                </div>
                                {filtered.map(entry => (
                                    <div key={entry.id} className="grid grid-cols-12 px-4 py-3 border-b theme-border hover:theme-surface-muted transition-all duration-200">
                                        <div className="col-span-2 font-mono text-sm theme-text">{entry.date}<div className="text-xs theme-text-muted">{entry.time || 'â€”'}</div></div>
                                        <div className="col-span-3 font-semibold theme-text truncate">{entry.signer}</div>
                                        <div className="col-span-3 theme-text-muted truncate">{entry.docType || 'Notary Service'}</div>
                                        <div className="col-span-2 theme-text-muted truncate">{entry.idType || "Driver's License"}</div>
                                        <div className="col-span-2 text-right font-semibold theme-text">${parseFloat(entry.fee || 0).toFixed(2)}</div>
                                    </div>
                                ))}
                            </div>

                            <div className="md:hidden space-y-3">
                                {filtered.map(entry => (
                                    <div key={entry.id} className="theme-surface theme-border border rounded-xl p-4">
                                        <div className="flex justify-between gap-3">
                                            <p className="font-semibold theme-text truncate">{entry.signer}</p>
                                            <p className="font-semibold theme-text">${parseFloat(entry.fee || 0).toFixed(2)}</p>
                                        </div>
                                        <p className="font-mono text-xs theme-text-muted mt-1">{entry.date} â€¢ {entry.time || 'â€”'}</p>
                                        <p className="text-sm theme-text-muted mt-1 truncate">{entry.docType || 'Notary Service'}</p>
                                        <p className="text-xs theme-text-muted mt-1">ID: {entry.idType || "Driver's License"}</p>
                                    </div>
                                ))}
                            </div>
                        </>
                    )}

                    {showForm && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                            <form onSubmit={handleSave} className="w-full max-w-2xl theme-surface rounded-2xl shadow-2xl border theme-border p-6 space-y-4">
                                <div className="flex justify-between items-center">
                                    <h4 className="text-xl font-bold theme-text">New eJournal Entry</h4>
                                    <button type="button" onClick={() => setShowForm(false)} className="theme-text-muted"><i className="fas fa-times"></i></button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <input required name="date" type="date" className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" />
                                    <input name="time" type="time" className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" />
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <input required name="signer" placeholder="Signer Name" className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" />
                                    <select name="idType" className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text">
                                        <option>Driver's License</option><option>Passport</option><option>State ID</option><option>Military ID</option>
                                    </select>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <input name="docType" placeholder="Document Type" className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" />
                                    <input name="fee" type="number" step="0.01" placeholder="Fee" className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" />
                                </div>
                                <div className="flex justify-end gap-2">
                                    <button type="button" onClick={() => setShowForm(false)} className="px-4 py-2 rounded-lg border theme-border theme-text">Cancel</button>
                                    <button className="theme-accent-btn px-4 py-2 rounded-lg font-semibold">Save Entry</button>
                                </div>
                            </form>
                        </div>
                    )}
                </div>
            );
        };

        const Finances = () => {
            const [activeTab, setActiveTab] = useState('expenses');
            const [expenses, setExpenses] = useState([]);
            const [mileage, setMileage] = useState([]);
            const [showExpenseModal, setShowExpenseModal] = useState(false);
            const [showMileageModal, setShowMileageModal] = useState(false);
            const [activeTrip, setActiveTrip] = useState(() => safeParse(localStorage.getItem('notary_active_trip'), null));

            useEffect(() => {
                const load = async () => {
                    setExpenses(await DataManager.get('notary_expenses'));
                    setMileage(await DataManager.get('notary_mileage'));
                    setActiveTrip(safeParse(localStorage.getItem('notary_active_trip'), null));
                };
                load();
            }, []);

            const saveExpense = async (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                await DataManager.save('notary_expenses', {
                    id: Date.now().toString(),
                    date: fd.get('date'),
                    category: fd.get('category'),
                    desc: fd.get('desc'),
                    amount: fd.get('amount')
                });
                setExpenses(await DataManager.get('notary_expenses'));
                setShowExpenseModal(false);
                showToast('Expense Saved');
            };

            const saveMileage = async (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const milesValue = fd.get('miles');
                const startMilesVal = parseFloat(fd.get('startMiles') || 0);
                const endMilesVal = parseFloat(fd.get('endMiles') || 0);
                const derivedMiles = endMilesVal > startMilesVal ? (endMilesVal - startMilesVal).toFixed(2) : '';

                await DataManager.save('notary_mileage', {
                    id: Date.now().toString(),
                    date: fd.get('date'),
                    start: fd.get('start'),
                    end: fd.get('end'),
                    miles: milesValue || derivedMiles,
                    startedAt: activeTrip?.startedAt || null,
                    endedAt: new Date().toISOString()
                });
                setMileage(await DataManager.get('notary_mileage'));
                setShowMileageModal(false);
                setActiveTrip(null);
                localStorage.removeItem('notary_active_trip');
                showToast('Mileage Trip Saved');
            };


            const handleStartTrip = () => {
                if (activeTrip) {
                    showToast('A trip is already active. Stop it first.', 'error');
                    return;
                }
                const trip = {
                    id: `trip_${Date.now()}`,
                    startedAt: new Date().toISOString(),
                    start: '',
                    startMiles: ''
                };
                setActiveTrip(trip);
                localStorage.setItem('notary_active_trip', JSON.stringify(trip));
                setShowMileageModal(true);
                showToast('Trip started. Add details and save when done.');
            };

            const handleStopTrip = () => {
                if (!activeTrip) {
                    showToast('No active trip to stop.', 'error');
                    return;
                }
                setShowMileageModal(true);
            };

            const totalExpenses = expenses.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
            const totalMileage = mileage.reduce((sum, m) => sum + parseFloat(m.miles || 0), 0);

            const categoryIcon = (category = '') => {
                const c = category.toLowerCase();
                if (c.includes('travel')) return 'fa-car';
                if (c.includes('supply')) return 'fa-paperclip';
                if (c.includes('software')) return 'fa-laptop-code';
                if (c.includes('meal')) return 'fa-utensils';
                return 'fa-receipt';
            };

            return (
                <div className="p-6 pb-24 space-y-5 font-sans">
                    <div className="flex flex-wrap items-center justify-between gap-3">
                        <h3 className="text-2xl font-bold theme-text">Finances</h3>
                        <div className="flex flex-wrap gap-2">
                            {activeTab === 'mileage' && !activeTrip && <button onClick={handleStartTrip} className="px-4 py-2 rounded-lg border theme-border theme-text font-semibold"><i className="fas fa-play mr-2"></i>Start Trip</button>}
                            {activeTab === 'mileage' && activeTrip && <button onClick={handleStopTrip} className="px-4 py-2 rounded-lg border border-amber-300 text-amber-700 font-semibold"><i className="fas fa-stop mr-2"></i>Stop Trip</button>}
                            <button onClick={() => activeTab === 'expenses' ? setShowExpenseModal(true) : setShowMileageModal(true)} className="theme-accent-btn px-4 py-2 rounded-lg font-semibold">{activeTab === 'expenses' ? 'Add Expense' : (activeTrip ? 'Save Active Trip' : 'Add Mileage Trip')}</button>
                        </div>
                    </div>

                    {activeTab === 'mileage' && activeTrip && (
                        <div className="theme-surface border theme-border rounded-xl p-4 flex flex-wrap items-center justify-between gap-3">
                            <div>
                                <p className="text-xs uppercase font-bold text-amber-600">Trip in progress</p>
                                <p className="theme-text font-semibold">Started {new Date(activeTrip.startedAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                                <p className="theme-text-muted text-sm">Click <span className="font-semibold">Stop Trip</span> to complete and save mileage.</p>
                            </div>
                            <button onClick={handleStopTrip} className="px-4 py-2 rounded-lg border border-amber-300 text-amber-700 font-semibold">Complete Trip</button>
                        </div>
                    )}

                    <div className="inline-flex theme-app-bg border theme-border p-1 rounded-lg">
                        <button onClick={() => setActiveTab('expenses')} className={`px-4 py-2 rounded-md text-sm font-semibold transition-all duration-200 ${activeTab === 'expenses' ? 'theme-surface theme-text shadow-sm' : 'theme-text-muted'}`}>Expenses</button>
                        <button onClick={() => setActiveTab('mileage')} className={`px-4 py-2 rounded-md text-sm font-semibold transition-all duration-200 ${activeTab === 'mileage' ? 'theme-surface theme-text shadow-sm' : 'theme-text-muted'}`}>Mileage</button>
                    </div>

                    <div className="theme-surface theme-border border rounded-2xl p-5" style={{ backgroundImage: 'linear-gradient(120deg, rgba(79,70,229,0.08), transparent)' }}>
                        <p className="text-xs font-semibold uppercase theme-text-muted">{activeTab === 'expenses' ? 'Total YTD Expenses' : 'Total YTD Mileage'}</p>
                        <p className="text-3xl font-bold theme-text mt-2">{activeTab === 'expenses' ? `$${totalExpenses.toFixed(2)}` : `${totalMileage.toFixed(0)} mi`}</p>
                    </div>

                    {activeTab === 'expenses' ? (
                        expenses.length === 0 ? (
                            <div className="theme-surface theme-border border rounded-2xl py-16 px-6 text-center">
                                <div className="w-20 h-20 mx-auto rounded-full theme-surface-muted flex items-center justify-center mb-6"><i className="fas fa-receipt text-3xl theme-text-muted"></i></div>
                                <h3 className="text-xl font-bold theme-text mb-2">No expenses logged yet</h3>
                                <p className="theme-text-muted max-w-xs mx-auto mb-7 text-sm">Track your write-offs here.</p>
                                <button onClick={() => setShowExpenseModal(true)} className="theme-accent-btn px-6 py-2.5 rounded-xl font-bold">Add Expense</button>
                            </div>
                        ) : (
                            <div className="theme-surface theme-border border rounded-2xl divide-y theme-border">
                                {expenses.map(item => (
                                    <div key={item.id} className="p-4 flex items-center justify-between gap-3 hover:theme-surface-muted transition-all duration-200">
                                        <div className="min-w-0">
                                            <p className="text-xs theme-text-muted">{item.date}</p>
                                            <p className="font-semibold theme-text truncate"><i className={`fas ${categoryIcon(item.category)} mr-2`}></i>{item.category || 'General'}</p>
                                            <p className="text-sm theme-text-muted truncate">{item.desc || 'No description'}</p>
                                        </div>
                                        <p className="font-bold" style={{ color: '#dc2626' }}>-${parseFloat(item.amount || 0).toFixed(2)}</p>
                                    </div>
                                ))}
                            </div>
                        )
                    ) : (
                        mileage.length === 0 ? (
                            <div className="theme-surface theme-border border rounded-2xl py-16 px-6 text-center">
                                <div className="w-20 h-20 mx-auto rounded-full theme-surface-muted flex items-center justify-center mb-6"><i className="fas fa-route text-3xl theme-text-muted"></i></div>
                                <h3 className="text-xl font-bold theme-text mb-2">No mileage trips logged yet</h3>
                                <p className="theme-text-muted max-w-xs mx-auto mb-7 text-sm">Track deductible business mileage here.</p>
                                <button onClick={() => setShowMileageModal(true)} className="theme-accent-btn px-6 py-2.5 rounded-xl font-bold">Add Mileage Trip</button>
                            </div>
                        ) : (
                            <div className="theme-surface theme-border border rounded-2xl divide-y theme-border">
                                {mileage.map(item => (
                                    <div key={item.id} className="p-4 flex items-center justify-between gap-3 hover:theme-surface-muted transition-all duration-200">
                                        <div className="min-w-0">
                                            <p className="text-xs theme-text-muted">{item.date}</p>
                                            <p className="font-semibold theme-text truncate">{item.start || 'Start'} <i className="fas fa-arrow-right mx-2"></i> {item.end || 'End'}</p>
                                        </div>
                                        <p className="font-bold" style={{ color: 'var(--accent-color)' }}>{parseFloat(item.miles || 0).toFixed(2)} mi</p>
                                    </div>
                                ))}
                            </div>
                        )
                    )}

                    {showExpenseModal && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                            <form onSubmit={saveExpense} className="w-full max-w-xl theme-surface rounded-2xl border theme-border shadow-2xl p-6 space-y-4">
                                <div className="flex justify-between items-center"><h4 className="text-xl font-bold theme-text">Add Expense</h4><button type="button" onClick={() => setShowExpenseModal(false)} className="theme-text-muted"><i className="fas fa-times"></i></button></div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <input name="date" type="date" defaultValue={new Date().toISOString().split('T')[0]} required className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" />
                                    <input name="category" placeholder="Category (Travel, Supplies...)" required className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" />
                                    <input name="desc" placeholder="Description" className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text md:col-span-2" />
                                    <input name="amount" type="number" step="0.01" placeholder="Amount" required className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" />
                                </div>
                                <div className="flex justify-end gap-2"><button type="button" onClick={() => setShowExpenseModal(false)} className="px-4 py-2 rounded-lg border theme-border">Cancel</button><button className="theme-accent-btn px-4 py-2 rounded-lg font-semibold">Save Expense</button></div>
                            </form>
                        </div>
                    )}

                    {showMileageModal && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                            <form onSubmit={saveMileage} className="w-full max-w-xl theme-surface rounded-2xl border theme-border shadow-2xl p-6 space-y-4">
                                <div className="flex justify-between items-center"><h4 className="text-xl font-bold theme-text">Add Mileage Trip</h4><button type="button" onClick={() => setShowMileageModal(false)} className="theme-text-muted"><i className="fas fa-times"></i></button></div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <input name="date" type="date" required className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" />
                                    <input name="miles" type="number" step="0.01" placeholder="Miles (optional if odometer used)" className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" />
                                    <input name="start" defaultValue={activeTrip?.start || ""} placeholder="Start Location" required className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text md:col-span-2" />
                                    <input name="end" placeholder="End Location" required className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text md:col-span-2" />
                                    <input name="startMiles" type="number" step="0.01" defaultValue={activeTrip?.startMiles || ''} placeholder="Start Odometer (optional)" className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" />
                                    <input name="endMiles" type="number" step="0.01" placeholder="End Odometer (optional)" className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" />

                                </div>
                                <div className="flex justify-end gap-2"><button type="button" onClick={() => setShowMileageModal(false)} className="px-4 py-2 rounded-lg border theme-border">Cancel</button><button className="theme-accent-btn px-4 py-2 rounded-lg font-semibold">Save Trip</button></div>
                            </form>
                        </div>
                    )}
                </div>
            );
        };

        const AgencyManagement = ({ appointments }) => {
            const [team, setTeam] = useState([]);
            const [assignments, setAssignments] = useState([]);
            const [showForm, setShowForm] = useState(false);

            useEffect(() => {
                const load = async () => {
                    setTeam(await DataManager.get('notary_team'));
                    setAssignments(await DataManager.get('notary_assignments'));
                };
                load();
            }, []);

            const safeAppointments = Array.isArray(appointments) ? appointments : [];
            const openJobs = safeAppointments.filter(appt => ['Scheduled', 'Completed'].includes(appt.status));
            const paidRevenue = safeAppointments.filter(appt => appt.status === 'Paid').reduce((sum, appt) => sum + parseFloat(appt.fee || 0), 0);

            const handleAddNotary = async (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                await DataManager.save('notary_team', {
                    id: Date.now().toString(),
                    name: fd.get('name'),
                    email: fd.get('email'),
                    region: fd.get('region') || 'Unassigned',
                    status: fd.get('status') || 'Available'
                });
                setTeam(await DataManager.get('notary_team'));
                setShowForm(false);
                showToast('Team Member Added');
            };

            const handleAssign = async (appointmentId, notaryId) => {
                if (!notaryId) return;
                await DataManager.save('notary_assignments', {
                    id: `${appointmentId}-${notaryId}`,
                    appointmentId,
                    notaryId,
                    assignedAt: new Date().toISOString()
                });
                setAssignments(await DataManager.get('notary_assignments'));
                showToast('Dispatch Updated');
            };

            const assignedName = (apptId) => {
                const a = assignments.find(item => item.appointmentId === apptId);
                if (!a) return 'Unassigned';
                return team.find(t => t.id === a.notaryId)?.name || 'Unassigned';
            };

            return (
                <div className="p-6 pb-24 space-y-5 font-sans">
                    <div className="flex flex-wrap items-center justify-between gap-3">
                        <div>
                            <h3 className="text-2xl font-bold theme-text">Team Dispatch</h3>
                            <p className="theme-text-muted text-sm">Coordinate multi-notary workflows and assignments from one control panel.</p>
                        </div>
                        <button onClick={() => setShowForm(true)} className="theme-accent-btn px-4 py-2 rounded-lg font-semibold"><i className="fas fa-user-plus mr-2"></i>Add Notary</button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="theme-surface theme-border border rounded-xl p-4"><p className="text-xs uppercase theme-text-muted">Team Size</p><p className="text-2xl font-bold theme-text mt-2">{team.length}</p></div>
                        <div className="theme-surface theme-border border rounded-xl p-4"><p className="text-xs uppercase theme-text-muted">Open Jobs</p><p className="text-2xl font-bold theme-text mt-2">{openJobs.length}</p></div>
                        <div className="theme-surface theme-border border rounded-xl p-4"><p className="text-xs uppercase theme-text-muted">Paid Revenue</p><p className="text-2xl font-bold theme-text mt-2">${paidRevenue.toLocaleString()}</p></div>
                    </div>

                    <div className="grid grid-cols-1 xl:grid-cols-3 gap-6">
                        <div className="xl:col-span-1 theme-surface theme-border border rounded-2xl p-4">
                            <h4 className="font-semibold theme-text mb-3">Notary Team</h4>
                            {team.length === 0 ? <p className="theme-text-muted text-sm">No team members yet.</p> : (
                                <div className="space-y-2">
                                    {team.map(member => (
                                        <div key={member.id} className="theme-surface-muted border theme-border rounded-xl p-3">
                                            <p className="font-semibold theme-text truncate">{member.name}</p>
                                            <p className="text-xs theme-text-muted truncate">{member.email}</p>
                                            <p className="text-xs mt-1 theme-text-muted">{member.region} â€¢ {member.status}</p>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        <div className="xl:col-span-2 theme-surface theme-border border rounded-2xl p-4">
                            <h4 className="font-semibold theme-text mb-3">Dispatch Queue</h4>
                            {openJobs.length === 0 ? <p className="theme-text-muted text-sm">No active jobs to assign.</p> : (
                                <div className="space-y-3">
                                    {openJobs.map(appt => (
                                        <div key={appt.id} className="border theme-border rounded-xl p-3 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                                            <div className="min-w-0">
                                                <p className="font-semibold theme-text truncate">{appt.clientName || 'Client'}</p>
                                                <p className="text-xs theme-text-muted truncate">{appt.type || 'Notary Service'} â€¢ {appt.date} {appt.time || ''}</p>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span className="text-xs theme-text-muted">Assigned: {assignedName(appt.id)}</span>
                                                <select onChange={(e) => handleAssign(appt.id, e.target.value)} className="px-2 py-1.5 rounded-lg border theme-border theme-app-bg theme-text text-sm">
                                                    <option value="">Assign</option>
                                                    {team.map(member => <option key={member.id} value={member.id}>{member.name}</option>)}
                                                </select>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>

                    {showForm && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                            <form onSubmit={handleAddNotary} className="w-full max-w-xl theme-surface border theme-border rounded-2xl shadow-2xl p-6 space-y-4">
                                <div className="flex justify-between items-center"><h4 className="text-xl font-bold theme-text">Add Team Member</h4><button type="button" onClick={() => setShowForm(false)} className="theme-text-muted"><i className="fas fa-times"></i></button></div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <input name="name" required placeholder="Full Name" className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" />
                                    <input name="email" required placeholder="Email" className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" />
                                    <input name="region" placeholder="Region" className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" />
                                    <select name="status" className="px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text"><option>Available</option><option>Busy</option></select>
                                </div>
                                <div className="flex justify-end gap-2"><button type="button" onClick={() => setShowForm(false)} className="px-4 py-2 rounded-lg border theme-border">Cancel</button><button className="theme-accent-btn px-4 py-2 rounded-lg font-semibold">Add Member</button></div>
                            </form>
                        </div>
                    )}
                </div>
            );
        };

        const Credentials = ({ onUpdate }) => {
            const [creds, setCreds] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [editingCred, setEditingCred] = useState(null);

            useEffect(() => { DataManager.get('notary_credentials').then(setCreds); }, []);

            const handleSave = async (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                await DataManager.save('notary_credentials', {
                    id: editingCred?.id || Date.now().toString(),
                    name: fd.get('name'),
                    expiry: fd.get('expiry')
                });
                setShowForm(false);
                setEditingCred(null);
                setCreds(await DataManager.get('notary_credentials'));
                if (onUpdate) onUpdate();
                showToast(editingCred ? 'Credential Updated' : 'Credential Saved');
            };

            const handleDelete = async (id) => {
                await DataManager.delete('notary_credentials', id);
                setCreds(await DataManager.get('notary_credentials'));
                if (onUpdate) onUpdate();
                showToast('Credential Deleted', 'error');
            };

            const now = new Date();
            const statusMeta = (expiry) => {
                const exp = new Date(expiry);
                if (isNaN(exp.getTime())) return { label: 'Unknown', days: 999, bar: '#94a3b8', cardBorder: 'var(--border-color)' };
                const days = Math.ceil((exp - now) / (1000 * 60 * 60 * 24));
                if (days < 0) return { label: 'Expired', days, bar: '#ef4444', cardBorder: '#ef4444' };
                if (days < 60) return { label: 'Expiring Soon', days, bar: '#f59e0b', cardBorder: 'var(--border-color)' };
                return { label: 'Active', days, bar: '#22c55e', cardBorder: 'var(--border-color)' };
            };

            return (
                <div className="p-6 pb-24 space-y-5 font-sans">
                    <div className="flex flex-wrap items-center justify-between gap-3">
                        <div>
                            <h3 className="text-2xl font-bold theme-text">Compliance & Credentials</h3>
                            <p className="theme-text-muted text-sm">Monitor every expiration before it becomes a risk.</p>
                        </div>
                        <button onClick={() => { setEditingCred(null); setShowForm(true); }} className="theme-accent-btn px-4 py-2 rounded-lg font-semibold">Add Credential</button>
                    </div>

                    {creds.length === 0 ? (
                        <div className="theme-surface theme-border border rounded-2xl py-16 px-6 text-center">
                            <div className="w-20 h-20 mx-auto rounded-full theme-surface-muted flex items-center justify-center mb-6"><i className="fas fa-shield-alt text-3xl theme-text-muted"></i></div>
                            <h3 className="text-xl font-bold theme-text mb-2">No credentials added</h3>
                            <p className="theme-text-muted max-w-xs mx-auto mb-7 text-sm">Track commission, bond, insurance, and certifications here.</p>
                            <button onClick={() => setShowForm(true)} className="theme-accent-btn px-6 py-2.5 rounded-xl font-bold">Add Credential</button>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                            {creds.map(c => {
                                const meta = statusMeta(c.expiry);
                                return (
                                    <div key={c.id} className="theme-surface border rounded-xl p-5 transition-all duration-200 hover:-translate-y-0.5 shadow-sm hover:shadow-md" style={{ borderColor: meta.cardBorder }}>
                                        <div className="flex items-start justify-between">
                                            <div className="w-10 h-10 rounded-xl theme-surface-muted flex items-center justify-center"><i className="fas fa-certificate theme-text-muted"></i></div>
                                            <div className="flex gap-2">
                                                <button onClick={() => { setEditingCred(c); setShowForm(true); }} className="w-8 h-8 rounded-lg border theme-border theme-text-muted"><i className="fas fa-ellipsis-h"></i></button>
                                                <button onClick={() => handleDelete(c.id)} className="w-8 h-8 rounded-lg border theme-border theme-text-muted"><i className="fas fa-trash"></i></button>
                                            </div>
                                        </div>
                                        <div className="mt-4">
                                            <p className="text-lg font-bold theme-text">{c.name}</p>
                                            <p className="text-sm theme-text-muted mt-1">Expires: {c.expiry || 'â€”'}</p>
                                        </div>
                                        <div className="mt-4">
                                            <div className="h-1.5 rounded-full" style={{ backgroundColor: 'rgba(148,163,184,0.25)' }}>
                                                <div className={`h-full rounded-full ${meta.label === 'Expiring Soon' ? 'animate-pulse' : ''}`} style={{ width: meta.label === 'Expired' ? '100%' : meta.label === 'Expiring Soon' ? '65%' : '35%', backgroundColor: meta.bar }}></div>
                                            </div>
                                            <span className={`mt-2 inline-flex px-2.5 py-1 rounded-full text-xs font-semibold ${meta.label === 'Expiring Soon' ? 'animate-pulse' : ''}`} style={{ backgroundColor: 'rgba(15,23,42,0.08)', color: meta.bar }}>
                                                {meta.label}{meta.days < 0 ? '' : ` â€¢ ${meta.days} days`}
                                            </span>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {showForm && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                            <form onSubmit={handleSave} className="w-full max-w-xl theme-surface rounded-2xl border theme-border shadow-2xl p-6 space-y-4">
                                <div className="flex justify-between items-center"><h4 className="text-xl font-bold theme-text">{editingCred ? 'Edit Credential' : 'Add Credential'}</h4><button type="button" onClick={() => { setShowForm(false); setEditingCred(null); }} className="theme-text-muted"><i className="fas fa-times"></i></button></div>
                                <input name="name" defaultValue={editingCred?.name || ''} placeholder="Credential Name (e.g., E&O Insurance)" required className="w-full px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" />
                                <input name="expiry" defaultValue={editingCred?.expiry || ''} type="date" required className="w-full px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" />
                                <div className="flex justify-end gap-2"><button type="button" onClick={() => { setShowForm(false); setEditingCred(null); }} className="px-4 py-2 rounded-lg border theme-border">Cancel</button><button className="theme-accent-btn px-4 py-2 rounded-lg font-semibold">Save Credential</button></div>
                            </form>
                        </div>
                    )}
                </div>
            );
        };

        const TrainerModule = ({ stateDB, courseMods, user, onUpgrade }) => {
            const [selectedStateKey, setSelectedStateKey] = useState('CA');
            const [mode, setMode] = useState('study');
            const [messages, setMessages] = useState([{ role: 'assistant', content: "Hello! I am your AI Coach. Ask me anything about notary laws." }]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => { scrollRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

            const sendMessage = async () => {
                if (!input.trim()) return;
                const newMsgs = [...messages, { role: 'user', content: input }];
                setMessages(newMsgs);
                setInput('');
                setLoading(true);
                setTimeout(() => {
                    setMessages([...newMsgs, { role: 'assistant', content: 'This is a simulated AI response. Add your API key in Settings for production AI answers.' }]);
                    setLoading(false);
                }, 700);
            };

            return (
                <div className="p-6 pb-24 font-sans h-full flex flex-col gap-4">
                    <div className="flex flex-wrap items-center justify-between gap-3">
                        <div>
                            <h3 className="text-2xl font-bold theme-text">AI Trainer</h3>
                            <p className="theme-text-muted text-sm">Compliance study and coaching workspace.</p>
                        </div>
                        <div className="flex gap-2">
                            <select value={selectedStateKey} onChange={e => setSelectedStateKey(e.target.value)} className="px-3 py-2 rounded-lg border theme-border theme-app-bg theme-text text-sm">
                                {Object.keys(stateDB).map(k => <option key={k} value={k}>{stateDB[k].state}</option>)}
                            </select>
                            <div className="inline-flex border theme-border rounded-lg p-1">
                                <button onClick={() => setMode('study')} className={`px-3 py-1.5 rounded-md text-sm ${mode === 'study' ? 'theme-surface theme-text' : 'theme-text-muted'}`}>Study</button>
                                <button onClick={() => setMode('chat')} className={`px-3 py-1.5 rounded-md text-sm ${mode === 'chat' ? 'theme-surface theme-text' : 'theme-text-muted'}`}>Chat</button>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 flex-1 min-h-0">
                        <div className="lg:col-span-1 theme-surface theme-border border rounded-2xl p-4 overflow-auto">
                            <h4 className="font-semibold theme-text mb-2">State Snapshot</h4>
                            <p className="text-sm theme-text-muted mb-3">Quick reference for {stateDB[selectedStateKey]?.state}.</p>
                            <ul className="space-y-2 text-sm theme-text-muted">
                                <li><i className="fas fa-receipt mr-2"></i>Acknowledgment Fee: ${stateDB[selectedStateKey]?.fees?.acknowledgment || 'â€”'}</li>
                                <li><i className="fas fa-file-signature mr-2"></i>Jurat Fee: ${stateDB[selectedStateKey]?.fees?.jurat || 'â€”'}</li>
                                <li><i className="fas fa-id-card mr-2"></i>ID Rules: {stateDB[selectedStateKey]?.id_rules?.slice(0, 55) || 'â€”'}...</li>
                            </ul>
                        </div>

                        <div className="lg:col-span-2 theme-surface theme-border border rounded-2xl flex flex-col min-h-0">
                            <div className="p-4 border-b theme-border">
                                <h4 className="font-semibold theme-text">AI Coach Conversation</h4>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                {messages.map((m, i) => (
                                    <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[85%] p-3 rounded-xl text-sm ${m.role === 'user' ? 'theme-accent-btn text-white' : 'theme-surface-muted theme-text'}`}>{m.content}</div>
                                    </div>
                                ))}
                                {loading && <p className="text-xs theme-text-muted">Thinking...</p>}
                                <div ref={scrollRef}></div>
                            </div>
                            <div className="p-4 border-t theme-border flex gap-2">
                                <input value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && sendMessage()} placeholder="Ask AI Coach..." className="flex-1 px-3 py-2 rounded-lg border theme-border theme-app-bg theme-text" />
                                <button onClick={sendMessage} className="theme-accent-btn px-4 rounded-lg">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AdminPanel = ({ stateDB }) => {
            const [activeTab, setActiveTab] = useState('states');
            const [selectedState, setSelectedState] = useState('CA');
            const [ackFee, setAckFee] = useState(stateDB['CA']?.fees?.acknowledgment || '');

            useEffect(() => {
                setAckFee(stateDB[selectedState]?.fees?.acknowledgment || '');
            }, [selectedState, stateDB]);

            const saveStateChanges = () => showToast('State configuration saved (demo).');

            return (
                <div className="p-6 pb-24 space-y-5 font-sans">
                    <div className="theme-surface border border-red-300 rounded-xl p-4 bg-red-500/10">
                        <h3 className="font-bold text-red-600">Admin Control Center</h3>
                        <p className="text-sm theme-text-muted mt-1">Manage legal data, curriculum, and system-wide compliance content.</p>
                    </div>

                    <div className="inline-flex border theme-border rounded-lg p-1">
                        <button onClick={() => setActiveTab('states')} className={`px-3 py-1.5 rounded-md text-sm ${activeTab === 'states' ? 'theme-surface theme-text' : 'theme-text-muted'}`}>State Rules</button>
                        <button onClick={() => setActiveTab('curriculum')} className={`px-3 py-1.5 rounded-md text-sm ${activeTab === 'curriculum' ? 'theme-surface theme-text' : 'theme-text-muted'}`}>Curriculum</button>
                    </div>

                    {activeTab === 'states' ? (
                        <div className="theme-surface theme-border border rounded-2xl p-5 space-y-4 max-w-2xl">
                            <div>
                                <label className="text-xs font-bold theme-text-muted uppercase">Select State</label>
                                <select className="w-full mt-1 px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" value={selectedState} onChange={e => setSelectedState(e.target.value)}>
                                    {Object.keys(stateDB).map(k => <option key={k} value={k}>{stateDB[k].state}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="text-xs font-bold theme-text-muted uppercase">Acknowledgment Fee</label>
                                <input value={ackFee} onChange={(e) => setAckFee(e.target.value)} className="w-full mt-1 px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" />
                            </div>
                            <button onClick={saveStateChanges} className="theme-accent-btn px-4 py-2 rounded-lg font-semibold">Save Changes</button>
                        </div>
                    ) : (
                        <div className="theme-surface theme-border border rounded-2xl p-5 max-w-2xl">
                            <h4 className="font-semibold theme-text">Curriculum Editor</h4>
                            <p className="text-sm theme-text-muted mt-1">Use this panel to publish updated AI Coach lessons and exam prompts.</p>
                            <textarea rows={6} className="w-full mt-4 px-3 py-2.5 rounded-lg border theme-border theme-app-bg theme-text" defaultValue="Module update notes..." />
                            <button onClick={() => showToast('Curriculum published (demo).')} className="mt-3 theme-accent-btn px-4 py-2 rounded-lg font-semibold">Publish Curriculum</button>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(() => safeParse(safeStorageGet('notary_user_profile', null), null));
            const [currentView, setCurrentView] = useState(user ? 'dashboard' : 'landing');
            const [appointments, setAppointments] = useState([]);
            const [credentials, setCredentials] = useState([]);
            const [showMobileMenu, setShowMobileMenu] = useState(false);
            const [isCloudConnected, setIsCloudConnected] = useState(false);
            const [showPricing, setShowPricing] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [showOnboarding, setShowOnboarding] = useState(false);
            const [showWelcomeTour, setShowWelcomeTour] = useState(false);
            const [showAIModal, setShowAIModal] = useState(false); 
            const [showWhatsNew, setShowWhatsNew] = useState(() => !!user && !localStorage.getItem('notary_whats_new_seen_v2'));
            const [editingAppointment, setEditingAppointment] = useState(null);
            const [paywallFeature, setPaywallFeature] = useState('pro');
            const theme = 'default';

            const ensureTrialFields = (profile) => {
                if (!profile) return profile;
                if (['pro', 'team'].includes(profile.plan)) return { ...profile, trialEndsAt: profile.trialEndsAt || null };
                if (profile.trialEndsAt) return profile;
                return { ...profile, trialEndsAt: Date.now() + TRIAL_DAYS * 24 * 60 * 60 * 1000 };
            };

            const isTrialExpired = (profile) => {
                if (!profile || ['pro', 'team'].includes(profile.plan) || profile.role === 'admin') return false;
                if (!profile.trialEndsAt) return false;
                return Date.now() > profile.trialEndsAt;
            };

            useEffect(() => {
                DataManager.get('notary_appointments').then(setAppointments);
                DataManager.get('notary_credentials').then(setCredentials);
                
                // Onboarding Logic Flow
                if (user) {
                    const normalized = ensureTrialFields(user);
                    if (normalized !== user) {
                        setUser(normalized);
                        localStorage.setItem('notary_user_profile', JSON.stringify(normalized));
                    }
                    const isOnboarded = localStorage.getItem('notary_onboarded');
                    const isTourComplete = localStorage.getItem('notary_tour_completed');
                    
                    if (!isOnboarded) {
                        setShowOnboarding(true);
                    } else if (!isTourComplete) {
                        setShowWelcomeTour(true);
                    }
                }
            }, [user]);

            useEffect(() => {
                document.body.setAttribute('data-theme', theme);
            }, [theme]);

            const handleUpdateProfile = (updatedData) => {
                const newUser = { ...user, ...updatedData };
                setUser(newUser);
                localStorage.setItem('notary_user_profile', JSON.stringify(newUser));
                showToast("Profile Saved");
            };


            const handleEnableAdminPreview = () => {
                const elevated = { ...(user || {}), role: 'admin' };
                setUser(elevated);
                localStorage.setItem('notary_user_profile', JSON.stringify(elevated));
                showToast('Admin preview enabled. Pro and agency features are unlocked for this profile.');
            };

            const handleLogin = (profile) => {
                const normalizedProfile = ensureTrialFields({ ...profile, plan: profile?.plan || 'free' });
                localStorage.setItem('notary_user_profile', JSON.stringify(normalizedProfile));
                setUser(normalizedProfile);
                setCurrentView('dashboard');
                // Onboarding triggers will handle the rest via useEffect
                showToast("Welcome Back!");
            };

            const handleLogout = () => {
                localStorage.removeItem('notary_user_profile');
                setUser(null);
                setCurrentView('landing');
            };

            const handleUpgrade = (targetPlan = 'pro') => {
                if (!STRIPE_PAYMENT_LINK) {
                    showToast('Stripe payment link is not configured yet.', 'error');
                    return;
                }

                const checkoutUrl = new URL(STRIPE_PAYMENT_LINK, window.location.origin);
                checkoutUrl.searchParams.set('plan', targetPlan);
                if (user?.email) checkoutUrl.searchParams.set('prefilled_email', user.email);
                if (user?.id) checkoutUrl.searchParams.set('client_reference_id', user.id);
                checkoutUrl.searchParams.set('source', 'notaryos_app');
                window.location.href = checkoutUrl.toString();
            };

            const handleOpenBillingPortal = () => {
                if (!STRIPE_BILLING_PORTAL_LINK) {
                    showToast('Billing portal link is not configured yet.', 'error');
                    return;
                }
                window.open(STRIPE_BILLING_PORTAL_LINK, '_blank', 'noopener');
            };

            const handleLockedFeature = (featureId) => {
                setPaywallFeature(featureId === 'agency' ? 'agency' : featureId);
                setCurrentView('paywall');
            };

            const handleOnboardingComplete = (selectedRole) => {
                const nextUser = {
                    ...(user || {}),
                    role: selectedRole,
                    plan: selectedRole === 'agency' ? ((user?.plan === 'team') ? 'team' : 'free') : (user?.plan || 'free')
                };
                setUser(nextUser);
                localStorage.setItem('notary_user_profile', JSON.stringify(nextUser));
                localStorage.setItem('notary_onboarded', 'true');
                setShowOnboarding(false);
                
                // Show tour immediately after role selection
                setShowWelcomeTour(true);
                
                if (selectedRole === 'agency' && !hasFeatureAccess(nextUser, 'agency')) setShowPricing(true);
            };

            const handleTourComplete = () => {
                localStorage.setItem('notary_tour_completed', 'true');
                setShowWelcomeTour(false);
                showToast("You're all set!");
            };

            const handleSaveAppt = async (appt) => {
                await DataManager.save('notary_appointments', appt);
                setAppointments(await DataManager.get('notary_appointments'));
                setCurrentView('schedule');
                setEditingAppointment(null);
                showToast("Appointment Saved");
            };
            
            const handleEditAppt = (appt) => {
                setEditingAppointment(appt);
                setCurrentView('addAppointment');
            };
            
            const handleAddApptWithDate = (dateStr) => {
                setEditingAppointment({ date: dateStr });
                setCurrentView('addAppointment');
            };

            const handleMarkPaid = async (appt) => {
                const updated = { ...appt, status: 'Paid' };
                await DataManager.save('notary_appointments', updated);
                await DataManager.save('notary_journal', {
                    id: `pay-${updated.id}`,
                    date: new Date().toISOString().split('T')[0],
                    signer: updated.clientName,
                    docType: `Payment â€¢ ${updated.type || 'Notary Service'}`,
                    fee: updated.fee
                });
                setAppointments(await DataManager.get('notary_appointments'));
                showToast("Payment Recorded");
            };
            
            const handleRefresh = async () => {
                 setAppointments(await DataManager.get('notary_appointments'));
                 setCredentials(await DataManager.get('notary_credentials'));
            };

            const handleNotify = () => {
                showToast("No new notifications", "success");
            };

            const handleSyncNow = async () => {
                showToast("Syncing data...");
                await handleRefresh();
                showToast("Sync complete", "success");
            };

            const renderView = () => {
                switch(currentView) {
                    case 'landing': return <LandingPage onNavigate={() => setCurrentView('auth')} />;
                    case 'auth': return <AuthScreen onAuth={handleLogin} onBack={() => setCurrentView('landing')} />;
                    case 'dashboard': return <Dashboard appointments={appointments} credentials={credentials} setView={setCurrentView} user={user} />;
                    case 'schedule': return <Schedule appointments={appointments} setView={setCurrentView} onMarkPaid={handleMarkPaid} onEdit={handleEditAppt} onAdd={handleAddApptWithDate} />;
                    case 'addAppointment': return <AppointmentForm onSave={handleSaveAppt} onCancel={() => { setEditingAppointment(null); setCurrentView('schedule'); }} initialData={editingAppointment} />;
                    case 'clients': return <Clients />;
                    case 'portal': return hasFeatureAccess(user, 'pro') ? <SignerPortal appointments={appointments} /> : <PaywallState featureKey='portal' onUpgrade={handleUpgrade} />;
                    case 'journal': return <Journal user={user} onUpgrade={()=>{}} />;
                    case 'finances': return <Finances />;
                    case 'credentials': return <Credentials onUpdate={handleRefresh} />;
                    case 'agency': return hasFeatureAccess(user, 'agency') ? <AgencyManagement appointments={appointments} /> : <PaywallState featureKey='agency' onUpgrade={handleUpgrade} />;
                    case 'trainer': return hasFeatureAccess(user, 'pro') ? <TrainerModule stateDB={STATE_DATABASE} courseMods={COURSE_MODULES} user={user} onUpgrade={()=>{}} /> : <PaywallState featureKey='trainer' onUpgrade={handleUpgrade} />;
                    case 'paywall': return <PaywallState featureKey={paywallFeature} onUpgrade={handleUpgrade} />;
                    case 'admin': return <AdminPanel stateDB={STATE_DATABASE} onUpdateStateDB={()=>{}} />;
                    default: return <div>Not found</div>;
                }
            };

            if (!user && currentView !== 'landing' && currentView !== 'auth') { return <LandingPage onNavigate={() => setCurrentView('auth')} />; }
            if (currentView === 'landing' || currentView === 'auth') return renderView();
            if (isTrialExpired(user)) return <TrialExpiredState onUpgrade={handleUpgrade} onOpenBillingPortal={handleOpenBillingPortal} />;

            return (
                <div className="flex h-screen overflow-hidden font-sans theme-app-bg">
                    <ToastContainer />

                    {/* Hide FAB on Trainer Page to avoid overlap/redundancy */}
                    {currentView !== 'trainer' && (
                        <button onClick={() => setShowAIModal(true)} className="fab-ai bg-indigo-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-2xl hover:bg-indigo-700 transition-transform transform hover:scale-110">
                            <i className="fas fa-robot text-2xl"></i>
                        </button>
                    )}

                    {showAIModal && <AIHelperModal onClose={() => setShowAIModal(false)} />}
                    {showPricing && <PricingModal onClose={() => setShowPricing(false)} onUpgrade={handleUpgrade} />}
                    {showSettings && <SettingsModal user={user} onClose={() => setShowSettings(false)} onSave={handleUpdateProfile} onOpenBillingPortal={handleOpenBillingPortal} onUpgrade={handleUpgrade} onEnableAdminPreview={handleEnableAdminPreview} />}
                    {showOnboarding && <OnboardingTour onComplete={handleOnboardingComplete} />}
                    {showWelcomeTour && <WelcomeTour onComplete={handleTourComplete} />}
                    
                    {showWhatsNew && (
                        <div className="fixed top-4 left-1/2 -translate-x-1/2 z-40 max-w-xl w-[92%] bg-white border border-blue-100 rounded-2xl shadow-xl p-4 font-sans">
                            <div className="flex items-start justify-between gap-3">
                                <div>
                                    <p className="text-xs font-bold uppercase text-blue-600">What's New</p>
                                    <p className="text-sm text-gray-600 mt-1">Payments, Client Portal, Smart Mileage, Audit Journal Capture, and Team Mode are now available by plan.</p>
                                </div>
                                <button onClick={() => { localStorage.setItem('notary_whats_new_seen_v2', 'true'); setShowWhatsNew(false); }} className="text-gray-400"><i className="fas fa-times"></i></button>
                            </div>
                        </div>
                    )}
                    
                    <Sidebar 
                        currentView={currentView} 
                        setView={setCurrentView} 
                        isOpen={showMobileMenu} 
                        onClose={() => setShowMobileMenu(false)} 
                        onLogout={handleLogout} 
                        userName={user.name} 
                        userPlan={user.plan} 
                        userRole={user.role || 'solo'}
                        onUpgrade={(plan) => plan ? handleUpgrade(plan) : setShowPricing(true)} 
                        onLockedFeature={handleLockedFeature} 
                        onSettings={() => setShowSettings(true)}
                    />
                    <main className="flex-1 flex flex-col h-screen md:ml-64 relative theme-app-bg">
                        <Header title={currentView.charAt(0).toUpperCase() + currentView.slice(1)} onNotify={handleNotify} onSyncNow={handleSyncNow} />
                        <div className="flex-1 overflow-y-auto relative">{renderView()}</div>
                        <MobileNav currentView={currentView} setView={setCurrentView} onOpenMenu={() => setShowMobileMenu(true)} user={user} onLockedFeature={handleLockedFeature} />
                    </main>
                </div>
            );
        };

        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(
                <AppErrorBoundary>
                    <App />
                </AppErrorBoundary>
            );
        } catch (e) {
            const mount = document.getElementById('root');
            if (mount) {
                mount.innerHTML = `<div style="min-height:100vh;display:grid;place-items:center;padding:24px;font-family:sans-serif;background:#f8fafc;color:#0f172a;"><div style="max-width:520px;background:#fff;border:1px solid #e2e8f0;border-radius:16px;padding:20px;box-shadow:0 10px 25px rgba(2,6,23,.08);"><h2 style="margin:0 0 8px;font-size:20px;">NotaryOS failed to load</h2><p style="margin:0 0 10px;color:#475569;">A browser/runtime issue prevented startup. Refresh the page or clear site data and retry.</p><p style="margin:0;color:#64748b;font-size:12px;word-break:break-word;">${(e && e.message) ? e.message : 'Unknown startup error'}</p></div></div>`;
            }
            console.error('Root render failure:', e);
        }
    </script>
</body>
</html>
